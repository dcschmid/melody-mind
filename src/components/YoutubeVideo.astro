---
import { Image } from "astro:assets";
import { getYoutubeEmbedUrl, getYoutubeThumbnail } from "@utils/youtube";

interface Props {
  src: string;
  title?: string;
  className?: string;
  showTitle?: boolean;
  showTitleIcon?: boolean;
}

const {
  src,
  title = "YouTube video player",
  className,
  showTitle = true,
  showTitleIcon = true,
} = Astro.props;

const embedUrl = getYoutubeEmbedUrl(src);
const thumbnail = await getYoutubeThumbnail(src);
const isPlayable = Boolean(embedUrl);
const ariaLabel = isPlayable ? "Play YouTube video" : "YouTube video unavailable";
---

<div
  class:list={[
    "bg-gn-soot-900 gn-panel relative aspect-video w-full cursor-pointer overflow-hidden rounded-lg",
    className,
  ]}
  data-youtube-video
>
  <button
    type="button"
    class="focus:ring-gn-amber-300 focus:ring-offset-gn-soot-900 absolute inset-0 aspect-video h-full w-full overflow-hidden focus:ring-2 focus:ring-offset-2 focus:outline-none"
    data-youtube-trigger
    aria-label={ariaLabel}
    data-embed-url={isPlayable ? embedUrl : undefined}
    disabled={!isPlayable}
    data-video-title={title}
  >
    <Image
      layout="full-width"
      src={thumbnail}
      width={1280}
      height={720}
      class="h-full w-full object-cover opacity-95"
      alt={title}
    />

    <span class="pointer-events-none absolute inset-0 flex items-center justify-center">
      <span
        class="bg-gn-amber-500 text-gn-soot-950 ring-gn-soot-700 hover:bg-gn-amber-400 flex h-16 w-16 items-center justify-center rounded-full shadow-[4px_4px_0_rgba(0,0,0,0.8)] ring-2 transition"
      >
        <svg
          width="26"
          height="26"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="text-gn-soot-950"
        >
          <path d="M8 5v14l11-7z"></path>
        </svg>
      </span>
    </span>

    {
      showTitle && (
        <div class="from-gn-soot-950/85 pointer-events-none absolute inset-x-0 bottom-0 bg-linear-to-t to-transparent px-6 py-5">
          <p class="text-gn-parchment-50 line-clamp-2 flex items-center gap-3 text-lg leading-snug font-semibold sm:text-2xl">
            {showTitleIcon && (
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="text-gn-amber-300"
              >
                <path d="M10 8l6 4-6 4V8z" />
                <path
                  d="M12 2a10 10 0 100 20 10 10 0 000-20z"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
              </svg>
            )}
            {title}
          </p>
        </div>
      )
    }
  </button>
</div>

<script is:inline>
  (() => {
    const root = document.currentScript?.previousElementSibling;
    if (!(root instanceof HTMLElement)) return;

    const trigger = root.querySelector("[data-youtube-trigger]");
    if (!(trigger instanceof HTMLButtonElement)) return;

    const embedUrl = trigger.dataset.embedUrl;
    const title = trigger.dataset.videoTitle;
    if (!embedUrl) return;

    const activate = () => {
      const iframe = document.createElement("iframe");
      iframe.src = embedUrl;
      iframe.title = title;
      iframe.allow =
        "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
      iframe.allowFullscreen = true;
      iframe.loading = "lazy";
      iframe.referrerPolicy = "strict-origin-when-cross-origin";
      iframe.classList.add("w-full", "h-full", "absolute", "inset-0");

      root.replaceChildren(iframe);
    };

    // click and accessibility activation
    trigger.addEventListener("click", activate, { once: true });
    trigger.addEventListener(
      "keydown",
      (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          activate();
        }
      },
      { once: true }
    );
  })();
</script>

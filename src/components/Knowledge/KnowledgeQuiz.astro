---
export type QuizQuestion = {
  question: string;
  options: string[];
  correct: number;
  explanation?: string;
  difficulty?: "easy" | "medium" | "hard";
};

const { title = "Quick Quiz", questions = [] } = Astro.props as {
  title?: string;
  questions?: QuizQuestion[];
};

const quizId = `knowledge-quiz-${Math.random().toString(36).slice(2, 9)}`;
const totalQuestions = questions.length;
---

<section id="knowledge-quiz" class="knowledge-quiz" data-knowledge-quiz>
  <header class="knowledge-quiz__header">
    <div class="knowledge-quiz__badge">Quick Quiz</div>
    <h2 class="knowledge-quiz__title" id={quizId}>{title}</h2>
    <p class="knowledge-quiz__lede">
      {totalQuestions} questions - No login - Instant feedback
    </p>
    <div class="knowledge-quiz__progress" data-quiz-progress>
      Question 1 of {totalQuestions}
    </div>
  </header>

  <form class="knowledge-quiz__form" aria-labelledby={quizId} data-quiz-form>
    <ol class="knowledge-quiz__list">
      {
        questions.map((question, questionIndex) => (
          <li class="knowledge-quiz__item">
            <fieldset
              class="knowledge-quiz__fieldset"
              data-question
              data-question-index={questionIndex}
              data-question-text={question.question}
              data-correct={question.correct}
              data-explanation={question.explanation || ""}
            >
              <legend class="knowledge-quiz__question">
                {questionIndex + 1}. {question.question}
              </legend>
              <div class="knowledge-quiz__options">
                {question.options.map((option, optionIndex) => (
                  <button
                    class="knowledge-quiz__option"
                    type="button"
                    data-answer-index={optionIndex}
                  >
                    <span class="knowledge-quiz__option-text">{option}</span>
                  </button>
                ))}
              </div>
              <div class="knowledge-quiz__feedback" data-feedback aria-live="polite" />
            </fieldset>
          </li>
        ))
      }
    </ol>

    <div class="knowledge-quiz__actions">
      <div class="knowledge-quiz__nav">
        <button
          class="knowledge-quiz__button knowledge-quiz__button--ghost"
          type="button"
          data-quiz-prev
        >
          Previous
        </button>
        <button class="knowledge-quiz__button" type="button" data-quiz-next>
          Next
        </button>
      </div>
      <button class="knowledge-quiz__button" type="button" data-quiz-submit>
        Show score
      </button>
      <button
        class="knowledge-quiz__button knowledge-quiz__button--ghost"
        type="button"
        data-quiz-reset
      >
        Reset
      </button>
      <div class="knowledge-quiz__result" data-quiz-result aria-live="polite"></div>
    </div>
  </form>
</section>

<script>
  (() => {
    const quizRoots = document.querySelectorAll("[data-knowledge-quiz]");
    quizRoots.forEach((root) => {
      const form = root.querySelector<HTMLFormElement>("[data-quiz-form]");
      if (!form) return;

      const listEl = root.querySelector<HTMLOListElement>(".knowledge-quiz__list");
      let questions = Array.from(root.querySelectorAll<HTMLElement>("[data-question]"));
      const resultEl = root.querySelector<HTMLElement>("[data-quiz-result]");
      const submitButton = root.querySelector("[data-quiz-submit]");
      const resetButton = root.querySelector("[data-quiz-reset]");
      const prevButton = root.querySelector("[data-quiz-prev]");
      const nextButton = root.querySelector("[data-quiz-next]");
      const progressEl = root.querySelector("[data-quiz-progress]");
      let currentIndex = 0;

      const shuffle = <T,>(items: T[]) => {
        const next = [...items];
        for (let i = next.length - 1; i > 0; i -= 1) {
          const j = Math.floor(Math.random() * (i + 1));
          [next[i], next[j]] = [next[j], next[i]];
        }
        return next;
      };

      const shuffleOptions = (fieldset: HTMLElement) => {
        const optionButtons = Array.from(
          fieldset.querySelectorAll<HTMLButtonElement>(".knowledge-quiz__option")
        );
        if (!optionButtons.length) return;
        const correctIndex = Number(fieldset.dataset.correct || "-1");
        const optionData = optionButtons.map((button, index) => ({
          button,
          wasCorrect: index === correctIndex,
        }));
        const shuffled = shuffle(optionData);
        const optionsContainer = fieldset.querySelector(".knowledge-quiz__options");
        if (!optionsContainer) return;
        shuffled.forEach((item, index) => {
          item.button.dataset.answerIndex = String(index);
          item.button.disabled = false;
          item.button.setAttribute("aria-pressed", "false");
          optionsContainer.appendChild(item.button);
          if (item.wasCorrect) {
            fieldset.dataset.correct = String(index);
          }
        });
        delete fieldset.dataset.selected;
      };

      const shuffleQuestions = () => {
        if (!listEl) return;
        const items = Array.from(
          listEl.querySelectorAll<HTMLLIElement>(".knowledge-quiz__item")
        );
        const shuffledItems = shuffle(items);
        shuffledItems.forEach((item) => listEl.appendChild(item));
        questions = shuffledItems
          .map((item) => item.querySelector<HTMLElement>("[data-question]"))
          .filter((item): item is HTMLElement => Boolean(item));
        questions.forEach((fieldset, index) => {
          const legend = fieldset.querySelector<HTMLLegendElement>(
            ".knowledge-quiz__question"
          );
          const baseText = fieldset.dataset.questionText || legend?.textContent || "";
          if (legend) {
            legend.textContent = `${index + 1}. ${baseText}`.trim();
          }
          shuffleOptions(fieldset);
        });
      };

      const clampIndex = (value: number) =>
        Math.min(Math.max(value, 0), questions.length - 1);

      const updateProgress = () => {
        if (!progressEl) return;
        progressEl.textContent = `Question ${currentIndex + 1} of ${questions.length}`;
      };

      const updateNav = () => {
        if (prevButton instanceof HTMLButtonElement) {
          prevButton.disabled = currentIndex <= 0;
        }
        if (nextButton instanceof HTMLButtonElement) {
          nextButton.disabled = currentIndex >= questions.length - 1;
        }
      };

      const showQuestion = (index: number) => {
        currentIndex = clampIndex(index);
        questions.forEach((fieldset, idx) => {
          const isActive = idx === currentIndex;
          fieldset.toggleAttribute("hidden", !isActive);
          fieldset.setAttribute("aria-hidden", isActive ? "false" : "true");
          const item = fieldset.closest("li");
          if (item) {
            item.toggleAttribute("hidden", !isActive);
          }
        });
        updateProgress();
        updateNav();
      };

      const updateFeedback = (fieldset: HTMLElement) => {
        const selectedIndex = Number(fieldset.dataset.selected || "-1");
        const feedback = fieldset.querySelector<HTMLElement>("[data-feedback]");
        if (!feedback) return;

        if (selectedIndex < 0) {
          feedback.textContent = "";
          feedback.removeAttribute("data-state");
          return;
        }

        const correctIndex = Number(fieldset.dataset.correct || "-1");
        const explanation = fieldset.dataset.explanation || "";
        const isCorrect = selectedIndex === correctIndex;
        const prefix = isCorrect ? "Correct." : "Not quite.";
        feedback.textContent = explanation ? `${prefix} ${explanation}` : prefix;
        feedback.dataset.state = isCorrect ? "correct" : "incorrect";
      };

      const scoreQuiz = () => {
        let answered = 0;
        let correct = 0;
        questions.forEach((fieldset) => {
          const selectedIndex = Number(fieldset.dataset.selected || "-1");
          if (selectedIndex < 0) return;
          answered += 1;
          const correctIndex = Number(fieldset.dataset.correct || "-1");
          if (selectedIndex === correctIndex) {
            correct += 1;
          }
        });
        return { answered, correct, total: questions.length };
      };

      form.addEventListener("click", (event) => {
        const target = event.target as HTMLElement;
        const button = target.closest<HTMLButtonElement>(".knowledge-quiz__option");
        if (!button || !button.dataset.answerIndex) return;
        const fieldset = button.closest<HTMLElement>("[data-question]");
        if (!fieldset || fieldset.dataset.selected) return;
        const selectedIndex = Number(button.dataset.answerIndex || "-1");
        fieldset.dataset.selected = String(selectedIndex);
        const optionButtons = fieldset.querySelectorAll<HTMLButtonElement>(
          ".knowledge-quiz__option"
        );
        optionButtons.forEach((btn) => {
          btn.disabled = true;
          btn.setAttribute(
            "aria-pressed",
            btn.dataset.answerIndex === button.dataset.answerIndex ? "true" : "false"
          );
        });
        updateFeedback(fieldset);
      });

      submitButton?.addEventListener("click", () => {
        const { answered, correct, total } = scoreQuiz();
        questions.forEach((fieldset) => updateFeedback(fieldset));
        if (!resultEl) return;
        if (!answered) {
          resultEl.textContent = "Pick at least one answer to see your score.";
          resultEl.dataset.state = "empty";
          return;
        }
        const percent = total ? Math.round((correct / total) * 100) : 0;
        resultEl.textContent = `Score: ${correct}/${total} correct (${percent}%).`;
        resultEl.dataset.state = "done";
      });

      resetButton?.addEventListener("click", () => {
        form.reset();
        questions.forEach((fieldset) => {
          const feedback = fieldset.querySelector<HTMLElement>("[data-feedback]");
          if (!feedback) return;
          feedback.textContent = "";
          feedback.removeAttribute("data-state");
          const optionButtons = fieldset.querySelectorAll<HTMLButtonElement>(
            ".knowledge-quiz__option"
          );
          optionButtons.forEach((button) => {
            button.disabled = false;
            button.setAttribute("aria-pressed", "false");
          });
          delete fieldset.dataset.selected;
        });
        if (resultEl) {
          resultEl.textContent = "";
          resultEl.removeAttribute("data-state");
        }
        shuffleQuestions();
        showQuestion(0);
      });

      prevButton?.addEventListener("click", () => {
        showQuestion(currentIndex - 1);
      });

      nextButton?.addEventListener("click", () => {
        showQuestion(currentIndex + 1);
      });

      shuffleQuestions();
      showQuestion(0);
    });
  })();
</script>

<style>
  .knowledge-quiz {
    display: grid;
    gap: 1.5rem;
    margin-top: 2rem;
    padding: 2rem 1.5rem;
    border-radius: 1.5rem;
    border: 2px solid color-mix(in srgb, var(--color-gn-amber-400) 35%, transparent);
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--color-gn-soot-900) 95%, var(--color-gn-amber-500)),
      color-mix(in srgb, var(--gn-bg-muted) 92%, transparent)
    );
    box-shadow:
      0 4px 24px rgba(0, 0, 0, 0.4),
      inset 0 1px 0 rgba(251, 191, 36, 0.1);
    position: relative;
    overflow: hidden;
  }

  .knowledge-quiz::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(
      90deg,
      var(--color-gn-amber-500),
      var(--color-gn-amber-300),
      var(--color-gn-teal-400),
      var(--color-gn-amber-300),
      var(--color-gn-amber-500)
    );
    background-size: 200% 100%;
    animation: shimmer 3s linear infinite;
  }

  @keyframes shimmer {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  .knowledge-quiz__header {
    display: grid;
    gap: 0.75rem;
  }

  .knowledge-quiz__badge {
    justify-self: start;
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    background: linear-gradient(
      135deg,
      rgba(251, 191, 36, 0.25),
      rgba(123, 214, 255, 0.2)
    );
    border: 2px solid var(--color-gn-amber-400);
    color: var(--color-gn-amber-200);
    text-transform: uppercase;
    letter-spacing: 0.16em;
    font-size: 0.85rem;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.15);
  }

  .knowledge-quiz__title {
    font-size: clamp(1.5rem, 1.1rem + 1vw, 2.1rem);
    margin: 0;
    background: linear-gradient(
      135deg,
      var(--color-gn-amber-200),
      var(--color-gn-teal-300)
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .knowledge-quiz__lede {
    margin: 0;
    color: var(--color-gn-parchment-200);
    font-size: 1.05rem;
  }

  .knowledge-quiz__progress {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-gn-amber-300);
    padding: 0.5rem 0;
  }

  .knowledge-quiz__form {
    display: grid;
    gap: 1.25rem;
  }

  .knowledge-quiz__list {
    display: grid;
    gap: 1.25rem;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .knowledge-quiz__item {
    padding: 1.75rem;
    border-radius: 1.25rem;
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--color-gn-soot-900) 85%, transparent),
      color-mix(in srgb, var(--gn-bg) 80%, transparent)
    );
    transition: all 0.3s ease;
  }

  .knowledge-quiz__item:hover {
    border-color: color-mix(in srgb, var(--color-gn-amber-400) 40%, transparent);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(251, 191, 36, 0.15);
  }

  .knowledge-quiz__fieldset {
    margin: 0;
    padding: 0;
    border: 0;
    display: grid;
    gap: 1.75rem;
  }

  .knowledge-quiz__question {
    font-weight: 600;
    color: var(--color-gn-amber-100);
    line-height: 1.5;
    font-size: 1.05rem;
  }

  .knowledge-quiz__options {
    display: grid;
    gap: 0.85rem;
    margin-top: 2rem;
  }

  .knowledge-quiz__option {
    appearance: none;
    display: flex;
    align-items: center;
    gap: 0.85rem;
    padding: 1rem 1.25rem;
    border-radius: 1rem;
    border: 2px solid color-mix(in srgb, var(--color-gn-teal-400) 25%, transparent);
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--color-gn-soot-900) 88%, transparent),
      color-mix(in srgb, var(--color-gn-soot-950) 90%, transparent)
    );
    cursor: pointer;
    text-align: left;
    color: var(--color-gn-parchment-100);
    font: inherit;
    font-weight: 500;
    font-size: 1.05rem;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow:
      0 2px 4px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(123, 214, 255, 0.1);
  }

  .knowledge-quiz__option::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(
      180deg,
      var(--color-gn-teal-400),
      var(--color-gn-amber-400)
    );
    opacity: 0;
    transition: opacity 0.25s ease;
  }

  .knowledge-quiz__option:focus-visible {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 3px;
  }

  .knowledge-quiz__option:hover:not(:disabled) {
    border-color: color-mix(in srgb, var(--color-gn-teal-400) 50%, transparent);
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--color-gn-teal-500) 12%, var(--color-gn-soot-900)),
      color-mix(in srgb, var(--color-gn-amber-500) 10%, var(--color-gn-soot-950))
    );
    transform: translateX(6px);
    box-shadow:
      -2px 4px 16px rgba(123, 214, 255, 0.25),
      0 0 0 1px rgba(123, 214, 255, 0.3),
      inset 0 1px 0 rgba(123, 214, 255, 0.2);
    color: var(--color-gn-teal-100);
  }

  .knowledge-quiz__option:hover:not(:disabled)::before {
    opacity: 1;
  }

  .knowledge-quiz__option[aria-pressed="true"] {
    border-color: var(--color-gn-amber-400);
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--color-gn-amber-500) 28%, var(--color-gn-soot-900)),
      color-mix(in srgb, var(--color-gn-amber-600) 20%, var(--color-gn-soot-950))
    );
    box-shadow:
      0 0 0 2px var(--color-gn-amber-400),
      0 0 20px rgba(251, 191, 36, 0.4),
      0 4px 16px rgba(251, 191, 36, 0.3),
      inset 0 1px 0 rgba(251, 191, 36, 0.25);
    color: var(--color-gn-amber-100);
    font-weight: 600;
    transform: translateX(6px);
  }

  .knowledge-quiz__option[aria-pressed="true"]::before {
    background: linear-gradient(
      180deg,
      var(--color-gn-amber-400),
      var(--color-gn-amber-500)
    );
    opacity: 1;
    width: 5px;
  }

  .knowledge-quiz__option:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }

  .knowledge-quiz__option:disabled:hover {
    transform: none;
  }

  .knowledge-quiz__option-text {
    line-height: 1.5;
    flex: 1;
  }

  .knowledge-quiz__feedback {
    min-height: 1.5rem;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    font-size: 0.95rem;
    font-weight: 500;
    line-height: 1.5;
    display: block;
    margin-top: 0.5rem;
  }

  .knowledge-quiz__feedback:empty {
    display: none;
  }

  .knowledge-quiz__feedback[data-state="correct"] {
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(34, 197, 94, 0.1));
    border: 2px solid rgba(74, 222, 128, 0.4);
    color: rgb(134, 239, 172);
    box-shadow: 0 2px 8px rgba(74, 222, 128, 0.2);
  }

  .knowledge-quiz__feedback[data-state="incorrect"] {
    background: linear-gradient(
      135deg,
      rgba(251, 146, 60, 0.15),
      rgba(249, 115, 22, 0.1)
    );
    border: 2px solid rgba(251, 146, 60, 0.4);
    color: rgb(253, 186, 116);
    box-shadow: 0 2px 8px rgba(251, 146, 60, 0.2);
  }

  .knowledge-quiz__actions {
    display: grid;
    gap: 0.75rem;
    justify-items: start;
    padding-top: 0.5rem;
  }

  .knowledge-quiz__nav {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .knowledge-quiz__button {
    appearance: none;
    border-radius: 999px;
    border: 2px solid var(--color-gn-amber-400);
    padding: 0.75rem 1.75rem;
    background: linear-gradient(
      135deg,
      var(--color-gn-amber-500),
      var(--color-gn-amber-400)
    );
    color: var(--color-gn-soot-950);
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow:
      0 2px 8px rgba(251, 191, 36, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }

  .knowledge-quiz__button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow:
      0 4px 16px rgba(251, 191, 36, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
    background: linear-gradient(
      135deg,
      var(--color-gn-amber-400),
      var(--color-gn-amber-300)
    );
  }

  .knowledge-quiz__button:active {
    transform: translateY(0);
  }

  .knowledge-quiz__button--ghost {
    background: transparent;
    border-color: color-mix(in srgb, var(--color-gn-amber-400) 60%, transparent);
    color: var(--color-gn-amber-200);
    box-shadow: none;
  }

  .knowledge-quiz__button--ghost:hover:not(:disabled) {
    background: color-mix(in srgb, var(--color-gn-amber-500) 15%, transparent);
    border-color: var(--color-gn-amber-400);
    color: var(--color-gn-amber-100);
    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
  }

  .knowledge-quiz__button:focus-visible {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 3px;
  }

  .knowledge-quiz__button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .knowledge-quiz__result {
    min-height: 1.5rem;
    padding: 0.75rem 1.25rem;
    border-radius: 999px;
    font-weight: 700;
    font-size: 1.05rem;
  }

  .knowledge-quiz__result[data-state="empty"] {
    color: var(--color-gn-amber-200);
    background: color-mix(in srgb, var(--color-gn-amber-500) 15%, transparent);
    border: 2px solid color-mix(in srgb, var(--color-gn-amber-400) 35%, transparent);
  }

  .knowledge-quiz__result[data-state="done"] {
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(34, 197, 94, 0.15));
    border: 2px solid rgba(74, 222, 128, 0.5);
    color: rgb(134, 239, 172);
    box-shadow:
      0 2px 12px rgba(74, 222, 128, 0.25),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  @media (min-width: 720px) {
    .knowledge-quiz {
      padding: 2.5rem 2rem;
    }

    .knowledge-quiz__actions {
      grid-template-columns: repeat(2, max-content) 1fr;
      align-items: center;
      gap: 1rem;
    }

    .knowledge-quiz__result {
      justify-self: start;
    }
  }
</style>

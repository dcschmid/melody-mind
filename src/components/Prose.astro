---
/**
 * Prose Component - Tailwind Typography Wrapper
 *
 * A reusable component that wraps rendered Markdown content with Tailwind Typography styles.
 * Based on the official Astro documentation: https://docs.astro.build/en/recipes/tailwind-rendered-markdown/
 *
 * @component
 * @example
 * ```astro
 * <Prose>
 *   <Content />
 * </Prose>
 * ```
 */

export interface Props {
  /** Additional CSS classes for customization */
  className?: string;
  /** Raw HTML to render (if provided, rendered via set:html) */
  html?: string;
  /** Size variant: sm | md | lg | xl (maps to tailwind-prose size utilities) */
  size?: "sm" | "md" | "lg" | "xl";
  /** Invert colors (useful for dark mode) */
  invert?: boolean;
  /** When true, keeps max width none (full width). Otherwise the component will use prose default max-width */
  fullWidth?: boolean;
}

const {
  className: extra = "",
  html = undefined,
  size = "lg",
  invert = true,
  fullWidth = true,
} = Astro.props as Props;

// Sanitize HTML string: remove visible literal "\n" sequences and trim whitespace.
let sanitizedHtml =
  typeof html === "string" ? html.replace(/\\n/g, "\n").trim() : undefined;

// Remove trailing triple backticks (```) that might have been appended accidentally
if (typeof sanitizedHtml === "string") {
  sanitizedHtml = sanitizedHtml.replace(/\n?\s*```\s*$/m, "");
}

// Aggressive removal: remove any remaining triple backticks, escaped backticks, or HTML-encoded backticks
if (typeof sanitizedHtml === "string") {
  // Remove occurrences of ``` anywhere
  sanitizedHtml = sanitizedHtml.replace(/```/g, "");
  // Remove escaped backticks like \`\`\`
  sanitizedHtml = sanitizedHtml.replace(/\\`/g, "");
  // Remove HTML entity for backtick if present
  sanitizedHtml = sanitizedHtml.replace(/&#96;|&#x60;|&grave;/g, "");
  sanitizedHtml = sanitizedHtml.trim();
}

const sizeClass = (() => {
  switch (size) {
    case "sm":
      return "prose-sm";
    case "md":
      return "prose";
    case "xl":
      return "prose-xl";
    case "lg":
    default:
      return "prose-lg";
  }
})();

const invertClass = invert ? "prose-invert" : "";
const maxWidthClass = fullWidth ? "max-w-none" : "mx-auto";

const baseClasses = [
  "prose",
  "prose-hr:border-gn-soot-700",
  sizeClass,
  invertClass,
  maxWidthClass,
  "prose-headings:text-gn-parchment-50",
  "prose-p:text-gn-parchment-200",
  "prose-li:text-gn-parchment-200",
  "prose-a:text-gn-amber-300 prose-a:no-underline",
  "prose-a:transition-colors",
  "hover:prose-a:text-gn-amber-200 hover:prose-a:underline hover:prose-a:underline-offset-4",
  "prose-strong:text-gn-parchment-50",
  "prose-code:text-gn-parchment-50",
  "prose-code:bg-gn-soot-800/90",
  "prose-code:px-2",
  "prose-code:py-1",
  "prose-code:rounded-lg",
  "prose-blockquote:border-l-gn-amber-400",
  "prose-blockquote:bg-gn-soot-800/80",
  "prose-blockquote:py-2",
  "prose-blockquote:px-4",
  "prose-blockquote:rounded-r-lg",
  "prose-p:leading-relaxed",
  "prose-li:leading-relaxed",
  "prose-p:my-5",
  "prose-ul:my-6",
  "prose-ol:my-6",
  "prose-li:my-1.5",
  "prose-h2:mt-12",
  "prose-h2:mb-4",
  "prose-h3:mt-10",
  "prose-h3:mb-3",
  "prose-hr:my-10",
];

const classes = [...baseClasses, extra].filter(Boolean).join(" ");
---

<div class={classes}>
  {sanitizedHtml ? <div set:html={sanitizedHtml} /> : <slot />}
</div>

```

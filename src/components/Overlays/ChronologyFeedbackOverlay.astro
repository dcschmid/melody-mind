---
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import { Icon } from "astro-icon/components";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Prepare translations for client-side usage
const clientTranslations = {
  "game.chronology.correct": t("game.chronology.correct"),
  "game.chronology.incorrect": t("game.chronology.incorrect"),
  "game.chronology.correct_order": t("game.chronology.correct_order"),
  "game.chronology.user_order.correct_title": t("game.chronology.user_order.correct_title"),
  "game.chronology.user_order.incorrect_title": t("game.chronology.user_order.incorrect_title"),
  "game.chronology.stats.accuracy": t("game.chronology.stats.accuracy"),
  "game.chronology.stats.round_points": t("game.chronology.stats.round_points"),
  "game.chronology.stats.total_points": t("game.chronology.stats.total_points"),
  "game.chronology.stats.round": t("game.chronology.stats.round"),
};
---

<div
  id="chronology-feedback-overlay"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
  data-translations={JSON.stringify(clientTranslations)}
  aria-hidden="true"
  role="dialog"
  aria-modal="true"
  aria-labelledby="feedback-heading"
>
  <div id="chronology-feedback-backdrop" class="absolute inset-0 bg-black/50" aria-hidden="true">
  </div>

  <div
    id="chronology-content-container"
    class="relative mx-4 max-h-[90vh] w-full max-w-4xl overflow-y-auto rounded-2xl border border-slate-600/50 bg-gradient-to-br from-slate-800/95 to-slate-900/95 p-6 shadow-2xl backdrop-blur-md"
    role="document"
    aria-labelledby="feedback-heading"
  >
    <!-- Header -->
    <header class="mb-6 flex items-center justify-between border-b border-slate-600/50 pb-4">
      <h2 id="feedback-heading" class="text-2xl font-bold text-white">
        {t("game.chronology.feedback.title")}
      </h2>
      <button
        id="chronology-close-button"
        type="button"
        class="flex h-10 w-10 items-center justify-center rounded-full border border-slate-600 bg-slate-700/50 text-slate-300 transition-all duration-200 hover:border-slate-500 hover:bg-slate-600/50 hover:text-white focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-800 focus:outline-none"
        aria-label={t("game.chronology.feedback.close")}
      >
        <Icon name="x" class="h-5 w-5" />
      </button>
    </header>

    <!-- Content -->
    <div
      id="feedback-content"
      class="mb-6 text-center text-gray-300"
      role="region"
      aria-live="polite"
    >
      <!-- Content will be populated by JavaScript -->
    </div>

    <!-- Stats Section -->
    <div
      class="mb-6 grid grid-cols-2 gap-4 rounded-lg border border-slate-600/50 bg-slate-800/50 p-4"
    >
      <div class="text-center">
        <div class="text-sm text-gray-400">{t("game.chronology.stats.accuracy")}</div>
        <div id="chronology-accuracy" class="text-2xl font-bold text-green-400">0%</div>
      </div>
      <div class="text-center">
        <div class="text-sm text-gray-400">{t("game.chronology.stats.round_points")}</div>
        <div id="chronology-score" class="text-2xl font-bold text-blue-400">+0</div>
      </div>
    </div>

    <!-- Results List -->
    <div
      id="chronology-results-list"
      class="mb-6 space-y-3"
      role="region"
      aria-label={t("game.chronology.results")}
    >
      <!-- Results will be populated by JavaScript -->
    </div>

    <!-- Status Announcer for Screen Readers -->
    <div id="feedback-status" class="sr-only" role="status" aria-live="polite" aria-atomic="true">
    </div>

    <!-- Footer Actions -->
    <footer class="flex items-center justify-center gap-4 border-t border-slate-600/50 pt-4">
      <button
        id="chronology-next-button"
        type="button"
        class="flex cursor-pointer items-center gap-3 rounded-xl border-2 border-blue-500 bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-3 text-base font-bold text-white transition-all duration-200 hover:-translate-y-1 hover:border-blue-600 hover:from-blue-600 hover:to-blue-700 focus:ring-4 focus:ring-blue-500/50 focus:ring-offset-2 focus:ring-offset-slate-800 focus:outline-none"
        aria-label={t("game.chronology.feedback.continue")}
      >
        <Icon name="arrow-right" class="h-5 w-5" />
        {t("game.chronology.feedback.continue")}
      </button>

      <button
        id="chronology-end-button"
        class="hidden cursor-pointer items-center gap-3 rounded-xl border-2 border-orange-500 bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-3 text-base font-bold text-white transition-all duration-200 hover:-translate-y-1 hover:border-orange-600 hover:from-orange-600 hover:to-orange-700 focus:ring-4 focus:ring-orange-500/50 focus:ring-offset-2 focus:ring-offset-slate-800 focus:outline-none"
        type="button"
        aria-label={t("game.end.title")}
      >
        <Icon name="flag" class="h-5 w-5" />
        {t("game.end.title")}
      </button>
    </footer>
  </div>
</div>

<script is:inline type="module">
  import { initChronologyFeedbackOverlay } from "@scripts/overlays/chronologyFeedbackOverlayClient";
  initChronologyFeedbackOverlay();
</script>

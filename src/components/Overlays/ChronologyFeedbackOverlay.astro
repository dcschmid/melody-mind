---
/**
 * ChronologyFeedbackOverlay - Game feedback modal
 *
 * Features:
 * - WCAG AAA compliant accessibility
 * - Performance optimized animations
 * - Responsive design with container queries
 * - Touch device support
 * - High contrast mode support
 * - Session timeout management
 *
 * @component
 * @example
 * ```typescript
 * window.dispatchEvent(new CustomEvent("showChronologyFeedback", {
 *   detail: { isCorrect: true, isLastRound: false }
 * }));
 * ```
 */
import { Icon } from "astro-icon/components";
import { getLangFromUrl, useTranslations } from "@utils/i18n";

export interface Props {
  /**
   * No props required - component controlled via events
   * @example
   * window.dispatchEvent(new CustomEvent("showChronologyFeedback", {
   *   detail: { isCorrect: true, isLastRound: false }
   * }));
   */
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Client-side translations for dynamic content
const clientTranslations = {
  "game.chronology.correct": t("game.chronology.correct"),
  "game.chronology.incorrect": t("game.chronology.incorrect"),
  "game.chronology.correct_order": t("game.chronology.correct_order"),
  "game.chronology.stats.accuracy": t("game.chronology.stats.accuracy"),
  "game.chronology.stats.round_points": t("game.chronology.stats.round_points"),
  "game.chronology.stats.total_points": t("game.chronology.stats.total_points"),
  "game.chronology.stats.round": t("game.chronology.stats.round"),
  "game.chronology.user_order.correct_title": t("game.chronology.user_order.correct_title"),
  "game.chronology.user_order.incorrect_title": t("game.chronology.user_order.incorrect_title"),
  "general.close": t("general.close"),
  "session.timeout.warning": t("session.timeout.warning"),
  "session.timeout.extend": t("session.timeout.extend"),
  "session.timeout.continue": t("session.timeout.continue"),
  "session.extended": t("session.extended"),
};
---

<div
  id="chronology-feedback-overlay"
  class="chronology-feedback-overlay hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="feedback-title"
  aria-describedby="feedback-content"
  tabindex="-1"
  data-translations={JSON.stringify(clientTranslations)}
>
  <!-- Use a div with inset-0 to create a click target for closing the modal -->
  <div id="overlay-backdrop" class="overlay-backdrop" aria-hidden="true"></div>

  <div class="modal-content" role="document">
    <!-- Close button - positioned at the top right -->
    <button
      id="close-feedback-overlay"
      class="close-button"
      aria-label={t("general.close")}
      type="button"
    >
      <Icon name="close" width={24} height={24} aria-hidden="true" class="close-icon" />
    </button>

    <h2 id="feedback-title" class="modal-title">
      {t("game.chronology.result")}
    </h2>

    <!-- Status announcer for screen readers -->
    <div id="feedback-status" aria-live="polite" aria-atomic="true" class="sr-only"></div>

    <div
      id="feedback-content"
      class="modal-content-text"
      aria-live="polite"
      aria-describedby="correct-order-description"
    >
      <!-- Content will be dynamically added here -->
      <!-- Hidden description for correct order list - enhanced accessibility -->
      <div id="correct-order-description" class="sr-only">
        {t("game.chronology.correct_order_description")}
      </div>
    </div>

    <div class="button-container">
      <button id="chronology-continue-button" class="primary-button" type="button">
        {t("game.next.round")}
      </button>
      <button id="chronology-end-button" class="secondary-button hidden" type="button">
        {t("game.end.title")}
      </button>
    </div>
  </div>
</div>

<style lang="scss" is:global>
  /**
   * ChronologyFeedbackOverlay Component Styles
   * 
   * ✅ 100% global.css variables integration
   * ✅ Performance optimized with CSS containment
   * ✅ WCAG AAA compliant styling
   * ✅ Responsive design with container queries
   * ✅ GPU acceleration for smooth animations
   */

  // Main overlay container
  .chronology-feedback-overlay {
    position: fixed;
    inset: var(--space-none);
    z-index: 9999; // Hoher Z-Index für Overlay

    display: flex;
    align-items: center;
    justify-content: center;

    background: rgba(0, 0, 0, 0.8); // Starker dunkler Hintergrund

    // Performance optimizations
    contain: layout style paint;
    content-visibility: auto;
    contain-intrinsic-size: var(--container-intrinsic-height-modal);

    will-change: opacity, visibility;
    transform: translateZ(0);

    // Container query support
    container-type: inline-size;
    container-name: chronology-feedback;

    // Performance optimizations
    backface-visibility: hidden;
    transform-style: preserve-3d;

    &.hidden {
      display: none;
      visibility: hidden;
      opacity: 0;
    }

    // Responsive padding
    @media (max-width: 39.9375em) {
      padding: clamp(var(--space-xs), 3vw, var(--space-sm));
    }
  }

  // Backdrop for click-to-close functionality
  .overlay-backdrop {
    position: absolute;
    inset: var(--space-none);

    // Performance optimizations
    contain: layout style;
    will-change: auto;
  }

  // Modal content container with clean design
  .modal-content {
    position: relative;
    z-index: 10000;

    margin: var(--space-md);
    width: calc(100vw - var(--space-xl));

    max-width: min(85vw, 550px);
    max-height: calc(100vh - var(--space-xl));

    border-radius: var(--radius-2xl);
    border: none;
    background: #1f2937; // Dunkelgrau statt schwarz

    padding: var(--space-xl);

    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);

    display: flex;
    flex-direction: column;

    min-height: 0;

    // Performance optimizations
    contain: layout style;
    will-change: transform, opacity;
    transform: translateZ(0);

    &::before {
      display: none;
    }

    // Responsive design improvements
    @media (min-width: 48em) {
      max-height: calc(var(--height-screen) - var(--space-3xl));
      max-width: min(95vw, var(--width-prose-lg));
    }

    @media (max-width: 47.9375em) {
      margin: var(--space-sm);
      padding: var(--space-xl);
      max-height: calc(var(--height-screen) - var(--space-xl));
      max-width: min(95vw, var(--width-prose-md));
    }

    @media (max-width: 23.4375em) {
      margin: var(--space-xs);
      padding: var(--space-lg);
      border-radius: var(--radius-xl);
      max-width: min(98vw, var(--width-prose-sm));
    }
  }

  // Close button with enhanced accessibility
  .close-button {
    position: absolute;
    top: clamp(var(--space-md), 4vw, var(--space-lg));
    right: clamp(var(--space-md), 4vw, var(--space-lg));

    display: flex;
    align-items: center;
    justify-content: center;

    height: var(--touch-target-enhanced);
    width: var(--touch-target-enhanced);

    border-radius: var(--radius-full);
    background: var(--bg-tertiary);
    border: var(--border-width-thick) solid var(--border-primary);

    cursor: pointer;
    box-shadow: var(--shadow-md);

    z-index: 10001; // Über dem Modal Content

    // Performance optimizations
    contain: layout style;
    will-change: transform, background-color;
    transform: translateZ(0);

    transition:
      background-color var(--transition-normal),
      transform var(--transition-fast),
      box-shadow var(--transition-normal);

    &:hover {
      background: var(--bg-primary);
      transform: translateZ(0) scale(var(--scale-focus)) rotate(90deg);
      box-shadow: var(--shadow-lg);
    }

    &:focus-visible {
      outline: var(--focus-outline);
      outline-offset: var(--focus-ring-offset);
      box-shadow: var(--focus-ring);
    }

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      top: var(--space-md);
      right: var(--space-md);
      height: calc(var(--touch-target-enhanced) - var(--space-sm));
      width: calc(var(--touch-target-enhanced) - var(--space-sm));
    }
  }

  // Close icon with responsive sizing
  .close-icon {
    height: clamp(var(--icon-size-sm), 4vw, var(--icon-size-md));
    width: clamp(var(--icon-size-sm), 4vw, var(--icon-size-md));
    color: var(--text-secondary);

    // Performance optimizations
    will-change: transform;
    transition: transform var(--transition-fast);
  }

  // Modal title with clean typography
  .modal-title {
    margin-bottom: var(--space-lg);

    text-align: center;
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: #f9fafb; // Helles Grau-Weiß

    line-height: var(--leading-tight);
    letter-spacing: -0.025em;

    text-wrap: balance;

    // Performance optimizations
    contain: layout style;
  }

  // Modal content text with enhanced scrolling
  .modal-content-text {
    flex: 1;

    overflow-y: auto;
    overflow-x: hidden;

    padding: var(--space-sm);

    // Bessere Höhenbeschränkungen für Scrolling
    max-height: calc(100vh - 250px); // Weniger Platz für kompakteres Design
    min-height: 150px;

    // Layout properties
    display: block;
    text-align: left;
    color: var(--text-secondary);
    line-height: var(--leading-relaxed);

    // Reset previous flexbox that might interfere
    align-items: unset;
    justify-content: unset;
    gap: unset;

    // Performance optimizations
    contain: layout style;
    will-change: scroll-position;

    // Firefox scrollbar styling
    scrollbar-width: thin;
    scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);

    // Ensure child elements don't break scrolling
    > * {
      margin-bottom: clamp(var(--space-md), 4vw, var(--space-lg));
      flex-shrink: 0;

      &:last-child {
        margin-bottom: 0;
      }
    }

    // Custom scrollbar styling for webkit browsers
    &::-webkit-scrollbar {
      width: var(--scrollbar-width);
    }

    &::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
      border-radius: var(--scrollbar-radius);
    }

    &::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: var(--scrollbar-radius);
      transition: background var(--transition-normal);

      &:hover {
        background: var(--scrollbar-thumb-hover);
      }
    }

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      padding: var(--space-sm);
    }
  }

  // Button container with responsive grid
  .button-container {
    margin-top: var(--space-lg);

    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-md);

    flex-shrink: 0;
    position: sticky;
    bottom: 0;

    background: #1f2937; // Gleiche Farbe wie Modal
    padding-top: var(--space-md);
    border-top: 1px solid #4b5563;

    // Performance optimizations
    contain: layout style;
    z-index: 10001; // Über dem scrollbaren Content

    @media (min-width: 48em) {
      grid-template-columns: repeat(2, 1fr);
    }

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      margin-top: var(--space-lg);
      gap: var(--space-sm);
      padding-top: var(--space-sm);
    }
  }

  // Enhanced button styles with accessibility
  .primary-button,
  .secondary-button {
    min-height: var(--touch-target-enhanced);

    border-radius: var(--radius-full);
    padding: clamp(var(--space-md), 4vw, var(--space-lg))
      clamp(var(--space-lg), 5vw, var(--space-xl));

    font-weight: var(--font-bold);
    font-size: clamp(var(--text-base), 4vw, var(--text-lg));

    border: none;
    cursor: pointer;

    position: relative;
    overflow: hidden;

    // Performance optimizations
    contain: layout style;
    will-change: transform, background-color;
    transform: translateZ(0);

    transition:
      transform var(--transition-normal),
      background var(--transition-normal),
      box-shadow var(--transition-normal);

    &::before {
      display: none;
    }

    &:focus-visible {
      outline: var(--focus-outline);
      outline-offset: var(--focus-ring-offset);
      box-shadow: var(--focus-ring);
    }

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      padding: var(--space-md) var(--space-lg);
      font-size: var(--text-base);
    }
  }

  // Clean primary button
  .primary-button {
    background: #8b5cf6; // Lila
    color: #ffffff;
    border: 2px solid #8b5cf6;

    transition: all 0.2s ease;

    &:hover {
      background: #7c3aed; // Dunkleres Lila
      border-color: #7c3aed;
      transform: translateY(-1px);
    }

    &:active {
      transform: translateY(0);
    }
  }

  // Secondary button with semantic colors
  .secondary-button {
    background: var(--color-warning-primary);
    color: var(--color-white);
    border: var(--border-width-thick) solid transparent;
    box-shadow: var(--shadow-md);

    &:hover {
      background: var(--color-warning-secondary);
      transform: translateZ(0) scale(var(--scale-focus)) translateY(var(--animation-y-offset-small));
      box-shadow: var(--shadow-xl);

      &::before {
        display: none;
      }
    }
  }

  // Hidden state utility
  .hidden {
    display: none;
    visibility: hidden;
    opacity: 0;
  }

  // Correct feedback message - Clean Design
  .feedback-correct {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);

    color: #065f46; // Dunkelgrün
    font-weight: var(--font-bold);
    font-size: var(--text-xl);

    margin-bottom: var(--space-lg);
    padding: var(--space-lg);

    background: #d1fae5; // Helles Grün
    border: 2px solid #10b981;
    border-radius: var(--radius-xl);

    // Kein Schatten, cleaner Look

    animation: successPulse 0.8s ease-out;

    // Performance optimizations
    contain: layout style;
    will-change: transform, opacity;
    transform: translateZ(0);

    // Responsive adjustments
    @media (max-width: 640px) {
      font-size: var(--text-xl);
      padding: var(--space-lg);
      gap: var(--space-sm);
    }
  }

  // Incorrect feedback message - Clean Design
  .feedback-incorrect {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);

    color: #7f1d1d; // Dunkelrot
    font-weight: var(--font-bold);
    font-size: var(--text-xl);

    margin-bottom: var(--space-lg);
    padding: var(--space-lg);

    background: #fecaca; // Helles Rot
    border: 2px solid #ef4444;
    border-radius: var(--radius-xl);

    // Kein Schatten, cleaner Look

    animation: errorShake 0.8s ease-out;

    // Performance optimizations
    contain: layout style;
    will-change: transform, opacity;
    transform: translateZ(0);

    // Responsive adjustments
    @media (max-width: 640px) {
      font-size: var(--text-xl);
      padding: var(--space-lg);
      gap: var(--space-sm);
    }
  }

  // Dark mode feedback adjustments
  @media (prefers-color-scheme: dark) {
    .feedback-correct {
      background: var(--bg-success-dark);
      border-color: var(--border-success-dark);
      color: var(--text-success-dark);
      box-shadow: var(--shadow-lg);
    }

    .feedback-incorrect {
      background: var(--bg-error-dark);
      border-color: var(--border-error-dark);
      color: var(--text-error-dark);
      box-shadow: var(--shadow-lg);
    }
  }

  // Clean correct order heading
  .correct-order-heading {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);

    margin-bottom: var(--space-lg);

    color: #f9fafb; // Weiß

    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);

    text-align: center;
    line-height: var(--leading-tight);

    text-wrap: balance;

    // Performance optimizations
    contain: layout style;

    &::before {
      content: "✓"; // Checkmark
      font-size: var(--text-2xl);
      color: #10b981; // Grün
    }

    // Responsive adjustments
    @media (max-width: 640px) {
      font-size: var(--text-lg);
      gap: var(--space-sm);
    }
  }

  // Clean correct order container
  .correct-order-container {
    width: var(--width-full);
    max-width: var(--width-full);

    margin: var(--space-xl) 0 0;
    padding: var(--space-xl);

    background: #374151; // Mittleres Grau
    border: 2px solid #10b981; // Grüner Rand
    border-radius: var(--radius-xl);

    // Ensure this doesn't interfere with scrolling
    flex-shrink: 0;

    // Performance optimizations
    contain: layout style;
    will-change: auto;

    // Responsive adjustments
    @media (max-width: 640px) {
      padding: var(--space-lg);
      margin: var(--space-lg) 0 0;
    }
  }

  // Clean correct order list
  .correct-order-list {
    list-style: none;
    padding: 0;
    margin: 0;

    display: flex;
    flex-direction: column;
    gap: var(--space-md);

    // Performance optimizations
    contain: layout style;

    div {
      display: flex;
      align-items: center;
      gap: var(--space-lg);

      padding: var(--space-lg);

      background: #1f2937; // Dunkles Grau
      border: 1px solid #4b5563;
      border-radius: var(--radius-lg);

      color: #f9fafb; // Weiß
      font-weight: var(--font-semibold);

      // Performance optimizations
      contain: layout style;
      will-change: transform, box-shadow;
      transform: translateZ(0) translateY(var(--space-lg));

      opacity: 0;

      transition: all var(--transition-normal);
      animation: slideUp 0.6s ease-out forwards;
      animation-delay: calc(0.15s * var(--item-index, 0));

      // Responsive adjustments
      @media (max-width: 640px) {
        padding: var(--space-md);
        gap: var(--space-md);
        flex-direction: column;
        text-align: center;
      }
    }
  }

  // Clean order number
  .order-number {
    display: flex;
    align-items: center;
    justify-content: center;

    width: var(--space-3xl);
    height: var(--space-3xl);

    background: #10b981; // Grün
    color: #ffffff;

    border-radius: var(--radius-full);

    font-weight: var(--font-bold);
    font-size: var(--text-lg);

    flex-shrink: 0;

    // Performance optimizations
    contain: layout style;
    will-change: auto;

    // Responsive adjustments
    @media (max-width: 640px) {
      width: var(--space-2xl);
      height: var(--space-2xl);
      font-size: var(--text-base);
    }
  }

  // Song info with responsive typography
  .song-info {
    flex: 1;

    font-size: clamp(var(--text-base), 4vw, var(--text-lg));
    line-height: var(--leading-relaxed);
    font-weight: var(--font-medium);

    text-wrap: balance;

    // Performance optimizations
    contain: layout style;

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      font-size: var(--text-base);
    }
  }

  // Feedback message with enhanced layout
  .feedback-message {
    width: var(--width-full);

    display: flex;
    flex-direction: column;
    align-items: center;
    gap: clamp(var(--space-md), 4vw, var(--space-lg));

    // Ensure this doesn't interfere with scrolling
    flex-shrink: 0;

    // Performance optimizations
    contain: layout style;

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      gap: var(--space-md);
    }
  }

  // Feedback icon with responsive sizing
  .feedback-icon {
    font-size: clamp(var(--text-2xl), 6vw, var(--text-3xl));

    animation: iconBounce 0.8s ease-out;

    // Performance optimizations
    will-change: transform;

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      font-size: var(--text-2xl);
    }
  }

  // Feedback text with responsive typography
  .feedback-text {
    font-size: clamp(var(--text-lg), 4vw, var(--text-xl));
    font-weight: var(--font-bold);

    text-align: center;
    line-height: var(--leading-relaxed);

    text-wrap: balance;

    // Performance optimizations
    contain: layout style;

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      font-size: var(--text-lg);
    }
  }

  // Game statistics display with enhanced design
  .game-stats {
    width: var(--width-full);
    max-width: var(--width-full);

    margin: clamp(var(--space-md), 4vw, var(--space-lg)) 0;
    padding: clamp(var(--space-md), 4vw, var(--space-lg));

    background: var(--bg-tertiary);
    border: var(--border-width-thick) solid var(--border-secondary);
    border-radius: var(--radius-2xl);

    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr));
    gap: clamp(var(--space-md), 4vw, var(--space-lg));

    box-shadow: var(--shadow-xl);

    position: relative;
    overflow: hidden;

    // Performance optimizations
    contain: layout style;
    will-change: auto;

    &::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: var(--border-width-enhanced);
      background: var(--interactive-primary);
      border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
    }

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      padding: var(--space-md);
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
      margin: var(--space-md) 0;
    }
  }

  // Stat item with enhanced interactivity
  .stat-item {
    text-align: center;
    padding: clamp(var(--space-sm), 3vw, var(--space-md));

    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    border: var(--border-width-thin) solid var(--border-primary);

    position: relative;
    overflow: hidden;

    // Performance optimizations
    contain: layout style;
    will-change: transform, box-shadow;
    transform: translateZ(0);

    transition: all var(--transition-normal);

    &::before {
      display: none;
    }

    &:hover {
      transform: translateZ(0) translateY(var(--animation-y-offset-small));
      box-shadow: var(--shadow-md);
      border-color: var(--interactive-primary);

      &::before {
        display: none;
      }
    }

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      padding: var(--space-sm);
    }
  }

  // Stat label with enhanced typography
  .stat-label {
    display: block;

    font-size: clamp(var(--text-xs), 3vw, var(--text-sm));
    color: var(--text-secondary);

    margin-bottom: clamp(var(--space-xs), 2vw, var(--space-sm));

    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);

    // Performance optimizations
    contain: layout style;

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      font-size: var(--text-xs);
    }
  }

  // Stat value with responsive sizing
  .stat-value {
    display: block;

    font-size: clamp(var(--text-xl), 5vw, var(--text-2xl));
    color: var(--text-primary);
    font-weight: var(--font-bold);

    line-height: var(--leading-none);

    // Performance optimizations
    contain: layout style;

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      font-size: var(--text-xl);
    }
  }

  // Performance-optimized animations
  @keyframes shimmer {
    0% {
      left: -100%;
    }
    100% {
      left: 100%;
    }
  }

  @keyframes successPulse {
    0% {
      transform: translateZ(0) scale(0.95);
      opacity: 0;
    }
    50% {
      transform: translateZ(0) scale(1.05);
    }
    100% {
      transform: translateZ(0) scale(1);
      opacity: 1;
    }
  }

  @keyframes errorShake {
    0%,
    100% {
      transform: translateZ(0) translateX(0);
      opacity: 0;
    }
    10%,
    30%,
    50%,
    70%,
    90% {
      transform: translateZ(0) translateX(-6px);
    }
    20%,
    40%,
    60%,
    80% {
      transform: translateZ(0) translateX(6px);
    }
    100% {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    to {
      opacity: 1;
      transform: translateZ(0) translateY(0);
    }
  }

  @keyframes iconBounce {
    0%,
    20%,
    53%,
    100% {
      animation-timing-function: var(--ease-out-quart);
      transform: translateZ(0) translate3d(0, 0, 0);
    }
    40%,
    43% {
      animation-timing-function: var(--ease-in-quart);
      transform: translateZ(0) translate3d(0, -20px, 0) scaleY(1.1);
    }
    70% {
      animation-timing-function: var(--ease-in-quart);
      transform: translateZ(0) translate3d(0, 0, 0) scaleY(0.95);
    }
    80% {
      animation-timing-function: var(--ease-out-quart);
      transform: translateZ(0) translate3d(0, 0, 0) scaleY(1.05);
    }
    90% {
      transform: translateZ(0) translate3d(0, 0, 0) scaleY(0.95);
    }
  }

  @keyframes float {
    0%,
    100% {
      transform: translateZ(0) translateY(0px);
    }
    50% {
      transform: translateZ(0) translateY(-10px);
    }
  }

  // Reduced motion support
  @media (prefers-reduced-motion: reduce) {
    .close-button,
    .primary-button,
    .secondary-button,
    .stat-item {
      transition: var(--transition-instant);
      animation: none;
      will-change: auto;

      &:hover {
        transform: translateZ(0);
      }
    }

    .feedback-correct,
    .feedback-incorrect,
    .correct-order-list div,
    .feedback-icon {
      animation: none;
    }

    .correct-order-list div:hover {
      transform: translateZ(0);
    }
  }

  // Desktop responsive improvements
  @media (min-width: 48em) {
    .feedback-correct,
    .feedback-incorrect {
      font-size: var(--text-3xl);
      padding: var(--space-xl);
    }

    .correct-order-container {
      max-width: var(--width-prose-md);
    }

    .correct-order-list div {
      padding: var(--space-lg);
    }

    .order-number {
      width: var(--space-3xl);
      height: var(--space-3xl);
      font-size: var(--text-base);
    }

    .song-info {
      font-size: var(--text-lg);
    }

    .game-stats {
      max-width: var(--width-prose-sm);
      grid-template-columns: repeat(4, 1fr);
    }

    .modal-content {
      max-height: calc(var(--height-screen) - var(--space-3xl));
    }
  }

  // Clean feedback stats display
  .feedback-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-lg);

    margin-top: var(--space-xl);
    padding: var(--space-xl);

    background: #374151; // Mittleres Grau
    border-radius: var(--radius-xl);
    border: 1px solid #4b5563;

    // Performance optimizations
    contain: layout style;

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);

      padding: var(--space-lg);
      border-radius: var(--radius-lg);
      background: #1f2937; // Dunkleres Grau
      border: 1px solid #4b5563;
    }

    .stat-label {
      font-size: var(--text-sm);
      color: #9ca3af; // Helles Grau
      font-weight: var(--font-medium);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: var(--text-2xl);
      color: #f9fafb; // Weiß
      font-weight: var(--font-bold);
    }

    // Responsive adjustments
    @media (max-width: 640px) {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
      padding: var(--space-lg);
    }
  }

  // Clean user order container
  .user-order-container {
    width: var(--width-full);
    max-width: var(--width-full);

    margin: var(--space-xl) 0 0;
    padding: var(--space-xl);

    background: #374151; // Mittleres Grau
    border: 2px solid #ef4444; // Roter Rand
    border-radius: var(--radius-xl);

    position: relative;
    overflow: hidden;

    // Ensure this doesn't interfere with scrolling
    flex-shrink: 0;

    // Performance optimizations
    contain: layout style;
    will-change: auto;

    &::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: #ef4444; // Einfacher roter Balken
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    }

    // Responsive adjustments
    @media (max-width: 640px) {
      padding: var(--space-lg);
      margin: var(--space-lg) 0 0;
    }
  }

  // Clean user order heading
  .user-order-heading {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);

    margin-bottom: var(--space-lg);

    color: #f9fafb; // Weiß

    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);

    text-align: center;
    text-wrap: balance;

    // Performance optimizations
    contain: layout style;

    &::before {
      content: "✖"; // X-Mark
      font-size: var(--text-2xl);
      color: #ef4444; // Rot
    }

    // Responsive adjustments
    @media (max-width: 640px) {
      font-size: var(--text-lg);
      gap: var(--space-sm);
    }
  }

  // User order list with enhanced styling
  .user-order-list {
    list-style: none;
    padding: 0;
    margin: 0;

    display: flex;
    flex-direction: column;
    gap: clamp(var(--space-xs), 2vw, var(--space-sm));

    // Performance optimizations
    contain: layout style;

    div {
      display: flex;
      align-items: center;
      gap: clamp(var(--space-md), 4vw, var(--space-lg));

      padding: clamp(var(--space-md), 4vw, var(--space-lg))
        clamp(var(--space-lg), 5vw, var(--space-xl));

      background: #1f2937; // Dunkles Grau
      border: 1px solid #4b5563;
      border-radius: var(--radius-lg);

      color: #f9fafb; // Weiß
      font-weight: var(--font-semibold);

      box-shadow: var(--shadow-md);

      position: relative;
      overflow: hidden;

      // Performance optimizations
      contain: layout style;
      will-change: transform, box-shadow;
      transform: translateZ(0) translateY(var(--space-lg));

      opacity: 0;

      transition: all var(--transition-normal);
      animation: slideUp 0.6s ease-out forwards;
      animation-delay: calc(0.15s * var(--item-index, 0));

      &::before {
        display: none;
      }

      &:hover {
        transform: translateZ(0) translateY(var(--animation-y-offset-md)) scale(1.02);
        box-shadow: var(--shadow-xl);

        &::before {
          display: none;
        }
      }

      &.correct {
        border-color: var(--border-success);
        background: var(--bg-success-aaa);
        box-shadow: var(--shadow-md);
      }

      &.incorrect {
        border-color: var(--border-error);
        background: var(--bg-error-aaa);
        box-shadow: var(--shadow-md);
      }

      // Responsive adjustments
      @media (max-width: 23.4375em) {
        padding: var(--space-md) var(--space-lg);
        gap: var(--space-md);
        flex-direction: column;
        text-align: center;
      }
    }

    .order-number {
      display: flex;
      align-items: center;
      justify-content: center;

      width: clamp(var(--space-2xl), 6vw, var(--space-3xl));
      height: clamp(var(--space-2xl), 6vw, var(--space-3xl));

      border-radius: var(--radius-full);

      font-weight: var(--font-bold);
      font-size: clamp(var(--text-base), 4vw, var(--text-lg));

      flex-shrink: 0;
      box-shadow: var(--shadow-lg);

      position: relative;
      overflow: hidden;

      // Performance optimizations
      contain: layout style;

      &::before {
        display: none;
      }

      &.correct {
        background: var(--color-success-primary);
        color: var(--color-white);
        box-shadow: var(--shadow-lg);
      }

      &.incorrect {
        background: var(--color-error-primary);
        color: var(--color-white);
        box-shadow: var(--shadow-lg);
      }

      // Responsive adjustments
      @media (max-width: 23.4375em) {
        width: var(--space-2xl);
        height: var(--space-2xl);
        font-size: var(--text-base);
      }
    }

    .song-info {
      flex: 1;

      font-size: clamp(var(--text-base), 4vw, var(--text-lg));
      line-height: var(--leading-relaxed);
      font-weight: var(--font-medium);

      text-wrap: balance;

      // Performance optimizations
      contain: layout style;

      // Responsive adjustments
      @media (max-width: 23.4375em) {
        font-size: var(--text-base);
      }
    }

    .status-icon {
      display: flex;
      align-items: center;
      justify-content: center;

      width: clamp(var(--space-lg), 4vw, var(--space-xl));
      height: clamp(var(--space-lg), 4vw, var(--space-xl));

      border-radius: var(--radius-full);

      font-weight: var(--font-bold);
      font-size: clamp(var(--text-base), 4vw, var(--text-lg));

      flex-shrink: 0;

      // Performance optimizations
      contain: layout style;
      will-change: transform;

      transition: all var(--transition-fast);

      &.correct {
        background: var(--bg-success-light);
        color: var(--text-success-dark);
      }

      &.incorrect {
        background: var(--bg-error-light);
        color: var(--text-error-dark);
      }

      // Responsive adjustments
      @media (max-width: 23.4375em) {
        width: var(--space-lg);
        height: var(--space-lg);
        font-size: var(--text-base);
      }
    }
  }

  // Dark mode support for user order
  @media (prefers-color-scheme: dark) {
    .user-order-list {
      div {
        &.correct {
          background: var(--bg-success-dark);
          border-color: var(--border-success-dark);
        }

        &.incorrect {
          background: var(--bg-error-dark);
          border-color: var(--border-error-dark);
        }
      }

      .status-icon {
        &.correct {
          background: var(--bg-success-dark);
          color: var(--text-success-dark);
        }

        &.incorrect {
          background: var(--bg-error-dark);
          color: var(--text-error-dark);
        }
      }
    }
  }

  // Order item styling with enhanced accessibility
  .order-item,
  .user-order-item {
    display: flex;
    align-items: center;
    gap: clamp(var(--space-sm), 3vw, var(--space-md));

    padding: clamp(var(--space-sm), 3vw, var(--space-md));

    background: var(--card-bg);
    border-radius: var(--radius-md);
    border: var(--border-width-thin) solid var(--border-secondary);

    // Performance optimizations
    contain: layout style;
    will-change: transform, box-shadow;
    transform: translateZ(0);

    transition: all var(--transition-normal);

    &:hover {
      transform: translateZ(0) translateY(var(--animation-y-offset-small));
      box-shadow: var(--shadow-md);
    }

    &.correct {
      border-color: var(--border-success);
      background: var(--bg-success-aaa);

      .order-position {
        background: var(--color-success-primary);
      }
    }

    &.incorrect {
      border-color: var(--border-neutral);
      background: var(--bg-neutral-aaa);

      .order-position {
        background: var(--color-neutral-primary);
      }
    }

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      flex-direction: column;
      text-align: center;
      gap: var(--space-sm);
    }
  }

  // Order position with responsive design
  .order-position {
    display: flex;
    align-items: center;
    justify-content: center;

    width: clamp(var(--space-xl), 5vw, var(--space-2xl));
    height: clamp(var(--space-xl), 5vw, var(--space-2xl));

    background: var(--interactive-primary);
    color: var(--color-white);

    border-radius: var(--radius-full);

    font-weight: var(--font-bold);
    font-size: clamp(var(--text-xs), 3vw, var(--text-sm));

    flex-shrink: 0;

    // Performance optimizations
    contain: layout style;

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      width: var(--space-xl);
      height: var(--space-xl);
      font-size: var(--text-xs);
    }
  }

  // Order content with responsive layout
  .order-content {
    flex: 1;

    font-size: clamp(var(--text-sm), 3vw, var(--text-base));
    color: var(--text-primary);

    display: flex;
    align-items: center;
    justify-content: space-between;

    // Performance optimizations
    contain: layout style;

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      justify-content: center;
      flex-direction: column;
      gap: var(--space-xs);
    }
  }

  // Check icon with semantic colors
  .check-icon {
    color: var(--color-success-primary);
    font-weight: var(--font-bold);
    margin-left: clamp(var(--space-xs), 2vw, var(--space-sm));

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      margin-left: 0;
      margin-top: var(--space-xs);
    }
  }

  // X icon with semantic colors
  .x-icon {
    color: var(--color-neutral-primary);
    font-weight: var(--font-bold);
    margin-left: clamp(var(--space-xs), 2vw, var(--space-sm));

    // Responsive adjustments
    @media (max-width: 23.4375em) {
      margin-left: 0;
      margin-top: var(--space-xs);
    }
  }

  // Touch device optimizations
  @media (hover: none) and (pointer: coarse) {
    .close-button {
      height: calc(var(--touch-target-enhanced) + var(--space-sm));
      width: calc(var(--touch-target-enhanced) + var(--space-sm));
    }

    .primary-button,
    .secondary-button {
      min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
      padding: var(--space-lg) var(--space-xl);
    }

    .order-item,
    .user-order-item {
      min-height: calc(var(--touch-target-enhanced) + var(--space-md));
      padding: var(--space-lg);
      gap: var(--space-lg);
    }

    .order-number {
      width: calc(var(--touch-target-enhanced) - var(--space-sm));
      height: calc(var(--touch-target-enhanced) - var(--space-sm));
      font-size: var(--text-lg);
    }

    .correct-order-list,
    .user-order-list {
      gap: var(--space-md);

      div {
        padding: var(--space-lg) var(--space-xl);
        min-height: calc(var(--touch-target-enhanced) + var(--space-md));
      }
    }

    .modal-title {
      font-size: var(--text-3xl);
      margin-bottom: var(--space-xl);
    }

    .feedback-icon {
      font-size: var(--text-4xl);
    }
  }

  // Mobile responsive adjustments
  @media (max-width: 47.9375em) {
    .feedback-stats {
      grid-template-columns: 1fr;

      .stat-item {
        flex-direction: row;
        justify-content: space-between;
      }
    }

    .order-item,
    .user-order-item {
      flex-direction: column;
      text-align: center;
      gap: var(--space-sm);

      .order-content {
        justify-content: center;
      }
    }
  }

  // High contrast mode support
  @media (prefers-contrast: high) {
    .chronology-feedback-overlay {
      background: var(--bg-overlay-high-contrast);
    }

    .modal-content {
      border-width: var(--border-width-enhanced);
    }

    .close-button {
      border-width: var(--border-width-enhanced);
    }

    .feedback-correct,
    .feedback-incorrect,
    .order-item,
    .user-order-item {
      border-width: var(--border-width-enhanced);
    }

    .primary-button,
    .secondary-button {
      border-width: var(--border-width-thick);

      &:focus-visible {
        outline-width: var(--focus-outline-thick);
        outline-offset: var(--focus-ring-offset-enhanced);
      }
    }

    .modal-title {
      color: var(--text-primary-high-contrast);
      font-weight: var(--font-black);
    }

    .stat-value {
      color: var(--text-primary-high-contrast);
      font-weight: var(--font-black);
    }
  }

  // Mobile-first responsive design
  @media (max-width: 640px) {
    .modal-content {
      margin: var(--space-sm);
      padding: var(--space-md);
      width: calc(100vw - var(--space-lg));
      max-width: none;
      max-height: calc(100vh - var(--space-lg));
    }

    .modal-content-text {
      padding: var(--space-sm);
      max-height: calc(100vh - 200px);
    }

    .modal-title {
      font-size: var(--text-lg);
      margin-bottom: var(--space-md);
    }

    .feedback-correct,
    .feedback-incorrect {
      font-size: var(--text-lg);
      padding: var(--space-md) var(--space-lg);
    }

    .correct-order-list,
    .user-order-list {
      gap: var(--space-xs);

      div {
        padding: var(--space-sm) var(--space-md);
        flex-direction: column;
        text-align: center;
      }
    }

    .order-number {
      width: var(--space-xl);
      height: var(--space-xl);
      font-size: var(--text-sm);
    }

    .game-stats {
      grid-template-columns: 1fr;
      gap: var(--space-xs);
      padding: var(--space-sm);
    }
  }

  // Desktop responsive design
  @media (min-width: 768px) {
    .modal-content {
      margin: var(--space-xl);
      padding: var(--space-2xl);
      max-width: min(80vw, 700px);
      max-height: calc(100vh - var(--space-2xl));
    }

    .modal-content-text {
      padding: var(--space-lg);
      max-height: calc(100vh - 250px);
    }

    .modal-title {
      font-size: var(--text-2xl);
      margin-bottom: var(--space-xl);
    }

    .feedback-correct,
    .feedback-incorrect {
      font-size: var(--text-2xl);
      padding: var(--space-xl) var(--space-2xl);
    }

    .correct-order-list,
    .user-order-list {
      gap: var(--space-md);

      div {
        padding: var(--space-lg) var(--space-xl);
      }
    }

    .order-number {
      width: var(--space-3xl);
      height: var(--space-3xl);
      font-size: var(--text-lg);
    }

    .game-stats {
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-lg);
      padding: var(--space-lg);
    }

    .button-container {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-lg);
    }
  }

  // Forced colors mode support
  @media (forced-colors: active) {
    .chronology-feedback-overlay {
      background: ButtonFace;
      forced-color-adjust: none;
    }

    .modal-content {
      background: ButtonFace;
      border: var(--border-width-thick) solid ButtonText;
      forced-color-adjust: none;
    }

    .close-button {
      background: ButtonFace;
      border: var(--border-width-thick) solid ButtonText;
      color: ButtonText;
      forced-color-adjust: none;
    }

    .primary-button {
      background: ButtonText;
      color: ButtonFace;
      border: var(--border-width-thick) solid ButtonText;
      forced-color-adjust: none;
    }

    .secondary-button {
      background: ButtonFace;
      color: ButtonText;
      border: var(--border-width-thick) solid ButtonText;
      forced-color-adjust: none;
    }

    .feedback-correct,
    .feedback-incorrect {
      background: ButtonFace;
      color: ButtonText;
      border: var(--border-width-thick) solid ButtonText;
      forced-color-adjust: none;
    }

    .order-number {
      background: ButtonText;
      color: ButtonFace;
      forced-color-adjust: none;
    }

    .modal-title,
    .feedback-text,
    .song-info,
    .stat-label,
    .stat-value {
      color: ButtonText;
      forced-color-adjust: none;
    }
  }

  // Print styles
  @media print {
    .chronology-feedback-overlay {
      background: var(--color-white);
      position: static;
      box-shadow: none;
    }

    .modal-content {
      background: var(--color-white);
      border: var(--border-width-thin) solid var(--color-black);
      box-shadow: none;
      break-inside: avoid;
      page-break-inside: avoid;
    }

    .close-button {
      display: none;
    }

    .feedback-correct,
    .feedback-incorrect {
      background: var(--color-white);
      border: var(--border-width-thin) solid var(--color-black);
      color: var(--color-black);
    }

    .primary-button,
    .secondary-button {
      display: none;
    }

    .modal-title,
    .feedback-text,
    .song-info,
    .stat-label,
    .stat-value {
      color: var(--color-black) !important;
    }
  }
</style>

<script>
  /**
   * ChronologyFeedbackOverlay Controller
   *
   * Manages feedback overlay interactions for chronology game mode.
   * Features comprehensive accessibility and performance optimizations.
   *
   * @features
   * - WCAG AAA compliant focus management
   * - Performance optimized animations
   * - Touch device support
   * - Container queries for responsive design
   * - Session timeout management
   * - Reduced motion support
   * - High contrast mode support
   * - Print styles optimization
   *
   * @accessibility Full keyboard navigation with focus trapping
   * @performance GPU acceleration with requestAnimationFrame
   * @responsive Container queries and fluid scaling
   */

  import { getGlobalSessionManager } from "@utils/auth/sessionTimeoutManager";

  // Type definitions following TypeScript best practices
  interface UserOrderItem {
    /** Position in user's ordering (1-based) */
    position: number;
    /** Artist name */
    artist: string;
    /** Album/song title */
    title: string;
    /** Release year */
    year: number;
    /** Whether this item is in the correct position */
    isCorrectPosition: boolean;
  }

  interface FeedbackEventDetail {
    /** Whether the user's chronology order was correct */
    isCorrect: boolean;
    /** Whether this is the final round of the game */
    isLastRound: boolean;
    /** Array of song titles in correct chronological order with years */
    correctOrder?: string[];
    /** User's ordering with position details */
    userOrder?: UserOrderItem[];
    /** Accuracy percentage (0-100) */
    accuracy?: number;
    /** Score gained this round */
    scoreGained?: number;
    /** Total accumulated score */
    totalScore?: number;
    /** Current round number */
    round?: number;
    /** Total number of rounds */
    totalRounds?: number;
    /** Game category */
    category?: string;
    /** Game difficulty */
    difficulty?: string;
  }

  interface TranslationMap {
    /** Translation key-value pairs for client-side usage */
    [key: string]: string;
  }

  // Get translations from the server-rendered data attribute
  let translations: TranslationMap = {};

  try {
    const overlay = document.getElementById("chronology-feedback-overlay");
    if (overlay) {
      const translationData = overlay.getAttribute("data-translations");

      if (translationData) {
        translations = JSON.parse(translationData);
      }
    }
  } catch (error) {
    console.warn("Failed to parse translations from data attributes:", error);
  }

  /**
   * Translation helper with caching for performance
   *
   * @param {string} key - Translation key
   * @returns {string} Translated string or key as fallback
   */
  const getTranslation = (key: string): string => translations[key] || key;

  // State management with performance optimizations
  const state = {
    previouslyFocused: null as Element | null,
    animation: {
      frameId: null as number | null,
      timeoutId: null as number | null,
    },
    // Performance tracking
    isAnimating: false,
    prefersReducedMotion: false,
    // Cached DOM measurements
    cachedViewport: { width: 0, height: 0 },
    // Throttled resize handler
    resizeTimeout: null as number | null,
  };

  /**
   * Initializes feedback overlay with performance optimizations
   *
   * @returns {(() => void) | undefined} Cleanup function or undefined if failed
   * @accessibility WCAG AAA compliant focus management
   * @performance Optimized event delegation with memory leak prevention
   */
  function initFeedbackOverlay(): (() => void) | undefined {
    // Initialize performance state
    state.prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    state.cachedViewport = {
      width: window.innerWidth,
      height: window.innerHeight,
    };

    // Get DOM elements with null checks and proper typing
    const overlay = document.getElementById("chronology-feedback-overlay") as HTMLElement | null;
    const closeButton = document.getElementById(
      "close-feedback-overlay"
    ) as HTMLButtonElement | null;
    const backdrop = document.getElementById("overlay-backdrop") as HTMLElement | null;
    const continueButton = document.getElementById(
      "chronology-continue-button"
    ) as HTMLButtonElement | null;
    const endButton = document.getElementById("chronology-end-button") as HTMLButtonElement | null;
    const statusAnnouncer = document.getElementById("feedback-status") as HTMLElement | null;
    const contentText = document.getElementById("feedback-content") as HTMLElement | null;

    // Early exit if required elements are not found
    if (!overlay || !closeButton || !backdrop || !continueButton || !endButton || !contentText) {
      console.warn("Chronology feedback overlay elements not found");
      return;
    }

    // Now TypeScript knows these elements are non-null within this scope
    const elements = {
      overlay,
      closeButton,
      backdrop,
      continueButton,
      endButton,
      statusAnnouncer,
      contentText,
    };

    // Initialize session timeout manager with custom callbacks
    const sessionManager = getGlobalSessionManager(
      {
        warningTime: 120, // 2 minutes warning (WCAG AAA requirement)
        totalTime: 1200, // 20 minutes total session time
        enabled: typeof window !== "undefined" && window.location.hostname !== "localhost",
      },
      {
        onWarning: (remainingSeconds: number) => {
          const warningMessage = getTranslation("session.timeout.warning").replace(
            "{0}",
            remainingSeconds.toString()
          );

          // Also announce through the feedback status if modal is open
          if (elements.statusAnnouncer && !elements.overlay.classList.contains("hidden")) {
            elements.statusAnnouncer.textContent = warningMessage;
          }
        },
        onExtend: (): void => {
          // Session extended successfully - informational only
        },
        onTimeout: (): void => {
          console.warn("User session timed out - redirecting to login");
          // Could redirect to login page or show timeout modal here
        },
      }
    );

    /**
     * Shows overlay with optimized animations
     * @accessibility Stores focus, prevents background scroll, respects reduced motion
     * @performance Uses requestAnimationFrame with GPU acceleration
     */
    const showOverlay = (): void => {
      // Prevent concurrent animations
      if (state.isAnimating) {
        return;
      }
      state.isAnimating = true;

      // Store current focus for restoration
      state.previouslyFocused = document.activeElement;

      // Show overlay immediately
      elements.overlay.classList.remove("hidden");
      elements.overlay.setAttribute("aria-hidden", "false");

      // Reset modal content scroll position to top for better UX
      elements.contentText.scrollTop = 0;

      // Prevent background scrolling without affecting modal scrolling
      const scrollY = window.scrollY;
      document.body.style.position = "fixed";
      document.body.style.top = `-${scrollY}px`;
      document.body.style.left = "0";
      document.body.style.right = "0";
      document.body.style.width = "100%";
      // Store scroll position for restoration
      document.body.setAttribute("data-scroll-y", scrollY.toString());

      if (state.prefersReducedMotion) {
        // No animation for reduced motion users
        elements.overlay.style.opacity = "1";
        elements.overlay.style.transform = "none";
        state.isAnimating = false;
        focusFirstElement();
      } else {
        // Performance-optimized entrance animation
        elements.overlay.style.opacity = "0";
        elements.overlay.style.transform = "translateY(-20px) scale(0.95)";

        state.animation.frameId = requestAnimationFrame(() => {
          elements.overlay.style.transition = "opacity 0.2s ease-out, transform 0.2s ease-out";
          elements.overlay.style.opacity = "1";
          elements.overlay.style.transform = "translateY(0) scale(1)";

          // Focus management after animation
          state.animation.timeoutId = window.setTimeout(() => {
            state.isAnimating = false;
            focusFirstElement();
          }, 200);
        });
      }
    };

    /**
     * Hides overlay with cleanup and focus restoration
     * @accessibility Restores focus, re-enables scrolling, sets ARIA attributes
     * @performance Cleans up animations, prevents memory leaks
     */
    const hideOverlay = (): void => {
      // Prevent concurrent animations
      if (state.isAnimating) {
        return;
      }
      state.isAnimating = true;

      // Clear any pending animations
      if (state.animation.frameId) {
        cancelAnimationFrame(state.animation.frameId);
        state.animation.frameId = null;
      }
      if (state.animation.timeoutId) {
        clearTimeout(state.animation.timeoutId);
        state.animation.timeoutId = null;
      }

      elements.overlay.setAttribute("aria-hidden", "true");

      if (state.prefersReducedMotion) {
        // Immediate hiding for reduced motion users
        elements.overlay.classList.add("hidden");
        elements.overlay.style.opacity = "";
        elements.overlay.style.transform = "";
        elements.overlay.style.transition = "";
        state.isAnimating = false;
        restoreFocusAndCleanup();
      } else {
        // Animate exit
        elements.overlay.style.opacity = "0";
        elements.overlay.style.transform = "translateY(-20px) scale(0.95)";

        state.animation.timeoutId = window.setTimeout(() => {
          elements.overlay.classList.add("hidden");
          elements.overlay.style.opacity = "";
          elements.overlay.style.transform = "";
          elements.overlay.style.transition = "";
          state.isAnimating = false;
          restoreFocusAndCleanup();
        }, 200);
      }
    };

    /**
     * Focuses first interactive element with delay
     * @accessibility Ensures logical keyboard navigation start
     * @wcag WCAG AAA compliant focus management
     */
    const focusFirstElement = (): void => {
      // Clear any existing timeout
      if (state.animation.timeoutId) {
        clearTimeout(state.animation.timeoutId);
      }

      state.animation.timeoutId = window.setTimeout(() => {
        elements.closeButton.focus();
      }, 50);
    };

    /**
     * Restores focus and cleanup after modal closes
     * @accessibility Restores focus, re-enables scrolling, handles missing elements
     * @performance Defensive programming with error handling
     */
    const restoreFocusAndCleanup = (): void => {
      // Re-enable scrolling and restore scroll position
      const scrollY = document.body.getAttribute("data-scroll-y");
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.left = "";
      document.body.style.right = "";
      document.body.style.width = "";
      document.body.removeAttribute("data-scroll-y");

      // Restore scroll position
      if (scrollY) {
        window.scrollTo(0, parseInt(scrollY, 10));
      }

      // Restore focus to previously focused element
      if (
        state.previouslyFocused &&
        "focus" in state.previouslyFocused &&
        typeof state.previouslyFocused.focus === "function"
      ) {
        state.animation.timeoutId = window.setTimeout(() => {
          try {
            (state.previouslyFocused as HTMLElement).focus();
          } catch {
            // Focus restoration failed silently - not critical for user experience
          }
          state.previouslyFocused = null;
        }, 50);
      }
    };

    /**
     * Updates feedback content based on game result
     * @param {FeedbackEventDetail} detail - Complete feedback data
     * @accessibility Creates semantic HTML with proper roles and live regions
     * @performance Efficient DOM manipulation with minimal reflows
     */
    function updateFeedbackContent(detail: FeedbackEventDetail): void {
      const feedbackContent = document.getElementById("feedback-content");
      if (!feedbackContent) {
        console.error("ChronologyFeedback: feedback-content element not found");
        return;
      }

      // Clear previous content efficiently
      feedbackContent.innerHTML = "";

      const {
        isCorrect,
        correctOrder,
        userOrder,
        accuracy,
        scoreGained,
        totalScore,
        round,
        totalRounds,
      } = detail;

      // Create main feedback message with enhanced styling
      const messageEl = document.createElement("div");
      messageEl.className = "feedback-message";
      messageEl.setAttribute("role", "status");
      messageEl.setAttribute("aria-live", "polite");

      // Main result message
      const resultEl = document.createElement("h3");
      resultEl.className = isCorrect ? "feedback-correct" : "feedback-incorrect";

      if (isCorrect) {
        resultEl.textContent = getTranslation("game.chronology.correct");
        resultEl.innerHTML = `
          <span class="feedback-icon">🎉</span>
          ${getTranslation("game.chronology.correct")}
        `;
      } else {
        resultEl.innerHTML = `
          <span class="feedback-icon">😔</span>
          ${getTranslation("game.chronology.incorrect")}
        `;
      }

      messageEl.appendChild(resultEl);

      // Add score and statistics section
      if (typeof scoreGained === "number" || typeof accuracy === "number") {
        const statsEl = document.createElement("div");
        statsEl.className = "feedback-stats";

        let statsHTML = "";
        if (typeof accuracy === "number") {
          statsHTML += `<div class="stat-item">
            <span class="stat-label">${getTranslation("game.chronology.stats.accuracy")}</span>
            <span class="stat-value">${accuracy}%</span>
          </div>`;
        }

        if (typeof scoreGained === "number") {
          statsHTML += `<div class="stat-item">
            <span class="stat-label">${getTranslation("game.chronology.stats.round_points")}</span>
            <span class="stat-value">+${scoreGained}</span>
          </div>`;
        }

        if (typeof totalScore === "number") {
          statsHTML += `<div class="stat-item">
            <span class="stat-label">${getTranslation("game.chronology.stats.total_points")}</span>
            <span class="stat-value">${totalScore}</span>
          </div>`;
        }

        if (typeof round === "number" && typeof totalRounds === "number") {
          statsHTML += `<div class="stat-item">
            <span class="stat-label">${getTranslation("game.chronology.stats.round")}</span>
            <span class="stat-value">${round}/${totalRounds}</span>
          </div>`;
        }

        statsEl.innerHTML = statsHTML;
        messageEl.appendChild(statsEl);
      }

      feedbackContent.appendChild(messageEl);

      // Add correct order information with years
      if (correctOrder && Array.isArray(correctOrder) && correctOrder.length > 0) {
        const orderSection = document.createElement("div");
        orderSection.className = "correct-order-container";

        const orderHeading = document.createElement("h4");
        orderHeading.className = "correct-order-heading";
        orderHeading.textContent = getTranslation("game.chronology.correct_order");
        orderSection.appendChild(orderHeading);

        // Create accessible container with enhanced styling
        const orderList = document.createElement("div");
        orderList.className = "correct-order-list";
        orderList.setAttribute("role", "list");
        orderList.setAttribute("aria-label", getTranslation("game.chronology.correct_order"));

        correctOrder.forEach((item, index) => {
          const listItem = document.createElement("div");
          listItem.setAttribute("role", "listitem");
          // Keine zusätzliche Klasse notwendig, CSS wird über .correct-order-list div angewendet
          listItem.innerHTML = `
            <span class="order-number">${index + 1}</span>
            <span class="song-info">${item}</span>
          `;
          listItem.setAttribute("aria-setsize", correctOrder.length.toString());
          listItem.setAttribute("aria-posinset", (index + 1).toString());
          orderList.appendChild(listItem);
        });

        orderSection.appendChild(orderList);
        feedbackContent.appendChild(orderSection);
      }

      // Show user's ordering with corrections - always show if userOrder exists
      if (userOrder && Array.isArray(userOrder) && userOrder.length > 0) {
        const userOrderSection = document.createElement("div");
        userOrderSection.className = "user-order-container";

        const userHeading = document.createElement("h4");
        userHeading.className = "user-order-heading";
        userHeading.textContent = isCorrect
          ? getTranslation("game.chronology.user_order.correct_title")
          : getTranslation("game.chronology.user_order.incorrect_title");
        userOrderSection.appendChild(userHeading);

        const userOrderList = document.createElement("div");
        userOrderList.className = "user-order-list";
        userOrderList.setAttribute("role", "list");

        userOrder.forEach((item, index) => {
          const listItem = document.createElement("div");
          listItem.setAttribute("role", "listitem");
          listItem.className = item.isCorrectPosition ? "correct" : "incorrect";
          listItem.innerHTML = `
            <span class="order-number ${item.isCorrectPosition ? "correct" : "incorrect"}">${item.position}</span>
            <span class="song-info">
              ${item.artist} - ${item.title} (${item.year})
            </span>
            <span class="status-icon ${item.isCorrectPosition ? "correct" : "incorrect"}">
              ${item.isCorrectPosition ? "✓" : "✗"}
            </span>
          `;
          // Add staggered animation delay for visual appeal
          listItem.style.setProperty("--item-index", index.toString());
          userOrderList.appendChild(listItem);
        });

        userOrderSection.appendChild(userOrderList);
        feedbackContent.appendChild(userOrderSection);
      }
    }

    /**
     * Gets focusable elements for keyboard navigation
     * @param {Element} container - Container to search within
     * @returns {HTMLElement[]} Array of focusable elements
     * @accessibility Identifies keyboard-navigable elements, filters hidden/disabled
     * @performance Efficient querySelector and filtering
     */
    function getFocusableElements(container: Element): HTMLElement[] {
      const selector = [
        "button:not([disabled])",
        "[href]:not([disabled])",
        "input:not([disabled])",
        "select:not([disabled])",
        "textarea:not([disabled])",
        '[tabindex]:not([tabindex="-1"])',
      ].join(", ");

      return Array.from(container.querySelectorAll(selector)).filter((el): el is HTMLElement => {
        if (!(el instanceof HTMLElement)) {
          return false;
        }

        // Check visibility and accessibility
        const style = window.getComputedStyle(el);
        const rect = el.getBoundingClientRect();

        return (
          style.display !== "none" &&
          style.visibility !== "hidden" &&
          style.opacity !== "0" &&
          rect.width > 0 &&
          rect.height > 0 &&
          el.getAttribute("aria-hidden") !== "true"
        );
      });
    }

    /**
     * Sets up focus trap for keyboard navigation
     * @param {Element} element - Modal container for focus trapping
     * @accessibility Implements Tab cycling, supports forward/backward navigation
     * @wcag Meets WCAG AAA focus management requirements
     */
    function setupFocusTrap(element: Element): void {
      element.addEventListener("keydown", (e: Event) => {
        const keyboardEvent = e as KeyboardEvent;

        // Only trap focus when modal is visible
        if (
          elements.overlay.classList.contains("hidden") ||
          elements.overlay.getAttribute("aria-hidden") === "true"
        ) {
          return;
        }

        if (keyboardEvent.key !== "Tab") {
          return;
        }

        const focusableElements = getFocusableElements(element);
        if (focusableElements.length === 0) {
          return;
        }

        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (keyboardEvent.shiftKey && document.activeElement === firstElement) {
          keyboardEvent.preventDefault();
          lastElement.focus();
        } else if (!keyboardEvent.shiftKey && document.activeElement === lastElement) {
          keyboardEvent.preventDefault();
          firstElement.focus();
        }
      });
    }

    /**
     * Handles keyboard navigation (Escape key closes modal)
     * @param {KeyboardEvent} e - Keyboard event object
     * @accessibility Provides keyboard escape mechanism (WCAG AAA required)
     * @performance Efficient event delegation pattern
     */
    function handleKeydown(e: KeyboardEvent): void {
      if (e.key === "Escape" && !elements.overlay.classList.contains("hidden")) {
        e.preventDefault();
        hideOverlay();
      }
    }

    /**
     * Shows feedback overlay with game results
     * @param {CustomEvent} e - Custom event with feedback details
     * @accessibility Shows overlay with focus management, updates screen readers
     * @performance Efficient batch DOM updates with cached elements
     * @wcag Meets WCAG AAA feedback and navigation requirements
     */
    function handleShowFeedback(e: CustomEvent): void {
      const detail = e.detail as FeedbackEventDetail;

      showOverlay();
      updateFeedbackContent(detail);

      // Manage button visibility with proper accessibility
      if (detail.isLastRound) {
        elements.endButton.classList.remove("hidden");
        elements.endButton.removeAttribute("aria-hidden");
      } else {
        elements.endButton.classList.add("hidden");
        elements.endButton.setAttribute("aria-hidden", "true");
      }

      // Screen reader announcement for immediate feedback
      if (elements.statusAnnouncer) {
        elements.statusAnnouncer.textContent = detail.isCorrect
          ? getTranslation("game.chronology.correct")
          : getTranslation("game.chronology.incorrect");
      }
    }

    /**
     * Handles continue button click
     * @accessibility Hides overlay with focus restoration, maintains keyboard flow
     * @performance Efficient event dispatching
     * @wcag Meets WCAG AAA user control requirements
     */
    function handleContinue(): void {
      hideOverlay();
      window.dispatchEvent(new CustomEvent("chronologyContinue"));
    }

    /**
     * Handles end game button click
     * @accessibility Hides overlay with focus restoration, maintains keyboard flow
     * @performance Efficient event dispatching
     * @wcag Meets WCAG AAA user control requirements
     */
    function handleEnd(): void {
      hideOverlay();
      window.dispatchEvent(new CustomEvent("chronologyEnd"));
    }

    /**
     * Throttled resize handler for performance optimization
     */
    const handleResize = (): void => {
      if (state.resizeTimeout) {
        clearTimeout(state.resizeTimeout);
      }

      state.resizeTimeout = window.setTimeout(() => {
        state.cachedViewport = {
          width: window.innerWidth,
          height: window.innerHeight,
        };

        // Update reduced motion preference
        state.prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      }, 100);
    };

    /**
     * Sets up all event listeners for the overlay
     * @accessibility Configures keyboard navigation, focus trap, modal controls
     * @performance Efficient event delegation with cached element references
     * @features Modal controls, keyboard navigation, session management
     * @wcag Meets WCAG AAA keyboard navigation and user control requirements
     */
    function setupEventListeners(): void {
      // Modal control events with semantic action handlers
      elements.closeButton.addEventListener("click", hideOverlay);
      elements.backdrop.addEventListener("click", hideOverlay);
      elements.continueButton.addEventListener("click", handleContinue);
      elements.endButton.addEventListener("click", handleEnd);

      // Global keyboard navigation events
      document.addEventListener("keydown", handleKeydown);
      window.addEventListener("showChronologyFeedback", handleShowFeedback as EventListener);

      // Performance optimization events
      window.addEventListener("resize", handleResize, { passive: true });

      // Focus trap setup for accessibility compliance
      setupFocusTrap(elements.overlay);

      // Make session manager extend function available globally for future UI implementations
      (window as typeof window & { extendChronologySession: () => void }).extendChronologySession =
        (): void => {
          sessionManager.extend();
        };
    }

    /**
     * Cleanup function to remove listeners and clear timeouts
     * @accessibility Removes accessibility listeners, clears focus state
     * @performance Cancels animations, stops session monitoring, prevents memory leaks
     * @usage Called on page unload or component destruction
     * @wcag Ensures proper cleanup for assistive technology compatibility
     */
    const cleanup = (): void => {
      // Clear any pending animations or timeouts to prevent memory leaks
      if (state.animation.frameId) {
        cancelAnimationFrame(state.animation.frameId);
        state.animation.frameId = null;
      }
      if (state.animation.timeoutId) {
        clearTimeout(state.animation.timeoutId);
        state.animation.timeoutId = null;
      }
      if (state.resizeTimeout) {
        clearTimeout(state.resizeTimeout);
        state.resizeTimeout = null;
      }

      // Stop session timeout monitoring and free resources
      sessionManager.cleanup();

      // Remove event listeners - all elements are guaranteed to exist in this scope
      elements.closeButton.removeEventListener("click", hideOverlay);
      elements.backdrop.removeEventListener("click", hideOverlay);
      elements.continueButton.removeEventListener("click", handleContinue);
      elements.endButton.removeEventListener("click", handleEnd);
      document.removeEventListener("keydown", handleKeydown);
      window.removeEventListener("showChronologyFeedback", handleShowFeedback as EventListener);
      window.removeEventListener("resize", handleResize);

      // Reset component state for potential reuse
      state.previouslyFocused = null;
      state.isAnimating = false;
    };

    // Initialize event listeners and component state
    setupEventListeners();

    // Start session timeout monitoring for WCAG AAA compliance
    sessionManager.start();

    // Cleanup on page unload to prevent memory leaks and maintain performance
    window.addEventListener("beforeunload", cleanup);
    window.addEventListener("pagehide", cleanup);

    // Return cleanup function for manual cleanup if needed
    return cleanup;
  }

  /**
   * Initialize overlay when DOM is ready
   * @performance Efficient DOM ready detection
   * @accessibility Sets up accessibility features before user interaction
   */
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initFeedbackOverlay);
  } else {
    initFeedbackOverlay();
  }
</script>

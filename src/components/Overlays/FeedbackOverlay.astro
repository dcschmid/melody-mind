---
import { Icon } from "astro-icon/components";
---

<div
  id="overlay"
  class="overlay hidden"
  role="dialog"
  aria-labelledby="overlay-title"
  aria-modal="true"
  aria-live="polite"
>
  <div class="overlayContent" role="document" tabindex="0">
    <h2 id="overlay-title" class="title">Auflösung</h2>
    <p id="feedback" class="feedback" role="status" aria-live="assertive"></p>

    <!-- Dynamische Anzeige: Cover oder Audio Player -->
    <div class="mediaSection" aria-label="Medien-Bereich">
      <img
        id="overlay-cover"
        class="albumCover"
        src=""
        alt=""
        loading="eager"
      />
      <audio
        id="audio-preview"
        class="audioPlayer"
        controls
        preload="metadata"
        aria-label="Musik-Vorschau"
      >
        <source id="audio-preview-source" src="" type="audio/mpeg" />
        <p>Dein Browser unterstützt keine Audio-Wiedergabe.</p>
      </audio>
    </div>

    <div class="musicLinks" role="group" aria-label="Musik-Streaming Links">
      <a
        id="spotify-link"
        class="musicButton"
        href="#"
        target="_blank"
        rel="noopener noreferrer"
        aria-label="Auf Spotify anhören"
      >
        <Icon name="spotify" width={36} height={36} />
        <span class="sr-only">Spotify</span>
      </a>
      <a
        id="deezer-link"
        class="musicButton"
        href="#"
        target="_blank"
        rel="noopener noreferrer"
        aria-label="Auf Deezer anhören"
      >
        <Icon name="deezer" width={36} height={36} />
        <span class="sr-only">Deezer</span>
      </a>
      <a
        id="apple-link"
        class="musicButton"
        href="#"
        target="_blank"
        rel="noopener noreferrer"
        aria-label="Auf Apple Music anhören"
      >
        <Icon name="apple-music" width={36} height={36} />
        <span class="sr-only">Apple Music</span>
      </a>
    </div>

    <div class="infoSection" role="contentinfo">
      <p id="overlay-artist" class="artist"></p>
      <p id="overlay-album" class="album"></p>
      <p id="overlay-year" class="year"></p>
      <p id="overlay-funfact" class="funFact"></p>
    </div>

    <div class="buttonWrapper">
      <button
        id="next-round-button"
        class="nextButton"
        aria-label="Zur nächsten Runde"
      >
        Nächste Runde
      </button>
    </div>
  </div>
</div>

<style lang="scss">
  .overlay {
    position: fixed;
    z-index: var(--layer-above);
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--padding-large);
    background: rgb(0 0 0 / 90%);
    backdrop-filter: blur(12px);

    &.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    @media (prefers-reduced-motion: no-preference) {
      transition: opacity var(--transition-speed) ease-in-out;
    }
  }

  .overlayContent {
    width: 100%;
    max-width: min(768px, 90vw);
    max-height: 90vh;
    padding: var(--padding-large);
    overflow-y: auto;
    background-color: var(--secondary-color);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    color: var(--text-color);

    &:focus {
      outline: var(--focus-outline-width) solid var(--focus-outline-color);
      outline-offset: var(--focus-outline-offset);
    }

    @media (max-width: 768px) {
      padding: var(--padding-medium);
    }
  }

  .title {
    font-size: var(--header-font-size);
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: var(--padding-medium);
    text-align: center;
  }

  .feedback {
    margin: var(--padding-medium) 0;
    padding: var(--padding-medium);
    border-radius: var(--border-radius);
    font-size: var(--body-font-size);
    font-weight: 600;
    text-align: center;

    &.correct {
      background-color: var(--highlight-color);
      color: var(--button-text-color);
    }

    &.incorrect {
      background-color: var(--error-color);
      color: var(--button-text-color);
    }
  }

  .mediaSection {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--padding-medium);
    margin-bottom: var(--padding-medium);
  }

  .albumCover {
    width: 100%;
    max-width: 250px;
    height: auto;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
  }

  .audioPlayer {
    width: 100%;
    max-width: 250px;
    margin-top: var(--padding-small);

    &:focus-within {
      outline: var(--focus-outline-width) solid var(--focus-outline-color);
      outline-offset: var(--focus-outline-offset);
    }
  }

  .musicLinks {
    display: flex;
    justify-content: center;
    gap: var(--padding-medium);
    margin: var(--padding-medium) 0;

    @media (max-width: 480px) {
      flex-wrap: wrap;
    }
  }

  .musicButton {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--padding-small);
    background-color: var(--highlight-color);
    border-radius: var(--border-radius);
    color: var(--button-text-color);
    min-width: var(--min-touch-target);
    min-height: var(--min-touch-target);

    &:hover {
      background-color: var(--button-hover-color);
    }

    &:focus-visible {
      outline: var(--focus-outline-width) solid var(--focus-outline-color);
      outline-offset: var(--focus-outline-offset);
    }
  }

  .infoSection {
    text-align: center;
    margin: var(--padding-medium) 0;
  }

  .artist {
    font-size: calc(var(--body-font-size) * 1.2);
    font-weight: 700;
    color: var(--highlight-color);
  }

  .album,
  .year,
  .funFact {
    margin-top: var(--padding-small);
    line-height: var(--line-height-body);
  }

  .nextButton {
    padding: var(--padding-medium) var(--padding-large);
    font-size: var(--button-font-size);
    font-weight: 600;
    color: var(--button-text-color);
    background-color: var(--highlight-color);
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    min-width: var(--min-touch-target);
    min-height: var(--min-touch-target);

    &:hover {
      background-color: var(--button-hover-color);
    }

    &:focus-visible {
      outline: var(--focus-outline-width) solid var(--focus-outline-color);
      outline-offset: var(--focus-outline-offset);
    }
  }

  .buttonWrapper {
    display: flex;
    justify-content: center;
    gap: var(--padding-medium);
    margin-top: var(--padding-medium);
  }

  // High Contrast Mode Support
  @media (forced-colors: active) {
    .overlayContent {
      border: 2px solid CanvasText;
    }

    .musicButton,
    .nextButton {
      border: 2px solid ButtonText;
    }
  }
</style>

<script>
  const overlay = document.getElementById("overlay") as HTMLElement;
  const observer = new MutationObserver(() => {
    if (!overlay.classList.contains("hidden")) {
      overlay.querySelector(".overlay-content")?.scrollTo({ top: 0 });
    }
  });

  observer.observe(overlay, { attributes: true, attributeFilter: ["class"] });

  const focusableElements =
    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';

  document.addEventListener("keydown", (event) => {
    const overlay = document.getElementById("overlay");
    if (!overlay?.classList.contains("hidden")) {
      const content = overlay!.querySelector(".overlayContent");

      switch (event.key) {
        case "Escape":
          document.getElementById("next-round-button")?.click();
          break;
        case "Tab":
          const focusable = content?.querySelectorAll(focusableElements);
          if (
            focusable &&
            event.shiftKey &&
            document.activeElement === focusable[0]
          ) {
            event.preventDefault();
            (focusable[focusable.length - 1] as HTMLElement).focus();
          }
          break;
      }
    }
  });
</script>

---
/**
 * @component FeedbackOverlay
 * @description A modal overlay that displays feedback after each game round, showing
 * album information, media preview, and streaming links. This component is optimized for
 * WCAG AAA accessibility standards and high performance.
 *
 * @props This component does not accept props - it's controlled via JavaScript
 * and populated dynamically by the game engine (gameEngine.ts).
 *
 * @usage
 * ```astro
 * <FeedbackOverlay />
 * ```
 *
 * @features
 * - Keyboard navigation with focus trap (Tab, Shift+Tab, Arrow keys)
 * - Screen reader announcements with live regions
 * - High contrast mode support (forced-colors media query)
 * - Optimized animations with reduced motion support
 * - Performance-optimized interactions (CSS containment, content-visibility)
 * - Uses CSS variables from global.css for WCAG AAA 2.2 compliance
 * - Responsive design with mobile-first approach
 * - Touch-friendly interface with 44px minimum touch targets
 *
 * @accessibility
 * - WCAG 2.2 AAA compliant (7:1 contrast ratios)
 * - Focus management with proper focus trap
 * - Screen reader compatible with ARIA labels and live regions
 * - Keyboard navigation support (Escape, Enter, Space, Tab, Arrow keys)
 * - Enhanced text spacing support for accessibility
 * - Reduced motion preferences respected
 *
 * @performance
 * - CSS containment for layout isolation
 * - Content-visibility for rendering optimization
 * - Will-change properties for animation performance
 * - Modern ES6+ JavaScript with efficient event handling
 * - Optimized scrolling with overscroll-behavior
 *
 * @responsive
 * - Mobile-first design with breakpoints at 48em, 64em
 * - Adaptive layout for different screen sizes
 * - Touch-optimized button sizing on mobile
 * - Responsive typography scaling
 *
 * @integration
 * - Controlled by gameEngine.ts for dynamic content population
 * - Uses i18n system for multilingual support
 * - Connects to streaming services (Spotify, Deezer, Apple Music)
 */
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import { Icon } from "astro-icon/components";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<div
  id="overlay"
  class="overlay hidden"
  role="dialog"
  aria-labelledby="overlay-title"
  aria-describedby="feedback"
  aria-modal="true"
  tabindex="-1"
>
  <!-- Overlay backdrop for click-to-close functionality -->
  <div id="overlay-backdrop" class="overlay__backdrop" aria-hidden="true"></div>

  <div class="overlay__content" role="document" tabindex="-1">
    <div class="overlay__header">
      <h2 id="overlay-title" class="overlay__title">
        {t("game.feedback.resolution")}
      </h2>

      <!-- Close button for enhanced accessibility -->
      <button
        id="close-overlay-button"
        class="overlay__close-button"
        aria-label={t("general.close")}
      >
        <Icon name="close" width={24} height={24} aria-hidden="true" />
      </button>
    </div>

    <!-- Status announcer for screen readers -->
    <div id="feedback-status-announcer" aria-live="assertive" aria-atomic="true" class="sr-only">
    </div>

    <!-- Keyboard shortcuts documentation for screen readers -->
    <div class="sr-only" id="keyboard-shortcuts">
      <h4>{t("general.keyboard.shortcuts")}</h4>
      <ul>
        <li>{t("general.keyboard.escape")}: {t("general.close")}</li>
        <li>{t("general.keyboard.enter")}: {t("game.feedback.next.round")}</li>
        <li>{t("general.keyboard.tab")}: {t("general.navigate.elements")}</li>
      </ul>
    </div>

    <p id="feedback" class="feedback" role="status"></p>

    <div class="album-info" aria-label={t("game.feedback.media.section")}>
      <div class="album-info__content" role="contentinfo">
        <div class="album-info__header">
          <h3 id="overlay-artist" class="artist-name"></h3>
          <h4 id="overlay-album" class="album-name"></h4>
          <p id="overlay-year" class="album-year"></p>
        </div>
        <div class="album-info__details">
          <p id="overlay-funfact" class="fun-fact"></p>
        </div>
      </div>
    </div>

    <button id="next-round-button" class="next-button" aria-label={t("game.feedback.next.round")}>
      <span class="next-button__content">
        {t("game.feedback.next.round")}
        <Icon name="arrow-right" width={20} height={20} aria-hidden="true" />
      </span>
    </button>
  </div>
</div>

<style lang="scss">
  // ======================================
  // OVERLAY BASE STYLES - Using Global CSS Variables
  // ======================================

  .overlay {
    position: fixed;
    top: var(--space-none);
    left: var(--space-none);
    width: var(--width-full);
    height: var(--width-full);
    z-index: var(--z-modal);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-md);
    background-color: var(--backdrop-overlay-dark);
    backdrop-filter: blur(var(--backdrop-blur));
    -webkit-backdrop-filter: blur(var(--backdrop-blur));
    transition:
      opacity var(--transition-normal),
      visibility var(--transition-normal);

    // Performance optimizations
    contain: layout style;
    will-change: opacity, visibility;

    &.hidden {
      pointer-events: none;
      visibility: hidden;
      opacity: var(--animation-opacity-end);
    }

    // Mobile-first responsive design using hardcoded breakpoints
    @media (max-width: 47.9375em) {
      padding: var(--space-sm);
    }
  }

  .overlay__backdrop {
    position: absolute;
    top: var(--space-none);
    left: var(--space-none);
    width: var(--width-full);
    height: var(--width-full);
    z-index: var(--z-backdrop);
    pointer-events: auto;
    background-color: var(--backdrop-overlay-dark);

    // Performance optimization
    contain: strict;
  }

  // ======================================
  // OVERLAY CONTENT - Using Root Variables
  // ======================================

  .overlay__content {
    position: relative;
    z-index: var(--z-modal-content);
    max-height: calc(100vh - var(--space-lg) * 2);
    width: var(--width-full);
    max-width: min(90vw, var(--container-lg));
    overflow-y: auto;
    overscroll-behavior: contain;
    border-radius: var(--radius-xl);
    border: var(--border-width-thin) solid var(--border-primary);
    background-color: var(--card-bg);
    padding: var(--space-xl);
    box-shadow: var(--card-shadow);
    scrollbar-gutter: stable;
    pointer-events: auto;

    // Performance optimizations
    contain: layout style paint;
    content-visibility: auto;
    contain-intrinsic-size: var(--container-intrinsic-height-modal);

    // Mobile responsive adjustments using hardcoded breakpoints
    @media (max-width: 47.9375em) {
      padding: var(--space-lg);
      border-radius: var(--radius-lg);
      max-height: calc(100vh - var(--space-md) * 2);
      max-width: min(95vw, var(--container-sm));
    }

    @media (min-width: 48em) and (max-width: 64em) {
      max-width: min(85vw, var(--container-md));
      padding: var(--space-xl);
    }
  }

  // ======================================
  // HEADER SECTION - Using Root Variables
  // ======================================

  .overlay__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-xl);
    gap: var(--space-md);

    @media (max-width: 47.9375em) {
      margin-bottom: var(--space-lg);
    }
  }

  .overlay__title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    letter-spacing: var(--letter-spacing-base);
    color: var(--text-primary);
    margin: 0;
    flex: 1;

    @media (max-width: 47.9375em) {
      font-size: var(--text-xl);
    }

    @media (min-width: 48em) {
      font-size: var(--text-3xl);
    }
  }

  .overlay__close-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--touch-target-enhanced);
    height: var(--touch-target-enhanced);
    min-width: var(--touch-target-enhanced);
    min-height: var(--touch-target-enhanced);
    border-radius: var(--radius-full);
    background-color: var(--bg-tertiary);
    color: var(--text-secondary);
    border: none;
    cursor: pointer;
    flex-shrink: 0;
    transition:
      background-color var(--transition-normal),
      color var(--transition-normal),
      transform var(--transition-fast);

    // Performance optimization
    contain: layout style;
    will-change: transform, background-color;

    &:hover,
    &:focus {
      background-color: var(--interactive-primary);
      color: var(--text-primary);
      transform: scale(var(--animation-scale-hover-subtle));
    }

    &:active {
      transform: scale(var(--scale-active));
    }

    @media (max-width: 47.9375em) {
      width: calc(var(--touch-target-enhanced) * 0.875);
      height: calc(var(--touch-target-enhanced) * 0.875);
      min-width: calc(var(--touch-target-enhanced) * 0.875);
      min-height: calc(var(--touch-target-enhanced) * 0.875);
    }
  }

  // ======================================
  // FEEDBACK STYLES - Using Root Variables
  // ======================================

  .feedback {
    margin: var(--space-xl) 0;
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    text-align: center;
    font-size: var(--text-xl);
    line-height: var(--leading-relaxed);
    font-weight: var(--font-semibold);

    @media (max-width: 47.9375em) {
      margin: var(--space-lg) 0;
      padding: var(--space-md);
      font-size: var(--text-lg);
    }

    // WCAG AAA 2.2 compliant feedback colors
    &.correct {
      color: var(--text-success-aaa);
      background-color: var(--bg-success-aaa);
    }

    &.incorrect {
      color: var(--text-error-aaa);
      background-color: var(--bg-error-aaa);
    }
  }

  // ======================================
  // ALBUM INFO SECTION - Using Root Variables
  // ======================================

  .album-info {
    margin-bottom: var(--space-2xl);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 200px;

    // Performance optimization
    contain: layout;

    @media (max-width: 47.9375em) {
      margin-bottom: var(--space-xl);
      min-height: 160px;
    }

    &__content {
      width: 100%;
      max-width: var(--container-md);
      text-align: center;
      padding: var(--space-xl);
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      border: var(--border-width-thin) solid var(--border-primary);
      box-shadow: var(--card-shadow);
      transition: all var(--transition-normal);

      @media (max-width: 47.9375em) {
        padding: var(--space-lg);
        border-radius: var(--radius-lg);
      }

      &:hover {
        transform: translateY(var(--animation-y-offset-small));
        box-shadow: var(--card-shadow-hover);
      }
    }

    &__header {
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-md);
      border-bottom: var(--border-width-thin) solid var(--border-secondary);

      @media (max-width: 47.9375em) {
        margin-bottom: var(--space-md);
        padding-bottom: var(--space-sm);
      }
    }

    &__details {
      margin-top: var(--space-lg);

      @media (max-width: 47.9375em) {
        margin-top: var(--space-md);
      }
    }
  }

  .artist-name {
    margin: 0 0 var(--space-sm) 0;
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--interactive-primary);
    line-height: var(--leading-tight);

    @media (max-width: 47.9375em) {
      font-size: var(--text-2xl);
    }

    @media (min-width: 64em) {
      font-size: var(--text-4xl);
    }
  }

  .album-name {
    margin: 0 0 var(--space-sm) 0;
    font-size: var(--text-2xl);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    line-height: var(--leading-tight);

    @media (max-width: 47.9375em) {
      font-size: var(--text-xl);
    }

    @media (min-width: 64em) {
      font-size: var(--text-3xl);
    }
  }

  .album-year {
    margin: 0;
    font-size: var(--text-xl);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    display: inline-block;
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-tertiary);
    border-radius: var(--radius-pill);
    border: var(--border-width-thin) solid var(--border-secondary);

    @media (max-width: 47.9375em) {
      font-size: var(--text-lg);
      padding: var(--space-xs) var(--space-sm);
    }
  }

  .fun-fact {
    margin: 0;
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    color: var(--text-secondary);
    max-width: 100%;
    padding: var(--space-lg);
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: var(--border-width-thin) solid var(--border-secondary);
    font-style: italic;

    @media (max-width: 47.9375em) {
      font-size: var(--text-base);
      padding: var(--space-md);
    }

    // Hide if empty
    &:empty {
      display: none;
    }
  }

  // ======================================
  // NEXT BUTTON - Using Root Variables
  // ======================================

  .next-button {
    display: block;
    margin: 0 auto;
    min-height: var(--min-touch-size);
    min-width: calc(var(--min-touch-size) * 4.5);
    border-radius: var(--radius-lg);
    background: var(--btn-primary-bg);
    color: var(--btn-primary-text);
    font-weight: var(--font-semibold);
    border: none;
    cursor: pointer;
    padding: var(--space-md) var(--space-xl);
    transition:
      background var(--transition-normal),
      transform var(--transition-fast);

    @media (max-width: 47.9375em) {
      min-width: calc(var(--min-touch-size) * 3.5);
      padding: var(--space-sm) var(--space-lg);
      font-size: var(--text-base);
    }

    @media (min-width: 48em) and (max-width: 63.9375em) {
      min-width: calc(var(--min-touch-size) * 4);
    }

    &:hover,
    &:focus {
      background: var(--btn-primary-hover);
      transform: translateY(var(--animation-y-offset-small));
    }

    &__content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);

      @media (max-width: 47.9375em) {
        gap: var(--space-xs);
      }
    }
  }

  // ======================================
  // ACCESSIBILITY & FOCUS STYLES - Using Root Variables
  // ======================================

  .overlay__content:focus,
  .overlay__close-button:focus-visible,
  .next-button:focus-visible,
  .album-info__content:focus-visible {
    outline: var(--focus-enhanced-outline-dark);
    outline-offset: var(--focus-ring-offset);
    box-shadow: var(--focus-enhanced-shadow);
  }

  // ======================================
  // ANIMATIONS & MOTION - Performance Optimized with Root Variables
  // ======================================

  @media (prefers-reduced-motion: no-preference) {
    .album-cover {
      &:hover {
        will-change: transform, box-shadow;
        transform: scale(var(--scale-focus)) translateZ(0);
        box-shadow: var(--shadow-xl);
      }

      &:not(:hover) {
        will-change: auto;
      }
    }

    .overlay:not(.hidden) .overlay__content {
      animation: fade-in var(--transition-normal) cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
    }

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(var(--animation-y-offset)) scale(var(--animation-scale-start))
          translateZ(0);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(var(--animation-scale-end)) translateZ(0);
      }
    }
  }

  // ======================================
  // REDUCED MOTION SUPPORT
  // ======================================

  @media (prefers-reduced-motion: reduce) {
    .overlay,
    .overlay__content,
    .album-info__content,
    .overlay__close-button,
    .music-button,
    .next-button {
      animation-duration: 0.001ms !important;
      transition-duration: 0.001ms !important;
      animation-iteration-count: 1 !important;
    }
  }

  // ======================================
  // HIGH CONTRAST MODE SUPPORT
  // ======================================

  @media (forced-colors: active) {
    .overlay__content {
      border: var(--border-width-enhanced) solid CanvasText;
      background-color: Canvas;
    }

    .next-button,
    .overlay__close-button {
      border: var(--border-width-thick) solid ButtonText;
      background-color: ButtonFace;
      color: ButtonText;
      forced-color-adjust: none;

      &:focus-visible {
        outline: var(--border-width-enhanced) solid Highlight;
        outline-offset: var(--focus-ring-offset);
      }
    }

    .feedback {
      &.correct,
      &.incorrect {
        border: var(--border-width-thick) solid CanvasText;
        background-color: Canvas;
        color: CanvasText;
      }
    }

    .overlay__backdrop {
      background: Canvas;
      opacity: 0.8;
    }
  }

  // ======================================
  // CUSTOM SCROLLBAR STYLES - Using Root Variables
  // ======================================

  .overlay__content {
    scrollbar-width: var(--scrollbar-thin);
    scrollbar-color: var(--scrollbar-thumb-bg) var(--scrollbar-track-bg);

    &::-webkit-scrollbar {
      width: var(--scrollbar-thin);
      height: var(--scrollbar-thin);
    }

    &::-webkit-scrollbar-track {
      background: var(--scrollbar-track-bg);
      border-radius: var(--scrollbar-track-radius);
    }

    &::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb-bg);
      border-radius: var(--scrollbar-thumb-radius);

      &:hover {
        background: var(--scrollbar-thumb-hover);
      }
    }
  }

  // ======================================
  // ENHANCED TEXT SPACING SUPPORT (WCAG 2.2) - Using Root Variables
  // ======================================

  .enhanced-text-spacing .overlay__content * {
    letter-spacing: var(--text-spacing-letter-2x) !important;
    word-spacing: var(--text-spacing-word-enhanced) !important;
    line-height: var(--text-spacing-line-1-5x) !important;
  }

  .enhanced-text-spacing .overlay__content p,
  .enhanced-text-spacing .overlay__content .feedback {
    margin-bottom: var(--text-spacing-paragraph-2x) !important;
  }

  .enhanced-text-spacing .overlay__content .next-button {
    padding: calc(var(--space-lg) * 1.2) calc(var(--space-xl) * 1.2);
  }

  // ======================================
  // PRINT STYLES - Using Root Variables
  // ======================================

  @media print {
    .overlay__content {
      border: var(--border-width-thin) solid var(--print-border);
      box-shadow: none;
      max-height: none !important;
      background: var(--print-bg);
      color: var(--print-text);
    }

    .next-button,
    .overlay__close-button {
      border: var(--border-width-thin) solid var(--print-border);
      background: var(--print-bg) !important;
      color: var(--print-text) !important;
    }

    .album-info__content {
      border: var(--border-width-thin) solid var(--print-border);
      background: var(--print-bg);
      box-shadow: none;
    }
  }
</style>

<script type="module" is:inline>
  /**
   * Modern ES6+ FeedbackOverlay Event Handlers
   * Using arrow functions, const/let, template literals, and modern event handling
   */

  // Global state management
  let handlersInitialized = false;
  let escapeHandler = null;

  /**
   * Initialize the overlay with modern ES6+ features
   */
  const initializeOverlay = () => {
    if (handlersInitialized) {
      return;
    }

    setupDirectEventHandlers();
    handlersInitialized = true;
  };

  /**
   * Set up direct event handlers using modern ES6+ syntax
   */
  const setupDirectEventHandlers = () => {
    // Close button handler
    const closeButton = document.getElementById("close-overlay-button");
    if (closeButton) {
      closeButton.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeOverlayAndNextRound();
      };
    }

    // Backdrop handler
    const backdrop = document.getElementById("overlay-backdrop");
    if (backdrop) {
      backdrop.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeOverlayAndNextRound();
      };
    }

    // Next round button handler
    const nextButton = document.getElementById("next-round-button");
    if (nextButton) {
      nextButton.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeOverlayAndNextRound();
      };
    }

    // Remove existing escape handler if any
    if (escapeHandler) {
      document.removeEventListener("keydown", escapeHandler);
    }

    // Enhanced keyboard navigation handler with modern syntax
    escapeHandler = (e) => {
      const overlay = document.getElementById("overlay");
      if (!overlay?.classList.contains("hidden")) {
        return;
      }

      const keyHandlers = {
        Escape: () => {
          e.preventDefault();
          e.stopPropagation();
          closeOverlayAndNextRound();
        },
        Tab: () => {
          e.preventDefault();
          handleTabNavigation(e.shiftKey);
        },
        Enter: () => {
          if (document.activeElement?.tagName === "BUTTON") {
            return;
          }
          e.preventDefault();
          closeOverlayAndNextRound();
        },
        " ": () => {
          if (document.activeElement?.tagName === "BUTTON") {
            return;
          }
          e.preventDefault();
          closeOverlayAndNextRound();
        },
        ArrowUp: () => {
          e.preventDefault();
          navigateFocus(-1);
        },
        ArrowLeft: () => {
          e.preventDefault();
          navigateFocus(-1);
        },
        ArrowDown: () => {
          e.preventDefault();
          navigateFocus(1);
        },
        ArrowRight: () => {
          e.preventDefault();
          navigateFocus(1);
        },
      };

      const handler = keyHandlers[e.key];
      if (handler) {
        handler();
      }
    };

    document.addEventListener("keydown", escapeHandler);

    // Set up focus management when overlay becomes visible
    setupFocusManagement();
  };

  /**
   * Set up focus management for the overlay using modern syntax
   */
  const setupFocusManagement = () => {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(({ type, target, attributeName }) => {
        if (type === "attributes" && attributeName === "class") {
          const overlay = target;
          const isVisible = !overlay.classList.contains("hidden");

          if (isVisible) {
            // Scroll to top immediately when overlay opens
            window.scrollTo(0, 0);

            // Focus the close button when overlay opens
            setTimeout(() => {
              const closeButton = document.getElementById("close-overlay-button");
              closeButton?.focus();
            }, 100);
          }
        }
      });
    });

    const overlay = document.getElementById("overlay");
    if (overlay) {
      observer.observe(overlay, {
        attributes: true,
        attributeFilter: ["class"],
      });
    }
  };

  /**
   * Get all focusable elements in the overlay using modern array methods
   */
  const getFocusableElements = () => {
    const overlay = document.getElementById("overlay");
    if (!overlay) {
      return [];
    }

    const selectors = [
      "button:not([disabled])",
      "a[href]:not([disabled])",
      "[tabindex]:not([tabindex='-1']):not([disabled])",
    ].join(", ");

    return Array.from(overlay.querySelectorAll(selectors)).filter((el) => {
      const style = getComputedStyle(el);
      return style.display !== "none" && style.visibility !== "hidden";
    });
  };

  /**
   * Handle Tab navigation through focusable elements
   */
  const handleTabNavigation = (isShiftKey) => {
    const focusableElements = getFocusableElements();
    if (focusableElements.length === 0) {
      return;
    }

    const currentIndex = focusableElements.indexOf(document.activeElement);
    const nextIndex = isShiftKey
      ? currentIndex <= 0
        ? focusableElements.length - 1
        : currentIndex - 1
      : currentIndex >= focusableElements.length - 1
        ? 0
        : currentIndex + 1;

    focusableElements[nextIndex]?.focus();
  };

  /**
   * Navigate focus with arrow keys
   */
  const navigateFocus = (direction) => {
    const focusableElements = getFocusableElements();
    if (focusableElements.length === 0) {
      return;
    }

    const currentIndex = focusableElements.indexOf(document.activeElement);
    const nextIndex =
      direction > 0
        ? currentIndex >= focusableElements.length - 1
          ? 0
          : currentIndex + 1
        : currentIndex <= 0
          ? focusableElements.length - 1
          : currentIndex - 1;

    focusableElements[nextIndex]?.focus();
  };

  /**
   * Close overlay and trigger next round using modern syntax
   */
  const closeOverlayAndNextRound = () => {
    const overlay = document.getElementById("overlay");
    if (!overlay) {
      return;
    }

    // Scroll to top immediately when overlay closes
    window.scrollTo(0, 0);

    // Find and trigger the next round button that the game engine set up
    const nextRoundButton = document.getElementById("next-round-button");
    if (nextRoundButton?.onclick) {
      // Call the game engine's onclick handler directly
      nextRoundButton.onclick(new MouseEvent("click"));
    } else {
      // Fallback: Hide overlay and dispatch click event
      overlay.classList.add("hidden");
      nextRoundButton?.click();
    }
  };

  // Initialize when DOM is ready using modern syntax
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeOverlay);
  } else {
    initializeOverlay();
  }

  // Re-initialize on Astro page load
  document.addEventListener("astro:page-load", () => {
    handlersInitialized = false;
    initializeOverlay();
  });
</script>

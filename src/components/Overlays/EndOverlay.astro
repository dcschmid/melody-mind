---
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import ShareOverlay from "./ShareOverlay.astro";
import { Icon } from "astro-icon/components";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

interface Props {
  title?: string;
  id: string;
  "data-score"?: string;
  "data-category"?: string;
  "data-difficulty"?: string;
}

const {
  title = t("game.end.title"),
  id,
  "data-score": initialScore = "0",
  "data-category": category = "",
  "data-difficulty": difficulty = "",
} = Astro.props;
---

<div
  id={id}
  class="popup hidden fixed inset-0 z-50 flex items-center justify-center p-6 bg-zinc-900/95 backdrop-blur-md"
  role="dialog"
  aria-labelledby="popup-title"
  aria-modal="true"
  data-score={initialScore}
  data-category={category}
  data-difficulty={difficulty}
>
  <div
    class="popupContent w-full max-w-lg max-h-[80vh] bg-gradient-to-b from-zinc-800 to-zinc-900 border border-zinc-700 rounded-2xl shadow-2xl p-8 md:p-10 text-center overflow-y-auto overscroll-contain scrollbar-gutter-stable"
    tabindex="-1"
  >
    <div class="achievement-badge mb-6 mx-auto w-20 h-20 flex items-center justify-center rounded-full bg-gradient-to-br from-amber-400 to-orange-500 text-zinc-900">
      <Icon name="trophy" width={42} height={42} aria-hidden="true" />
    </div>
    
    <h2 
      id="popup-title" 
      class="title text-3xl font-bold text-gradient bg-gradient-to-r from-sky-300 to-indigo-400 mb-6"
    >
      {title}
    </h2>

    <!-- Progress Visualization -->
    <div class="achievement-progress relative h-3 bg-zinc-700 rounded-full mb-8 overflow-hidden" role="presentation">
      <div id="score-bar" class="absolute left-0 top-0 h-full bg-gradient-to-r from-sky-500 to-indigo-500 transition-all duration-1000 ease-out" style="width: 0%"></div>
    </div>

    <!-- Der Motivationstext wird dynamisch gesetzt -->
    <p
      id="motivation-text"
      class="motivationText text-zinc-100 text-lg mb-8 leading-relaxed"
      aria-live="polite"
    >
    </p>

    <div class="scoreSection flex justify-center items-center p-4 rounded-xl bg-zinc-800/50 border border-zinc-700 mb-8">
      <div class="score-container text-center">
        <span class="scoreLabel text-zinc-300 text-lg block mb-1">{t("game.end.score")}</span>
        <span id="popup-score" class="scoreValue text-3xl font-bold text-white">0</span>
      </div>
    </div>

    <!-- Difficulty Badge -->
    <div class="difficulty-badge mb-8 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-zinc-800 border border-zinc-700">
      <Icon name="difficulty" width={20} height={20} class="text-amber-400" aria-hidden="true" />
      <span id="difficulty-display" class="text-zinc-200">{difficulty}</span>
    </div>

    <!-- Improved Share Section -->
    <div class="share-section mb-8">
      <ShareOverlay />
    </div>

    <div class="buttonWrapper flex justify-center gap-4">
      <a
        href="/"
        class="homeButton min-w-[48px] min-h-[48px] py-3 px-6 bg-zinc-700 hover:bg-zinc-600 focus:bg-zinc-600 text-white font-medium rounded-xl transition-colors focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-400"
        aria-label={t("game.end.home")}
      >
        <span class="flex items-center gap-2">
          <Icon name="home" width={20} height={20} aria-hidden="true" />
          {t("game.end.home")}
        </span>
      </a>
      
      <button
        id="restart-button"
        class="restartButton min-w-[48px] min-h-[48px] py-3 px-6 bg-gradient-to-r from-sky-600 to-indigo-600 hover:from-sky-500 hover:to-indigo-500 focus:from-sky-500 focus:to-indigo-500 text-white font-medium rounded-xl transition-colors focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-400"
        aria-label={t("game.end.newgame")}
      >
        <span class="flex items-center gap-2">
          <Icon name="restart" width={20} height={20} aria-hidden="true" />
          {t("game.end.newgame")}
        </span>
      </button>
    </div>
  </div>
</div>

<style>
  /* JS Compatibility Classes */
  .popup.hidden {
    pointer-events: none;
    visibility: hidden;
    opacity: 0;
  }

  /* Text gradient */
  .text-gradient {
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  /* Animation improvements */
  @keyframes fade-in-up {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes badge-pulse {
    0% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
    }
    70% {
      transform: scale(1);
      box-shadow: 0 0 0 15px rgba(251, 191, 36, 0);
    }
    100% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
    }
  }

  /* Apply animations when popup is visible */
  .popup:not(.hidden) .popupContent {
    animation: fade-in-up 0.5s ease-out;
  }
  
  @media (prefers-reduced-motion: no-preference) {
    .popup:not(.hidden) .achievement-badge {
      animation: badge-pulse 2s infinite;
    }
  }
  
  /* WCAG AAA Compliant Styles */
  .motivationText {
    line-height: 1.6;
    max-width: 65ch;
    margin-left: auto;
    margin-right: auto;
  }
  
  /* Accessibility improvements */
  button:focus-visible,
  a:focus-visible {
    outline: 3px solid rgb(56, 189, 248); /* sky-300 */
    outline-offset: 4px;
  }
  
  /* High Contrast Mode Support */
  @media (forced-colors: active) {
    .popupContent {
      border: 3px solid CanvasText;
      background: Canvas;
    }
    
    .achievement-badge {
      border: 2px solid ButtonText;
    }
    
    .achievement-progress {
      border: 1px solid CanvasText;
    }
    
    #score-bar {
      background: Highlight;
    }
    
    .scoreSection {
      border: 2px solid CanvasText;
    }
    
    .buttonWrapper button,
    .buttonWrapper a {
      border: 2px solid ButtonText;
      background-color: ButtonFace;
      color: ButtonText;
      forced-color-adjust: none;
    }
    
    .text-gradient {
      -webkit-text-fill-color: CanvasText;
      background: none;
    }
  }
  
  /* Support for reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .popup:not(.hidden) .popupContent,
    .achievement-badge,
    #score-bar {
      animation: none !important;
      transition: none !important;
    }
  }
  
  /* Print styles */
  @media print {
    .popupContent {
      border: 1px solid #000;
      box-shadow: none !important;
    }
    
    .buttonWrapper button,
    .buttonWrapper a {
      border: 1px solid #000;
      background: none !important;
      color: #000 !important;
    }
    
    .achievement-badge {
      border: 1px solid #000;
      background: none !important;
    }
  }
  
  /* Scrollbar styling */
  .popupContent::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  .popupContent::-webkit-scrollbar-track {
    background: rgba(39, 39, 42, 0.6); /* zinc-800 with opacity */
    border-radius: 10px;
  }
  
  .popupContent::-webkit-scrollbar-thumb {
    background: rgba(82, 82, 91, 0.8); /* zinc-600 with opacity */
    border-radius: 10px;
  }
  
  .popupContent::-webkit-scrollbar-thumb:hover {
    background: rgba(113, 113, 122, 0.8); /* zinc-500 with opacity */
  }

  /* Improve focus indication when scrolling */
  .popupContent:focus-visible {
    outline: 3px solid rgb(56, 189, 248); /* sky-300 */
    outline-offset: 3px;
  }
</style>

<script>
  /**
   * EndOverlay Component Script
   *
   * Handles the end game modal functionality including dynamic motivation text based on score
   * and sharing capabilities.
   */
  import { shareScore } from "../../utils/share/shareUtils";

  /**
   * Achievement thresholds for different score levels
   */
  const ACHIEVEMENT_THRESHOLDS = {
    GENIUS: 800,
    PRO: 600,
    ENTHUSIAST: 400,
    LOVER: 200,
    EXPLORER: 0,
  };

  /**
   * Multilingual motivational texts for different achievement levels
   */
  const MOTIVATION_TEXTS = {
    de: {
      GENIUS:
        "Au√üergew√∂hnlich! üí´ Du bist ein wahres Musikgenie! üé∂ Dein tiefes Wissen und dein musikalisches Gesp√ºr sind beeindruckend. Du k√∂nntest in einer Musikquiz-Show gewinnen oder selbst Musikhistoriker sein. Teile deine bemerkenswerte Leistung und fordere andere heraus, gegen dich anzutreten!",
      PRO: "Fantastisch! üåü Du bist definitiv ein Musik-Profi mit umfassendem Wissen √ºber verschiedene K√ºnstler und Genres. Dein Musikverst√§ndnis ist weit √ºberdurchschnittlich. Nur wenige k√∂nnen mit deinem Wissen mithalten. Mach weiter so und fordere deine Freunde heraus!",
      ENTHUSIAST:
        "Bemerkenswert! üëç Als echter Musikenthusiast kennst du dich richtig gut aus. Du hast ein solides Fundament an Musikwissen aufgebaut, das dich von der Masse abhebt. Mit etwas mehr √úbung k√∂nntest du bald zur Profi-Liga aufsteigen. Probiere eine weitere Runde?",
      LOVER:
        "Gut gemacht! üëè Als Musikliebhaber hast du ein ordentliches Wissen gezeigt. Du bist auf dem richtigen Weg, ein echter Musikkenner zu werden. Mit mehr Spielpraxis kannst du dein Wissen weiter ausbauen und deine Punktzahl verbessern. Bist du bereit f√ºr eine neue Herausforderung?",
      EXPLORER:
        "Danke f√ºrs Spielen! üôè Als Musikentdecker hast du den ersten Schritt gemacht, die faszinierende Welt der Musik zu erkunden. Jedes Spiel ist eine Gelegenheit, Neues zu lernen. Fordere dich selbst heraus, spiele weitere Runden und erweitere dein musikalisches Wissen!",
    },
    en: {
      GENIUS:
        "Extraordinary! üí´ You're a true music genius! üé∂ Your deep knowledge and musical intuition are truly impressive. You could win a music quiz show or even be a music historian. Share your remarkable achievement and challenge others to compete against you!",
      PRO: "Fantastic! üåü You're definitely a music pro with extensive knowledge about various artists and genres. Your music comprehension is far above average. Few can match your knowledge. Keep it up and challenge your friends!",
      ENTHUSIAST:
        "Impressive! üëç As a genuine music enthusiast, you really know your stuff. You've built a solid foundation of music knowledge that sets you apart from the crowd. With a bit more practice, you could soon rise to the pro league. Would you like to try another round?",
      LOVER:
        "Well done! üëè As a music lover, you've shown considerable knowledge. You're on the right track to becoming a true music connoisseur. With more gameplay practice, you can expand your knowledge and improve your score. Are you ready for a new challenge?",
      EXPLORER:
        "Thanks for playing! üôè As a music explorer, you've taken the first step in discovering the fascinating world of music. Each game is an opportunity to learn something new. Challenge yourself, play more rounds, and expand your musical knowledge!",
    },
    es: {
      GENIUS:
        "¬°Extraordinario! üí´ ¬°Eres un verdadero genio musical! üé∂ Tu profundo conocimiento e intuici√≥n musical son realmente impresionantes. Podr√≠as ganar un programa de preguntas musicales o incluso ser historiador de m√∫sica. ¬°Comparte tu notable logro y desaf√≠a a otros a competir contra ti!",
      PRO: "¬°Fant√°stico! üåü Definitivamente eres un profesional de la m√∫sica con un amplio conocimiento sobre varios artistas y g√©neros. Tu comprensi√≥n musical est√° muy por encima del promedio. Pocos pueden igualar tu conocimiento. ¬°Sigue as√≠ y desaf√≠a a tus amigos!",
      ENTHUSIAST:
        "¬°Impresionante! üëç Como aut√©ntico entusiasta de la m√∫sica, realmente sabes de lo que hablas. Has construido una base s√≥lida de conocimiento musical que te distingue de la multitud. Con un poco m√°s de pr√°ctica, pronto podr√≠as ascender a la liga profesional. ¬øTe gustar√≠a intentar otra ronda?",
      LOVER:
        "¬°Bien hecho! üëè Como amante de la m√∫sica, has demostrado un buen conocimiento. Est√°s en el camino correcto para convertirte en un verdadero conocedor de m√∫sica. Con m√°s pr√°ctica de juego, puedes expandir tu conocimiento y mejorar tu puntuaci√≥n. ¬øListo para un nuevo desaf√≠o?",
      EXPLORER:
        "¬°Gracias por jugar! üôè Como explorador musical, has dado el primer paso para descubrir el fascinante mundo de la m√∫sica. Cada juego es una oportunidad para aprender algo nuevo. Desaf√≠ate a ti mismo, juega m√°s rondas y ampl√≠a tu conocimiento musical.",
    },
    fr: {
      GENIUS:
        "Extraordinaire ! üí´ Tu es un vrai g√©nie de la musique ! üé∂ Ta connaissance profonde et ton intuition musicale sont vraiment impressionnantes. Tu pourrais gagner un jeu t√©l√©vis√© musical ou m√™me √™tre historien de la musique. Partage ton remarquable accomplissement et d√©fie les autres √† se mesurer √† toi !",
      PRO: "Fantastique ! üåü Tu es d√©finitivement un pro de la musique avec une connaissance √©tendue de divers artistes et genres. Ta compr√©hension musicale est bien au-dessus de la moyenne. Peu peuvent √©galer ton savoir. Continue comme √ßa et d√©fie tes amis !",
      ENTHUSIAST:
        "Impressionnant ! üëç En tant que v√©ritable passionn√© de musique, tu connais vraiment ton sujet. Tu as construit une base solide de connaissances musicales qui te distingue de la foule. Avec un peu plus de pratique, tu pourrais bient√¥t monter en ligue professionnelle. Envie d'essayer une autre partie ?",
      LOVER:
        "Bien jou√© ! üëè En tant qu'amateur de musique, tu as montr√© de bonnes connaissances. Tu es sur la bonne voie pour devenir un v√©ritable connaisseur musical. Avec plus de pratique de jeu, tu peux √©largir tes connaissances et am√©liorer ton score. Pr√™t pour un nouveau d√©fi ?",
      EXPLORER:
        "Merci d'avoir jou√© ! üôè En tant qu'explorateur musical, tu as fait le premier pas pour d√©couvrir le monde fascinant de la musique. Chaque partie est une occasion d'apprendre quelque chose de nouveau. Lance-toi des d√©fis, joue davantage et √©largis tes connaissances musicales !",
    },
    it: {
      GENIUS:
        "Straordinario! üí´ Sei un vero genio della musica! üé∂ La tua profonda conoscenza e intuizione musicale sono davvero impressionanti. Potresti vincere un quiz musicale o persino essere uno storico della musica. Condividi il tuo notevole risultato e sfida gli altri a competere con te!",
      PRO: "Fantastico! üåü Sei sicuramente un professionista della musica con una vasta conoscenza di vari artisti e generi. La tua comprensione musicale √® ben al di sopra della media. Pochi possono eguagliare la tua conoscenza. Continua cos√¨ e sfida i tuoi amici!",
      ENTHUSIAST:
        "Impressionante! üëç Come vero appassionato di musica, conosci davvero il tuo mestiere. Hai costruito una solida base di conoscenze musicali che ti distingue dalla massa. Con un po' pi√π di pratica, potresti presto salire nella lega dei professionisti. Vuoi provare un altro round?",
      LOVER:
        "Ben fatto! üëè Come amante della musica, hai dimostrato una conoscenza considerevole. Sei sulla strada giusta per diventare un vero intenditore di musica. Con pi√π pratica di gioco, puoi espandere le tue conoscenze e migliorare il tuo punteggio. Sei pronto per una nuova sfida?",
      EXPLORER:
        "Grazie per aver giocato! üôè Come esploratore musicale, hai fatto il primo passo per scoprire il mondo affascinante della musica. Ogni partita √® un'opportunit√† per imparare qualcosa di nuovo. Sfida te stesso, gioca pi√π round ed espandi le tue conoscenze musicali!",
    },
    pt: {
      GENIUS:
        "Extraordin√°rio! üí´ Voc√™ √© um verdadeiro g√™nio da m√∫sica! üé∂ Seu profundo conhecimento e intui√ß√£o musical s√£o realmente impressionantes. Voc√™ poderia ganhar um quiz musical ou at√© mesmo ser um historiador da m√∫sica. Compartilhe sua not√°vel conquista e desafie os outros a competir com voc√™!",
      PRO: "Fant√°stico! üåü Voc√™ definitivamente √© um profissional da m√∫sica com amplo conhecimento sobre v√°rios artistas e g√™neros. Sua compreens√£o musical est√° muito acima da m√©dia. Poucos podem igualar seu conhecimento. Continue assim e desafie seus amigos!",
      ENTHUSIAST:
        "Impressionante! üëç Como um verdadeiro entusiasta da m√∫sica, voc√™ realmente conhece o assunto. Voc√™ construiu uma base s√≥lida de conhecimento musical que o distingue da multid√£o. Com um pouco mais de pr√°tica, voc√™ pode em breve subir para a liga dos profissionais. Quer tentar outra rodada?",
      LOVER:
        "Muito bem! üëè Como amante da m√∫sica, voc√™ demonstrou um bom conhecimento. Voc√™ est√° no caminho certo para se tornar um verdadeiro conhecedor de m√∫sica. Com mais pr√°tica de jogo, voc√™ pode expandir seu conhecimento e melhorar sua pontua√ß√£o. Est√° pronto para um novo desafio?",
      EXPLORER:
        "Obrigado por jogar! üôè Como explorador musical, voc√™ deu o primeiro passo para descobrir o fascinante mundo da m√∫sica. Cada jogo √© uma oportunidade para aprender algo novo. Desafie-se, jogue mais rodadas e expanda seu conhecimento musical!",
    },
    da: {
      GENIUS:
        "Ekstraordin√¶rt! üí´ Du er et sandt musiktalent! üé∂ Din dybe viden og musikalske intuition er virkelig imponerende. Du kunne vinde en musikquiz eller endda v√¶re musikhistoriker. Del din bem√¶rkelsesv√¶rdige pr√¶station og udfordr andre til at konkurrere mod dig!",
      PRO: "Fantastisk! üåü Du er bestemt en musikekspert med omfattende viden om forskellige kunstnere og genrer. Din musikforst√•else er langt over gennemsnittet. F√• kan matche din viden. Bliv ved og udfordr dine venner!",
      ENTHUSIAST:
        "Bem√¶rkelsesv√¶rdigt! üëç Som √¶gte musikentusiast kender du virkelig din sag. Du har opbygget et solidt fundament af musikkundskab, der adskiller dig fra m√¶ngden. Med lidt mere √∏velse kan du snart stige til pro-ligaen. Vil du pr√∏ve en runde mere?",
      LOVER:
        "Godt klaret! üëè Som musikelsker har du vist betydelig viden. Du er p√• rette vej til at blive en √¶gte musikconnaisseur. Med mere spilpraksis kan du udvide din viden og forbedre din score. Er du klar til en ny udfordring?",
      EXPLORER:
        "Tak for spillet! üôè Som musikopdager har du taget det f√∏rste skridt i at opdage musikkens fascinerende verden. Hvert spil er en mulighed for at l√¶re noget nyt. Udfordr dig selv, spil flere runder og udvid din musikkundskab!",
    },
    nl: {
      GENIUS:
        "Buitengewoon! üí´ Je bent een echt muzikaal genie! üé∂ Je diepgaande kennis en muzikale intu√Øtie zijn echt indrukwekkend. Je zou een muziekquiz kunnen winnen of zelfs een muziekgeschiedkundige kunnen zijn. Deel je opmerkelijke prestatie en daag anderen uit om tegen je te strijden!",
      PRO: "Fantastisch! üåü Je bent zeker een muziekprofessional met uitgebreide kennis over verschillende artiesten en genres. Je muzikale begrip is ver boven het gemiddelde. Weinig mensen kunnen jouw kennis evenaren. Ga zo door en daag je vrienden uit!",
      ENTHUSIAST:
        "Indrukwekkend! üëç Als echte muziekliefhebber weet je echt waar je het over hebt. Je hebt een solide basis van muziekkennis opgebouwd die je onderscheidt van de massa. Met een beetje meer oefening kun je binnenkort naar de pro-league stijgen. Wil je nog een ronde proberen?",
      LOVER:
        "Goed gedaan! üëè Als muziekliefhebber heb je aanzienlijke kennis getoond. Je bent op de goede weg om een echte muziekkenner te worden. Met meer spelervaring kun je je kennis uitbreiden en je score verbeteren. Ben je klaar voor een nieuwe uitdaging?",
      EXPLORER:
        "Bedankt voor het spelen! üôè Als muziekontdekker heb je de eerste stap gezet in het ontdekken van de fascinerende wereld van muziek. Elk spel is een kans om iets nieuws te leren. Daag jezelf uit, speel meer rondes en breid je muziekkennis uit!",
    },
    sv: {
      GENIUS:
        "Enast√•ende! üí´ Du √§r ett riktigt musikgeni! üé∂ Din djupa kunskap och musikaliska intuition √§r verkligen imponerande. Du skulle kunna vinna en musikt√§vling eller till och med vara en musikhistoriker. Dela din anm√§rkningsv√§rda prestation och utmana andra att t√§vla mot dig!",
      PRO: "Fantastiskt! üåü Du √§r definitivt en musikproffs med omfattande kunskap om olika artister och genrer. Din musikaliska f√∂rst√•else √§r l√•ngt √∂ver genomsnittet. F√• kan matcha din kunskap. Forts√§tt s√• och utmana dina v√§nner!",
      ENTHUSIAST:
        "Imponerande! üëç Som en sann musikentusiast k√§nner du verkligen till √§mnet. Du har byggt en solid grund av musikkunskap som skiljer dig fr√•n m√§ngden. Med lite mer √∂vning kan du snart stiga till pro-ligan. Vill du prova en runda till?",
      LOVER:
        "Bra gjort! üëè Som musik√§lskare har du visat betydande kunskap. Du √§r p√• r√§tt v√§g att bli en riktig musik√§lskare. Med mer spel√∂vning kan du ut√∂ka din kunskap och f√∂rb√§ttra din po√§ng. √Ñr du redo f√∂r en ny utmaning?",
      EXPLORER:
        "Tack f√∂r att du spelade! üôè Som musikutforskare har du tagit det f√∂rsta steget i att uppt√§cka musikens fascinerande v√§rld. Varje spel √§r en m√∂jlighet att l√§ra sig n√•got nytt. Utmana dig sj√§lv, spela fler rundor och ut√∂ka din musikkunskap!",
    },
    fi: {
      GENIUS:
        "Uskomaton! üí´ Olet todellinen musiikin nero! üé∂ Syv√§llinen tietosi ja musiikillinen intuitiosi ovat todella vaikuttavia. Voisit voittaa musiikkivisailun tai jopa olla musiikkihistorioitsija. Jaa merkitt√§v√§ saavutuksesi ja haasta muut kilpailemaan kanssasi!",
      PRO: "Mahtava! üåü Olet ehdottomasti musiikin ammattilainen, jolla on laaja tiet√§mys eri artisteista ja genreist√§. Musiikillinen ymm√§rryksesi on huomattavasti keskim√§√§r√§ist√§ parempi. Harvat voivat vastata tiet√§mykseesi. Jatka samaan malliin ja haasta yst√§v√§si!",
      ENTHUSIAST:
        "Vaikuttavaa! üëç Aidosti musiikkia rakastavana tied√§t todella, mist√§ puhut. Olet rakentanut vankan perustan musiikkitiet√§mykselle, joka erottaa sinut joukosta. V√§h√§n enemm√§n harjoittelua, ja voit pian nousta ammattilaisliigaan. Haluatko kokeilla toista kierrosta?",
      LOVER:
        "Hienoa! üëè Musiikin yst√§v√§n√§ olet osoittanut huomattavaa tiet√§myst√§. Olet oikealla tiell√§ tullaksesi todelliseksi musiikin tuntijaksi. Lis√§√§ peliharjoittelua, ja voit laajentaa tiet√§myst√§si ja parantaa pisteit√§si. Oletko valmis uuteen haasteeseen?",
      EXPLORER:
        "Kiitos pelaamisesta! üôè Musiikkitutkijana olet ottanut ensimm√§isen askeleen musiikin kiehtovan maailman l√∂yt√§misess√§. Jokainen peli on tilaisuus oppia jotain uutta. Haasta itsesi, pelaa lis√§√§ kierroksia ja laajenna musiikkitiet√§myst√§si!",
    },
  };

  /**
   * Gets the appropriate motivation text based on score and language
   *
   * @param {number} score - Player's score
   * @param {string} language - Current language code
   * @returns {string} The appropriate motivation text
   */
  function getMotivationText(score: number, language: string): string {
    // Get texts for the current language or fallback to English
    const texts =
      MOTIVATION_TEXTS[language as keyof typeof MOTIVATION_TEXTS] ||
      MOTIVATION_TEXTS.en;

    // Select text based on score threshold
    if (score >= ACHIEVEMENT_THRESHOLDS.GENIUS) return texts.GENIUS;
    if (score >= ACHIEVEMENT_THRESHOLDS.PRO) return texts.PRO;
    if (score >= ACHIEVEMENT_THRESHOLDS.ENTHUSIAST) return texts.ENTHUSIAST;
    if (score >= ACHIEVEMENT_THRESHOLDS.LOVER) return texts.LOVER;
    return texts.EXPLORER;
  }

  /**
   * Initialize EndOverlay with dynamic motivation text
   */
  function initializeEndOverlay(): void {
    const popup = document.getElementById("endgame-popup");

    if (!popup) {
      console.debug("EndOverlay: popup element not found");
      return;
    }

    // Set up an observer to update motivation text when the popup becomes visible
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (
          mutation.type === "attributes" &&
          mutation.attributeName === "class" &&
          !popup.classList.contains("hidden")
        ) {
          // Update motivation text when popup is shown
          updateMotivationText(popup);
          
          // Animate score bar
          animateScoreBar(popup);
          
          // Announce achievement for screen readers
          announceAchievement(popup);
        }
      });
    });

    // Start observing the popup for class changes
    observer.observe(popup, { attributes: true, attributeFilter: ["class"] });

    // Initial update in case the popup is already visible
    if (!popup.classList.contains("hidden")) {
      updateMotivationText(popup);
      animateScoreBar(popup);
    }

    // Set up sharing functionality
    initializeSharing();
    
    // Improve keyboard interaction
    improveKeyboardInteraction(popup);
  }
  
  /**
   * Creates an animated progress bar based on the score
   * 
   * @param {HTMLElement} popup - The popup element 
   */
  function animateScoreBar(popup: HTMLElement): void {
    const scoreAttr = popup.getAttribute("data-score");
    const score = scoreAttr ? parseInt(scoreAttr) : 0;
    
    // Calculate percentage of max possible score (1000)
    const percentage = Math.min(Math.max(score / 10, 5), 100); // Min 5%, max 100%
    
    const scoreBar = document.getElementById("score-bar");
    if (scoreBar) {
      // Trigger animation
      setTimeout(() => {
        scoreBar.style.width = `${percentage}%`;
      }, 200);
    }
    
    // Update difficulty display
    const difficultyDisplay = document.getElementById("difficulty-display");
    const difficulty = popup.getAttribute("data-difficulty") || "";
    
    if (difficultyDisplay) {
      const lang = document.documentElement.lang || "en";
      const difficultyText = getDifficultyText(difficulty, lang);
      difficultyDisplay.textContent = difficultyText;
    }
  }
  
  /**
   * Gets the translated difficulty text
   */
  function getDifficultyText(difficulty: string, lang: string): string {
    // Simple translation mapping
    const translations: Record<string, Record<string, string>> = {
      en: {
        easy: "Easy",
        medium: "Medium",
        hard: "Hard"
      },
      de: {
        easy: "Einfach",
        medium: "Mittel",
        hard: "Schwer"
      }
    };
    
    // Get translation or fallback to English
    return translations[lang]?.[difficulty] || 
           translations.en[difficulty] || 
           difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
  }
  
  /**
   * Announces achievement level for screen readers
   */
  function announceAchievement(popup: HTMLElement): void {
    const scoreAttr = popup.getAttribute("data-score");
    const score = scoreAttr ? parseInt(scoreAttr) : 0;
    
    // Create an ARIA live region for announcements
    let ariaLive = document.getElementById("achievement-announcement");
    if (!ariaLive) {
      ariaLive = document.createElement("div");
      ariaLive.id = "achievement-announcement";
      ariaLive.setAttribute("aria-live", "assertive");
      ariaLive.setAttribute("aria-atomic", "true");
      ariaLive.className = "sr-only";
      document.body.appendChild(ariaLive);
    }
    
    // Get achievement level based on score
    let achievementLevel = "";
    if (score >= ACHIEVEMENT_THRESHOLDS.GENIUS) achievementLevel = "genius";
    else if (score >= ACHIEVEMENT_THRESHOLDS.PRO) achievementLevel = "pro";
    else if (score >= ACHIEVEMENT_THRESHOLDS.ENTHUSIAST) achievementLevel = "enthusiast";
    else if (score >= ACHIEVEMENT_THRESHOLDS.LOVER) achievementLevel = "lover";
    else achievementLevel = "explorer";
    
    // Get language and create announcement
    const lang = document.documentElement.lang || "en";
    const announcement = lang === "de" 
      ? `Spielende! Deine Punktzahl: ${score}. Erreichtes Level: ${achievementLevel}.`
      : `Game over! Your score: ${score}. Achievement level: ${achievementLevel}.`;
    
    // Make the announcement
    ariaLive.textContent = announcement;
    
    // Clean up after announcement is likely read
    setTimeout(() => {
      ariaLive.textContent = "";
    }, 3000);
  }
  
  /**
   * Improves keyboard interaction with the popup
   */
  function improveKeyboardInteraction(popup: HTMLElement): void {
    // Trap focus within the modal
    popup.addEventListener("keydown", (e) => {
      // Skip if the popup is hidden
      if (popup.classList.contains("hidden")) return;
      
      if (e.key === "Escape") {
        // Close modal on Escape
        document.getElementById("restart-button")?.click();
        return;
      }
      
      if (e.key !== "Tab") return;
      
      // Find all focusable elements
      const focusableElements = popup.querySelectorAll<HTMLElement>(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      
      if (focusableElements.length === 0) return;
      
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];
      
      // Handle tab navigation to maintain focus trap
      if (e.shiftKey && document.activeElement === firstElement) {
        e.preventDefault();
        lastElement.focus();
      } else if (!e.shiftKey && document.activeElement === lastElement) {
        e.preventDefault();
        firstElement.focus();
      }
    });
    
    // Focus first element when opened
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === "class" && !popup.classList.contains("hidden")) {
          // Focus the popup content
          const content = popup.querySelector(".popupContent") as HTMLElement;
          if (content) {
            setTimeout(() => content.focus(), 100);
          }
        }
      });
    });
    
    observer.observe(popup, { attributes: true });
  }

  /**
   * Updates the motivation text based on current score
   *
   * @param {HTMLElement} popup - The popup element
   */
  function updateMotivationText(popup: HTMLElement): void {
    const scoreAttr = popup.getAttribute("data-score");
    const score = scoreAttr ? parseInt(scoreAttr) : 0;

    const lang = document.documentElement.lang || "en";
    const motivationElement = document.getElementById("motivation-text");

    if (motivationElement) {
      motivationElement.textContent = getMotivationText(score, lang);
    }

    // Also update the visible score
    const scoreElement = document.getElementById("popup-score");
    if (scoreElement) {
      scoreElement.textContent = score.toString();
    }
  }

  /**
   * Initialize sharing functionality for the End Overlay
   * (Rest of the sharing functionality remains the same as before)
   */
  function initializeSharing(): void {
    // Select all share buttons (elements with data-share attribute)
    const shareButtons = document.querySelectorAll<HTMLElement>("[data-share]");

    if (!shareButtons.length) {
      console.debug("No share buttons found in EndOverlay");
      return;
    }

    // Add click event listeners to each button
    shareButtons.forEach((button) => {
      button.addEventListener("click", handleShareButtonClick);
    });
  }

  /**
   * Handle click events on share buttons
   *
   * Extracts sharing platform from the button's data attribute
   * and collects game data from the popup before invoking the sharing function.
   *
   * @param {MouseEvent} event - The click event object
   */
  function handleShareButtonClick(event: MouseEvent): void {
    // Get the sharing platform from the button's data attribute
    const button = event.currentTarget as HTMLElement;
    const platform = button.dataset.share;

    if (!platform) {
      console.warn("Share button clicked but no platform specified");
      return;
    }

    // Get the game data from the popup element
    const shareData = getGameDataFromPopup();
    if (!shareData) return;

    // Call the sharing function with the collected data
    try {
      shareScore(platform, shareData);
    } catch (error) {
      console.error(`Failed to share score to ${platform}:`, error);
    }
  }

  /**
   * Extract game data from the end game popup
   *
   * @returns {import("../../utils/share/shareUtils").ShareData|null} The extracted game data or null if popup not found
   */
  function getGameDataFromPopup():
    | import("../../utils/share/shareUtils").ShareData
    | null {
    const popup = document.querySelector("#endgame-popup");

    if (!popup) {
      console.error("EndOverlay: Cannot find game popup element");
      return null;
    }

    // Extract and parse game data from popup attributes
    const score = parseInt(popup.getAttribute("data-score") || "0");
    const category = popup.getAttribute("data-category") || "";
    const difficulty = popup.getAttribute("data-difficulty") || "";

    return { score, category, difficulty };
  }

  // Initialize the overlay when the DOM is fully loaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeEndOverlay);
  } else {
    initializeEndOverlay();
  }

  // Clean up event listeners when the component is removed
  document.addEventListener("astro:before-swap", () => {
    document.querySelectorAll("[data-share]").forEach((button) => {
      (button as HTMLElement).removeEventListener(
        "click",
        handleShareButtonClick,
      );
    });
    
    // Remove any ARIA live regions we created
    document.getElementById("achievement-announcement")?.remove();
  });
</script>

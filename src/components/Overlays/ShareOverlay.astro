---
/**
 * ShareOverlay Component
 * 
 * A high-performance sharing component that provides multiple ways to share game results
 * with advanced multilingual support and accessibility features.
 * 
 * Features responsive design, native Web Share API integration, platform-specific sharing,
 * and comprehensive error handling with fallback options.
 * 
 * @component
 * @example
 * <ShareOverlay gameData={gameData} />
 * <ShareOverlay gameData={gameData} showTitle={false} />
 * <ShareOverlay shareGroupLabel="Custom share buttons" showFallback={false} />
 */

import { Icon } from "astro-icon/components";
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import type { ShareData } from "@utils/share/shareUtils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

/**
 * Props for the ShareOverlay component
 * @interface Props
 * @property {ShareData} [gameData] - Game data to share (if not provided, component will attempt to extract from DOM)
 * @property {string} [shareGroupLabel] - Custom aria-label for the share buttons group
 * @property {boolean} [showFallback] - Whether to show fallback content when no game data is available
 * @property {boolean} [showTitle] - Whether to show the component title
 */
export interface Props {
  /** Game data to share - if not provided, component will attempt to extract from DOM */
  gameData?: ShareData;
  /** Custom aria-label for the share buttons group */
  shareGroupLabel?: string;
  /** Whether to show fallback content when no game data is available */
  showFallback?: boolean;
  /** Whether to show the title */
  showTitle?: boolean;
}

const {
  gameData,
  shareGroupLabel = t("share.buttons.group.label"),
  showFallback = true,
  showTitle = true,
} = Astro.props;
---

<div class="share-overlay" data-game-data={gameData ? JSON.stringify(gameData) : ""}>
  {showTitle && <h3 class="share-overlay__title">{t("share.title")}</h3>}

  <!-- Status announcer for screen readers -->
  <div id="share-status-announcer" aria-live="polite" aria-atomic="true" class="sr-only"></div>

  <div
    id="share-buttons-container"
    class="share-overlay__buttons-container"
    role="group"
    aria-label={shareGroupLabel}
  >
    <!-- Native Web Share API Button (hidden by default, shown when supported) -->
    <button
      id="native-share-button"
      class="share-overlay__button share-overlay__button--native share-overlay__button--hidden"
      aria-label={t("share.native")}
      type="button"
    >
      <Icon name="share" width={24} height={24} class="share-overlay__icon" aria-hidden="true" />
      <span class="share-overlay__button-text">{t("share.native.label")}</span>
    </button>

    <!-- Twitter/X Share -->
    <button
      class="share-overlay__button share-overlay__button--twitter"
      data-share="twitter"
      aria-label={t("share.twitter")}
      type="button"
    >
      <Icon name="twitter" width={24} height={24} class="share-overlay__icon" aria-hidden="true" />
      <span class="share-overlay__button-text">X</span>
    </button>

    <!-- WhatsApp Share -->
    <button
      class="share-overlay__button share-overlay__button--whatsapp"
      data-share="whatsapp"
      aria-label={t("share.whatsapp")}
      type="button"
    >
      <Icon name="whatsapp" width={24} height={24} class="share-overlay__icon" aria-hidden="true" />
      <span class="share-overlay__button-text">WhatsApp</span>
    </button>

    <!-- Email Share -->
    <button
      class="share-overlay__button share-overlay__button--email"
      data-share="email"
      aria-label={t("share.email")}
      type="button"
    >
      <Icon name="mail" width={24} height={24} class="share-overlay__icon" aria-hidden="true" />
      <span class="share-overlay__button-text">{t("share.email.label")}</span>
    </button>
  </div>

  <!-- Copy to Clipboard Button -->
  <div class="share-overlay__clipboard-section">
    <button
      id="copy-share-button"
      class="share-overlay__clipboard-button"
      aria-label={t("share.copy")}
      type="button"
    >
      <Icon
        name="clipboard"
        width={20}
        height={20}
        class="share-overlay__clipboard-icon"
        aria-hidden="true"
      />
      <span class="share-overlay__clipboard-text" id="copy-button-text"
        >{t("share.copy.label")}</span
      >
    </button>
  </div>

  <!-- Fallback Content when Game Data is Unavailable -->
  {
    showFallback && (
      <div id="share-fallback-content" class="share-overlay__fallback" style="display: none;">
        <div class="share-overlay__fallback-message">
          <Icon
            name="alert-circle"
            width={24}
            height={24}
            class="share-overlay__fallback-icon"
            aria-hidden="true"
          />
          <p class="share-overlay__fallback-text">{t("share.fallback.message")}</p>
        </div>
        <div class="share-overlay__fallback-actions">
          <button
            id="retry-share-button"
            class="share-overlay__fallback-button"
            type="button"
            aria-label={t("share.fallback.retry.label")}
          >
            <Icon
              name="refresh"
              width={16}
              height={16}
              class="share-overlay__fallback-button-icon"
              aria-hidden="true"
            />
            {t("share.fallback.retry.text")}
          </button>
          <button
            id="manual-copy-button"
            class="share-overlay__fallback-button share-overlay__fallback-button--secondary"
            type="button"
            aria-label={t("share.fallback.manual.label")}
          >
            <Icon
              name="clipboard"
              width={16}
              height={16}
              class="share-overlay__fallback-button-icon"
              aria-hidden="true"
            />
            {t("share.fallback.manual.text")}
          </button>
        </div>
      </div>
    )
  }
</div>

<style lang="scss">
  /* ======================================
   * SHARE OVERLAY COMPONENT STYLES
   * Optimized for performance with global.css integration
   * ====================================== */

  /**
   * Main container with performance optimizations
   * Uses CSS containment and hardware acceleration
   */
  .share-overlay {
    margin-top: var(--space-xl);
    text-align: center;
    contain: layout style;
    
    @media (min-width: 48em) {
      margin-top: var(--space-2xl);
    }

    /**
     * Component title with responsive typography
     * Uses global typography scale and color system
     */
    &__title {
      margin-bottom: var(--space-lg);
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      font-family: var(--font-family-primary);
      line-height: var(--leading-tight);
      
      @media (min-width: 48em) {
        font-size: var(--text-2xl);
        margin-bottom: var(--space-xl);
      }
      
      @media (min-width: 64em) {
        font-size: var(--text-3xl);
      }
    }

    /**
     * Share buttons container with responsive flex layout
     * Uses flexbox for better responsive control and spacing
     */
    &__buttons-container {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-md);
      margin-top: var(--space-lg);
      justify-content: center;
      align-items: center;
      max-width: 100%;
      
      @media (max-width: 47.9375em) {
        flex-direction: column;
        gap: var(--space-sm);
        max-width: 100%;
        margin: var(--space-lg) auto 0;
      }
      
      @media (min-width: 48em) {
        flex-direction: row;
        gap: var(--space-lg);
        max-width: 600px;
        margin: var(--space-xl) auto 0;
      }
      
      @media (min-width: 64em) {
        gap: var(--space-xl);
        max-width: 700px;
      }
    }

    /**
     * Icon styles with performance optimizations
     * Uses global icon sizing variables and hardware acceleration
     */
    &__icon,
    &__clipboard-icon,
    &__fallback-icon,
    &__fallback-button-icon {
      flex-shrink: 0;
      transform: translate3d(0, 0, 0);
      will-change: transform;
      transition: transform var(--transition-fast);
    }

    &__icon {
      width: var(--icon-size-md);
      height: var(--icon-size-md);
      
      @media (max-width: 47.9375em) {
        width: var(--icon-size-sm);
        height: var(--icon-size-sm);
      }
    }

    &__clipboard-icon {
      width: var(--icon-size-sm);
      height: var(--icon-size-sm);
      
      @media (max-width: 47.9375em) {
        width: 16px;
        height: 16px;
      }
    }

    /**
     * Base button styles with enhanced performance and accessibility
     * Uses global design tokens and hardware acceleration
     */
    &__button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      min-height: var(--min-touch-size);
      min-width: var(--min-touch-size);
      padding: var(--space-md) var(--space-lg);
      border: none;
      border-radius: var(--radius-lg);
      font-size: var(--text-base);
      font-weight: var(--font-medium);
      color: var(--text-primary);
      background: var(--bg-tertiary);
      cursor: pointer;
      font-family: var(--font-family-primary);
      transition: all var(--transition-fast);
      
      /* Performance optimizations with hardware acceleration */
      contain: layout style paint;
      transform: translate3d(0, 0, 0);
      will-change: transform, background-color;
      backface-visibility: hidden;

      /* Enhanced focus styles for WCAG AAA */
      &:focus-visible {
        outline: var(--focus-enhanced-outline-dark);
        outline-offset: var(--focus-ring-offset);
        box-shadow: var(--focus-enhanced-shadow);
      }

      /* Hover effects with hardware acceleration */
      &:hover:not(:disabled) {
        transform: translate3d(0, var(--animation-y-offset-small), 0);
        box-shadow: var(--shadow-lg);
      }

      &:active:not(:disabled) {
        transform: translate3d(0, 0, 0) scale(var(--animation-scale-hover));
        transition: transform var(--transition-fast);
      }

      /* Disabled state */
      &:disabled {
        opacity: var(--opacity-disabled);
        cursor: not-allowed;
        transform: translate3d(0, 0, 0);
      }

      /* Performance cleanup */
      &:not(:hover):not(:focus) {
        will-change: auto;
      }
      
      /* Responsive sizing */
      @media (max-width: 47.9375em) {
        padding: var(--space-md) var(--space-lg);
        font-size: var(--text-sm);
        gap: var(--space-sm);
        width: 100%;
        max-width: 280px;
        min-height: var(--touch-target-enhanced);
      }
      
      @media (min-width: 48em) {
        padding: var(--space-md) var(--space-lg);
        min-width: 120px;
        flex: 1;
        max-width: 140px;
      }
      
      @media (min-width: 64em) {
        padding: var(--space-lg) var(--space-xl);
        min-width: 140px;
        max-width: 160px;
      }

      /**
       * Button variants with platform-specific styling
       * Uses global color system for consistency
       */
      
      /* Native Share Button */
      &--native {
        background: var(--interactive-primary);
        color: var(--btn-primary-text);

        &:hover:not(:disabled) {
          background: var(--interactive-primary-hover);
        }

        &:active:not(:disabled) {
          background: var(--interactive-primary-active);
        }

        &.share-overlay__button--visible {
          display: flex;
        }
      }

      &--hidden {
        display: none;
      }

      /* Twitter/X Button */
      &--twitter {
        background: var(--color-neutral-800);
        color: var(--color-white);

        &:hover:not(:disabled) {
          background: var(--color-neutral-700);
        }

        &:active:not(:disabled) {
          background: var(--color-neutral-900);
        }
      }

      /* WhatsApp Button */
      &--whatsapp {
        background: var(--color-success-600);
        color: var(--color-white);

        &:hover:not(:disabled) {
          background: var(--color-success-500);
        }

        &:active:not(:disabled) {
          background: var(--color-success-700);
        }
      }

      /* Email Button */
      &--email {
        background: var(--color-warning-600);
        color: var(--color-white);

        &:hover:not(:disabled) {
          background: var(--color-warning-500);
        }

        &:active:not(:disabled) {
          background: var(--color-warning-700);
        }
      }
    }

    /**
     * Clipboard section with enhanced spacing and responsive layout
     * Uses global spacing system for consistency
     */
    &__clipboard-section {
      margin-top: var(--space-xl);
      
      @media (min-width: 48em) {
        margin-top: var(--space-2xl);
      }
    }

    /**
     * Clipboard button with enhanced accessibility and performance
     * Features distinct styling and state management
     */
    &__clipboard-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      min-height: var(--min-touch-size);
      min-width: var(--min-touch-size);
      padding: var(--space-md) var(--space-lg);
      border: var(--border-width-thick) solid var(--interactive-secondary);
      border-radius: var(--radius-lg);
      background: transparent;
      font-size: var(--text-base);
      font-weight: var(--font-medium);
      color: var(--interactive-secondary);
      cursor: pointer;
      font-family: var(--font-family-primary);
      transition: all var(--transition-fast);
      
      /* Performance optimizations */
      contain: layout style paint;
      transform: translate3d(0, 0, 0);
      will-change: transform, background-color;
      backface-visibility: hidden;

      /* Enhanced focus styles for WCAG AAA */
      &:focus-visible {
        outline: var(--focus-enhanced-outline-dark);
        outline-offset: var(--focus-ring-offset);
        box-shadow: var(--focus-enhanced-shadow);
      }

      &:hover:not(:disabled) {
        border-color: var(--interactive-primary);
        color: var(--interactive-primary);
        background: var(--bg-tertiary);
        transform: translate3d(0, var(--animation-y-offset-small), 0);
      }

      &:active:not(:disabled) {
        transform: translate3d(0, 0, 0) scale(var(--animation-scale-hover));
      }

      &:disabled {
        opacity: var(--opacity-disabled);
        cursor: not-allowed;
        transform: translate3d(0, 0, 0);
      }

      &:not(:hover):not(:focus) {
        will-change: auto;
      }

      /* Success state for clipboard button */
      &--success {
        background: var(--bg-success-aaa);
        border-color: var(--color-success-500);
        color: var(--text-success-aaa);
      }

      /* Error state for clipboard button */
      &--error {
        background: var(--bg-error-aaa);
        border-color: var(--color-error-500);
        color: var(--text-error-aaa);
      }
      
      /* Responsive sizing */
      @media (max-width: 47.9375em) {
        padding: var(--space-md) var(--space-lg);
        font-size: var(--text-sm);
        gap: var(--space-sm);
        width: 100%;
        max-width: 280px;
        min-height: var(--touch-target-enhanced);
      }
      
      @media (min-width: 48em) {
        padding: var(--space-md) var(--space-xl);
        min-width: 160px;
        max-width: 200px;
      }
      
      @media (min-width: 64em) {
        padding: var(--space-lg) var(--space-xl);
        min-width: 180px;
        max-width: 220px;
      }
    }

    /**
     * Fallback content with enhanced accessibility and responsive design
     * Provides alternative when game data is unavailable
     */
    &__fallback {
      margin-top: var(--space-xl);
      padding: var(--space-lg);
      border: var(--border-width-thin) solid var(--color-warning-500);
      border-radius: var(--radius-lg);
      background: var(--bg-warning-aaa);
      text-align: center;
      contain: layout style;
      
      @media (min-width: 48em) {
        margin-top: var(--space-2xl);
        padding: var(--space-xl);
      }

      &-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
        
        @media (min-width: 48em) {
          gap: var(--space-lg);
          margin-bottom: var(--space-xl);
        }
      }

      &-icon {
        color: var(--color-warning-600);
        width: var(--icon-size-md);
        height: var(--icon-size-md);
        flex-shrink: 0;
        transform: translate3d(0, 0, 0);
        
        @media (min-width: 48em) {
          width: var(--icon-size-lg);
          height: var(--icon-size-lg);
        }
      }

      &-text {
        color: var(--text-warning-aaa);
        font-size: var(--text-base);
        font-family: var(--font-family-primary);
        margin: 0;
        line-height: var(--leading-relaxed);
        max-width: 400px;
        
        @media (min-width: 48em) {
          font-size: var(--text-lg);
        }
      }

      &-actions {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-md);
        justify-content: center;
        align-items: center;
        
        @media (max-width: 47.9375em) {
          flex-direction: column;
          gap: var(--space-sm);
        }
      }

      &-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        min-height: var(--min-touch-size);
        padding: var(--space-sm) var(--space-md);
        border: var(--border-width-thin) solid var(--interactive-primary);
        border-radius: var(--radius-md);
        background: var(--interactive-primary);
        color: var(--btn-primary-text);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        font-family: var(--font-family-primary);
        cursor: pointer;
        transition: all var(--transition-fast);
        
        /* Performance optimizations */
        contain: layout style paint;
        transform: translate3d(0, 0, 0);
        will-change: transform, background-color;

        /* Enhanced focus styles for WCAG AAA */
        &:focus-visible {
          outline: var(--focus-enhanced-outline-dark);
          outline-offset: var(--focus-ring-offset);
          box-shadow: var(--focus-enhanced-shadow);
        }

        &:hover:not(:disabled) {
          background: var(--interactive-primary-hover);
          border-color: var(--interactive-primary-hover);
          transform: translate3d(0, var(--animation-y-offset-small), 0);
        }

        &:active:not(:disabled) {
          background: var(--interactive-primary-active);
          border-color: var(--interactive-primary-active);
          transform: translate3d(0, 0, 0) scale(var(--animation-scale-hover));
        }

        &:disabled {
          opacity: var(--opacity-disabled);
          cursor: not-allowed;
          transform: translate3d(0, 0, 0);
        }

        &--secondary {
          background: transparent;
          color: var(--color-warning-200);
          border-color: var(--color-warning-500);

          &:hover:not(:disabled) {
            background: var(--color-warning-900);
            border-color: var(--color-warning-400);
            color: var(--color-warning-100);
          }

          &:active:not(:disabled) {
            background: var(--color-warning-800);
          }
        }

        &-icon {
          width: var(--icon-size-sm);
          height: var(--icon-size-sm);
          flex-shrink: 0;
          transform: translate3d(0, 0, 0);
        }
        
        /* Responsive sizing */
        @media (max-width: 47.9375em) {
          width: 100%;
          max-width: 280px;
          padding: var(--space-md) var(--space-lg);
          min-height: var(--touch-target-enhanced);
        }
        
        @media (min-width: 48em) {
          padding: var(--space-sm) var(--space-lg);
          min-width: 120px;
          max-width: 140px;
        }
      }
    }

    /**
     * Text styles with responsive typography
     * Uses global typography scale for consistency
     */
    &__button-text,
    &__clipboard-text {
      font-size: var(--text-base);
      white-space: nowrap;
      line-height: var(--leading-base);
      
      @media (max-width: 47.9375em) {
        font-size: var(--text-sm);
      }
    }
  }

  /* ======================================
   * ACCESSIBILITY ENHANCEMENTS
   * ====================================== */

  /**
   * High contrast mode support for Windows High Contrast
   * Ensures proper visibility and interaction
   */
  @media (forced-colors: active) {
    .share-overlay__button,
    .share-overlay__clipboard-button,
    .share-overlay__fallback-button {
      border: var(--border-width-thick) solid ButtonText;
      background-color: ButtonFace;
      color: ButtonText;
      forced-color-adjust: none;

      &:focus-visible {
        outline: var(--border-width-enhanced) solid Highlight;
        outline-offset: var(--focus-ring-offset);
      }
    }

    .share-overlay__icon,
    .share-overlay__clipboard-icon,
    .share-overlay__fallback-icon {
      fill: ButtonText;
    }
  }

  /**
   * Reduced motion support - respects user preference
   * Disables animations and transitions for accessibility
   */
  @media (prefers-reduced-motion: reduce) {
    .share-overlay__button,
    .share-overlay__clipboard-button,
    .share-overlay__fallback-button {
      will-change: auto;
      transition: none;

      &:hover,
      &:active {
        transform: translate3d(0, 0, 0);
      }
    }

    .share-overlay__icon,
    .share-overlay__clipboard-icon,
    .share-overlay__fallback-icon {
      transition: none;
    }
  }

  /**
   * High contrast preference support
   * Enhances borders for better visibility
   */
  @media (prefers-contrast: high) {
    .share-overlay__button {
      border: var(--border-width-thick) solid var(--text-primary);
    }

    .share-overlay__clipboard-button {
      border-width: var(--border-width-enhanced);
    }

    .share-overlay__fallback {
      border-width: var(--border-width-thick);
    }
  }

  /* ======================================
   * SCREEN READER ONLY UTILITY
   * ====================================== */

  .sr-only {
    position: absolute;
    width: var(--sr-only-width);
    height: var(--sr-only-height);
    padding: 0;
    margin: var(--sr-only-margin);
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* ======================================
   * PERFORMANCE OPTIMIZATIONS
   * ====================================== */

  /**
   * Icon rendering optimizations
   * Improves visual quality and performance
   */
  .share-overlay__icon,
  .share-overlay__clipboard-icon,
  .share-overlay__fallback-icon {
    will-change: auto;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }

  /* ======================================
   * ENHANCED TEXT SPACING SUPPORT (WCAG 2.2)
   * ====================================== */

  .enhanced-text-spacing .share-overlay {
    .share-overlay__button,
    .share-overlay__clipboard-button,
    .share-overlay__fallback-button {
      letter-spacing: var(--text-spacing-letter-2x) !important;
      word-spacing: var(--text-spacing-word-enhanced) !important;
      line-height: var(--text-spacing-line-1-5x) !important;
      padding: calc(var(--space-md) * 1.2) calc(var(--space-lg) * 1.2);
    }

    .share-overlay__buttons-container {
      gap: calc(var(--space-md) * 1.5) !important;
    }

    .share-overlay__fallback-text {
      margin-bottom: calc(var(--space-lg) * 1.2) !important;
    }
  }
</style>

<script
  is:inline
  define:vars={{
    // Share accessibility translations
    shareAccessibilityDataUnavailable: t("share.accessibility.data_unavailable"),
    shareAccessibilityRetrying: t("share.accessibility.retrying"),
    shareAccessibilityDataFound: t("share.accessibility.data_found"),
    shareAccessibilityDataStillUnavailable: t("share.accessibility.data_still_unavailable"),
    shareAccessibilityRetryFailed: t("share.accessibility.retry_failed"),
    shareAccessibilityLinkCopiedFallback: t("share.accessibility.link_copied_fallback"),
    shareAccessibilityCopyFailedManual: t("share.accessibility.copy_failed_manual"),
    shareAccessibilityScoreShared: t("share.accessibility.score_shared"),
    shareAccessibilitySharingCancelled: t("share.accessibility.sharing_cancelled"),
    shareAccessibilityPlatformShareFailed: t("share.accessibility.platform_share_failed"),
    shareAccessibilityTryAlternativeMethods: t("share.accessibility.try_alternative_methods"),
    shareAccessibilityScoreCopied: t("share.accessibility.score_copied"),
    shareAccessibilityNativeShareFailed: t("share.accessibility.native_share_failed"),
    shareAccessibilityTryPlatformButtons: t("share.accessibility.try_platform_buttons"),
    shareAccessibilityPlatformOpened: t("share.accessibility.platform_opened"),
  }}
>
  /**
   * ShareOverlay Component Enhancement Script
   * 
   * Provides comprehensive sharing functionality with performance optimizations
   * and accessibility features. Supports native Web Share API, platform-specific
   * sharing, and clipboard operations with robust error handling.
   * 
   * @features
   * - Native Web Share API integration with fallback support
   * - Platform-specific sharing (Twitter/X, WhatsApp, Email)
   * - Advanced clipboard operations with multiple fallback methods
   * - Comprehensive error handling and user feedback
   * - Performance-optimized DOM element caching
   * - Accessibility-first design with screen reader support
   * - Multilingual share text generation
   * - Responsive touch and keyboard interaction support
   */

  /**
   * Error types for comprehensive error handling
   * @enum {string}
   */
  const ShareErrorType = {
    NO_DATA: "NO_DATA",
    CLIPBOARD_FAILED: "CLIPBOARD_FAILED",
    NATIVE_SHARE_FAILED: "NATIVE_SHARE_FAILED",
    PLATFORM_SHARE_FAILED: "PLATFORM_SHARE_FAILED",
    NETWORK_ERROR: "NETWORK_ERROR",
    PERMISSION_DENIED: "PERMISSION_DENIED",
  };

  /**
   * Cached DOM element references for performance optimization
   * Prevents repeated DOM queries and improves rendering efficiency
   * @type {Object}
   */
  const elements = {
    nativeShareButton: null,
    copyButton: null,
    copyButtonText: null,
    statusAnnouncer: null,
    shareButtons: null,
    fallbackContent: null,
    retryButton: null,
    manualCopyButton: null,
  };

  /**
   * UI interaction constants for consistent behavior
   * @type {Object}
   */
  const UI_CONSTANTS = {
    COPY_SUCCESS_DURATION: 2000,
    COPY_ORIGINAL_TEXT: "",
    ANIMATION_DURATION: 200,
  };

  // Initialize the sharing functionality
  const initializeSharing = async () => {
    cacheElements();

    if (!elements.statusAnnouncer || !elements.copyButton) {
      console.warn("ShareOverlay: Required elements not found");
      return;
    }

    UI_CONSTANTS.COPY_ORIGINAL_TEXT = elements.copyButtonText?.textContent || "";

    initializeNativeSharing();
    initializeClipboardCopy();
    initializePlatformSharing();
    initializeFallbackHandlers();
    setupCleanupHandlers();

    // Try to validate game data with retries
    await validateGameDataWithRetries();
  };

  // Validate game data with retries
  const validateGameDataWithRetries = async () => {
    const maxRetries = 10;
    const retryDelay = 500; // 500ms

    for (let i = 0; i < maxRetries; i++) {
      const gameData = getGameDataFromProps() || getGameDataFromPopup();

      console.log(`ShareOverlay: Validation attempt ${i + 1}/${maxRetries}:`, gameData);

      if (gameData && isValidShareData(gameData)) {
        console.log("ShareOverlay: Game data validation successful");
        return;
      }

      if (i < maxRetries - 1) {
        console.log(`ShareOverlay: Retrying in ${retryDelay}ms...`);
        await new Promise((resolve) => setTimeout(resolve, retryDelay));
      }
    }

    console.warn("ShareOverlay: Game data validation failed after all retries, showing fallback");
    showFallbackContent();
  };

  // Get game data from component props
  const getGameDataFromProps = () => {
    const overlay = document.querySelector(".share-overlay");
    if (!overlay) {
      return null;
    }

    const propsData = overlay.getAttribute("data-game-data");
    if (!propsData) {
      return null;
    }

    try {
      const data = JSON.parse(propsData);

      // Always prefer the current score from DOM over props
      const popup =
        document.querySelector("#endgame-popup") ||
        document.querySelector("#end-overlay") ||
        document.querySelector(".popup[data-score]");
      if (popup) {
        const currentScore = popup.querySelector("#popup-score");
        if (currentScore && currentScore.textContent) {
          const score = parseInt(currentScore.textContent, 10);
          if (!isNaN(score)) {
            data.score = score;
          }
        }
      }
      return data;
    } catch (error) {
      console.error("ShareOverlay: Error parsing props data:", error);
      return null;
    }
  };

  // Validate share data
  const isValidShareData = (data) => {
    if (!data || typeof data !== "object") {
      console.log("ShareOverlay: Invalid data - not an object:", data);
      return false;
    }

    // Check score
    if (typeof data.score !== "number" || data.score < 0) {
      console.log("ShareOverlay: Invalid score:", data.score);
      return false;
    }

    // Check category
    if (!data.category || typeof data.category !== "string" || data.category.trim().length === 0) {
      console.log("ShareOverlay: Invalid category:", data.category);
      return false;
    }

    // Check difficulty
    if (
      !data.difficulty ||
      typeof data.difficulty !== "string" ||
      data.difficulty.trim().length === 0
    ) {
      console.log("ShareOverlay: Invalid difficulty:", data.difficulty);
      return false;
    }

    const validDifficulties = ["easy", "medium", "hard"];
    if (data.difficulty && !validDifficulties.includes(data.difficulty.toLowerCase())) {
      console.log("ShareOverlay: Invalid difficulty value:", data.difficulty);
      return false;
    }

    console.log("ShareOverlay: Data validation successful:", data);
    return true;
  };

  // Show fallback content
  const showFallbackContent = () => {
    if (!elements.fallbackContent) {
      return;
    }

    const shareContainer = document.getElementById("share-buttons-container");
    const clipboardSection = document.querySelector(".share-overlay__clipboard-section");

    if (shareContainer) {
      shareContainer.style.display = "none";
    }
    if (clipboardSection) {
      clipboardSection.style.display = "none";
    }

    elements.fallbackContent.style.display = "block";
    announceToScreenReader(shareAccessibilityDataUnavailable);
  };

  // Hide fallback content
  const hideFallbackContent = () => {
    if (!elements.fallbackContent) {
      return;
    }

    const shareContainer = document.getElementById("share-buttons-container");
    const clipboardSection = document.querySelector(".share-overlay__clipboard-section");

    if (shareContainer) {
      shareContainer.style.display = "flex";
    }
    if (clipboardSection) {
      clipboardSection.style.display = "block";
    }

    elements.fallbackContent.style.display = "none";
  };

  // Initialize fallback handlers
  const initializeFallbackHandlers = () => {
    if (elements.retryButton) {
      elements.retryButton.addEventListener("click", handleRetryAction);
    }

    if (elements.manualCopyButton) {
      elements.manualCopyButton.addEventListener("click", handleManualCopyAction);
    }
  };

  // Handle retry action
  const handleRetryAction = async () => {
    if (!elements.retryButton) {
      return;
    }

    elements.retryButton.disabled = true;
    announceToScreenReader(shareAccessibilityRetrying);

    try {
      await new Promise((resolve) => setTimeout(resolve, 500));

      const gameData = getGameDataFromProps() || getGameDataFromPopup();

      if (gameData && isValidShareData(gameData)) {
        hideFallbackContent();
        announceToScreenReader(shareAccessibilityDataFound);
      } else {
        announceToScreenReader(shareAccessibilityDataStillUnavailable);
      }
    } catch (error) {
      console.warn("Error during retry:", error);
      announceToScreenReader(shareAccessibilityRetryFailed);
    } finally {
      elements.retryButton.disabled = false;
    }
  };

  // Handle manual copy action
  const handleManualCopyAction = async () => {
    if (!elements.manualCopyButton) {
      return;
    }

    elements.manualCopyButton.disabled = true;

    try {
      const fallbackText = `Check out this music quiz game! ${window.location.href}`;
      await copyTextFallback(fallbackText);
      announceToScreenReader(shareAccessibilityLinkCopiedFallback);

      // Update button text temporarily
      const originalText = elements.manualCopyButton.textContent;
      elements.manualCopyButton.textContent = "✓ Copied!";
      setTimeout(() => {
        if (elements.manualCopyButton && originalText) {
          elements.manualCopyButton.textContent = originalText;
        }
      }, 2000);
    } catch (error) {
      console.warn("Manual copy failed:", error);
      announceToScreenReader(shareAccessibilityCopyFailedManual);
    } finally {
      elements.manualCopyButton.disabled = false;
    }
  };

  // Fallback copy method
  const copyTextFallback = async (text) => {
    if (navigator.clipboard && window.isSecureContext) {
      try {
        await navigator.clipboard.writeText(text);
        return;
      } catch (error) {
        console.warn("Clipboard API failed, using fallback:", error);
      }
    }

    const textarea = document.createElement("textarea");
    textarea.value = text;
    textarea.style.position = "fixed";
    textarea.style.left = "-999999px";
    textarea.style.top = "-999999px";

    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();

    try {
      const successful = document.execCommand("copy");
      if (!successful) {
        throw new Error("execCommand copy failed");
      }
    } finally {
      document.body.removeChild(textarea);
    }
  };

  // Cache DOM elements
  const cacheElements = () => {
    elements.nativeShareButton = document.getElementById("native-share-button");
    elements.copyButton = document.getElementById("copy-share-button");
    elements.copyButtonText = document.getElementById("copy-button-text");
    elements.statusAnnouncer = document.getElementById("share-status-announcer");
    elements.shareButtons = document.querySelectorAll("[data-share]");
    elements.fallbackContent = document.getElementById("share-fallback-content");
    elements.retryButton = document.getElementById("retry-share-button");
    elements.manualCopyButton = document.getElementById("manual-copy-button");
  };

  // Initialize native sharing
  const initializeNativeSharing = () => {
    const nativeShareSupported = "share" in navigator;

    if (!nativeShareSupported || !elements.nativeShareButton) {
      return;
    }

    elements.nativeShareButton.classList.remove("share-overlay__button--hidden");
    elements.nativeShareButton.classList.add("share-overlay__button--visible");

    elements.nativeShareButton.addEventListener("click", async (event) => {
      const button = event.currentTarget;

      if (button.hasAttribute("disabled")) {
        return;
      }

      button.setAttribute("disabled", "disabled");

      try {
        const gameData = getGameDataFromProps() || getGameDataFromPopup();
        if (!gameData || !isValidShareData(gameData)) {
          await handleNativeShareError(ShareErrorType.NO_DATA, button);
          return;
        }

        const shareText = await generateAdvancedShareText(gameData);
        const shareData = {
          title: "Melody Mind Music Quiz",
          text: shareText,
          url: window.location.href,
        };

        if (navigator.canShare && !navigator.canShare(shareData)) {
          throw new Error("Share data not supported by this device");
        }

        await navigator.share(shareData);
        announceToScreenReader(shareAccessibilityScoreShared);
      } catch (err) {
        if (err.name === "AbortError") {
          announceToScreenReader(shareAccessibilitySharingCancelled);
        } else if (err.name === "NotAllowedError") {
          await handleNativeShareError(ShareErrorType.PERMISSION_DENIED, button, err);
        } else {
          await handleNativeShareError(ShareErrorType.NATIVE_SHARE_FAILED, button, err);
        }
      } finally {
        button.removeAttribute("disabled");
      }
    });
  };

  // Handle native share errors
  const handleNativeShareError = async (errorType, button, error) => {
    console.warn(`Native share error (${errorType}):`, error);

    const errorMessage = getErrorMessage(errorType);
    const recoveryMessage = getRecoveryMessage(errorType);

    announceToScreenReader(
      shareAccessibilityNativeShareFailed
        .replace("{errorMessage}", errorMessage)
        .replace("{recoveryMessage}", recoveryMessage)
    );

    if (errorType === ShareErrorType.NO_DATA) {
      setTimeout(() => {
        showFallbackContent();
      }, 1000);
    } else if (
      errorType === ShareErrorType.PERMISSION_DENIED ||
      errorType === ShareErrorType.NATIVE_SHARE_FAILED
    ) {
      announceToScreenReader(shareAccessibilityTryPlatformButtons);

      if (elements.copyButton) {
        elements.copyButton.style.border = "2px solid var(--color-warning-400)";
        setTimeout(() => {
          if (elements.copyButton) {
            elements.copyButton.style.border = "";
          }
        }, 3000);
      }
    }
  };

  // Initialize platform sharing
  const initializePlatformSharing = () => {
    if (!elements.shareButtons || !elements.shareButtons.length) {
      return;
    }

    document.addEventListener("click", async (event) => {
      const target = event.target;
      const button = target.closest("[data-share]");

      if (!button) {
        return;
      }

      event.preventDefault();

      if (button.hasAttribute("disabled")) {
        return;
      }

      const platform = button.getAttribute("data-share");
      if (!platform) {
        return;
      }

      button.setAttribute("disabled", "disabled");

      try {
        const gameData = getGameDataFromProps() || getGameDataFromPopup();
        if (!gameData || !isValidShareData(gameData)) {
          await handlePlatformShareError(ShareErrorType.NO_DATA, platform, button);
          return;
        }

        const shareText = await generateAdvancedShareText(gameData);
        const shareUrl = createShareUrl(platform, shareText);

        if (shareUrl) {
          window.open(shareUrl, "_blank", "width=600,height=400");
          announceToScreenReader(shareAccessibilityPlatformOpened.replace("{platform}", platform));
        } else {
          throw new Error(`Unsupported platform: ${platform}`);
        }
      } catch (err) {
        await handlePlatformShareError(ShareErrorType.PLATFORM_SHARE_FAILED, platform, button, err);
      } finally {
        setTimeout(() => {
          button.removeAttribute("disabled");
        }, 1000);
      }
    });
  };

  // Create platform-specific share URLs
  const createShareUrl = (platform, text) => {
    const encodedText = encodeURIComponent(text);
    const encodedUrl = encodeURIComponent(window.location.href);

    switch (platform) {
      case "twitter":
        return `https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}`;
      case "whatsapp":
        return `https://wa.me/?text=${encodedText}%20${encodedUrl}`;
      case "email":
        return `mailto:?subject=My Melody Mind Score&body=${encodedText}%0A%0A${encodedUrl}`;
      default:
        return null;
    }
  };

  // Generate advanced multilingual share text using shareUtils
  const generateAdvancedShareText = async (data) => {
    const { score, category, difficulty } = data;
    const currentLang = document.documentElement.lang || "en";

    try {
      // Import the generateShareTextForLanguage function from shareUtils
      const { generateShareTextForLanguage } = await import("/src/utils/share/shareUtils.ts");
      return generateShareTextForLanguage(data, currentLang);
    } catch (error) {
      console.warn("Failed to import shareUtils, using fallback:", error);

      // Fallback implementation for compatibility
      const achievement =
        score >= 800
          ? "🎵 Music Genius! 🎵"
          : score >= 600
            ? "🎧 Music Pro! 🎧"
            : score >= 400
              ? "🎸 Music Enthusiast! 🎸"
              : score >= 200
                ? "🎹 Music Lover! 🎹"
                : "🎼 Music Explorer! 🎼";

      const difficultyEmoji =
        difficulty.toLowerCase() === "easy"
          ? "🟢"
          : difficulty.toLowerCase() === "medium"
            ? "🟡"
            : difficulty.toLowerCase() === "hard"
              ? "🔴"
              : "⚪️";

      const scoreText = `I scored ${score} points in Melody Mind's ${category} quiz (${difficultyEmoji} ${difficulty})!`;
      const challenge = "Think you can beat me? Play now at:";

      return `${achievement}\n\n${scoreText}\n\n${challenge}`;
    }
  };

  // Handle platform share errors
  const handlePlatformShareError = async (errorType, platform, button, error) => {
    console.warn(`Platform share error for ${platform} (${errorType}):`, error);

    const errorMessage = getErrorMessage(errorType);
    const recoveryMessage = getRecoveryMessage(errorType);

    announceToScreenReader(
      shareAccessibilityPlatformShareFailed
        .replace("{platform}", platform)
        .replace("{errorMessage}", errorMessage)
        .replace("{recoveryMessage}", recoveryMessage)
    );

    if (errorType === ShareErrorType.NO_DATA) {
      setTimeout(() => {
        showFallbackContent();
      }, 1000);
    } else {
      announceToScreenReader(shareAccessibilityTryAlternativeMethods);
    }

    if (elements.copyButton) {
      const originalBorder = elements.copyButton.style.border;
      elements.copyButton.style.border = "2px solid var(--color-info-400)";
      setTimeout(() => {
        if (elements.copyButton) {
          elements.copyButton.style.border = originalBorder;
        }
      }, 3000);
    }
  };

  // Initialize clipboard copy
  const initializeClipboardCopy = () => {
    if (!elements.copyButton || !elements.copyButtonText) {
      return;
    }

    const originalCopyText = UI_CONSTANTS.COPY_ORIGINAL_TEXT;
    if (!originalCopyText) {
      return;
    }

    elements.copyButton.addEventListener("click", async (event) => {
      const button = event.currentTarget;

      if (button.hasAttribute("disabled")) {
        return;
      }

      button.setAttribute("disabled", "disabled");

      try {
        const gameData = getGameDataFromProps() || getGameDataFromPopup();
        if (!gameData || !isValidShareData(gameData)) {
          await handleClipboardError(ShareErrorType.NO_DATA, button, originalCopyText);
          return;
        }

        const shareText = await generateAdvancedShareText(gameData);
        const shareUrl = window.location.href;
        const fullText = `${shareText}\n\n${shareUrl}`;

        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(fullText);
          } catch (clipboardError) {
            console.warn("Modern clipboard failed, trying fallback:", clipboardError);
            await copyTextFallback(fullText);
          }
        } else {
          await copyTextFallback(fullText);
        }

        if (elements.copyButtonText) {
          elements.copyButtonText.textContent = "✓ Copied!";
        }
        button.classList.add("share-overlay__clipboard-button--success");

        announceToScreenReader(shareAccessibilityScoreCopied);

        setTimeout(() => {
          if (elements.copyButtonText) {
            elements.copyButtonText.textContent = originalCopyText;
          }
          button.classList.remove("share-overlay__clipboard-button--success");
          button.removeAttribute("disabled");
        }, UI_CONSTANTS.COPY_SUCCESS_DURATION);
      } catch (err) {
        await handleClipboardError(ShareErrorType.CLIPBOARD_FAILED, button, originalCopyText, err);
      }
    });
  };

  // Handle clipboard errors
  const handleClipboardError = async (errorType, button, originalText, error) => {
    console.warn(`Clipboard error (${errorType}):`, error);

    if (elements.copyButtonText) {
      elements.copyButtonText.textContent = getErrorMessage(errorType);
    }
    button.classList.add("share-overlay__clipboard-button--error");

    const errorMessage = getErrorMessage(errorType);
    const recoveryMessage = getRecoveryMessage(errorType);
    announceToScreenReader(
      shareAccessibilityNativeShareFailed
        .replace("{errorMessage}", errorMessage)
        .replace("{recoveryMessage}", recoveryMessage)
    );

    if (errorType === ShareErrorType.NO_DATA) {
      setTimeout(() => {
        showFallbackContent();
      }, 1000);
    }

    setTimeout(() => {
      if (elements.copyButtonText) {
        elements.copyButtonText.textContent = originalText;
      }
      button.classList.remove("share-overlay__clipboard-button--error");
      button.removeAttribute("disabled");
    }, UI_CONSTANTS.COPY_SUCCESS_DURATION / 2);
  };

  // Get user-friendly error messages
  const getErrorMessage = (errorType) => {
    switch (errorType) {
      case ShareErrorType.NO_DATA:
        return "No game data";
      case ShareErrorType.CLIPBOARD_FAILED:
        return "Copy failed";
      case ShareErrorType.PERMISSION_DENIED:
        return "Permission denied";
      default:
        return "Error occurred";
    }
  };

  // Get recovery guidance messages
  const getRecoveryMessage = (errorType) => {
    switch (errorType) {
      case ShareErrorType.NO_DATA:
        return "Please retry or refresh the page";
      case ShareErrorType.CLIPBOARD_FAILED:
        return "Try manual copy or use share buttons";
      case ShareErrorType.PERMISSION_DENIED:
        return "Check browser permissions or use manual copy";
      default:
        return "Please try again or use alternative sharing methods";
    }
  };

  // Announce messages to screen readers
  const announceToScreenReader = (message) => {
    if (!elements.statusAnnouncer) {
      return;
    }

    elements.statusAnnouncer.textContent = message;

    setTimeout(() => {
      if (elements.statusAnnouncer) {
        elements.statusAnnouncer.textContent = "";
      }
    }, 5000);
  };

  // Extract game data from popup element
  const getGameDataFromPopup = () => {
    // Try multiple possible selectors for the popup element
    const popup =
      document.querySelector("#endgame-popup") ||
      document.querySelector("#end-overlay") ||
      document.querySelector(".popup[data-score]");
    if (!popup) {
      return null;
    }

    try {
      // Try to get the current score from the DOM element first
      const scoreElement = popup.querySelector("#popup-score");
      let score = 0;

      if (scoreElement && scoreElement.textContent) {
        score = parseInt(scoreElement.textContent, 10);
        if (isNaN(score) || score < 0) {
          // Fallback to data attribute if DOM element parsing fails
          const scoreAttr = popup.getAttribute("data-score");
          score = parseInt(scoreAttr, 10);
        }
      } else {
        // Fallback to data attribute if no score element found
        const scoreAttr = popup.getAttribute("data-score");
        score = parseInt(scoreAttr, 10);
      }

      const categoryAttr = popup.getAttribute("data-category");
      const difficultyAttr = popup.getAttribute("data-difficulty");

      if (!categoryAttr || !difficultyAttr) {
        console.warn("ShareOverlay: Missing required data attributes on popup element");
        return null;
      }

      if (isNaN(score) || score < 0) {
        console.warn("ShareOverlay: Invalid score value:", score);
        return null;
      }

      if (categoryAttr.trim().length === 0 || difficultyAttr.trim().length === 0) {
        console.warn("ShareOverlay: Empty category or difficulty values");
        return null;
      }

      const gameData = {
        score,
        category: categoryAttr.trim(),
        difficulty: difficultyAttr.trim(),
      };

      if (!isValidShareData(gameData)) {
        console.warn("ShareOverlay: Game data failed validation:", gameData);
        return null;
      }

      return gameData;
    } catch (error) {
      console.warn("ShareOverlay: Error extracting game data from popup:", error);
      return null;
    }
  };

  // Setup cleanup handlers
  const setupCleanupHandlers = () => {
    const eventHandlers = new Map();

    const cleanup = () => {
      eventHandlers.forEach((handlers, element) => {
        handlers.forEach(({ event, handler }) => {
          element.removeEventListener(event, handler);
        });
      });
      eventHandlers.clear();

      Object.keys(elements).forEach((key) => {
        elements[key] = null;
      });
    };

    document.addEventListener("astro:before-swap", cleanup);
    document.addEventListener("astro:after-swap", cleanup);
    window.addEventListener("beforeunload", cleanup);
  };

  // Initialize sharing features when the EndOverlay is actually shown
  const initializeOnEndOverlayShow = () => {
    // Wait for the EndOverlay to be visible before initializing
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === "attributes" && mutation.attributeName === "class") {
          const popup = mutation.target;
          if (popup.classList && !popup.classList.contains("hidden")) {
            console.log("EndOverlay is now visible, initializing ShareOverlay");
            initializeSharing().catch(console.error);
            observer.disconnect(); // Stop observing once initialized
          }
        }
      });
    });

    // Find the EndOverlay element to observe
    const endOverlay =
      document.querySelector("#endgame-popup") ||
      document.querySelector("#end-overlay") ||
      document.querySelector(".popup[data-score]");

    if (endOverlay) {
      observer.observe(endOverlay, {
        attributes: true,
        attributeFilter: ["class"],
      });
    } else {
      // Fallback: initialize after a short delay if no popup found
      setTimeout(() => {
        initializeSharing().catch(console.error);
      }, 1000);
    }
  };

  // Initialize when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeOnEndOverlayShow);
  } else {
    initializeOnEndOverlayShow();
  }
</script>

---
/**
 * KnowledgeCard Component - Responsive & Accessible
 *
 * An enhanced card component for displaying music knowledge articles with image,
 * title, description, and metadata. Fully responsive with WCAG AAA compliance.
 *
 * @component
 * @example
 * ```astro
 * // Standalone card with own link
 * <KnowledgeCard
 *   title="The History of Rock Music"
 *   description="Explore the evolution of rock from the 1950s to today..."
 *   image="/images/rock-history.jpg"
 *   createdAt={new Date('2024-01-15')}
 *   slug="history-of-rock-music"
 *   lang="en"
 *   readingTime={8}
 *   articleUrl="/en/knowledge/history-of-rock-music"
 * />
 *
 * // Card for use within parent link
 * <KnowledgeCard
 *   title="Jazz Fundamentals"
 *   description="Learn the basic elements that define jazz music..."
 *   slug="jazz-fundamentals"
 *   lang="en"
 *   readingTime={5}
 * />
 * ```
 */
import { Picture } from "astro:assets";
import { useTranslations } from "@utils/i18n";
import { format } from "date-fns";
import { enUS as en } from "date-fns/locale";
import { Icon } from "astro-icon/components";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";
import { resolveImageMetadata } from "@utils/images/resolveImage";

export const prerender = true;

interface Props {
  /** Title of the knowledge article */
  title: string;
  /** Brief description or excerpt of the article */
  description: string;
  /** Path to the article's cover image (uses default if not provided) */
  image?: string;
  /** Date when the article was created/published */
  createdAt: Date;
  /** URL slug for the article link */
  slug: string;
  /** Language code for localization */
  lang: string;
  /** Estimated reading time in minutes */
  readingTime?: number;
  /** Complete URL to the article (optional - if omitted, component will be a non-linking card) */
  articleUrl?: string;
  /** Comma-separated keywords for searchability */
  keywords?: string;
  /** Index for animation delay calculation */
  index?: number;
}

const {
  title,
  description,
  image = "/default-cover.jpg",
  createdAt,
  slug,
  lang,
  readingTime = 0,
  articleUrl,
  keywords,
  index = 0,
} = Astro.props;

// English-only formatting and translations
const locale = en;
const lang_t = useTranslations(lang);
const formattedDate = format(createdAt, "MMMM d, yyyy", { locale });

// Use articleUrl if provided, otherwise let the parent handle the link
const hasOwnLink = Boolean(articleUrl);

// Generate unique IDs for this card for accessibility
const cardId = `card-title-${slug}-${index}`;
const metaId = `${cardId}-meta`;

// Generate appropriate alt text for the image
const imageAltText = title ? `Cover image for ${title}` : "";
const resolvedImage = resolveImageMetadata(image);
const responsiveWidths = [320, 480, 640, 768, 960];
const responsiveSizes =
  "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw";
---

<article
  class="group relative isolate flex h-full flex-col overflow-hidden rounded-2xl bg-slate-900/60 backdrop-blur-sm shadow-xl transition duration-200 border-0"
  data-testid="knowledge-card"
  data-title={title}
  data-description={description}
  data-keywords={keywords}
  aria-labelledby={cardId}
  aria-describedby={`${cardId}-desc ${metaId}`}
>
  {
    hasOwnLink ? (
      <a
        href={articleUrl}
        class="group flex h-full flex-col overflow-hidden rounded-2xl text-inherit no-underline transition-all duration-200 focus-visible:-translate-y-0.5 focus-visible:ring-3 focus-visible:ring-white focus-visible:ring-offset-2 focus-visible:ring-offset-[#0b0c10] focus-visible:outline-none"
        aria-labelledby={cardId}
        aria-describedby={`${cardId}-desc`}
      >
        <div class="relative flex h-full flex-col">
          <div class="absolute inset-0 bg-linear-to-br from-white/4 via-white/2 to-transparent opacity-0 transition duration-300 group-hover:opacity-100"></div>

          <div class="relative aspect-video overflow-hidden rounded-xl border border-white/10 bg-neutral-900/70">
            {
              resolvedImage ? (
                <Picture
                  src={resolvedImage}
                  widths={responsiveWidths}
                  sizes={responsiveSizes}
                  formats={["avif", "webp", "jpeg"]}
                  alt={imageAltText}
                  loading="lazy"
                  decoding="async"
                  width={640}
                  height={360}
                  class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                />
              ) : (
                <img
                  src={image}
                  alt={imageAltText}
                  loading="lazy"
                  decoding="async"
                  width="640"
                  height="360"
                  class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                />
              )
            }
            <div class="absolute inset-0 bg-linear-to-t from-[#0b0e1a] via-transparent to-transparent opacity-60"></div>
          </div>

          <div class="flex grow flex-col justify-start p-6 pb-5">
            <Headline level="h3" textSize="base" textAlign="left" className="mb-3 text-white font-semibold">
              {title}
            </Headline>

            <Paragraph textSize="base" textAlign="left" className="mb-4 text-slate-200 leading-relaxed">
              {description}
            </Paragraph>

            <div class="mt-auto border-t border-slate-700/50 pt-4" id={metaId}>
              <div class="flex items-center justify-between gap-4 text-xs">
                <span
                  class="flex items-center text-slate-300 font-medium"
                  aria-label={`${lang_t("knowledge.reading.time.label")}: ${readingTime} ${lang_t("knowledge.reading.time")}`}
                >
                  <Icon
                    name="clock"
                    class="mr-1.5 h-3.5 w-3.5 shrink-0 text-slate-400"
                    aria-hidden="true"
                  />
                  <span>
                    {readingTime} {lang_t("knowledge.reading.time")}
                  </span>
                </span>

                <time
                  datetime={createdAt.toISOString()}
                  class="flex items-center text-slate-300 font-medium"
                  aria-label={`${lang_t("knowledge.published")}: ${formattedDate}`}
                >
                  <Icon
                    name="calendar"
                    class="mr-1.5 h-3.5 w-3.5 shrink-0 text-slate-400"
                    aria-hidden="true"
                  />
                  {formattedDate}
                </time>
              </div>
            </div>
          </div>
        </div>
        <span class="sr-only" aria-live="polite">
          {lang_t("navigation.article.opens")}
        </span>
      </a>
    ) : (
      <div class="relative flex h-full flex-col">
        <div class="relative aspect-video overflow-hidden rounded-xl border border-white/10 bg-neutral-900/70">
          {
            resolvedImage ? (
              <Picture
                src={resolvedImage}
                widths={responsiveWidths}
                sizes={responsiveSizes}
                formats={["avif", "webp", "jpeg"]}
                alt={imageAltText}
                loading="lazy"
                decoding="async"
                width={640}
                height={360}
                class="h-full w-full object-cover transition-transform duration-500 hover:scale-105"
              />
            ) : (
              <img
                src={image}
                alt={imageAltText}
                loading="lazy"
                decoding="async"
                width="640"
                height="360"
                class="h-full w-full object-cover transition-transform duration-500 hover:scale-105"
              />
            )
          }
          <div
            class="absolute inset-0 bg-linear-to-t from-[#0b0e1a] via-transparent to-transparent opacity-60"
            aria-hidden="true"
          />
        </div>

        <div class="flex grow flex-col justify-start p-5 pb-4">
          <Headline level="h3" textSize="xl" textAlign="center" className="text-white">
            {title}
          </Headline>

          <Paragraph textSize="base" textAlign="center" className="text-gray-200">
            {description}
          </Paragraph>

          <div class="mt-auto border-t border-white/10 pt-4" id={metaId}>
            <div class="flex items-center justify-between gap-4">
              <span
                class="flex items-center text-sm text-gray-200"
                aria-label={`${lang_t("knowledge.reading.time.label")}: ${readingTime} ${lang_t("knowledge.reading.time")}`}
              >
                <Icon
                  name="clock"
                  class="mr-2 h-4 w-4 shrink-0 text-white"
                  aria-hidden="true"
                />
                <span>
                  {readingTime} {lang_t("knowledge.reading.time")}
                </span>
              </span>

              <time
                datetime={createdAt.toISOString()}
                class="flex items-center text-sm text-gray-200"
                aria-label={`${lang_t("knowledge.published")}: ${formattedDate}`}
              >
                <Icon
                  name="calendar"
                  class="mr-2 h-4 w-4 shrink-0 text-white"
                  aria-hidden="true"
                />
                {formattedDate}
              </time>
            </div>
          </div>
        </div>
      </div>
    )
  }
</article>

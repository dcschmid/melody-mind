---
/**
 * KnowledgeCard Component - Responsive & Accessible
 *
 * An enhanced card component for displaying music knowledge articles with image,
 * title, description, and metadata. Fully responsive with WCAG AAA compliance.
 *
 * @component
 * @example
 * ```astro
 * // Standalone card with own link
 * <KnowledgeCard
 *   title="The History of Rock Music"
 *   description="Explore the evolution of rock from the 1950s to today..."
 *   image="/images/rock-history.jpg"
 *   createdAt={new Date('2024-01-15')}
 *   slug="history-of-rock-music"
 *   lang="en"
 *   readingTime={8}
 *   articleUrl="/en/knowledge/history-of-rock-music"
 * />
 *
 * // Card for use within parent link
 * <KnowledgeCard
 *   title="Jazz Fundamentals"
 *   description="Learn the basic elements that define jazz music..."
 *   slug="jazz-fundamentals"
 *   lang="en"
 *   readingTime={5}
 * />
 * ```
 */
import { useTranslations } from "@utils/i18n";
import { format } from "date-fns";
import { enUS as en } from "date-fns/locale";
import { Icon } from "astro-icon/components";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";
import { Image } from "astro:assets";

export const prerender = true;

interface Props {
  /** Title of the knowledge article */
  title: string;
  /** Brief description or excerpt of the article */
  description: string;
  /** Path to the article's cover image (uses default if not provided) */
  image?: string;
  /** Date when the article was created/published */
  createdAt: Date;
  /** URL slug for the article link */
  slug: string;
  /** Language code for localization */
  lang: string;
  /** Estimated reading time in minutes */
  readingTime?: number;
  /** Complete URL to the article (optional - if omitted, component will be a non-linking card) */
  articleUrl?: string;
  /** Comma-separated keywords for searchability */
  keywords?: string;
  /** Index for animation delay calculation */
  index?: number;
}

const {
  title,
  description,
  image = "/default-cover.jpg",
  createdAt,
  slug,
  lang,
  readingTime = 0,
  articleUrl,
  keywords,
  index = 0,
} = Astro.props;

// English-only formatting and translations
const locale = en;
const lang_t = useTranslations(lang);
const formattedDate = format(createdAt, "MMMM d, yyyy", { locale });

// Use articleUrl if provided, otherwise let the parent handle the link
const hasOwnLink = Boolean(articleUrl);

// Generate unique IDs for this card for accessibility
const cardId = `card-title-${slug}-${index}`;
const metaId = `${cardId}-meta`;

// Generate appropriate alt text for the image
const imageAltText = title ? `Cover image for ${title}` : "";
---

<article
  class="knowledge-card"
  data-testid="knowledge-card"
  data-title={title}
  data-description={description}
  data-keywords={keywords}
  aria-labelledby={cardId}
  aria-describedby={`${cardId}-desc ${metaId}`}
>
  {
    hasOwnLink ? (
      <a
        href={articleUrl}
        class="knowledge-card__link"
        aria-labelledby={cardId}
        aria-describedby={`${cardId}-desc`}
      >
        <div class="knowledge-card__content">
          <div class="knowledge-card__shine" aria-hidden="true" />
          <div class="knowledge-card__media">
            <Image
              src={image}
              alt={imageAltText}
              loading="lazy"
              decoding="async"
              width="640"
              height="360"
              class="knowledge-card__image"
            />
            <div class="knowledge-card__overlay" aria-hidden="true" />
          </div>

          <div class="knowledge-card__body">
            <Headline
              level="h3"
              textSize="base"
              textAlign="left"
              className="knowledge-card__title"
            >
              {title}
            </Headline>

            <Paragraph
              textSize="base"
              textAlign="left"
              className="knowledge-card__description"
            >
              {description}
            </Paragraph>

            <div class="knowledge-card__meta" id={metaId}>
              <div class="knowledge-card__meta-item">
                <Icon name="clock" class="knowledge-card__meta-icon" aria-hidden="true" />
                <span>
                  {readingTime} {lang_t("knowledge.reading.time")}
                </span>
              </div>
              <time
                datetime={createdAt.toISOString()}
                class="knowledge-card__meta-item"
                aria-label={`${lang_t("knowledge.published")}: ${formattedDate}`}
              >
                <Icon
                  name="calendar"
                  class="knowledge-card__meta-icon"
                  aria-hidden="true"
                />
                {formattedDate}
              </time>
            </div>
          </div>
        </div>
        <span class="knowledge-card__sr">{lang_t("navigation.article.opens")}</span>
      </a>
    ) : (
      <div class="knowledge-card__content">
        <div class="knowledge-card__shine" aria-hidden="true" />
        <div class="knowledge-card__media">
          <Image
            src={image}
            alt={imageAltText}
            loading="lazy"
            decoding="async"
            width="640"
            height="360"
            class="knowledge-card__image"
          />
          <div class="knowledge-card__overlay" aria-hidden="true" />
        </div>

        <div class="knowledge-card__body">
          <Headline
            level="h3"
            textSize="xl"
            textAlign="center"
            className="knowledge-card__title"
          >
            {title}
          </Headline>

          <Paragraph
            textSize="base"
            textAlign="center"
            className="knowledge-card__description"
          >
            {description}
          </Paragraph>

          <div class="knowledge-card__meta" id={metaId}>
            <div class="knowledge-card__meta-item">
              <span
                aria-label={`${lang_t("knowledge.reading.time.label")}: ${readingTime} ${lang_t("knowledge.reading.time")}`}
              >
                <Icon name="clock" class="knowledge-card__meta-icon" aria-hidden="true" />
                <span>
                  {readingTime} {lang_t("knowledge.reading.time")}
                </span>
              </span>
            </div>
            <time
              datetime={createdAt.toISOString()}
              class="knowledge-card__meta-item"
              aria-label={`${lang_t("knowledge.published")}: ${formattedDate}`}
            >
              <Icon
                name="calendar"
                class="knowledge-card__meta-icon"
                aria-hidden="true"
              />
              {formattedDate}
            </time>
          </div>
        </div>
      </div>
    )
  }
  <style>
    @media screen and (prefers-reduced-motion: reduce) {
      .knowledge-card {
        position: relative;
        display: flex;
        flex-direction: column;
        block-size: 100%;
        overflow: hidden;
        color: var(--gn-ink);
        background: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
        border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
        border-radius: 1.25rem;
        box-shadow: var(--gn-offset-shadow);
        transition: none;
      }
    }

    .knowledge-card {
      position: relative;
      display: flex;
      flex-direction: column;
      block-size: 100%;
      overflow: hidden;
      color: var(--gn-ink);
      background: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
      border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
      border-radius: 1.25rem;
      box-shadow: var(--gn-offset-shadow);
      transition:
        transform var(--transition-base),
        box-shadow var(--transition-base);
    }

    .knowledge-card::after {
      position: absolute;
      inset: 4px;
      pointer-events: none;
      content: "";
      border: 1px solid var(--gn-panel-inner);
      border-radius: 1rem;
    }

    .knowledge-card:hover,
    .knowledge-card:focus {
      box-shadow: 0 22px 45px rgba(0, 0, 0, 0.45);
      transform: translateY(-4px);
    }

    .knowledge-card__link,
    .knowledge-card__content {
      display: flex;
      flex-direction: column;
      block-size: 100%;
      color: inherit;
      text-decoration: none;
    }

    @media screen and (prefers-reduced-motion: reduce) {
      .knowledge-card__shine {
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          135deg,
          rgba(95, 199, 255, 0.12),
          rgba(95, 199, 255, 0.06),
          transparent 65%
        );
        opacity: 0;
        transition: none;
      }
    }

    .knowledge-card__shine {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(
        135deg,
        rgba(95, 199, 255, 0.12),
        rgba(95, 199, 255, 0.06),
        transparent 65%
      );
      opacity: 0;
      transition: opacity var(--transition-base);
    }

    .knowledge-card:hover .knowledge-card__shine,
    .knowledge-card__link:focus-visible .knowledge-card__shine {
      opacity: 1;
    }

    .knowledge-card__link:focus-visible {
      outline: 3px solid var(--color-gn-amber-300);
      outline-offset: 3px;
    }

    .knowledge-card__media {
      position: relative;
      aspect-ratio: 3 / 2;
      margin: 0;
      overflow: hidden;
      background: var(--gn-bg);
      border: none;
      border-radius: 0;
    }

    @media screen and (prefers-reduced-motion: reduce) {
      .knowledge-card__image {
        inline-size: 100%;
        block-size: 100%;
        object-fit: cover;
        transition: none;
      }
    }

    .knowledge-card__image {
      inline-size: 100%;
      block-size: 100%;
      object-fit: cover;
      transition: transform 500ms ease;
    }

    .knowledge-card:hover .knowledge-card__image,
    .knowledge-card__link:focus-visible .knowledge-card__image {
      transform: scale(1.05);
    }

    .knowledge-card__overlay {
      position: absolute;
      inset: 0;
    }

    .knowledge-card__body {
      display: flex;
      flex: 1;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1.5rem 1.5rem 1.25rem;
    }

    .knowledge-card__title {
      margin: 0;
      color: var(--gn-ink);
    }

    .knowledge-card__description {
      margin: 0;
      color: var(--gn-ink-muted);
    }

    .knowledge-card__meta {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding-block-start: 1rem;
      margin-block-start: auto;
      font-size: 1rem;
      color: var(--gn-ink-muted);
      border-block-start: 1px solid
        color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
    }

    .knowledge-card__meta-item {
      display: grid;
      grid-template-columns: 1.1rem 1fr;
      gap: 0.55rem;
      align-items: center;
      font-weight: 500;
    }

    .knowledge-card__meta-icon {
      display: block;
      flex-shrink: 0;
      inline-size: 1.05rem;
      block-size: 1.05rem;
      color: var(--color-gn-amber-300);
    }

    .knowledge-card__meta-item span {
      white-space: nowrap;
    }

    .knowledge-card__sr {
      position: absolute;
      inline-size: var(--sr-only-width);
      block-size: var(--sr-only-height);
      margin: var(--sr-only-margin);
      overflow: hidden;
      white-space: nowrap;
      border: 0;
      clip-path: var(--sr-only-clip-path);
    }
  </style>
</article>
<style>
  @media screen and (prefers-reduced-motion: reduce) {
    .knowledge-card {
      position: relative;
      display: flex;
      flex-direction: column;
      block-size: 100%;
      overflow: hidden;
      color: var(--text-primary);
      background: color-mix(in srgb, var(--surface-2) 92%, transparent);
      border: 2px solid color-mix(in srgb, var(--color-gn-soot-600) 85%, transparent);
      border-radius: 1.25rem;
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.5);
      transition: none;
    }
  }

  .knowledge-card {
    position: relative;
    display: flex;
    flex-direction: column;
    block-size: 100%;
    overflow: hidden;
    color: var(--text-primary);
    background: color-mix(in srgb, var(--surface-2) 92%, transparent);
    border: 2px solid color-mix(in srgb, var(--color-gn-soot-600) 85%, transparent);
    border-radius: 1.25rem;
    box-shadow: 0 16px 36px rgba(0, 0, 0, 0.5);
    transition:
      transform var(--transition-base),
      box-shadow var(--transition-base);
  }

  .knowledge-card::after {
    position: absolute;
    inset: 4px;
    pointer-events: none;
    content: "";
    border: 1px solid var(--gn-panel-inner);
    border-radius: 1rem;
  }

  .knowledge-card:hover,
  .knowledge-card:focus {
    box-shadow: 0 26px 50px rgba(0, 0, 0, 0.55);
    transform: translateY(-4px);
  }

  .knowledge-card__link,
  .knowledge-card__content {
    display: flex;
    flex-direction: column;
    block-size: 100%;
    color: inherit;
    text-decoration: none;
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .knowledge-card__shine {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(
        135deg,
        rgba(240, 194, 123, 0.14),
        rgba(240, 194, 123, 0.08),
        transparent 65%
      );
      opacity: 0;
      transition: none;
    }
  }

  .knowledge-card__shine {
    position: absolute;
    inset: 0;
    pointer-events: none;
    background: linear-gradient(
      135deg,
      rgba(240, 194, 123, 0.14),
      rgba(240, 194, 123, 0.08),
      transparent 65%
    );
    opacity: 0;
    transition: opacity var(--transition-base);
  }

  .knowledge-card:hover .knowledge-card__shine,
  .knowledge-card__link:focus-visible .knowledge-card__shine {
    opacity: 1;
  }

  .knowledge-card__link:focus-visible {
    outline: var(--focus-ring-width) solid var(--focus-ring-color);
    outline-offset: var(--focus-ring-offset);
  }

  .knowledge-card__media {
    position: relative;
    aspect-ratio: 3 / 2;
    margin: 0;
    overflow: hidden;
    background: var(--surface-1);
    border: none;
    border-radius: 0;
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .knowledge-card__image {
      inline-size: 100%;
      block-size: 100%;
      object-fit: cover;
      transition: none;
    }
  }

  .knowledge-card__image {
    inline-size: 100%;
    block-size: 100%;
    object-fit: cover;
    transition: transform 500ms ease;
  }

  .knowledge-card:hover .knowledge-card__image,
  .knowledge-card__link:focus-visible .knowledge-card__image {
    transform: scale(1.05);
  }

  .knowledge-card__overlay {
    position: absolute;
    inset: 0;
  }

  .knowledge-card__body {
    display: flex;
    flex: 1;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1.5rem 1.5rem 1.25rem;
  }

  .knowledge-card__title {
    margin: 0;
    color: var(--text-primary);
  }

  .knowledge-card__description {
    margin: 0;
    color: var(--text-secondary);
  }

  .knowledge-card__meta {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding-block-start: 1rem;
    margin-block-start: auto;
    font-size: 1rem;
    color: var(--text-secondary);
    border-block-start: 1px solid
      color-mix(in srgb, var(--color-gn-soot-600) 70%, transparent);
  }

  .knowledge-card__meta-item {
    display: grid;
    grid-template-columns: 1.1rem 1fr;
    gap: 0.55rem;
    align-items: center;
    font-weight: 500;
  }

  .knowledge-card__meta-icon {
    display: block;
    flex-shrink: 0;
    inline-size: 1.05rem;
    block-size: 1.05rem;
    color: var(--link-default);
  }

  .knowledge-card__meta-item span {
    white-space: nowrap;
  }

  .sr-only {
    position: absolute;
    inline-size: var(--sr-only-width);
    block-size: var(--sr-only-height);
    padding: 0;
    margin: var(--sr-only-margin);
    overflow: hidden;
    white-space: nowrap;
    border: 0;
    clip-path: var(--sr-only-clip-path);
  }
</style>

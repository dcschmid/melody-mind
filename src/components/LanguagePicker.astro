---
/**
 * LanguagePicker Component - Responsive & Accessible
 *
 * A fully accessible language selection component that allows users to switch
 * between multiple languages. Maintains user preferences and provides seamless
 * multilingual experience with WCAG AAA compliance.
 *
 * @component
 * @example
 * ```astro
 * <LanguagePicker />
 * ```
 */
import { getRelativeLocaleUrl } from "astro:i18n";
import { getLangFromUrl, useTranslations } from "@utils/i18n";

// Get current language and translations
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(String(lang));

/**
 * Clean the current path by removing language prefixes
 */
const currentPath = Astro.url.pathname;
const cleanPath = currentPath
  .split("/")
  .filter(
    (segment) =>
      ![
        "de",
        "en",
        "es",
        "fr",
        "it",
        "pt",
        "da",
        "nl",
        "sv",
        "fi",
        "cn",
        "ru",
        "jp",
        "uk",
      ].includes(segment)
  )
  .join("/");

/**
 * Available languages configuration with localized names and accessibility labels
 */
const unsortedLanguages = {
  cn: {
    name: t("language.cn"),
    label: t("language.cn.label"),
    flag: "ðŸ‡¨ðŸ‡³",
  },
  da: {
    name: t("language.da"),
    label: t("language.da.label"),
    flag: "ðŸ‡©ðŸ‡°",
  },
  de: {
    name: t("language.de"),
    label: t("language.de.label"),
    flag: "ðŸ‡©ðŸ‡ª",
  },
  en: {
    name: t("language.en"),
    label: t("language.en.label"),
    flag: "ðŸ‡¬ðŸ‡§",
  },
  es: {
    name: t("language.es"),
    label: t("language.es.label"),
    flag: "ðŸ‡ªðŸ‡¸",
  },
  fi: {
    name: t("language.fi"),
    label: t("language.fi.label"),
    flag: "ðŸ‡«ðŸ‡®",
  },
  fr: {
    name: t("language.fr"),
    label: t("language.fr.label"),
    flag: "ðŸ‡«ðŸ‡·",
  },
  it: {
    name: t("language.it"),
    label: t("language.it.label"),
    flag: "ðŸ‡®ðŸ‡¹",
  },
  jp: {
    name: t("language.jp"),
    label: t("language.jp.label"),
    flag: "ðŸ‡¯ðŸ‡µ",
  },
  nl: {
    name: t("language.nl"),
    label: t("language.nl.label"),
    flag: "ðŸ‡³ðŸ‡±",
  },
  pt: {
    name: t("language.pt"),
    label: t("language.pt.label"),
    flag: "ðŸ‡µðŸ‡¹",
  },
  ru: {
    name: t("language.ru"),
    label: t("language.ru.label"),
    flag: "ðŸ‡·ðŸ‡º",
  },
  sv: {
    name: t("language.sv"),
    label: t("language.sv.label"),
    flag: "ðŸ‡¸ðŸ‡ª",
  },
  uk: {
    name: t("language.uk"),
    label: t("language.uk.label"),
    flag: "ðŸ‡ºðŸ‡¦",
  },
};

/**
 * Sort languages alphabetically by their localized names
 */
const languages = Object.fromEntries(
  Object.entries(unsortedLanguages).sort(([, a], [, b]) => a.name.localeCompare(b.name))
);
---

<div class="language-picker" role="navigation" aria-label={t("language.picker.label")}>
  <div class="language-picker__select-container">
    <select
      id="language-select"
      class="language-picker__select"
      value={getRelativeLocaleUrl(String(lang), cleanPath)}
      aria-expanded="false"
      onchange="
        const newLang = this.value.split('/')[1];
        window.localStorage.setItem('preferred-language', newLang);
        window.location.href = this.value;
      "
      aria-label={t("language.select.label")}
      data-focus-announce={t("language.focus.announce")}
      data-change-success={t("language.change.success")}
      data-change-error={t("language.change.error")}
      data-preference-restored={t("language.preference.restored")}
    >
      {
        Object.entries(languages).map(([code, { name, label, flag }]) => {
          const url = getRelativeLocaleUrl(code, cleanPath);
          return (
            <option
              value={url}
              selected={code === lang}
              aria-label={label}
              class="language-picker__option"
            >
              {flag} {name}
            </option>
          );
        })
      }
    </select>

    <div class="language-picker__arrow-container" id="arrow-container">
      <svg
        id="language-arrow"
        class="language-picker__arrow"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 20 20"
        aria-hidden="true"
      >
        <title>{t("language.dropdown.arrow")}</title>
        <path
          d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
        ></path>
      </svg>
    </div>
  </div>

  <div class="language-picker__status" id="language-status" aria-live="polite">
    {t("language.selected", { language: languages[String(lang)].name })}
  </div>
</div>

<style lang="scss">
  /* ======================================
   * LANGUAGE PICKER COMPONENT STYLES
   * Responsive design with global.css variables
   * WCAG AAA compliant - Zero hardcoded values
   * ====================================== */

  .language-picker {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    border-radius: var(--radius-lg);
    font-family: var(--font-family-primary);

    /* Enhanced focus-within state for WCAG AAA compliance */
    transition: box-shadow var(--animation-duration-normal);

    &:focus-within {
      box-shadow: var(--focus-ring);
    }

    /* ======================================
     * SELECT CONTAINER
     * ====================================== */

    &__select-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    /* ======================================
     * SELECT ELEMENT STYLING
     * ====================================== */

    &__select {
      /* Layout and sizing using CSS variables for WCAG AAA compliance */
      min-height: var(--min-touch-size);
      width: 100%;
      min-width: var(--min-touch-size);

      /* Appearance and positioning */
      cursor: pointer;
      appearance: none;
      border: 2px solid var(--interactive-primary);
      border-radius: var(--radius-lg);

      /* Spacing using CSS variables - match menu button */
      padding: var(--space-sm) var(--space-2xl) var(--space-sm) var(--space-md);

      /* Background and colors using semantic CSS variables */
      background-color: var(--interactive-primary);
      color: var(--btn-primary-text);

      /* Typography using CSS variables */
      font-size: var(--text-base);
      font-weight: var(--font-medium);

      /* Visual effects to match menu button */
      box-shadow: var(--shadow-md);
      margin: var(--space-xs);

      /* Transitions */
      transition:
        background-color var(--animation-duration-normal),
        transform var(--animation-duration-normal),
        box-shadow var(--animation-duration-normal),
        color var(--animation-duration-normal);

      /* Hover states - match menu button */
      &:hover {
        background-color: var(--interactive-primary-hover);
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }

      /* Focus states - match menu button */
      &:focus,
      &:focus-visible {
        background-color: var(--interactive-primary-hover);
        outline: 3px solid var(--focus-ring);
        outline-offset: 2px;
        box-shadow: var(--shadow-xl);
      }

      /* Disabled state */
      &:disabled {
        opacity: var(--opacity-disabled);
        cursor: not-allowed;
      }

      /* Responsive design */
      @media (min-width: 48em) {
        /* md breakpoint */
        min-width: calc(var(--min-touch-size) * 1.5);
      }

      @media (max-width: 47.9375em) {
        /* Below md breakpoint */
        min-width: var(--min-touch-size);
        padding: var(--space-xs) var(--space-xl) var(--space-xs) var(--space-sm);
        font-size: var(--text-sm);
      }

      @media (max-width: 39.9375em) {
        /* Below sm breakpoint */
        min-width: auto;
        padding: var(--space-xs) var(--space-lg) var(--space-xs) var(--space-xs);
        font-size: var(--text-xs);
      }

      /* High contrast mode support */
      @media (prefers-contrast: high) {
        border: var(--border-width-thick) solid var(--text-primary);

        &:focus,
        &:focus-visible {
          outline: var(--border-width-enhanced) solid var(--text-primary);
          outline-offset: var(--space-xs);
        }
      }

      /* Forced colors mode support */
      @media (forced-colors: active) {
        background-color: ButtonFace;
        color: ButtonText;
        border: var(--border-width-thin) solid ButtonText;
        forced-color-adjust: none;

        &:focus,
        &:focus-visible {
          outline: var(--border-width-thick) solid Highlight;
        }
      }

      /* Reduced motion support */
      @media (prefers-reduced-motion: reduce) {
        transition-duration: var(--animation-duration-fast) !important;

        &:hover {
          transform: none;
        }
      }
    }

    /* ======================================
     * OPTION STYLING
     * ====================================== */

    &__option {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      padding: var(--space-xs);

      /* Enhanced option styling for better contrast */
      border-bottom: var(--border-width-thin) solid var(--border-primary);

      &:hover {
        background-color: var(--bg-tertiary);
      }

      &:focus {
        background-color: var(--interactive-primary);
        color: var(--btn-primary-text);
      }
    }

    /* ======================================
     * ARROW INDICATOR
     * ====================================== */

    &__arrow-container {
      /* Positioning */
      position: absolute;
      top: var(--space-none);
      bottom: var(--space-none);
      right: var(--space-none);

      /* Layout */
      display: flex;
      align-items: center;
      justify-content: center;

      /* Spacing and styling */
      padding: var(--space-none) var(--space-sm);
      pointer-events: none;

      /* Color using CSS variables */
      color: var(--btn-primary-text);

      /* Responsive adjustments */
      @media (max-width: 47.9375em) {
        /* Below md breakpoint */
        padding: var(--space-none) var(--space-xs);
      }
    }

    &__arrow {
      /* Size using CSS variables */
      height: var(--icon-size-sm);
      width: var(--icon-size-sm);

      /* Styling */
      fill: currentColor;

      transition:
        background-color var(--animation-duration-normal),
        transform var(--animation-duration-normal),
        box-shadow var(--animation-duration-normal),
        color var(--animation-duration-normal);

      /* Responsive icon sizing */
      @media (max-width: 39.9375em) {
        /* Below sm breakpoint */
        height: var(--icon-size-sm);
        width: var(--icon-size-sm);
      }

      /* Forced colors mode support */
      @media (forced-colors: active) {
        fill: ButtonText;
      }

      /* Reduced motion support */
      @media (prefers-reduced-motion: reduce) {
        transition-duration: var(--animation-duration-fast) !important;
      }
    }

    /* Arrow rotation states for enhanced UX */
    &__select:focus + &__arrow-container &__arrow,
    &__select:active + &__arrow-container &__arrow {
      transform: rotate(var(--rotation-180));
    }

    &__select:focus + &__arrow-container,
    &__select:active + &__arrow-container {
      color: var(--btn-primary-text);
    }

    /* ======================================
     * SCREEN READER STATUS
     * ====================================== */

    &__status {
      /* Screen reader only - using semantic utility class approach with CSS variables */
      position: absolute;
      width: var(--sr-only-width);
      height: var(--sr-only-height);
      padding: var(--space-none);
      margin: var(--sr-only-margin);
      overflow: hidden;
      clip: rect(var(--space-none), var(--space-none), var(--space-none), var(--space-none));
      white-space: nowrap;
      border: var(--space-none);
    }

    /* ======================================
     * RESPONSIVE ADJUSTMENTS
     * ====================================== */

    /* Mobile-first responsive design */
    @media (max-width: 47.9375em) {
      /* Below md breakpoint */
      gap: var(--space-xs);
    }

    @media (max-width: 39.9375em) {
      /* Below sm breakpoint */
      gap: var(--space-xs);
    }
  }

  /* ======================================
   * ENHANCED TEXT SPACING SUPPORT (WCAG 2.2)
   * ====================================== */

  .enhanced-text-spacing .language-picker__select {
    letter-spacing: var(--letter-spacing-enhanced);
    word-spacing: var(--word-spacing-enhanced);
    line-height: var(--line-height-enhanced);
    padding-top: calc(var(--space-sm) * 1.2);
    padding-bottom: calc(var(--space-sm) * 1.2);

    /* Enhanced text spacing support for better accessibility */
    @media (min-width: 48em) {
      /* md breakpoint */
      padding-top: calc(var(--space-md) * 1.1);
      padding-bottom: calc(var(--space-md) * 1.1);
    }
  }
</style>

<script type="module">
  /**
   * LanguagePicker Component Script
   * Enhanced language picker implementation with modern ES6+ features
   */

  // Modern ES6+ class with arrow functions and destructuring
  class LanguagePicker {
    #selectElement = null;
    #arrowElement = null;
    #arrowContainer = null;
    #statusElement = null;
    #abortController = null;
    #eventHandlers = new Map();
    #translations = {};

    constructor(config = {}) {
      const {
        selectElementId = "language-select",
        arrowElementId = "language-arrow",
        arrowContainerId = "arrow-container",
        statusElementId = "language-status",
      } = config;

      this.#abortController = new AbortController();
      this.#initializeElements(selectElementId, arrowElementId, arrowContainerId, statusElementId);
      this.#loadTranslations();

      if (this.#isValid()) {
        this.#initialize();
      } else {
        console.warn("Language picker initialization skipped - required elements not found");
      }
    }

    #initializeElements = (selectId, arrowId, arrowContainerId, statusId) => {
      this.#selectElement = document.getElementById(selectId);
      this.#arrowElement = document.getElementById(arrowId);
      this.#arrowContainer = document.getElementById(arrowContainerId);
      this.#statusElement = document.getElementById(statusId);
    };

    #loadTranslations = () => {
      if (!this.#selectElement) {
        this.#translations = {
          focusAnnounce: "Language selector focused. Use arrow keys to navigate options.",
          changeSuccess: "Language changed to {language}",
          changeError: "Language change failed. Please try again.",
          preferenceRestored: "Language preference restored: {language}",
        };
        return;
      }

      const { dataset } = this.#selectElement;
      this.#translations = {
        focusAnnounce:
          dataset.focusAnnounce || "Language selector focused. Use arrow keys to navigate options.",
        changeSuccess: dataset.changeSuccess || "Language changed to {language}",
        changeError: dataset.changeError || "Language change failed. Please try again.",
        preferenceRestored:
          dataset.preferenceRestored || "Language preference restored: {language}",
      };
    };

    #isValid = () => {
      return !!(
        this.#selectElement &&
        this.#arrowElement &&
        this.#arrowContainer &&
        this.#statusElement
      );
    };

    #initialize = () => {
      try {
        // Set initial ARIA attributes
        this.#selectElement.setAttribute("aria-expanded", "false");
        this.#selectElement.setAttribute("aria-haspopup", "listbox");

        const { signal } = this.#abortController;

        // Event listeners with modern arrow functions
        this.#selectElement.addEventListener("focus", this.#handleFocus, { signal });
        this.#selectElement.addEventListener("blur", this.#handleBlur, { signal });
        this.#selectElement.addEventListener("mousedown", this.#handleMouseDown, { signal });
        this.#selectElement.addEventListener("mouseup", this.#handleMouseUp, { signal });
        this.#selectElement.addEventListener("change", this.#handleLanguageChange, { signal });
        this.#selectElement.addEventListener("keydown", this.#handleKeyDown, { signal });
        this.#selectElement.addEventListener("keyup", this.#handleKeyUp, { signal });

        this.#resetArrow();
        console.log("LanguagePicker initialized successfully with modern ES6+ features");
      } catch (error) {
        console.error("Error initializing LanguagePicker:", error);
      }
    };

    #handleFocus = () => {
      this.#arrowContainer.classList.add("focused");
      this.#announceToScreenReader(this.#translations.focusAnnounce);
    };

    #handleBlur = () => {
      this.#arrowContainer.classList.remove("focused");
      this.#resetArrow();
    };

    #handleMouseDown = () => {
      this.#rotateArrow();
      this.#selectElement.setAttribute("aria-expanded", "true");
    };

    #handleMouseUp = () => {
      setTimeout(() => {
        this.#resetArrow();
        this.#selectElement.setAttribute("aria-expanded", "false");
      }, 150);
    };

    #handleLanguageChange = (event) => {
      const target = event.target;
      const selectedValue = target.value;
      const selectedText = target.options[target.selectedIndex].text;

      try {
        const newLang = selectedValue.split("/")[1];
        if (!newLang) {
          throw new Error("Invalid language selection: No language code found");
        }

        // Store preference
        localStorage.setItem("preferred-language", newLang);

        // Announce success
        const successMessage = this.#translations.changeSuccess.replace("{language}", selectedText);
        this.#announceToScreenReader(successMessage);

        // Navigate to new URL
        window.location.href = selectedValue;
      } catch (error) {
        console.error("Language change error:", error);
        this.#announceToScreenReader(this.#translations.changeError);
      }
    };

    #handleKeyDown = (event) => {
      const { key } = event;
      if (["ArrowUp", "ArrowDown", "Enter", " "].includes(key)) {
        this.#rotateArrow();
      }
    };

    #handleKeyUp = (event) => {
      const { key } = event;
      if (["ArrowUp", "ArrowDown", "Enter", " "].includes(key)) {
        setTimeout(() => this.#resetArrow(), 150);
      }
    };

    #rotateArrow = () => {
      if (this.#arrowElement) {
        this.#arrowElement.style.transform = "rotate(180deg)";
      }
    };

    #resetArrow = () => {
      if (this.#arrowElement) {
        this.#arrowElement.style.transform = "rotate(0deg)";
      }
    };

    #announceToScreenReader = (message) => {
      if (this.#statusElement) {
        this.#statusElement.textContent = message;
        setTimeout(() => {
          this.#statusElement.textContent = "";
        }, 1000);
      }
    };

    // Public methods
    cleanup = () => {
      this.#abortController.abort();
      this.#eventHandlers.clear();
    };

    getPerformanceMetrics = () => ({
      eventListenerCount: this.#eventHandlers.size,
      memoryUsage: performance.memory?.usedJSHeapSize || null,
      isAborted: this.#abortController.signal.aborted,
      hasValidElements: this.#isValid(),
    });

    // Static factory methods
    static create = (config) => new LanguagePicker(config);
    static init = (config) => new LanguagePicker(config);
  }

  // Initialize with modern ES6+ syntax
  LanguagePicker.init();
</script>

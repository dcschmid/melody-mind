---
/**
 * TableOfContents Component
 *
 * A responsive, accessible dropdown component that creates a table of contents
 * from h2 and h3 headings. Automatically extracts and displays navigation links.
 *
 * Features:
 * - Responsive design with mobile-first breakpoints
 * - WCAG AAA compliant with proper keyboard navigation
 * - Focus management and ARIA attributes
 * - Touch-friendly with appropriate target sizes
 * - Visual feedback for hover and focus states
 * - Support for reduced motion preferences
 * - Performance optimized with smooth animations
 * - Uses Tailwind CSS 4 for consistent theming
 *
 * @component
 * @accessibility WCAG AAA compliant
 */

/**
 * Interface for heading objects extracted from content
 * @interface Heading
 */
interface Heading {
  /** The heading level (2 for h2, 3 for h3) */
  depth: number;
  /** The slug ID for the heading */
  slug: string;
  /** The heading text content */
  text: string;
}

/**
 * Props interface for the TableOfContents component
 * @interface Props
 */
interface Props {
  /** Array of heading objects extracted from content */
  headings: Heading[];
  /** Optional custom title for the table of contents */
  title?: string;
  /** Optional language code for localization */
  lang?: string;
}

import { getLangFromUrl, useTranslations } from "@utils/i18n";
import { Icon } from "astro-icon/components";

const { headings = [], title, lang } = Astro.props;

// Get language from URL if not provided
const currentLang = lang || getLangFromUrl(Astro.url);

// Get translations function
const t = useTranslations(currentLang);

// Filter to only include h2 and h3 headings
const filteredHeadings = headings.filter((heading) => heading.depth === 2 || heading.depth === 3);

// Check if there are any headings to display
const hasHeadings = filteredHeadings.length > 0;

// Use title from props or default to translated title
const tocTitle = title || t("toc.nav.label");
---

{
  hasHeadings && (
    <div class="relative">
      <div class="relative">
        <button
          id="toc-toggle"
          aria-expanded="false"
          aria-controls="toc-content"
          aria-label={t("toc.toggle.label")}
          class="flex min-h-[44px] w-full items-center justify-between rounded-lg border-2 border-gn-soot-700 bg-gn-soot-900/90 px-4 py-3 text-left text-base font-medium text-gn-parchment-50 shadow-[4px_4px_0_rgba(0,0,0,0.75)] transition-all duration-300 hover:border-gn-amber-300 hover:bg-gn-soot-800 hover:shadow-[6px_6px_0_rgba(0,0,0,0.82)] focus:outline-none focus-visible:ring-4 focus-visible:ring-gn-amber-300 focus-visible:ring-offset-2 focus-visible:ring-offset-gn-soot-900"
        >
          <span class="flex items-center gap-3">
            <Icon name="menu" class="h-5 w-5 text-gn-amber-300" aria-hidden="true" />
            <span>{tocTitle}</span>
          </span>
          <span
            class="sr-only"
            data-expanded={t("toc.state.expanded")}
            data-collapsed={t("toc.state.collapsed")}
          >
            {t("toc.state.collapsed")}
          </span>
          <Icon
            name="chevron-down"
            id="toc-icon"
            class="h-5 w-5 text-gn-parchment-200 transition-transform duration-300"
            aria-hidden="true"
          />
        </button>

        <div
          id="toc-content"
          aria-labelledby="toc-toggle"
          class="mt-3 hidden overflow-hidden rounded-lg border-2 border-gn-soot-700 bg-gn-soot-900/90 shadow-[4px_4px_0_rgba(0,0,0,0.75)] backdrop-blur-sm transition-all duration-300"
        >
          <nav aria-label={t("toc.nav.label")} class="p-4">
            <a
              href="#article-content"
              class="mb-4 block min-h-[44px] text-sm font-semibold text-gn-amber-300 no-underline transition-colors duration-200 hover:underline hover:underline-offset-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-gn-amber-300 focus-visible:ring-offset-2 focus-visible:ring-offset-gn-soot-900"
            >
              {t("toc.skip.link")}
            </a>
            <ul
              id="toc-list"
              class="scrollbar-thin scrollbar-track-gn-soot-800 scrollbar-thumb-gn-soot-600 hover:scrollbar-thumb-gn-amber-400 m-0 max-h-[50vh] list-none overflow-y-auto p-0"
            >
              {filteredHeadings.map((heading) => (
                <li class={`mb-1 ${heading.depth === 3 ? "ml-4" : ""}`}>
                  <a
                    href={`#${heading.slug}`}
                    class={`text-decoration-none block min-h-[44px] rounded-md px-3 py-2 leading-relaxed transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gn-amber-300 focus-visible:ring-offset-2 focus-visible:ring-offset-gn-soot-900 ${
                      heading.depth === 2
                        ? "text-sm font-semibold text-gn-parchment-50 hover:bg-gn-soot-800 hover:text-gn-parchment-50"
                        : "text-xs font-medium text-gn-parchment-200 hover:bg-gn-soot-800 hover:text-gn-parchment-50"
                    }`}
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </div>
      </div>
    </div>
  )
}

<script>
  (() => {
    const toggle = document.getElementById("toc-toggle");
    const content = document.getElementById("toc-content");
    const icon = document.getElementById("toc-icon");
    const stateText = toggle?.querySelector("[data-expanded]") as HTMLElement | null;
    const tocList = document.getElementById("toc-list");
    const articleRoot = document.getElementById("article-content");

    if (!toggle || !content) return;

    const slugify = (text: string): string =>
      text
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");

    const setExpanded = (expanded: boolean): void => {
      toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
      content.classList.toggle("hidden", !expanded);
      content.setAttribute("aria-hidden", expanded ? "false" : "true");
      if (icon) {
        icon.classList.toggle("rotate-180", expanded);
      }
      if (stateText) {
        stateText.textContent = expanded
          ? stateText.getAttribute("data-expanded") || ""
          : stateText.getAttribute("data-collapsed") || "";
      }
    };

    let isOpen = false;
    setExpanded(isOpen);

    const buildTocFromDom = (): void => {
      if (!tocList || !articleRoot) return;
      const headingNodes = Array.from(articleRoot.querySelectorAll("h2, h3"));
      if (!headingNodes.length) return;

      const seenIds = new Set<string>();
      const headings = headingNodes
        .map((node) => {
          const depth = Number(node.tagName.substring(1));
          if (depth !== 2 && depth !== 3) return null;
          const text = (node.textContent || "").trim();
          if (!text) return null;

          let id = node.id || slugify(text) || "section";
          let counter = 2;
          while (seenIds.has(id)) {
            id = `${slugify(text) || "section"}-${counter++}`;
          }
          seenIds.add(id);
          if (!node.id) node.id = id;

          return { depth, id, text };
        })
        .filter(Boolean) as Array<{ depth: number; id: string; text: string }>;

      if (!headings.length) return;

      tocList.innerHTML = "";
      headings.forEach((heading) => {
        const li = document.createElement("li");
        li.className = `mb-1 ${heading.depth === 3 ? "ml-4" : ""}`;

        const a = document.createElement("a");
        a.href = `#${heading.id}`;
        a.className =
          heading.depth === 2
            ? "text-decoration-none block min-h-[44px] rounded-md px-3 py-2 text-sm font-semibold text-gn-parchment-50 leading-relaxed transition-all duration-200 hover:bg-gn-soot-800 hover:text-gn-parchment-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-gn-amber-300 focus-visible:ring-offset-2 focus-visible:ring-offset-gn-soot-900"
            : "text-decoration-none block min-h-[44px] rounded-md px-3 py-2 text-xs font-medium text-gn-parchment-200 leading-relaxed transition-all duration-200 hover:bg-gn-soot-800 hover:text-gn-parchment-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-gn-amber-300 focus-visible:ring-offset-2 focus-visible:ring-offset-gn-soot-900";
        a.textContent = heading.text;

        li.appendChild(a);
        tocList.appendChild(li);
      });
    };

    buildTocFromDom();

    const toggleContent = (): void => {
      isOpen = !isOpen;
      setExpanded(isOpen);
    };

    toggle.addEventListener("click", (e): void => {
      e.preventDefault();
      toggleContent();
    });

    toggle.addEventListener("keydown", (e): void => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        toggleContent();
      }
    });

    document.addEventListener("click", (e): void => {
      if (!isOpen) return;
      const target = e.target as Node;
      if (target && !toggle.contains(target) && !content.contains(target)) {
        isOpen = false;
        setExpanded(false);
      }
    });
  })();
</script>

---
/**
 * TableOfContents Component
 *
 * A responsive, accessible dropdown component that creates a table of contents
 * from h2 and h3 headings. Automatically extracts and displays navigation links.
 *
 * Features:
 * - Responsive design with mobile-first breakpoints
 * - WCAG AAA compliant with proper keyboard navigation
 * - Focus management and ARIA attributes
 * - Touch-friendly with appropriate target sizes
 * - Visual feedback for hover and focus states
 * - Support for reduced motion preferences
 * - Performance optimized with smooth animations
 *
 * @component
 * @accessibility WCAG AAA compliant
 */

/**
 * Interface for heading objects extracted from content
 * @interface Heading
 */
interface Heading {
  /** The heading level (2 for h2, 3 for h3) */
  depth: number;
  /** The slug ID for the heading */
  slug: string;
  /** The heading text content */
  text: string;
}

/**
 * Props interface for the TableOfContents component
 * @interface Props
 */
interface Props {
  /** Array of heading objects extracted from content */
  headings: Heading[];
  /** Optional custom title for the table of contents */
  title?: string;
  /** Optional language code for localization */
  lang?: string;
  /** Optional class overrides for the panel wrapper */
  className?: string;
}

import { getLangFromUrl, useTranslations } from "@utils/i18n";
import { Icon } from "astro-icon/components";

const { headings = [], title, lang, className = "" } = Astro.props;

// Get language from URL if not provided
const currentLang = lang || getLangFromUrl(Astro.url);

// Get translations function
const t = useTranslations(currentLang);

// Filter to only include h2 and h3 headings
const filteredHeadings = headings.filter(
  (heading) => heading.depth === 2 || heading.depth === 3
);

// Use title from props or default to translated title
const tocTitle = title || t("toc.nav.label");
---

<div class={`panel panel--compact toc ${className}`.trim()} data-toc-shell>
  <div data-toc-root>
    <button
      id="toc-toggle"
      aria-expanded="false"
      aria-controls="toc-content"
      aria-label={t("toc.toggle.label")}
      class="toc__toggle"
    >
      <span class="toc__toggle-label">
        <Icon name="menu" class="toc__toggle-icon" aria-hidden="true" />
        <span>{tocTitle}</span>
      </span>
      <span
        class="toc__sr"
        data-expanded={t("toc.state.expanded")}
        data-collapsed={t("toc.state.collapsed")}
      >
        {t("toc.state.collapsed")}
      </span>
      <Icon
        name="chevron-down"
        id="toc-icon"
        class="toc__toggle-chevron"
        aria-hidden="true"
      />
    </button>

    <div id="toc-content" aria-labelledby="toc-toggle" class="toc__content">
      <nav aria-label={t("toc.nav.label")} class="toc__nav">
        <a href="#article-content" class="toc__skip">
          {t("toc.skip.link")}
        </a>
        <ul id="toc-list" class="toc__list">
          {
            filteredHeadings.map((heading) => (
              <li
                class={`toc__item ${heading.depth === 3 ? "toc__item--child" : ""}`.trim()}
              >
                <a
                  href={`#${heading.slug}`}
                  class={`toc__link ${heading.depth === 3 ? "toc__link--child" : ""}`.trim()}
                >
                  {heading.text}
                </a>
              </li>
            ))
          }
        </ul>
      </nav>
    </div>
  </div>
</div>

<script>
  (() => {
    const shell = document.querySelector("[data-toc-shell]");
    const toggle = document.getElementById("toc-toggle");
    const content = document.getElementById("toc-content");
    const stateText = toggle?.querySelector("[data-expanded]") as HTMLElement | null;
    const tocList = document.getElementById("toc-list");
    const articleRoot = document.getElementById("article-content");

    const getScopeAttr = (element: Element | null): string | null => {
      if (!element) return null;
      const scopeAttr = element
        .getAttributeNames()
        .find((name) => name.startsWith("data-astro-cid"));
      return scopeAttr || null;
    };

    const applyScopeAttr = (element: Element, scopeAttr: string | null): void => {
      if (!scopeAttr) return;
      element.setAttribute(scopeAttr, "");
    };

    const tocScopeAttr = getScopeAttr(tocList);

    const setShellVisibility = (visible: boolean): void => {
      if (!(shell instanceof HTMLElement)) return;
      shell.hidden = !visible;
      shell.setAttribute("aria-hidden", visible ? "false" : "true");
    };

    if (!toggle || !content) {
      setShellVisibility(false);
      return;
    }

    const slugify = (text: string): string =>
      text
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");

    const setExpanded = (expanded: boolean): void => {
      toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
      content.setAttribute("aria-hidden", expanded ? "false" : "true");
      if (shell instanceof HTMLElement) {
        shell.classList.toggle("toc--open", expanded);
      }
      if (stateText) {
        stateText.textContent = expanded
          ? stateText.getAttribute("data-expanded") || ""
          : stateText.getAttribute("data-collapsed") || "";
      }
    };

    let isOpen = false;
    setExpanded(isOpen);

    const buildTocFromDom = (): void => {
      if (!tocList || !articleRoot) {
        setShellVisibility(Boolean(tocList?.children.length));
        return;
      }
      const headingNodes = Array.from(articleRoot.querySelectorAll("h2, h3"));
      if (!headingNodes.length) {
        setShellVisibility(Boolean(tocList?.children.length));
        return;
      }
      setShellVisibility(true);

      const seenIds = new Set<string>();
      const headings = headingNodes
        .map((node) => {
          const depth = Number(node.tagName.substring(1));
          if (depth !== 2 && depth !== 3) return null;
          const text = (node.textContent || "").trim();
          if (!text) return null;

          let id = node.id || slugify(text) || "section";
          let counter = 2;
          while (seenIds.has(id)) {
            id = `${slugify(text) || "section"}-${counter++}`;
          }
          seenIds.add(id);
          if (!node.id) node.id = id;
          return { depth, id, text };
        })
        .filter(Boolean) as Array<{ depth: number; id: string; text: string }>;

      if (!headings.length) return;

      tocList.innerHTML = "";
      headings.forEach((heading) => {
        const li = document.createElement("li");
        li.className = `toc__item ${heading.depth === 3 ? "toc__item--child" : ""}`;
        applyScopeAttr(li, tocScopeAttr);

        const a = document.createElement("a");
        a.href = `#${heading.id}`;
        a.className = heading.depth === 2 ? "toc__link" : "toc__link toc__link--child";
        a.textContent = heading.text;
        applyScopeAttr(a, tocScopeAttr);

        li.appendChild(a);
        tocList.appendChild(li);
      });
    };

    buildTocFromDom();

    const toggleContent = (): void => {
      isOpen = !isOpen;
      setExpanded(isOpen);
    };

    toggle.addEventListener("click", (e): void => {
      e.preventDefault();
      toggleContent();
    });

    toggle.addEventListener("keydown", (e): void => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        toggleContent();
      }
    });

    document.addEventListener("click", (e): void => {
      if (!isOpen) return;
      const target = e.target as Node;
      if (target && !toggle.contains(target) && !content.contains(target)) {
        isOpen = false;
        setExpanded(false);
      }
    });
  })();
</script>
<style>
  .panel {
    --panel-radius: 1.5rem;
    --panel-padding: 1.5rem;
    --panel-bg: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
    --panel-border: color-mix(in srgb, var(--gn-panel-border) 85%, transparent);

    position: relative;
    padding: var(--panel-padding);
    background: var(--panel-bg);
    border: 2px solid var(--panel-border);
    border-radius: var(--panel-radius);
    box-shadow: var(--gn-offset-shadow);
  }

  .panel::after {
    position: absolute;
    inset: 4px;
    pointer-events: none;
    content: "";
    border: 1px solid var(--gn-panel-inner);
    border-radius: calc(var(--panel-radius) - 0.25rem);
  }

  .panel--compact {
    --panel-padding: 1rem;
  }

  .panel--tight {
    --panel-padding: 1.25rem;
  }

  .panel--card {
    --panel-radius: 1.25rem;
    --panel-padding: 1.25rem;
  }

  .toc {
    margin-block-end: 2rem;
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .toc__toggle {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
      inline-size: 100%;
      min-block-size: 48px;
      padding: 0.75rem 1.25rem;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gn-ink);
      text-align: start;
      cursor: pointer;
      background: color-mix(in srgb, var(--gn-bg) 65%, transparent);
      border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
      border-radius: 1rem;
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.06),
        4px 4px 0 rgba(0, 0, 0, 0.75);
      transition: none;
    }
  }

  .toc__toggle {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    justify-content: space-between;
    inline-size: 100%;
    min-block-size: 48px;
    padding: 0.75rem 1.25rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gn-ink);
    text-align: start;
    cursor: pointer;
    background: color-mix(in srgb, var(--gn-bg) 65%, transparent);
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    border-radius: 1rem;
    box-shadow:
      inset 0 1px 0 rgba(255, 255, 255, 0.06),
      4px 4px 0 rgba(0, 0, 0, 0.75);
    transition:
      border-color var(--transition-fast),
      background-color var(--transition-fast),
      box-shadow var(--transition-fast),
      transform var(--transition-fast);
  }

  .toc__toggle:hover,
  .toc__toggle:focus {
    background: color-mix(in srgb, var(--gn-bg-muted) 90%, transparent);
    border-color: var(--color-gn-amber-300);
    box-shadow:
      inset 0 1px 0 rgba(255, 255, 255, 0.08),
      6px 6px 0 rgba(0, 0, 0, 0.82);
  }

  .toc__toggle:focus-visible {
    outline: 4px solid var(--color-gn-amber-300);
    outline-offset: 2px;
  }

  .toc__toggle-label {
    display: inline-flex;
    gap: 0.75rem;
    align-items: center;
  }

  .toc__toggle-icon {
    display: block;
    inline-size: 1.1rem;
    block-size: 1.1rem;
    color: var(--gn-ink-muted);
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .toc__toggle-chevron {
      display: block;
      inline-size: 1.1rem;
      block-size: 1.1rem;
      color: var(--gn-ink-muted);
      transition: none;
    }
  }

  .toc__toggle-chevron {
    display: block;
    inline-size: 1.1rem;
    block-size: 1.1rem;
    color: var(--gn-ink-muted);
    transition: transform var(--transition-fast);
  }

  .toc--open .toc__toggle-chevron {
    transform: rotate(180deg);
  }

  .toc__content {
    display: none;
    margin-block-start: 1rem;
    background: color-mix(in srgb, var(--gn-bg) 75%, transparent);
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    border-radius: 1rem;
    box-shadow:
      inset 0 1px 0 rgba(255, 255, 255, 0.04),
      4px 4px 0 rgba(0, 0, 0, 0.7);
  }

  .toc--open .toc__content {
    display: block;
  }

  .toc__nav {
    padding: 1.25rem;
  }

  .toc__skip {
    display: inline-flex;
    align-items: center;
    min-block-size: 44px;
    margin-block-end: 1rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-gn-amber-300);
    text-decoration: none;
  }

  .toc__skip:hover,
  .toc__skip:focus {
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .toc__list {
    max-block-size: 50vb;
    padding: 0;
    margin: 0;
    overflow-block: auto;
    list-style: none;
  }

  .toc__list::-webkit-scrollbar {
    inline-size: 8px;
  }

  .toc__list::-webkit-scrollbar-track {
    background: var(--color-gn-soot-800);
  }

  .toc__list::-webkit-scrollbar-thumb {
    background: var(--color-gn-soot-600);
    border-radius: 999px;
  }

  .toc__list::-webkit-scrollbar-thumb:hover,
  .toc__list::-webkit-scrollbar-thumb:focus {
    background: var(--color-gn-amber-400);
  }

  .toc__item {
    margin-block-end: 0.25rem;
  }

  .toc__item--child {
    margin-inline-start: 1rem;
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .toc__link {
      display: block;
      min-block-size: 44px;
      padding: 0.5rem 0.75rem;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gn-ink);
      text-decoration: none;
      border-radius: 0.5rem;
      transition: none;
    }
  }

  .toc__link {
    display: block;
    min-block-size: 44px;
    padding: 0.5rem 0.75rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gn-ink);
    text-decoration: none;
    border-radius: 0.5rem;
    transition:
      background-color var(--transition-fast),
      color var(--transition-fast);
  }

  .toc__link--child {
    font-size: 1.125rem;
    font-weight: 500;
    color: var(--gn-ink-muted);
  }

  .toc__link:hover,
  .toc__link:focus {
    color: var(--gn-ink);
    background: color-mix(in srgb, var(--gn-bg-muted) 75%, transparent);
  }

  .toc__link:focus-visible {
    outline: 2px solid var(--color-gn-amber-300);
    outline-offset: 2px;
  }

  .toc__sr {
    position: absolute;
    inline-size: var(--sr-only-width);
    block-size: var(--sr-only-height);
    margin: var(--sr-only-margin);
    overflow: hidden;
    white-space: nowrap;
    border: 0;
    clip-path: var(--sr-only-clip-path);
  }
</style>

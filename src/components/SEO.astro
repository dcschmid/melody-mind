---
import type { StructuredData } from "@utils/seo/buildPageSeo";
import { Head } from "astro-capo";

interface Props {
  title?: string;
  description?: string;
  keywords?: string[];
  image?: string;
  imageWidth?: number;
  imageHeight?: number;
  type?: string;
  publishDate?: Date;
  modifiedDate?: Date;
  ogMusic?: any;
  audioSrc?: string;
  episodeNumber?: number;
  seriesName?: string;
  seriesUrl?: string;
  canonical?: string;
  breadcrumbs?: any;
  noIndex?: boolean;
  noFollow?: boolean;
  prevUrl?: string;
  nextUrl?: string;
  disableAlternateLanguages?: boolean;
  structuredDataExtra?: StructuredData[];
  authorName?: string;
}

const {
  title,
  description,
  keywords,
  canonical,
  noIndex,
  noFollow,
  prevUrl,
  nextUrl,
  publishDate,
  modifiedDate,
  structuredDataExtra,
} = Astro.props;
---

<Head>
  {title && <title>{title}</title>}
  {description && <meta name="description" content={description} />}
  {
    Array.isArray(keywords) && keywords.length > 0 && (
      <meta name="keywords" content={keywords.join(", ")} />
    )
  }

  {/* canonical link (Layout may pass canonical via props) */}
  {canonical && <link rel="canonical" href={canonical} />}

  {/* prev/next pagination rel links */}
  {prevUrl && <link rel="prev" href={prevUrl} />}
  {nextUrl && <link rel="next" href={nextUrl} />}

  {/* Robots override if provided via props (Layout also emits robots sometimes) */}
  {
    (noIndex || noFollow) && (
      <meta
        name="robots"
        content={`${noIndex ? "noindex" : "index"},${noFollow ? "nofollow" : "follow"}`}
      />
    )
  }

  {/* Publish / Modified dates as meta tags (helpful for some parsers) */}
  {
    publishDate && (
      <meta name="article:published_time" content={publishDate.toISOString()} />
    )
  }
  {
    modifiedDate && (
      <meta name="article:modified_time" content={modifiedDate.toISOString()} />
    )
  }

  {
    /* Structured data: combine page-provided structuredDataExtra (if any) with any already-built objects */
  }
  {
    (() => {
      const all = Array.isArray(structuredDataExtra)
        ? structuredDataExtra
        : structuredDataExtra
          ? [structuredDataExtra]
          : [];
      if (all.length === 0) return null;
      try {
        const cleaned = all.map((obj) => {
          const replacer = (_k: string, v: unknown) =>
            v instanceof Date ? v.toISOString() : v;
          return JSON.stringify(obj, replacer as any, 2);
        });
        return cleaned.map((jsonString) => (
          <script is:inline type="application/ld+json" set:html={jsonString} />
        ));
      } catch (e) {
        return null;
      }
    })()
  }
</Head>

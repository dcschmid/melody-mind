---
/**
 * @component SkipLink
 * @description Accessibility component that allows keyboard users to bypass repetitive navigation
 * and quickly access the main content. Initially hidden visually but appears when focused,
 * following WCAG AAA compliance standards.
 *
 * Features:
 * - Mobile-first responsive design
 * - WCAG AAA compliant with enhanced focus indicators
 * - Performance optimized transitions using CSS variables
 * - High contrast mode support
 * - Reduced motion support
 * - Consistent styling using global CSS variables
 * - Proper focus management
 * - Keyboard accessibility optimized
 *
 * @example
 * ```astro
 * <SkipLink targetId="quiz-content" />
 * <SkipLink targetId="main-content" />
 * ```
 *
 * @accessibility
 * - WCAG AAA compliant with enhanced focus indicators
 * - Screen reader announcements with proper ARIA attributes
 * - Keyboard navigation support
 * - High contrast mode support
 * - Reduced motion support
 * - Minimum 44Ã—44px touch target
 */

import { getLangFromUrl, useTranslations } from "@utils/i18n";

interface Props {
  /**
   * The ID of the element to target when the skip link is activated
   * @default "main-content"
   */
  targetId?: string;
}

const { targetId = "main-content" } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<a href={`#${targetId}`} class="skip-link" data-skip-link aria-label={t("nav.skip.main")}>
  <svg
    class="skip-link__icon"
    width="16"
    height="16"
    viewBox="0 0 24 24"
    fill="none"
    aria-hidden="true"
  >
    <path
      d="M7 17L17 7M17 7H8M17 7V16"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"></path>
  </svg>
  {t("nav.skip.main")}
</a>

<style lang="scss">
  /* ======================================
   * SKIPLINK COMPONENT STYLES
   * Mobile-first responsive design using global CSS variables
   * WCAG AAA compliant with enhanced accessibility features
   * ====================================== */

  .skip-link {
    // Positioning - optimize using standardized variables
    position: absolute;
    top: -9999px;
    left: -9999px;
    z-index: var(--z-modal);

    // Layout - use semantic touch target variables consistently
    min-width: var(--min-touch-size);
    min-height: var(--min-touch-size);
    transform: translate(-50%, 0) translateZ(0);

    // Visual styling - enhanced with gradient background
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    background: linear-gradient(
      135deg,
      var(--interactive-primary) 0%,
      var(--color-primary-600) 100%
    );
    padding: var(--space-sm) var(--space-xl);
    box-shadow:
      var(--shadow-lg),
      0 4px 20px rgba(139, 69, 255, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);

    // Typography - use consistent font variables
    text-align: center;
    font-size: var(--text-base);
    font-weight: var(--font-bold);
    color: var(--btn-primary-text);
    line-height: var(--leading-normal);

    // Interactive styles
    text-decoration: none;
    cursor: pointer;

    // Performance optimization
    will-change: top, background-color, transform;
    transition:
      top var(--animation-duration-normal) cubic-bezier(0.16, 1, 0.3, 1),
      background-color var(--animation-duration-fast),
      transform var(--animation-duration-fast);

    // Layout optimization
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xs);

    // Icon styling
    &__icon {
      flex-shrink: 0;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
      transition: transform var(--animation-duration-fast);
    }

    // Mobile-first responsive design
    @media (min-width: 48em) {
      padding: var(--space-md) var(--space-2xl);
      font-size: var(--text-lg);
    }

    @media (min-width: 64em) {
      padding: var(--space-md) var(--space-3xl);
    }

    // Hover state - enhanced with gradient animation
    @media (hover: hover) {
      &:hover {
        background: linear-gradient(
          135deg,
          var(--color-primary-500) 0%,
          var(--color-primary-700) 100%
        );
        transform: translate(-50%, 0) translateZ(0) scale(var(--scale-focus));
        box-shadow:
          var(--shadow-xl),
          0 6px 25px rgba(139, 69, 255, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);

        .skip-link__icon {
          transform: translateX(2px) translateY(-2px);
        }
      }
    }

    // Focus state - enhanced with beautiful gradient and glow
    &:focus-visible {
      top: 0;
      left: 50%;
      outline: var(--focus-enhanced-outline-dark);
      outline-offset: var(--focus-ring-offset);
      background: linear-gradient(
        135deg,
        var(--color-primary-400) 0%,
        var(--color-primary-600) 100%
      );
      box-shadow:
        var(--focus-enhanced-shadow),
        var(--shadow-xl),
        0 8px 30px rgba(139, 69, 255, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.25);
      transform: translate(-50%, 0) translateZ(0) scale(1.05);

      .skip-link__icon {
        transform: translateX(3px) translateY(-3px) scale(1.1);
      }
    }

    // Active state - enhanced with deeper gradient
    &:active {
      transform: translate(-50%, 0) translateZ(0) scale(var(--scale-active));
      background: linear-gradient(
        135deg,
        var(--color-primary-600) 0%,
        var(--color-primary-800) 100%
      );
      box-shadow:
        0 4px 15px rgba(139, 69, 255, 0.3),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    // Touch device optimizations
    @media (pointer: coarse) {
      min-height: var(--min-touch-size);
      min-width: var(--min-touch-size);
      padding: var(--space-md) var(--space-xl);
    }
  }

  // High Contrast Mode Support
  @media (forced-colors: active) {
    .skip-link {
      border: var(--border-width-thick) solid ButtonText;
      background-color: ButtonFace !important;
      color: ButtonText !important;
      forced-color-adjust: none;
    }

    .skip-link:focus-visible {
      outline: var(--border-width-enhanced) solid Highlight !important;
      background-color: Highlight !important;
      color: HighlightText !important;
    }
  }

  // Reduced Motion Support - use semantic animation variables
  @media (prefers-reduced-motion: reduce) {
    .skip-link {
      transition-duration: var(--animation-duration-fast) !important;
      transform: translate(-50%, 0);
    }

    .skip-link:hover,
    .skip-link:active {
      transform: translate(-50%, 0);
    }
  }

  // Enhanced contrast for high contrast preference - using semantic variables
  @media (prefers-contrast: high) {
    .skip-link {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      border: var(--border-width-thick) solid var(--text-primary);
    }

    .skip-link:focus-visible {
      background-color: var(--text-primary);
      color: var(--bg-primary);
      outline-width: var(--border-width-enhanced);
    }
  }

  // Dark mode support
  @media (prefers-color-scheme: dark) {
    .skip-link {
      background-color: var(--interactive-primary-dark);
      color: var(--btn-primary-text-dark);
    }

    .skip-link:hover,
    .skip-link:focus-visible {
      background-color: var(--interactive-primary-hover-dark);
    }

    .skip-link:active {
      background-color: var(--interactive-primary-active-dark);
    }
  }

  // Print styles
  @media print {
    .skip-link {
      display: none;
    }
  }
</style>

<script>
  /* eslint-disable @typescript-eslint/explicit-function-return-type */
  /**
   * SkipLink Enhancement Script
   *
   * Improves the skip link behavior with:
   * - Focus management for the target element
   * - Proper keyboard navigation
   * - Announcements for screen readers
   */
  class SkipLinkEnhancer {
    /** The skip link element */
    #skipLink: HTMLAnchorElement | null = null;

    /**
     * Initialize the enhancer
     */
    constructor() {
      this.#skipLink = document.querySelector("[data-skip-link]");
      this.#setupEventListeners();
    }

    /**
     * Set up event listeners for the skip link
     */
    #setupEventListeners = () => {
      if (!this.#skipLink) {
        return;
      }

      // Add click handler with proper focus management
      this.#skipLink.addEventListener("click", (e) => {
        e.preventDefault();

        const targetId = this.#skipLink?.getAttribute("href")?.substring(1);
        if (!targetId) {
          return;
        }

        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          // Set tabindex to make non-interactive elements focusable
          if (!targetElement.getAttribute("tabindex")) {
            targetElement.setAttribute("tabindex", "-1");
          }

          // Enhanced accessibility: Associate skip link with target element
          const announcementId = `skip-link-announcement-${targetId}`;
          targetElement.setAttribute("aria-describedby", announcementId);

          // Focus the target and scroll into view
          targetElement.focus({ preventScroll: true });
          targetElement.scrollIntoView({
            behavior: this.#prefersReducedMotion() ? "auto" : "smooth",
          });

          // Announce to screen readers with enhanced context
          this.#announceToScreenReader(`Skipped to ${targetId}`, announcementId);
        }
      });

      // Monitor for page changes in SPA context
      document.addEventListener("astro:page-load", () => {
        // Re-acquire skip link reference after page changes
        this.#skipLink = document.querySelector("[data-skip-link]");
        this.#setupEventListeners();
      });
    };

    /**
     * Check if user prefers reduced motion
     * @returns {boolean} True if reduced motion is preferred
     */
    #prefersReducedMotion = () => {
      return window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    };

    /**
     * Announce a message to screen readers
     * @param {string} message - The message to announce
     * @param {string} id - Optional ID for the announcer element
     */
    #announceToScreenReader = (message, id) => {
      const announcer = document.createElement("div");
      announcer.setAttribute("aria-live", "assertive");
      announcer.setAttribute("aria-atomic", "true");
      announcer.className = "sr-only";
      announcer.textContent = message;

      // Set ID if provided for aria-describedby relationship
      if (id) {
        announcer.id = id;
      }

      document.body.appendChild(announcer);

      // Remove after announcement is likely complete - use semantic timeout from CSS variable
      const cleanupDelay =
        parseInt(
          getComputedStyle(document.documentElement)
            .getPropertyValue("--announcement-cleanup")
            .replace("ms", "")
        ) || 3000;

      setTimeout(() => {
        if (document.body.contains(announcer)) {
          document.body.removeChild(announcer);
        }
      }, cleanupDelay);
    };
  }

  // Initialize enhancer when DOM is ready using modern ES6 features
  const initializeSkipLink = () => {
    new SkipLinkEnhancer();
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeSkipLink);
  } else {
    initializeSkipLink();
  }
</script>

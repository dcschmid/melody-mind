---
import ThemeToggle from "@components/ThemeToggle.astro";
---

<footer class="site-footer">
  <div class="site-footer__container">
    <div class="site-footer__grid">
      <div class="site-footer__section">
        <p class="site-footer__title">Melody Mind</p>
        <p class="site-footer__text">
          Curated knowledge and playlists to help you listen with intent and discover new sounds.
        </p>
      </div>

      <div class="site-footer__section">
        <p class="site-footer__title">Explore</p>
        <nav
          aria-label="Footer navigation"
          class="site-footer__nav site-footer__nav--two-column"
        >
          <a class="site-footer__link" href="/bookmarks"> Bookmarks </a>
          <a
            class="site-footer__link"
            href="https://podcasts.melody-mind.de"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Open Melody Mind podcast site (opens in a new tab)"
          >
            Podcast
          </a>
        </nav>
      </div>

      <div class="site-footer__section">
        <p class="site-footer__title">Support</p>
        <nav aria-label="Support links" class="site-footer__nav">
          <a
            class="site-footer__link"
            href="https://www.paypal.me/dcschmid"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Donate via PayPal (opens in a new tab)"
          >
            PayPal
          </a>
          <a
            class="site-footer__link"
            href="https://www.buymeacoffee.com/dcschmid"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Support on Buy Me a Coffee (opens in a new tab)"
          >
            Buy me a coffee
          </a>
        </nav>
      </div>

      <div class="site-footer__section">
        <p class="site-footer__title">Legal</p>
        <nav aria-label="Legal navigation" class="site-footer__nav">
          <a class="site-footer__link" href="/imprint"> Imprint </a>
          <a class="site-footer__link" href="/privacy"> Privacy Policy </a>
          <a class="site-footer__link" href="/ai-content"> AI Content </a>
        </nav>
      </div>

      <div class="site-footer__section">
        <p class="site-footer__title">Settings</p>
        <nav aria-label="Settings navigation" class="site-footer__nav">
          <ThemeToggle />
          <button
            type="button"
            class="site-footer__link site-footer__cookie-button"
            data-cookie-settings-trigger
          >
            Cookie Settings
          </button>
          <button
            type="button"
            class="site-footer__link site-footer__cookie-button"
            data-reading-settings-trigger
          >
            Reading Settings
          </button>
        </nav>
        <div class="site-footer__status-list">
          <p class="site-footer__cookie-status" data-theme-status>Theme status: system</p>
          <p class="site-footer__cookie-status" data-cookie-consent-status>
            Cookie status: pending choice
          </p>
          <p class="site-footer__cookie-status" data-reading-preferences-status>
            Reading status: default
          </p>
        </div>
      </div>
    </div>

    <div class="site-footer__meta">
      <p>Â© 2025 MelodyMind. All rights reserved.</p>
      <p class="site-footer__meta-note">
        Optimized for accessibility (WCAG AAA) and responsive on all screens.
      </p>
    </div>
  </div>
</footer>
<script>
  const STORAGE_KEY = "cookie_consent";
  const READING_KEY = "readingPreferences";
  const THEME_KEY = "themePreference";
  const trigger = document.querySelector("[data-cookie-settings-trigger]");
  const readingTrigger = document.querySelector("[data-reading-settings-trigger]");
  const themeStatusElement = document.querySelector("[data-theme-status]");
  const statusElement = document.querySelector("[data-cookie-consent-status]");
  const readingStatusElement = document.querySelector(
    "[data-reading-preferences-status]"
  );

  interface ConsentPreference {
    essential: true;
    analytics: boolean;
  }

  interface ReadingPreference {
    fontSize: "small" | "medium" | "large";
    lineHeight: "compact" | "normal" | "relaxed";
    readingMode: boolean;
  }

  const isTheme = (value: unknown): value is "light" | "dark" =>
    value === "light" || value === "dark";

  const getStoredTheme = (): "light" | "dark" | null => {
    try {
      const raw = window.localStorage?.getItem(THEME_KEY);
      return isTheme(raw) ? raw : null;
    } catch {
      return null;
    }
  };

  const getResolvedTheme = (): "light" | "dark" => {
    const rootTheme = document.documentElement.getAttribute("data-theme");
    if (isTheme(rootTheme)) {
      return rootTheme;
    }

    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  };

  const dntEnabled = () => {
    const navigatorAny = window.navigator as Navigator & {
      msDoNotTrack?: string;
    };
    const windowAny = window as Window & { doNotTrack?: string };
    const navigatorValue = navigatorAny.doNotTrack;
    const windowValue = windowAny.doNotTrack;
    const legacyMsValue = navigatorAny.msDoNotTrack;

    return navigatorValue === "1" || windowValue === "1" || legacyMsValue === "1";
  };

  const readConsent = (): ConsentPreference | null => {
    try {
      const raw = window.localStorage?.getItem(STORAGE_KEY);
      if (!raw) {
        return null;
      }

      const parsed = JSON.parse(raw);
      if (!parsed || parsed.essential !== true || typeof parsed.analytics !== "boolean") {
        return null;
      }

      return {
        essential: true,
        analytics: parsed.analytics,
      };
    } catch {
      return null;
    }
  };

  const isReadingFontSize = (value: unknown): value is ReadingPreference["fontSize"] =>
    value === "small" || value === "medium" || value === "large";

  const isReadingLineHeight = (
    value: unknown
  ): value is ReadingPreference["lineHeight"] =>
    value === "compact" || value === "normal" || value === "relaxed";

  const readReadingPreferences = (): ReadingPreference | null => {
    try {
      const raw = window.localStorage?.getItem(READING_KEY);
      if (!raw) return null;

      const parsed = JSON.parse(raw);
      if (
        !isReadingFontSize(parsed?.fontSize) ||
        !isReadingLineHeight(parsed?.lineHeight)
      ) {
        return null;
      }

      return {
        fontSize: parsed.fontSize,
        lineHeight: parsed.lineHeight,
        readingMode: typeof parsed.readingMode === "boolean" ? parsed.readingMode : false,
      };
    } catch {
      return null;
    }
  };

  const renderStatus = (consent: ConsentPreference | null = readConsent()) => {
    if (!statusElement) {
      return;
    }

    if (!consent) {
      statusElement.textContent = "Cookie status: pending choice";
      return;
    }

    if (!consent.analytics) {
      statusElement.textContent = "Cookie status: essential only";
      return;
    }

    if (dntEnabled()) {
      statusElement.textContent = "Cookie status: analytics consented (DNT active)";
      return;
    }

    statusElement.textContent = "Cookie status: analytics allowed";
  };

  renderStatus();

  const renderThemeStatus = () => {
    if (!themeStatusElement) {
      return;
    }

    const storedTheme = getStoredTheme();
    const resolvedTheme = getResolvedTheme();
    const source = storedTheme ? "manual" : "system";
    themeStatusElement.textContent = `Theme status: ${resolvedTheme} (${source})`;
  };

  renderThemeStatus();

  const renderReadingStatus = (
    prefs: ReadingPreference | null = readReadingPreferences()
  ) => {
    if (!readingStatusElement) {
      return;
    }

    if (!prefs) {
      readingStatusElement.textContent = "Reading status: default";
      return;
    }

    const size =
      prefs.fontSize === "small" ? "A-" : prefs.fontSize === "large" ? "A+" : "A";
    const spacing =
      prefs.lineHeight === "compact"
        ? "compact"
        : prefs.lineHeight === "relaxed"
          ? "relaxed"
          : "normal";
    const mode = prefs.readingMode ? "focus on" : "focus off";

    readingStatusElement.textContent = `Reading status: ${size}, ${spacing}, ${mode}`;
  };

  renderReadingStatus();

  if (trigger) {
    trigger.addEventListener("click", () => {
      window.dispatchEvent(new CustomEvent("cookie-consent:open"));
    });
  }

  if (readingTrigger) {
    const hasReadingControls = Boolean(document.querySelector(".reading-controls"));

    if (!hasReadingControls) {
      readingTrigger.setAttribute("hidden", "true");
      readingTrigger.setAttribute("aria-hidden", "true");
      readingTrigger.setAttribute("tabindex", "-1");
    }

    readingTrigger.addEventListener("click", () => {
      if (!hasReadingControls) {
        return;
      }

      window.dispatchEvent(new CustomEvent("reading-settings:open"));
    });
  }

  window.addEventListener("cookie-consent:change", (event) => {
    const detail = (event as CustomEvent<{ consent?: unknown }>).detail;
    const consent = detail && typeof detail === "object" ? detail.consent : null;

    if (
      consent &&
      typeof consent === "object" &&
      (consent as ConsentPreference).essential === true &&
      typeof (consent as ConsentPreference).analytics === "boolean"
    ) {
      renderStatus(consent as ConsentPreference);
      return;
    }

    renderStatus(readConsent());
  });

  window.addEventListener("reading-preferences:change", (event) => {
    const detail = (event as CustomEvent<{ preferences?: unknown }>).detail;
    const preferences =
      detail && typeof detail === "object"
        ? detail.preferences
        : readReadingPreferences();

    if (
      preferences &&
      typeof preferences === "object" &&
      isReadingFontSize((preferences as ReadingPreference).fontSize) &&
      isReadingLineHeight((preferences as ReadingPreference).lineHeight)
    ) {
      renderReadingStatus(preferences as ReadingPreference);
      return;
    }

    renderReadingStatus(readReadingPreferences());
  });

  window.addEventListener("theme:change", () => {
    renderThemeStatus();
  });
</script>
<style>
  .site-footer {
    margin-top: 4rem;
    border-top: 2px solid var(--gn-panel-border);
    background: color-mix(in srgb, var(--gn-bg) 92%, transparent);
    backdrop-filter: blur(6px);
  }

  .site-footer__container {
    max-width: 72rem;
    margin: 0 auto;
    padding: 2.5rem 1rem;
    color: var(--gn-ink);
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  @media (min-width: 640px) {
    .site-footer__container {
      padding: 3rem 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .site-footer__container {
      padding: 3rem 2rem;
    }
  }

  .site-footer__grid {
    display: grid;
    gap: 2rem;
  }

  @media (min-width: 640px) {
    .site-footer__grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1024px) {
    .site-footer__grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .site-footer__section {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .site-footer__title {
    font-size: 1.125rem;
    font-weight: 600;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--color-gn-amber-300);
  }

  .site-footer__text {
    font-size: 1.125rem;
    line-height: 1.6;
    color: var(--gn-ink-muted);
  }

  .site-footer__nav {
    display: grid;
    gap: 0.5rem;
  }

  @media (min-width: 640px) {
    .site-footer__nav--two-column {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1024px) {
    .site-footer__nav--two-column {
      grid-template-columns: 1fr;
    }
  }

  .site-footer__link {
    font-size: 1.125rem;
    color: var(--gn-ink-muted);
    text-decoration: none;
    border-radius: 0.35rem;
    padding: 0.15rem 0.3rem;
    transition: color var(--transition-fast);
  }

  .site-footer__link:hover {
    color: var(--gn-ink);
  }

  .site-footer__link:focus-visible {
    outline: 2px solid var(--color-gn-amber-300);
    outline-offset: 2px;
  }

  .site-footer__meta {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--gn-panel-border);
    font-size: 1.125rem;
    color: var(--gn-ink-muted);
  }

  @media (min-width: 640px) {
    .site-footer__meta {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }

  .site-footer__meta-note {
    font-size: 1.125rem;
    color: color-mix(in srgb, var(--gn-ink-muted) 80%, transparent);
  }

  .site-footer__cookie-button {
    background: none;
    border: 0;
    text-align: left;
    cursor: pointer;
    width: fit-content;
    font-family: inherit;
  }

  .site-footer__cookie-status {
    margin: 0;
    font-size: 1rem;
    color: color-mix(in srgb, var(--gn-ink-muted) 86%, transparent);
  }

  .site-footer__status-list {
    display: grid;
    gap: 0.25rem;
    margin-top: 0.45rem;
    padding-top: 0.4rem;
    border-top: 1px solid color-mix(in srgb, var(--gn-panel-border) 50%, transparent);
  }
</style>

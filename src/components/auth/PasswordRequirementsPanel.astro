---
/**
 * PasswordRequirementsPanel Component
 * WCAG 2.2 AAA Compliant Password Requirements Checker
 *
 * Features:
 * - Live region announcements for screen readers
 * - Enhanced keyboard navigation
 * - Multiple visual indicators beyond color
 * - AAA color contrast ratios
 * - Support for increased text spacing and 400% zoom
 */

import { getLangFromUrl, useTranslations } from "@utils/i18n";
import { validatePassword, type PasswordErrorKey } from "@lib/auth/password-validation";
import Paragraph from "@components/Paragraph.astro";

interface Props {
  password?: string;
  isVisible?: boolean;
}

const { password = "", isVisible = false }: Props = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const validationResult = validatePassword(password);

const requirements = [
  {
    id: "length",
    errorKey: "auth.password.min_length_error" as PasswordErrorKey,
    textKey: "auth.password.min_length",
  },
  {
    id: "uppercase",
    errorKey: "auth.password.uppercase_error" as PasswordErrorKey,
    textKey: "auth.password.uppercase",
  },
  {
    id: "lowercase",
    errorKey: "auth.password.lowercase_error" as PasswordErrorKey,
    textKey: "auth.password.lowercase",
  },
  {
    id: "number",
    errorKey: "auth.password.number_error" as PasswordErrorKey,
    textKey: "auth.password.number",
  },
  {
    id: "special",
    errorKey: "auth.password.special_char_error" as PasswordErrorKey,
    textKey: "auth.password.special",
  },
] as const;

const validatedRequirements = requirements.map((req) => ({
  ...req,
  isMet: !validationResult.errors.includes(req.errorKey),
  text: t(req.textKey),
}));

const metCount = validatedRequirements.filter((req) => req.isMet).length;

import { calculatePasswordStrength } from "@lib/auth/password-validation";

const strengthResult = calculatePasswordStrength(password);
const passwordStrength = strengthResult.level.toLowerCase().replace("-", "_");
const strengthPercentage = strengthResult.score;
---

<div
  id="password-requirements-status"
  class="sr-only"
  aria-live="polite"
  aria-atomic="true"
  role="status"
>
  {t("auth.password.requirements.status", { met: metCount, total: requirements.length })}
</div>

<div
  class={`password-requirements ${isVisible ? "password-requirements--visible" : "password-requirements--hidden"}`}
  aria-hidden={!isVisible}
  role="region"
  aria-labelledby="requirements-heading"
>
  <fieldset class="password-requirements__fieldset">
    <legend id="requirements-heading" class="password-requirements__heading">
      {t("auth.password.requirements")}
      <span class="sr-only">
        {t("auth.password.requirements.help")}
      </span>
    </legend>

    <ul
      class="password-requirements__list"
      aria-label={t("auth.password.requirements.checklist")}
      data-keyboard-nav="true"
    >
      {
        validatedRequirements.map((req, index) => (
          <li
            id={`requirement-${req.id}`}
            class={`password-requirements__item ${req.isMet ? "password-requirements__item--valid" : "password-requirements__item--invalid"}`}
            aria-describedby={`desc-${req.id}`}
            tabindex="-1"
            data-index={index}
          >
            <span class="password-requirements__icon" aria-hidden="true">
              {req.isMet ? "✓" : "✗"}
            </span>
            <span class="password-requirements__symbol" aria-hidden="true">
              {req.isMet ? "●" : "○"}
            </span>
            <span class="password-requirements__text">{req.text}</span>
            <span class="password-requirements__status sr-only">
              {req.isMet
                ? t("auth.password.requirements.met")
                : t("auth.password.requirements.not_met")}
            </span>

            <span id={`desc-${req.id}`} class="sr-only">
              {t(`auth.password.requirements.${req.id}.description`)}
            </span>
          </li>
        ))
      }
    </ul>

    <div class="password-requirements__progress">
      <Paragraph
        description={t("auth.password.strength")}
        textSize="base"
        className="password-requirements__progress-label"
        id="progress-label"
      />
      <div
        class="password-requirements__progress-meter"
        role="progressbar"
        aria-valuemin="0"
        aria-valuemax={requirements.length}
        aria-valuenow={metCount}
        aria-labelledby="progress-label"
        aria-describedby="progress-description"
      >
        <div
          class={`password-requirements__progress-bar password-requirements__progress-bar--${passwordStrength}`}
          style={`--progress-width: ${strengthPercentage}%`}
        >
        </div>
      </div>
      <Paragraph
        description={t(`auth.password.strength.${passwordStrength}`)}
        textSize="base"
        className={`password-requirements__progress-text password-requirements__progress-text--${passwordStrength}`}
      />
      <Paragraph
        description={t("auth.password.strength.description")}
        textSize="base"
        className="sr-only"
        id="progress-description"
      />
    </div>

    <div class="sr-only" id="keyboard-instructions">
      <Paragraph
        description={t("auth.password.requirements.keyboard_navigation")}
        textSize="base"
        className="sr-only"
      />
      <Paragraph
        description={t("auth.password.requirements.keyboard_spacebar")}
        textSize="base"
        className="sr-only"
      />
      <Paragraph
        description={t("auth.password.requirements.keyboard_progress")}
        textSize="base"
        className="sr-only"
      />
    </div>
  </fieldset>
</div>

<script
  define:vars={{
    positionText: t("auth.password.requirements.position"),
    progressText: t("auth.password.requirements.progress"),
  }}
>
  import { initPasswordRequirementsPanel } from "@utils/password-requirements-panel";

  // Modern ES6+ initialization with arrow function
  const initializeComponent = () => {
    initPasswordRequirementsPanel(positionText, progressText);
  };

  // Use modern event listener with arrow function
  document.addEventListener("DOMContentLoaded", initializeComponent);
</script>

<style lang="scss">
  .password-requirements {
    background: var(--card-bg);
    border: var(--border-width-thick) solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-top: var(--space-md);
    box-shadow: var(--shadow-md);
    transition: all var(--transition-normal);
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    max-width: 100%;
    overflow-wrap: break-word;

    &--visible {
      opacity: 1;
      max-height: 500px;
    }

    &--hidden {
      opacity: 0;
      max-height: 0;
    }

    &__fieldset {
      border: none;
      padding: 0;
      margin: 0;
      min-width: 0;
    }

    &__heading {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      margin: 0 0 var(--space-lg) 0;
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);
    }

    &__list {
      list-style: none;
      padding: 0;
      margin: 0 0 var(--space-xl) 0;
      outline: none;

      &:focus-visible {
        outline: var(--focus-outline);
        outline-offset: var(--focus-ring-offset);
      }
    }

    &__item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-xs);
      min-height: var(--min-touch-size);
      transition: all var(--transition-normal);
      border: var(--border-width-thick) transparent solid;
      font-size: var(--text-base);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);

      &:focus-visible {
        outline: var(--focus-outline);
        outline-offset: var(--focus-ring-offset);
        background: var(--focus-bg-overlay);
      }

      &--valid {
        background: var(--bg-success-subtle);
        border-color: var(--border-success);
        color: var(--text-success-aaa);

        .password-requirements__icon {
          color: var(--text-success-aaa);
          background-color: var(--bg-success-aaa);
          border: var(--border-width-thin) solid var(--border-success);
        }

        .password-requirements__symbol {
          color: var(--color-success-400);
        }
      }

      &--invalid {
        background: var(--bg-tertiary);
        border-color: var(--border-primary);
        color: var(--text-secondary);

        .password-requirements__icon {
          color: var(--text-error-aaa);
          background-color: var(--bg-error-aaa);
          border: var(--border-width-thin) solid var(--border-error);
        }

        .password-requirements__symbol {
          color: var(--color-neutral-400);
        }
      }

      &[tabindex="-1"]:focus {
        outline: var(--focus-outline);
        background: var(--focus-bg-overlay);
      }
    }

    &__icon {
      font-size: var(--text-base);
      font-weight: var(--font-bold);
      min-width: var(--space-lg);
      text-align: center;
      width: var(--space-xl);
      height: var(--space-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
      flex-shrink: 0;
    }

    &__symbol {
      font-size: var(--text-base);
      min-width: var(--space-md);
      text-align: center;
      flex-shrink: 0;
    }

    &__text {
      flex: 1;
      font-size: var(--text-base);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);
    }

    &__progress {
      border-top: var(--border-width-thin) solid var(--border-primary);
      padding-top: var(--space-md);
      margin-top: var(--space-lg);
    }

    &__progress-label {
      font-size: var(--text-base);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
      margin: 0 0 var(--space-sm) 0;
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);
    }

    &__progress-meter {
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      height: var(--space-md);
      overflow: hidden;
      border: var(--border-width-thin) solid var(--border-primary);
      margin-bottom: var(--space-sm);
      width: 100%;
      position: relative;

      &:focus-visible {
        outline: var(--focus-outline);
        outline-offset: var(--focus-ring-offset);
      }
    }

    &__progress-bar {
      height: 100%;
      background: linear-gradient(
        90deg,
        var(--color-error-500) 0%,
        var(--color-warning-500) 50%,
        var(--color-success-500) 100%
      );
      transition: width var(--transition-normal);
      border-radius: var(--radius-full);
      width: var(--progress-width, 0%);

      &--weak {
        background: var(--strength-weak);
      }

      &--medium {
        background: var(--strength-medium);
      }

      &--good {
        background: var(--strength-strong);
      }

      &--strong {
        background: var(--strength-very-strong);
      }

      &--very_strong {
        background: var(--strength-very-strong);
      }
    }

    &__progress-text {
      font-size: var(--text-base);
      font-weight: var(--font-medium);
      margin: 0;
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);

      &--weak {
        color: var(--text-error-aaa);
      }

      &--medium {
        color: var(--text-warning-aaa);
      }

      &--good {
        color: var(--color-info-400);
      }

      &--strong {
        color: var(--text-success-aaa);
      }

      &--very_strong {
        color: var(--text-success-aaa);
      }
    }
  }

  .password-requirements__list[data-keyboard-nav="true"] {
    .password-requirements__item {
      cursor: pointer;

      &:hover {
        background: var(--bg-hover-subtle);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      &[tabindex="0"] {
        background: var(--focus-bg-overlay);
        border-color: var(--border-focus);
      }
    }
  }

  .password-requirements,
  .password-requirements__item,
  .password-requirements__progress-bar {
    transition: var(--transition-normal);
  }

  @media (min-width: 40em) {
    .password-requirements {
      &__heading {
        font-size: var(--text-xl);
      }

      &__item {
        font-size: var(--text-lg);
        padding: var(--space-md) var(--space-lg);
      }

      &__text {
        font-size: var(--text-lg);
      }

      &__progress-label {
        font-size: var(--text-lg);
      }
    }
  }

  @media (max-width: 39.9375em) {
    .password-requirements {
      padding: var(--space-md);
      margin-top: var(--space-sm);

      &__heading {
        font-size: var(--text-base);
        margin-bottom: var(--space-md);
      }

      &__item {
        padding: var(--space-sm) 0;
        font-size: var(--text-sm);
        min-height: var(--min-touch-size);
      }

      &__text {
        font-size: var(--text-sm);
      }

      &__progress-label {
        font-size: var(--text-sm);
      }
    }
  }

  @media (max-width: 23.4375em) {
    .password-requirements {
      padding: var(--space-sm);
      margin-top: var(--space-xs);

      &__heading {
        font-size: var(--text-sm);
        margin-bottom: var(--space-sm);
      }

      &__item {
        padding: var(--space-xs) 0;
        font-size: var(--text-xs);
        gap: var(--space-xs);
      }

      &__text {
        font-size: var(--text-xs);
      }

      &__progress-label {
        font-size: var(--text-xs);
      }

      &__icon {
        width: var(--space-lg);
        height: var(--space-lg);
        font-size: var(--text-sm);
      }
    }
  }

  @media (prefers-contrast: high) {
    .password-requirements {
      border-width: var(--border-width-thick);
      background: var(--color-black);
      color: var(--color-white);

      &__item {
        border-width: var(--border-width-thick);

        &--valid {
          background: var(--bg-success-aaa);
          color: var(--color-white);
        }

        &--invalid {
          background: var(--bg-secondary);
          color: var(--color-white);
        }
      }

      &__progress-meter {
        border-width: var(--border-width-thick);
        background: var(--color-black);
      }
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .password-requirements,
    .password-requirements__item,
    .password-requirements__progress-bar {
      transition: none;
    }
  }

  @media (hover: none) and (pointer: coarse) {
    .password-requirements {
      &__item {
        min-height: var(--min-touch-size);
        padding: var(--space-md);
        font-size: var(--text-lg);

        &:hover {
          transform: none;
        }
      }

      &__text {
        font-size: var(--text-lg);
      }

      &__progress-label {
        font-size: var(--text-lg);
      }
    }
  }

  @container (max-width: 64em) {
    .password-requirements {
      padding: var(--space-md);

      &__item {
        padding: var(--space-xs) var(--space-sm);
        gap: var(--space-xs);
      }

      &__text {
        font-size: var(--text-base);
      }
    }
  }

  @media print {
    .password-requirements {
      background: var(--print-bg);
      border: var(--print-border);
      box-shadow: none;

      &__item {
        &--valid {
          background: var(--print-bg);
          border: var(--print-border);

          .password-requirements__icon::after {
            content: " ✓";
          }
        }

        &--invalid .password-requirements__icon::after {
          content: " ✗";
        }
      }
    }
  }

  @media (forced-colors: active) {
    .password-requirements {
      &__item:focus-visible {
        outline: var(--border-width-thick) solid ButtonText;
        background-color: Highlight;
        color: HighlightText;
      }

      &__list:focus-visible {
        outline: var(--border-width-thick) solid ButtonText;
      }

      &__progress-meter:focus-visible {
        outline: var(--border-width-thick) solid ButtonText;
      }
    }
  }
</style>

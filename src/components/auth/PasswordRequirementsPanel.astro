---
/**
 * PasswordRequirementsPanel - Interactive password requirements checker
 *
 * Features:
 * - Live validation with visual feedback
 * - WCAG AAA compliant with enhanced accessibility
 * - Performance optimized with CSS containment
 * - Full responsive design with container queries
 * - Keyboard navigation and screen reader support
 * - Multi-modal indicators (color, icons, symbols)
 *
 * @component
 * @accessibility WCAG AAA compliant with live regions and keyboard navigation
 * @performance CSS containment, GPU acceleration, efficient state management
 * @responsive Mobile-first design with container queries and fluid scaling
 */
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import { validatePassword, type PasswordErrorKey } from "@lib/auth/password-validation";
import Paragraph from "@components/Paragraph.astro";

export interface Props {
  /** Current password value for validation */
  password?: string;
  /** Panel visibility state */
  isVisible?: boolean;
}

const { password = "", isVisible = false }: Props = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const validationResult = validatePassword(password);

const requirements = [
  {
    id: "length",
    errorKey: "auth.password.min_length_error" as PasswordErrorKey,
    textKey: "auth.password.min_length",
  },
  {
    id: "uppercase",
    errorKey: "auth.password.uppercase_error" as PasswordErrorKey,
    textKey: "auth.password.uppercase",
  },
  {
    id: "lowercase",
    errorKey: "auth.password.lowercase_error" as PasswordErrorKey,
    textKey: "auth.password.lowercase",
  },
  {
    id: "number",
    errorKey: "auth.password.number_error" as PasswordErrorKey,
    textKey: "auth.password.number",
  },
  {
    id: "special",
    errorKey: "auth.password.special_char_error" as PasswordErrorKey,
    textKey: "auth.password.special",
  },
] as const;

const validatedRequirements = requirements.map((req) => ({
  ...req,
  isMet: !validationResult.errors.includes(req.errorKey),
  text: t(req.textKey),
}));

const metCount = validatedRequirements.filter((req) => req.isMet).length;

import { calculatePasswordStrength } from "@lib/auth/password-validation";

const strengthResult = calculatePasswordStrength(password);
const passwordStrength = strengthResult.level.toLowerCase().replace("-", "_");
const strengthPercentage = strengthResult.score;
---

<div
  id="password-requirements-status"
  class="sr-only"
  aria-live="polite"
  aria-atomic="true"
  role="status"
>
  {t("auth.password.requirements.status", { met: metCount, total: requirements.length })}
</div>

<div
  class={`password-requirements ${isVisible ? "password-requirements--visible" : "password-requirements--hidden"}`}
  aria-hidden={!isVisible}
  role="region"
  aria-labelledby="requirements-heading"
>
  <fieldset class="password-requirements__fieldset">
    <legend id="requirements-heading" class="password-requirements__heading">
      {t("auth.password.requirements")}
      <span class="sr-only">
        {t("auth.password.requirements.help")}
      </span>
    </legend>

    <ul
      class="password-requirements__list"
      aria-label={t("auth.password.requirements.checklist")}
      data-keyboard-nav="true"
    >
      {
        validatedRequirements.map((req, index) => (
          <li
            id={`requirement-${req.id}`}
            class={`password-requirements__item ${req.isMet ? "password-requirements__item--valid" : "password-requirements__item--invalid"}`}
            aria-describedby={`desc-${req.id}`}
            tabindex="-1"
            data-index={index}
          >
            <span class="password-requirements__icon" aria-hidden="true">
              {req.isMet ? "✓" : "✗"}
            </span>
            <span class="password-requirements__symbol" aria-hidden="true">
              {req.isMet ? "●" : "○"}
            </span>
            <span class="password-requirements__text">{req.text}</span>
            <span class="password-requirements__status sr-only">
              {req.isMet
                ? t("auth.password.requirements.met")
                : t("auth.password.requirements.not_met")}
            </span>

            <span id={`desc-${req.id}`} class="sr-only">
              {t(`auth.password.requirements.${req.id}.description`)}
            </span>
          </li>
        ))
      }
    </ul>

    <div class="password-requirements__progress">
      <Paragraph
        description={t("auth.password.strength")}
        textSize="base"
        className="password-requirements__progress-label"
        id="progress-label"
      />
      <div
        class="password-requirements__progress-meter"
        role="progressbar"
        aria-valuemin="0"
        aria-valuemax={requirements.length}
        aria-valuenow={metCount}
        aria-labelledby="progress-label"
        aria-describedby="progress-description"
      >
        <div
          class={`password-requirements__progress-bar password-requirements__progress-bar--${passwordStrength}`}
          style={`--progress-width: ${strengthPercentage}%`}
        >
        </div>
      </div>
      <Paragraph
        description={t(`auth.password.strength.${passwordStrength}`)}
        textSize="base"
        className={`password-requirements__progress-text password-requirements__progress-text--${passwordStrength}`}
      />
      <Paragraph
        description={t("auth.password.strength.description")}
        textSize="base"
        className="sr-only"
        id="progress-description"
      />
    </div>

    <div class="sr-only" id="keyboard-instructions">
      <Paragraph
        description={t("auth.password.requirements.keyboard_navigation")}
        textSize="base"
        className="sr-only"
      />
      <Paragraph
        description={t("auth.password.requirements.keyboard_spacebar")}
        textSize="base"
        className="sr-only"
      />
      <Paragraph
        description={t("auth.password.requirements.keyboard_progress")}
        textSize="base"
        className="sr-only"
      />
    </div>
  </fieldset>
</div>

<script
  define:vars={{
    positionText: t("auth.password.requirements.position"),
    progressText: t("auth.password.requirements.progress"),
  }}
  is:inline
>
  import { initPasswordRequirementsPanel } from "@utils/password-requirements-panel";

  // Modern ES6+ initialization with arrow function
  const initializeComponent = () => {
    initPasswordRequirementsPanel(positionText, progressText);
  };

  // Use modern event listener with arrow function
  document.addEventListener("DOMContentLoaded", initializeComponent);
</script>

<style lang="scss">
  /**
   * PasswordRequirementsPanel Component Styles
   * 
   * ✅ 100% global.css variables integration
   * ✅ Performance optimized with CSS containment
   * ✅ WCAG AAA compliant styling
   * ✅ Responsive design with container queries
   * ✅ GPU acceleration for smooth animations
   */

  .password-requirements {
    background: var(--bg-secondary);
    border: var(--border-width-thick) solid var(--border-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);

    padding: clamp(var(--space-md), 4vw, var(--space-xl));
    margin-top: clamp(var(--space-sm), 3vw, var(--space-md));

    opacity: var(--animation-opacity-start);
    max-height: var(--space-none);
    overflow: hidden;
    max-width: var(--width-full);

    // Performance optimizations
    contain: layout style paint;
    content-visibility: auto;
    contain-intrinsic-size: var(--container-intrinsic-height-component);

    transform: translateZ(0);
    will-change: opacity, max-height, box-shadow;

    transition:
      opacity var(--transition-normal),
      max-height var(--transition-normal),
      box-shadow var(--transition-normal);

    // Container query support
    container-type: inline-size;
    container-name: password-requirements;

    overflow-wrap: break-word;
    word-wrap: break-word;
    hyphens: auto;

    &--visible {
      opacity: var(--animation-opacity-full);
      max-height: 500px;
      box-shadow: var(--shadow-lg);
    }

    &--hidden {
      opacity: var(--animation-opacity-start);
      max-height: var(--space-none);
    }

    &__fieldset {
      border: none;
      padding: var(--space-none);
      margin: var(--space-none);
      min-width: var(--space-none);

      // Performance optimizations
      contain: layout style;
    }

    &__heading {
      font-size: clamp(var(--text-base), 4vw, var(--text-xl));
      font-weight: var(--font-semibold);
      color: var(--text-primary);

      margin: var(--space-none) var(--space-none) clamp(var(--space-md), 3vw, var(--space-lg))
        var(--space-none);

      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);

      text-wrap: balance;

      // Performance optimizations
      contain: layout style;
    }

    &__list {
      list-style: none;
      padding: var(--space-none);
      margin: var(--space-none) var(--space-none) clamp(var(--space-lg), 4vw, var(--space-xl))
        var(--space-none);

      outline: none;

      // Performance optimizations
      contain: layout style;
      transform: translateZ(0);

      &:focus-visible {
        outline: var(--focus-outline);
        outline-offset: var(--focus-ring-offset);
        box-shadow: var(--focus-ring);
      }
    }

    &__item {
      display: flex;
      align-items: center;

      gap: clamp(var(--space-xs), 2vw, var(--space-sm));
      padding: clamp(var(--space-sm), 3vw, var(--space-md))
        clamp(var(--space-md), 4vw, var(--space-lg));

      border: var(--border-width-thick) transparent solid;
      border-radius: var(--radius-md);
      margin-bottom: clamp(var(--space-xs), 2vw, var(--space-sm));

      min-height: var(--touch-target-enhanced);

      font-size: clamp(var(--text-sm), 3vw, var(--text-base));
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);

      // Performance optimizations
      contain: layout style;
      transform: translateZ(0);
      will-change: transform, background-color, border-color;

      transition:
        background-color var(--transition-normal),
        border-color var(--transition-normal),
        transform var(--transition-fast);

      &:focus-visible {
        outline: var(--focus-outline);
        outline-offset: var(--focus-ring-offset);
        background: var(--focus-bg-overlay);
        box-shadow: var(--focus-ring);
      }

      &--valid {
        background: var(--color-success-50);
        border-color: var(--color-success-300);
        color: var(--color-success-800);

        .password-requirements__icon {
          color: var(--btn-success-text);
          background-color: var(--color-success-600);
          border: var(--border-width-thin) solid var(--color-success-700);
        }

        .password-requirements__symbol {
          color: var(--color-success-600);
        }
      }

      &--invalid {
        background: var(--bg-tertiary);
        border-color: var(--border-primary);
        color: var(--text-secondary);

        .password-requirements__icon {
          color: var(--btn-error-text);
          background-color: var(--color-error-600);
          border: var(--border-width-thin) solid var(--color-error-700);
        }

        .password-requirements__symbol {
          color: var(--color-neutral-500);
        }
      }

      &[tabindex="-1"]:focus {
        outline: var(--focus-outline);
        background: var(--focus-bg-overlay);
        box-shadow: var(--focus-ring);
      }
    }

    &__icon {
      font-size: clamp(var(--text-sm), 3vw, var(--text-base));
      font-weight: var(--font-bold);

      min-width: clamp(var(--space-lg), 4vw, var(--space-xl));
      width: clamp(var(--space-lg), 4vw, var(--space-xl));
      height: clamp(var(--space-lg), 4vw, var(--space-xl));

      display: flex;
      align-items: center;
      justify-content: center;

      border-radius: var(--radius-full);
      text-align: center;
      flex-shrink: 0;

      // Performance optimizations
      contain: layout style;
      transform: translateZ(0);

      transition:
        background-color var(--transition-normal),
        border-color var(--transition-normal),
        color var(--transition-normal);
    }

    &__symbol {
      font-size: clamp(var(--text-sm), 3vw, var(--text-base));
      min-width: clamp(var(--space-sm), 3vw, var(--space-md));

      text-align: center;
      flex-shrink: 0;

      // Performance optimizations
      contain: layout style;

      transition: color var(--transition-normal);
    }

    &__text {
      flex: 1;
      font-size: clamp(var(--text-sm), 3vw, var(--text-base));
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);

      text-wrap: balance;

      // Performance optimizations
      contain: layout style;
    }

    &__progress {
      border-top: var(--border-width-thin) solid var(--border-primary);
      padding-top: clamp(var(--space-sm), 3vw, var(--space-md));
      margin-top: clamp(var(--space-md), 4vw, var(--space-lg));

      // Performance optimizations
      contain: layout style;
      transform: translateZ(0);
    }

    &__progress-label {
      font-size: clamp(var(--text-sm), 3vw, var(--text-base));
      font-weight: var(--font-medium);
      color: var(--text-secondary);

      margin: var(--space-none) var(--space-none) clamp(var(--space-xs), 2vw, var(--space-sm))
        var(--space-none);

      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);

      text-wrap: balance;

      // Performance optimizations
      contain: layout style;
    }

    &__progress-meter {
      background: var(--bg-tertiary);
      border: var(--border-width-thin) solid var(--border-primary);
      border-radius: var(--radius-full);

      height: clamp(var(--space-sm), 3vw, var(--space-md));
      width: var(--width-full);

      margin-bottom: clamp(var(--space-xs), 2vw, var(--space-sm));

      overflow: hidden;
      position: relative;

      // Performance optimizations
      contain: layout style;
      transform: translateZ(0);

      &:focus-visible {
        outline: var(--focus-outline);
        outline-offset: var(--focus-ring-offset);
        box-shadow: var(--focus-ring);
      }
    }

    &__progress-bar {
      height: var(--height-full);
      border-radius: var(--radius-full);

      background: linear-gradient(
        90deg,
        var(--color-error-500) 0%,
        var(--color-warning-500) 50%,
        var(--color-success-500) 100%
      );

      width: var(--progress-width, 0%);

      // Performance optimizations
      contain: layout style;
      transform: translateZ(0);
      will-change: width;

      transition: width var(--transition-normal);

      &--weak {
        background: var(--color-error-500);
      }

      &--medium {
        background: var(--color-warning-500);
      }

      &--good {
        background: var(--color-info-500);
      }

      &--strong {
        background: var(--color-success-500);
      }

      &--very_strong {
        background: var(--color-success-600);
      }
    }

    &__progress-text {
      font-size: clamp(var(--text-sm), 3vw, var(--text-base));
      font-weight: var(--font-medium);

      margin: var(--space-none);

      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);

      text-wrap: balance;

      // Performance optimizations
      contain: layout style;

      transition: color var(--transition-normal);

      &--weak {
        color: var(--color-error-700);
      }

      &--medium {
        color: var(--color-warning-700);
      }

      &--good {
        color: var(--color-info-700);
      }

      &--strong {
        color: var(--color-success-700);
      }

      &--very_strong {
        color: var(--color-success-800);
      }
    }
  }

  .password-requirements__list[data-keyboard-nav="true"] {
    .password-requirements__item {
      cursor: pointer;

      &:hover:not(:focus-visible) {
        background: var(--bg-hover);
        transform: translateY(calc(-1 * var(--space-micro))) translateZ(0);
        box-shadow: var(--shadow-sm);
      }

      &[tabindex="0"] {
        background: var(--focus-bg-overlay);
        border-color: var(--interactive-primary);
        box-shadow: var(--focus-ring);
      }
    }
  }

  // Responsive design
  @media (min-width: 48em) {
    .password-requirements {
      &__item {
        min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
      }
    }
  }

  @media (max-width: 39.9375em) {
    .password-requirements {
      &__item {
        min-height: var(--touch-target-enhanced);
      }
    }
  }

  @media (max-width: 23.4375em) {
    .password-requirements {
      &__icon {
        min-width: var(--space-lg);
        width: var(--space-lg);
        height: var(--space-lg);
      }
    }
  }

  // High contrast mode support
  @media (prefers-contrast: high) {
    .password-requirements {
      border-width: var(--border-width-thick);
      background: var(--bg-primary);
      color: var(--text-primary);

      &__item {
        border-width: var(--border-width-thick);

        &--valid {
          background: var(--color-success-50);
          border-color: var(--color-success-700);
          color: var(--color-success-900);
        }

        &--invalid {
          background: var(--bg-secondary);
          border-color: var(--border-primary);
          color: var(--text-primary);
        }
      }

      &__progress-meter {
        border-width: var(--border-width-thick);
        background: var(--bg-primary);
      }
    }
  }

  // Reduced motion support
  @media (prefers-reduced-motion: reduce) {
    .password-requirements,
    .password-requirements__item,
    .password-requirements__progress-bar,
    .password-requirements__icon,
    .password-requirements__symbol {
      transition: var(--transition-instant);
      animation: none;
      will-change: auto;
    }

    .password-requirements__list[data-keyboard-nav="true"] {
      .password-requirements__item {
        &:hover {
          transform: translateZ(0);
        }
      }
    }
  }

  // Touch device optimization
  @media (hover: none) and (pointer: coarse) {
    .password-requirements {
      &__item {
        min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
        padding: var(--space-lg);
        font-size: var(--text-lg);

        &:hover {
          transform: translateZ(0);
          box-shadow: var(--shadow-sm);
        }
      }
    }
  }

  // Print styles
  @media print {
    .password-requirements {
      background: var(--color-white);
      border: var(--border-width-thin) solid var(--color-black);
      box-shadow: none;
      color: var(--color-black);

      &__item {
        &--valid {
          background: var(--color-white);
          border: var(--border-width-thin) solid var(--color-black);
          color: var(--color-black);

          .password-requirements__icon::after {
            content: " ✓";
          }
        }

        &--invalid {
          background: var(--color-white);
          border: var(--border-width-thin) solid var(--color-black);
          color: var(--color-black);

          .password-requirements__icon::after {
            content: " ✗";
          }
        }
      }

      &__progress-bar {
        background: var(--color-black) !important;
      }
    }
  }

  // Forced colors mode support
  @media (forced-colors: active) {
    .password-requirements {
      &__item:focus-visible {
        outline: var(--border-width-thick) solid ButtonText;
        background-color: Highlight;
        color: HighlightText;
        forced-color-adjust: none;
      }

      &__list:focus-visible {
        outline: var(--border-width-thick) solid ButtonText;
      }

      &__progress-meter:focus-visible {
        outline: var(--border-width-thick) solid ButtonText;
      }
    }
  }

  // Container queries for component-specific responsiveness
  @container password-requirements (max-width: 20em) {
    .password-requirements {
      padding: var(--space-sm);

      &__item {
        padding: var(--space-xs) var(--space-sm);
        gap: var(--space-xs);
        font-size: var(--text-sm);
      }

      &__icon {
        width: var(--space-lg);
        height: var(--space-lg);
        font-size: var(--text-sm);
      }
    }
  }

  @container password-requirements (min-width: 30em) {
    .password-requirements {
      padding: var(--space-2xl);

      &__item {
        padding: var(--space-lg) var(--space-xl);
        font-size: var(--text-lg);
        min-height: calc(var(--touch-target-enhanced) + var(--space-md));
      }

      &__icon {
        width: var(--space-2xl);
        height: var(--space-2xl);
        font-size: var(--text-lg);
      }
    }
  }
</style>

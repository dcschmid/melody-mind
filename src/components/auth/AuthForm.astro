---
/**
 * AuthForm - Simplified authentication form with OAuth and guest access only
 *
 * Features:
 * - OAuth provider buttons (Google, Spotify, etc.)
 * - Guest access option
 * - WCAG AAA compliant with keyboard navigation and screen reader support
 * - Full responsive design
 * - Internationalization support for all languages
 */

import { getLangFromUrl, useTranslations } from "../../utils/i18n";
import OAuthProviders from "./OAuthProviders.astro";
import Headline from "../Headline.astro";
import Paragraph from "../Paragraph.astro";
import { Icon } from "astro-icon/components";

const lang = String(getLangFromUrl(Astro.url));
const t = useTranslations(lang);
---

<div class="auth-form__container">
  <div class="auth-form__header">
    <Headline
      level="h2"
      title={t("auth.form.title")}
      size="xl"
      variant="default"
      className="auth-form__title"
    />

    <Paragraph
      description={t("auth.form.subtitle")}
      textSize="base"
      className="auth-form__subtitle"
    />
  </div>

  <div class="auth-form__content">
    <!-- OAuth Providers Section -->
    <div class="auth-form__section">
      <Headline
        level="h3"
        title={t("auth.oauth.title")}
        size="lg"
        variant="default"
        className="auth-form__section-title"
      />

      <Paragraph
        description={t("auth.oauth.description")}
        textSize="sm"
        className="auth-form__section-description"
      />

      <OAuthProviders />
    </div>

    <!-- Divider -->
    <div class="auth-form__divider">
      <span class="auth-form__divider-text">{t("auth.form.or")}</span>
    </div>

    <!-- Guest Access Section -->
    <div class="auth-form__section">
      <Headline
        level="h3"
        title={t("auth.guest.title")}
        size="lg"
        variant="default"
        className="auth-form__section-title"
      />

      <Paragraph
        description={t("auth.guest.description")}
        textSize="sm"
        className="auth-form__section-description"
      />

      <button
        type="button"
        class="auth-form__guest-button"
        data-guest-access
        aria-describedby="guest-description"
      >
        <Icon name="user" class="auth-form__guest-icon" aria-hidden="true" />
        <span>{t("auth.guest.button")}</span>
      </button>

      <div id="guest-description" class="sr-only">
        {t("auth.guest.accessibility")}
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="auth-form__footer">
    <Paragraph
      description={t("auth.form.footer")}
      textSize="xs"
      className="auth-form__footer-text"
    />
  </div>
</div>

<script>
  // Guest access functionality
  document.addEventListener("DOMContentLoaded", () => {
    const guestButton = document.querySelector("[data-guest-access]");

    if (guestButton) {
      guestButton.addEventListener("click", async () => {
        try {
          // Create a guest user session
          const response = await fetch("/api/auth/guest", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();

            // Redirect to game home or refresh the page
            if (data.redirectUrl) {
              window.location.href = data.redirectUrl;
            } else {
              window.location.reload();
            }
          } else {
            console.error("Failed to create guest session");
          }
        } catch (error) {
          console.error("Error creating guest session:", error);
        }
      });
    }
  });
</script>

<style>
  .auth-form__container {
    max-width: 480px;
    margin: 0 auto;
    padding: 2rem;
    background: var(--color-background);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-lg);
  }

  .auth-form__header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .auth-form__title {
    margin-bottom: 0.5rem;
    color: var(--color-text-primary);
  }

  .auth-form__subtitle {
    color: var(--color-text-secondary);
  }

  .auth-form__content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .auth-form__section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .auth-form__section-title {
    color: var(--color-text-primary);
    margin-bottom: 0.25rem;
  }

  .auth-form__section-description {
    color: var(--color-text-secondary);
    margin-bottom: 1rem;
  }

  .auth-form__divider {
    position: relative;
    text-align: center;
    margin: 1rem 0;
  }

  .auth-form__divider::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: var(--color-border);
  }

  .auth-form__divider-text {
    background: var(--color-background);
    padding: 0 1rem;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }

  .auth-form__guest-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.75rem 1.5rem;
    background: var(--color-primary);
    color: var(--color-primary-contrast);
    border: none;
    border-radius: var(--border-radius-md);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .auth-form__guest-button:hover {
    background: var(--color-primary-hover);
    transform: translateY(-1px);
  }

  .auth-form__guest-button:focus {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .auth-form__guest-button:active {
    transform: translateY(0);
  }

  .auth-form__guest-icon {
    width: 1.25rem;
    height: 1.25rem;
  }

  .auth-form__footer {
    margin-top: 2rem;
    text-align: center;
  }

  .auth-form__footer-text {
    color: var(--color-text-tertiary);
  }

  /* Responsive design */
  @media (max-width: 640px) {
    .auth-form__container {
      padding: 1.5rem;
      margin: 1rem;
    }

    .auth-form__content {
      gap: 1.5rem;
    }
  }

  /* Accessibility improvements */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Focus styles for better accessibility */
  .auth-form__guest-button:focus-visible {
    outline: 3px solid var(--color-primary);
    outline-offset: 2px;
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .auth-form__guest-button {
      border: 2px solid var(--color-primary);
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .auth-form__guest-button {
      transition: none;
    }

    .auth-form__guest-button:hover {
      transform: none;
    }
  }
</style>

---
/**
 * AuthFormField - Reusable form input with validation and accessibility
 *
 * Features:
 * - Email, password, text, tel, url, search, and number input support
 * - Built-in validation with error messages and password toggle
 * - WCAG AAA compliant with proper focus management
 * - Full responsive design with touch optimization
 * - Internationalization support
 */

import PasswordToggleButton from "./PasswordToggleButton.astro";
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import Paragraph from "../Paragraph.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const clientTranslations = {
  "auth.form.email_invalid": t("auth.form.email_invalid"),
  "auth.form.password_min_length": t("auth.form.password_min_length"),
  "auth.accessibility.field_error": t("auth.accessibility.field_error"),
  "auth.accessibility.error_resolved": t("auth.accessibility.error_resolved"),
};

export interface Props {
  id: string;
  name: string;
  type: "email" | "password" | "text" | "tel" | "url" | "search" | "number";
  label: string;
  placeholder?: string;
  required?: boolean;
  autocomplete?: string;
  class?: string;
  labelSuffix?: string;
  showPasswordToggle?: boolean;
  passwordToggleLabel?: string;
  inputAttributes?: Record<string, string | number | boolean>;
  helpText?: string;
}

const {
  id,
  name,
  type,
  label,
  placeholder,
  required = false,
  autocomplete,
  class: className = "",
  labelSuffix,
  showPasswordToggle = type === "password",
  passwordToggleLabel = t("auth.accessibility.password_toggle"),
  inputAttributes = {},
  helpText,
} = Astro.props;

const isPasswordType = type === "password";
const errorId = `${id}Error`;
const helpId = helpText ? `${id}Help` : undefined;
const toggleId = `toggle${id.charAt(0).toUpperCase() + id.slice(1)}`;

const describedByIds = [helpId, errorId].filter(Boolean).join(" ");
---

<div class={`auth-form-field ${className}`}>
  <div class="auth-form-field__label-group">
    <label for={id} class="auth-form-field__label">
      {label}
      {
        required && (
          <>
            <span class="auth-form-field__required-mark" aria-hidden="true">
              *
            </span>
            <span class="sr-only">{t("auth.form.required")}</span>
          </>
        )
      }
    </label>
    {labelSuffix && <div class="auth-form-field__label-suffix" set:html={labelSuffix} />}
  </div>

  <div class="auth-form-field__input-wrapper">
    {
      helpText && (
        <Paragraph
          id={helpId}
          description={helpText}
          textSize="sm"
          className="auth-form-field__help-text"
        />
      )
    }

    <input
      {type}
      {id}
      {name}
      class="auth-form-field__input"
      {placeholder}
      {required}
      {autocomplete}
      aria-required={required ? "true" : "false"}
      aria-describedby={describedByIds}
      {...inputAttributes}
    />

    {
      isPasswordType && showPasswordToggle && (
        <PasswordToggleButton id={toggleId} targetPasswordId={id} ariaLabel={passwordToggleLabel} />
      )
    }

    <div id={errorId} class="auth-form-field__error-message" role="alert" aria-live="polite"></div>
  </div>
</div>

<noscript>
  <style>
    .auth-form-field__input--error {
      border-color: var(--color-error-500) !important;
      background-color: var(--color-error-50) !important;
    }

    .auth-form-field__error-message[data-error] {
      display: block !important;
      color: var(--color-error-800) !important;
    }
  </style>
</noscript>

<script type="module" define:vars={{ translations: clientTranslations }} is:inline>
  window.authTranslations = translations;
</script>

<script type="module" is:inline>
  import("/src/utils/authFormField.ts");
</script>

<style lang="scss">
  .auth-form-field {
    margin-bottom: var(--space-md);

    @media (min-width: 30em) {
      margin-bottom: var(--space-lg);
    }

    * {
      box-sizing: border-box;
    }

    &__label-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-sm);
      gap: var(--space-sm);

      @media (min-width: 30em) {
        margin-bottom: var(--space-md);
        gap: var(--space-md);
      }

      @media (max-width: 39.9375em) {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-xs);
      }
    }

    &__label {
      display: block;
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);
      text-wrap: balance;

      @media (min-width: 30em) {
        font-size: var(--text-lg);
      }

      @media (min-width: 48em) {
        font-size: var(--text-xl);
      }
    }

    &__required-mark {
      color: var(--color-error-600);
      margin-left: var(--space-xs);
      font-weight: var(--font-bold);
      font-size: var(--text-lg);

      @media (min-width: 30em) {
        font-size: var(--text-xl);
      }
    }

    &__label-suffix {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: var(--leading-relaxed);
      text-wrap: balance;

      @media (min-width: 30em) {
        font-size: var(--text-base);
      }
    }

    &__input-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);

      @media (min-width: 30em) {
        gap: var(--space-sm);
      }
    }

    &__help-text {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);
      padding: var(--space-xs) var(--space-sm);
      background-color: var(--color-blue-50);
      border: var(--border-width-thin) solid var(--color-blue-200);
      border-radius: var(--radius-sm);
      transition: opacity var(--transition-normal);
      text-wrap: balance;

      @media (min-width: 30em) {
        font-size: var(--text-base);
        padding: var(--space-sm) var(--space-md);
      }

      @media (min-width: 48em) {
        font-size: var(--text-base);
        padding: var(--space-sm) var(--space-lg);
      }

      :global(p) {
        margin: 0;
      }
    }

    &__input {
      width: var(--width-full);
      min-height: var(--touch-target-enhanced);
      padding: var(--space-md) var(--space-lg);
      background-color: var(--bg-tertiary);
      border: var(--border-width-thick) solid var(--border-secondary);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--text-base);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);
      appearance: none;
      touch-action: manipulation;
      transition:
        border-color var(--transition-normal),
        background-color var(--transition-normal),
        box-shadow var(--transition-normal);

      @media (min-width: 30em) {
        padding: var(--space-lg) var(--space-xl);
        font-size: var(--text-lg);
      }

      @media (min-width: 48em) {
        min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
      }

      &::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
        font-size: var(--text-base);
        text-wrap: balance;

        @media (min-width: 30em) {
          font-size: var(--text-lg);
        }
      }

      &:focus,
      &:focus-visible {
        border-color: var(--interactive-primary);
        background-color: var(--bg-secondary);
        outline: none;
        box-shadow: var(--focus-ring);
      }

      &:focus-visible {
        outline: var(--focus-outline);
        outline-offset: var(--focus-ring-offset);
        box-shadow: var(--focus-ring);
      }

      &--focused {
        border-color: var(--interactive-primary);
        background-color: var(--bg-secondary);
      }

      &--error {
        border-color: var(--color-error-500);
        background-color: var(--color-error-50);

        &:focus {
          border-color: var(--color-error-500);
          box-shadow: var(--focus-ring);
        }
      }
    }

    &__error-message {
      display: none;
      margin-top: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      font-size: var(--text-sm);
      color: var(--color-error-800);
      background-color: var(--color-error-50);
      border: var(--border-width-thick) solid var(--color-error-300);
      border-radius: var(--radius-sm);
      line-height: var(--leading-relaxed);
      font-weight: var(--font-medium);
      text-wrap: balance;
      transition: opacity var(--transition-normal);

      @media (min-width: 30em) {
        margin-top: var(--space-md);
        padding: var(--space-md) var(--space-lg);
        font-size: var(--text-base);
      }

      &:not(:empty) {
        display: block;
      }
    }
  }

  @media (max-width: 23.4375em) {
    .auth-form-field {
      &__input {
        min-height: var(--touch-target-enhanced);
      }
    }
  }

  @media (prefers-contrast: high) {
    .auth-form-field {
      &__input {
        border-width: var(--border-width-thick);
        border-color: var(--text-primary);
        background-color: var(--bg-primary);

        &:focus {
          border-color: var(--interactive-primary);
          box-shadow: var(--focus-ring);
        }
      }

      &__required-mark,
      &__label {
        font-weight: var(--font-bold);
      }

      &__error-message {
        background-color: var(--color-error-50);
        border-width: var(--border-width-thick);
        font-weight: var(--font-semibold);
      }
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .auth-form-field {
      &__input,
      &__help-text,
      &__error-message {
        transition: var(--transition-instant);
      }
    }
  }

  @media (hover: none) and (pointer: coarse) {
    .auth-form-field {
      &__input {
        min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
        padding: var(--space-lg);
        font-size: var(--text-lg);
        touch-action: manipulation;
      }

      &__help-text {
        min-height: calc(var(--touch-target-enhanced) - var(--space-sm));
        display: flex;
        align-items: center;
      }

      &__input-wrapper {
        gap: var(--space-md);
      }
    }
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>

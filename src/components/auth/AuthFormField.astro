---
/**
 * AuthFormField - Reusable form input with validation and accessibility
 *
 * Features:
 * - Email, password, text, tel, url, search, and number input support
 * - Built-in validation with error messages and password toggle
 * - WCAG AAA compliant with proper focus management
 * - Performance optimized with CSS containment
 * - Full responsive design with touch optimization
 * - Internationalization support
 *
 * @component
 * @accessibility WCAG AAA compliant with enhanced focus indicators
 * @performance CSS containment, GPU acceleration, optimized transitions
 * @responsive Mobile-first design with touch-friendly sizing
 */
import PasswordToggleButton from "./PasswordToggleButton.astro";
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import Paragraph from "../Paragraph.astro";

// Get current language and translations for client-side scripts
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Prepare translations for client-side validation
const clientTranslations = {
  "auth.form.email_invalid": t("auth.form.email_invalid"),
  "auth.form.password_min_length": t("auth.form.password_min_length"),
  "auth.accessibility.field_error": t("auth.accessibility.field_error"),
  "auth.accessibility.error_resolved": t("auth.accessibility.error_resolved"),
};

export interface Props {
  /** Unique input identifier */
  id: string;
  /** Form input name */
  name: string;
  /** Input type */
  type: "email" | "password" | "text" | "tel" | "url" | "search" | "number";
  /** Input label text */
  label: string;
  /** Placeholder text */
  placeholder?: string;
  /** Required field flag */
  required?: boolean;
  /** Autocomplete attribute */
  autocomplete?: string;
  /** Additional CSS classes */
  class?: string;
  /** Content after label (e.g., forgot password link) */
  labelSuffix?: string;
  /** Show password toggle button */
  showPasswordToggle?: boolean;
  /** Password toggle accessibility label */
  passwordToggleLabel?: string;
  /** Additional input attributes */
  inputAttributes?: Record<string, string | number | boolean>;
  /** Optional help text */
  helpText?: string;
}

const {
  id,
  name,
  type,
  label,
  placeholder,
  required = false,
  autocomplete,
  class: className = "",
  labelSuffix,
  showPasswordToggle = type === "password",
  passwordToggleLabel = t("auth.accessibility.password_toggle"),
  inputAttributes = {},
  helpText,
} = Astro.props;

const isPasswordType = type === "password";
const errorId = `${id}Error`;
const helpId = helpText ? `${id}Help` : undefined;
const toggleId = `toggle${id.charAt(0).toUpperCase() + id.slice(1)}`;

// Build aria-describedby attribute - combine help text and error IDs
const describedByIds = [helpId, errorId].filter(Boolean).join(" ");
---

<div class={`auth-form-field ${className}`}>
  <div class="auth-form-field__label-group">
    <label for={id} class="auth-form-field__label">
      {label}
      {
        required && (
          <>
            <span class="auth-form-field__required-mark" aria-hidden="true">
              *
            </span>
            <span class="sr-only">{t("auth.form.required")}</span>
          </>
        )
      }
    </label>
    {labelSuffix && <div class="auth-form-field__label-suffix" set:html={labelSuffix} />}
  </div>

  <div class="auth-form-field__input-wrapper">
    {
      helpText && (
        <Paragraph
          id={helpId}
          description={helpText}
          textSize="sm"
          className="auth-form-field__help-text"
        />
      )
    }

    <input
      {type}
      {id}
      {name}
      class="auth-form-field__input"
      {placeholder}
      {required}
      {autocomplete}
      aria-required={required ? "true" : "false"}
      aria-describedby={describedByIds}
      {...inputAttributes}
    />

    {
      isPasswordType && showPasswordToggle && (
        <PasswordToggleButton id={toggleId} targetPasswordId={id} ariaLabel={passwordToggleLabel} />
      )
    }

    <div id={errorId} class="auth-form-field__error-message" role="alert" aria-live="polite"></div>
  </div>
</div>

<!-- Progressive Enhancement: NoScript fallback for error states -->
<noscript>
  <style>
    .auth-form-field__input--error {
      border-color: var(--color-error-500) !important;
      background-color: var(--color-error-50) !important;
    }

    .auth-form-field__error-message[data-error] {
      display: block !important;
      color: var(--color-error-800) !important;
    }
  </style>
</noscript>

<!-- Setup client-side translations for validation messages -->
<script type="module" define:vars={{ translations: clientTranslations }} is:inline>
  // Make translations available to the client-side validation
  window.authTranslations = translations;
</script>

<script type="module" is:inline>
  // Import the auth form field functionality
  import("/src/utils/authFormField.ts");
</script>

<style lang="scss">
  /**
   * AuthFormField Component Styles
   * 
   * ✅ 100% global.css variables integration
   * ✅ Performance optimized with CSS containment
   * ✅ WCAG AAA compliant styling
   * ✅ Responsive design with fluid scaling
   * ✅ GPU acceleration for smooth interactions
   */

  .auth-form-field {
    margin-bottom: clamp(var(--space-md), 4vw, var(--space-lg));

    // Performance optimizations
    contain: layout style paint;
    content-visibility: auto;
    contain-intrinsic-size: var(--container-intrinsic-height-component);

    transform: translateZ(0);

    // Container query support
    container-type: inline-size;
    container-name: auth-form-field;

    * {
      box-sizing: border-box;
    }

    &__label-group {
      display: flex;
      align-items: center;
      justify-content: space-between;

      margin-bottom: clamp(var(--space-sm), 3vw, var(--space-md));
      gap: clamp(var(--space-sm), 3vw, var(--space-md));

      contain: layout style;

      @media (max-width: 39.9375em) {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-xs);
      }
    }

    &__label {
      display: block;

      font-size: clamp(var(--text-base), 3vw, var(--text-lg));
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);

      text-wrap: balance;
      contain: layout style;
    }

    &__required-mark {
      color: var(--color-error-600);
      margin-left: var(--space-xs);
      font-weight: var(--font-bold);

      font-size: clamp(var(--text-lg), 4vw, var(--text-xl));

      text-shadow: 0 0 var(--space-micro) var(--bg-primary);
    }

    &__label-suffix {
      font-size: clamp(var(--text-sm), 3vw, var(--text-base));
      color: var(--text-secondary);
      line-height: var(--leading-relaxed);

      text-wrap: balance;
    }

    &__input-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;

      gap: clamp(var(--space-xs), 2vw, var(--space-sm));

      contain: layout style;
    }

    &__help-text {
      font-size: clamp(var(--text-sm), 3vw, var(--text-base));
      color: var(--text-secondary);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);

      padding: clamp(var(--space-xs), 2vw, var(--space-sm))
        clamp(var(--space-sm), 3vw, var(--space-md));

      background-color: var(--color-blue-50);
      border: var(--border-width-thin) solid var(--color-blue-200);
      border-radius: var(--radius-sm);

      contain: layout style;
      transform: translateZ(0);
      will-change: opacity;

      transition: opacity var(--transition-normal);

      text-wrap: balance;

      // Remove default paragraph margins from nested Paragraph component
      :global(p) {
        margin: var(--space-none);
      }
    }

    &__input {
      width: var(--width-full);
      min-height: var(--touch-target-enhanced);

      padding: clamp(var(--space-md), 4vw, var(--space-lg));

      background-color: var(--bg-tertiary);
      border: var(--border-width-thick) solid var(--border-secondary);
      border-radius: var(--radius-md);
      color: var(--text-primary);

      font-size: clamp(var(--text-base), 3vw, var(--text-lg));
      line-height: var(--leading-relaxed);
      letter-spacing: var(--letter-spacing-base);

      appearance: none;

      contain: layout style;
      transform: translateZ(0);
      will-change: border-color, background-color, box-shadow, transform;

      touch-action: manipulation;

      transition:
        border-color var(--transition-normal),
        background-color var(--transition-normal),
        box-shadow var(--transition-normal),
        transform var(--transition-fast);

      &::placeholder {
        color: var(--text-muted);
        opacity: var(--opacity-medium);

        font-size: clamp(var(--text-base), 3vw, var(--text-lg));

        text-wrap: balance;
      }

      &:focus,
      &:focus-visible {
        border-color: var(--interactive-primary);
        background-color: var(--bg-secondary);
        transform: translateY(calc(-1 * var(--space-micro))) translateZ(0);
        outline: none;
        box-shadow: var(--focus-ring);
      }

      &:focus-visible {
        outline: var(--focus-outline);
        outline-offset: var(--focus-ring-offset);
        box-shadow: var(--focus-ring);
      }

      &--focused {
        border-color: var(--interactive-primary);
        background-color: var(--bg-secondary);
      }

      &--error {
        border-color: var(--color-error-500);
        background-color: var(--color-error-50);
        animation: error-shake var(--transition-normal) ease-in-out;
        will-change: transform;

        &:focus {
          border-color: var(--color-error-500);
          box-shadow: var(--focus-ring);
          transform: translateY(calc(-1 * var(--space-micro))) translateZ(0);
        }
      }
    }

    &__error-message {
      display: none;

      margin-top: clamp(var(--space-sm), 3vw, var(--space-md));
      padding: clamp(var(--space-sm), 3vw, var(--space-md))
        clamp(var(--space-md), 4vw, var(--space-lg));

      font-size: clamp(var(--text-sm), 3vw, var(--text-base));
      color: var(--color-error-800);
      background-color: var(--color-error-50);
      border: var(--border-width-thick) solid var(--color-error-300);
      border-radius: var(--radius-sm);
      line-height: var(--leading-relaxed);
      font-weight: var(--font-medium);

      contain: layout style;
      transform: translateZ(0);

      text-wrap: balance;

      transition: opacity var(--transition-normal);

      &:not(:empty) {
        display: block;
      }
    }
  }

  // Error shake animation
  @keyframes error-shake {
    0%,
    100% {
      transform: translateX(var(--space-none)) translateZ(0);
    }
    25% {
      transform: translateX(calc(-1 * var(--space-xs))) translateZ(0);
    }
    75% {
      transform: translateX(var(--space-xs)) translateZ(0);
    }
  }

  // Responsive design
  @media (min-width: 48em) {
    .auth-form-field {
      &__input {
        min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
      }
    }
  }

  @media (max-width: 23.4375em) {
    .auth-form-field {
      &__input {
        min-height: var(--touch-target-enhanced);
      }
    }
  }

  // High contrast mode support
  @media (prefers-contrast: high) {
    .auth-form-field {
      &__input {
        border-width: var(--border-width-thick);
        border-color: var(--text-primary);
        background-color: var(--bg-primary);

        &:focus {
          border-color: var(--interactive-primary);
          box-shadow: var(--focus-ring);
        }
      }

      &__required-mark,
      &__label {
        font-weight: var(--font-bold);
      }

      &__required-mark {
        text-shadow: var(--space-micro) var(--space-micro) var(--space-xs) var(--bg-primary);
      }

      &__error-message {
        background-color: var(--color-error-50);
        border-width: var(--border-width-thick);
        font-weight: var(--font-semibold);
      }
    }
  }

  // Reduced motion support
  @media (prefers-reduced-motion: reduce) {
    .auth-form-field {
      &__input,
      &__help-text,
      &__error-message {
        transition: var(--transition-instant);
        will-change: auto;
        animation: none;

        &--error {
          transition: var(--transition-instant);
          animation: none;
        }
      }
    }

    @keyframes error-shake {
      0%,
      100% {
        transform: none;
      }
    }
  }

  // Touch device support
  @media (hover: none) and (pointer: coarse) {
    .auth-form-field {
      &__input {
        min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
        padding: var(--space-lg);
        font-size: var(--text-lg);
        touch-action: manipulation;

        &:focus {
          transform: scale(1.02) translateZ(0);
          transition: transform var(--transition-fast);
        }
      }

      &__help-text {
        min-height: calc(var(--touch-target-enhanced) - var(--space-sm));
        display: flex;
        align-items: center;
      }

      &__input-wrapper {
        gap: var(--space-md);
      }
    }
  }

  // Container queries for component-specific responsiveness
  @container auth-form-field (max-width: 20em) {
    .auth-form-field {
      &__label-group {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-xs);
      }

      &__input {
        font-size: var(--text-base);
        padding: var(--space-sm) var(--space-md);
      }

      &__help-text {
        font-size: var(--text-sm);
        padding: var(--space-xs) var(--space-sm);
      }
    }
  }

  @container auth-form-field (min-width: 30em) {
    .auth-form-field {
      &__input {
        padding: var(--space-lg) var(--space-xl);
        font-size: var(--text-lg);
      }

      &__label {
        font-size: var(--text-xl);
      }

      &__help-text {
        font-size: var(--text-base);
        padding: var(--space-sm) var(--space-lg);
      }
    }
  }
</style>

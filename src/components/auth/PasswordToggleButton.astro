---
/**
 * PasswordToggleButton - Password visibility toggle with accessibility
 *
 * Features:
 * - Eye/eye-slash icon toggle for password visibility
 * - WCAG AAA compliant with enhanced accessibility
 * - Performance optimized with CSS containment
 * - Full responsive design with container queries
 * - Keyboard shortcut support (Ctrl+Shift+H)
 * - Internationalization support with live announcements
 *
 * @component
 * @accessibility WCAG AAA compliant with live regions and keyboard navigation
 * @performance CSS containment, GPU acceleration, efficient event handling
 * @responsive Mobile-first design with container queries and touch optimization
 */
import { Icon } from "astro-icon/components";
import { getLangFromUrl, useTranslations } from "@utils/i18n";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const clientTranslations = {
  "auth.accessibility.password_toggle_empty": t("auth.accessibility.password_toggle_empty"),
  "auth.accessibility.password.visible": t("auth.accessibility.password.visible"),
  "auth.accessibility.password.hidden": t("auth.accessibility.password.hidden"),
  "auth.accessibility.password.visible_status": t("auth.accessibility.password.visible_status"),
  "auth.accessibility.password.hidden_status": t("auth.accessibility.password.hidden_status"),
};

export interface Props {
  /** Button element ID */
  id: string;
  /** Target password input ID */
  targetPasswordId: string;
  /** Accessibility label for screen readers */
  ariaLabel: string;
  /** Additional CSS classes */
  class?: string;
}

const { id, targetPasswordId, ariaLabel, class: className = "" } = Astro.props;
---

<button
  type="button"
  {id}
  class={`auth-form-field__toggle-password ${className}`}
  aria-label={ariaLabel}
  aria-pressed="false"
  aria-describedby={`${id}Status ${id}Help`}
  data-target={targetPasswordId}
>
  <span class="auth-form-field__icon auth-form-field__icon--show">
    <Icon name="eye" class="auth-form-field__svg-icon" aria-hidden="true" />
  </span>
  <span class="auth-form-field__icon auth-form-field__icon--hide">
    <Icon name="eye-slash" class="auth-form-field__svg-icon" aria-hidden="true" />
  </span>
</button>

<!-- Hidden status announcement for screen readers -->
<div id={`${id}Status`} class="sr-only" aria-live="polite" aria-atomic="true"></div>

<!-- Contextual help for accessibility -->
<div id={`${id}Help`} class="sr-only">
  {t("auth.accessibility.password_toggle_help")}
</div>

<script define:vars={{ clientTranslations }} is:inline>
  /**
   * Password Toggle Button - Modern ES6+ implementation
   * Enhanced accessibility with live announcements and keyboard shortcuts.
   * Performance optimized with efficient DOM handling.
   */

  // Make translations available globally
  if (!window.authTranslations) {
    window.authTranslations = {};
  }
  Object.assign(window.authTranslations, clientTranslations);

  /**
   * Get required DOM elements for password toggle
   */
  const getToggleElements = (button) => {
    const targetId = button.dataset.target;
    if (!targetId) {
      return null;
    }

    const passwordInput = document.getElementById(targetId);
    const showIcon = button.querySelector(".auth-form-field__icon--show");
    const hideIcon = button.querySelector(".auth-form-field__icon--hide");
    const statusElement = document.getElementById(`${button.id}Status`);

    if (!passwordInput || !showIcon || !hideIcon) {
      return null;
    }

    return { passwordInput, showIcon, hideIcon, statusElement };
  };

  /**
   * Toggle icon visibility with CSS classes
   */
  const toggleIconVisibility = (showIcon, hideIcon, isPassword) => {
    const hiddenClass = "auth-form-field__icon--hidden";

    if (isPassword) {
      showIcon.classList.add(hiddenClass);
      hideIcon.classList.remove(hiddenClass);
    } else {
      showIcon.classList.remove(hiddenClass);
      hideIcon.classList.add(hiddenClass);
    }
  };

  /**
   * Update accessibility attributes and announcements
   */
  const updateAccessibilityState = (button, statusElement, isShowing) => {
    button.setAttribute("aria-pressed", isShowing ? "true" : "false");

    if (window.authTranslations) {
      const labelKey = isShowing
        ? "auth.accessibility.password.visible"
        : "auth.accessibility.password.hidden";
      const statusKey = isShowing
        ? "auth.accessibility.password.visible_status"
        : "auth.accessibility.password.hidden_status";

      const label = window.authTranslations[labelKey];
      if (label) {
        button.setAttribute("aria-label", label);
      }

      if (statusElement) {
        const statusText = window.authTranslations[statusKey];
        if (statusText) {
          statusElement.textContent = statusText;
        }
      }
    }
  };

  /**
   * Show error message and focus input
   */
  const showEmptyPasswordError = (passwordInput, statusElement) => {
    if (statusElement) {
      const errorMessage =
        window.authTranslations?.["auth.accessibility.password_toggle_empty"] ||
        "Enter a password first before toggling visibility.";
      statusElement.textContent = errorMessage;
    }
    passwordInput.focus();
  };

  /**
   * Initialize password toggle functionality
   */
  const initializePasswordToggle = (button) => {
    const elements = getToggleElements(button);
    if (!elements) {
      return;
    }

    const { passwordInput, showIcon, hideIcon, statusElement } = elements;

    button.addEventListener("click", () => {
      if (!passwordInput.value.trim()) {
        showEmptyPasswordError(passwordInput, statusElement);
        return;
      }

      const isPassword = passwordInput.type === "password";
      passwordInput.type = isPassword ? "text" : "password";

      toggleIconVisibility(showIcon, hideIcon, isPassword);
      updateAccessibilityState(button, statusElement, passwordInput.type === "text");

      passwordInput.focus();
    });
  };

  /**
   * Initialize all password toggle buttons
   */
  const initializeAllPasswordToggles = () => {
    const toggleButtons = document.querySelectorAll(".auth-form-field__toggle-password");
    toggleButtons.forEach(initializePasswordToggle);
  };

  /**
   * Find target toggle button for keyboard shortcuts
   */
  const findTargetToggleButton = (activeElement) => {
    if (activeElement?.type === "password") {
      const inputId = activeElement.id;
      return document.querySelector(`[data-target="${inputId}"]`);
    }
    return document.querySelector(".auth-form-field__toggle-password");
  };

  /**
   * Announce keyboard shortcut usage
   */
  const announceKeyboardShortcut = (targetButton) => {
    const statusElement = document.getElementById(`${targetButton.id}Status`);
    if (statusElement) {
      const lang = document.documentElement.lang || "en";
      const shortcutMessage =
        lang === "de"
          ? "Tastenkombination Strg+Umschalt+H verwendet"
          : "Keyboard shortcut Ctrl+Shift+H used";

      setTimeout(() => {
        statusElement.textContent = shortcutMessage;
      }, 500);
    }
  };

  /**
   * Initialize keyboard shortcuts
   */
  const initializeKeyboardShortcuts = () => {
    document.addEventListener("keydown", (event) => {
      if (event.ctrlKey && event.shiftKey && event.key === "H") {
        event.preventDefault();

        const activeElement = document.activeElement;
        const targetButton = findTargetToggleButton(activeElement);

        if (targetButton) {
          targetButton.click();
          announceKeyboardShortcut(targetButton);
        }
      }
    });
  };

  // Initialize on DOM content loaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initializeAllPasswordToggles();
      initializeKeyboardShortcuts();
    });
  } else {
    initializeAllPasswordToggles();
    initializeKeyboardShortcuts();
  }

  // Expose for manual initialization
  window.initializePasswordToggle = initializePasswordToggle;
</script>

<style lang="scss">
  /**
   * PasswordToggleButton Component Styles
   * 
   * ✅ 100% global.css variables integration
   * ✅ Performance optimized with CSS containment
   * ✅ WCAG AAA compliant styling
   * ✅ Responsive design with container queries
   * ✅ GPU acceleration for smooth animations
   */

  .auth-form-field__toggle-password {
    position: absolute;
    right: clamp(var(--space-sm), 2vw, var(--space-md));
    top: 50%;
    transform: translateY(-50%) translateZ(0);

    z-index: var(--z-dropdown);

    background-color: transparent;
    border: var(--border-width-thin) solid transparent;
    border-radius: var(--radius-md);
    color: var(--text-secondary);

    padding: clamp(var(--space-xs), 2vw, var(--space-sm));

    min-width: var(--touch-target-enhanced);
    min-height: var(--touch-target-enhanced);

    display: flex;
    align-items: center;
    justify-content: center;

    cursor: pointer;
    touch-action: manipulation;

    // Performance optimizations
    contain: layout style;
    will-change: transform, background-color, color, border-color;

    transition:
      background-color var(--transition-normal),
      color var(--transition-normal),
      border-color var(--transition-normal),
      transform var(--transition-fast);

    &:hover {
      color: var(--interactive-primary-hover);
      background-color: var(--bg-hover);
      transform: translateY(-50%) scale(1.05) translateZ(0);
    }

    &:focus-visible {
      outline: var(--focus-outline);
      outline-offset: var(--focus-ring-offset);
      color: var(--interactive-primary);
      background-color: var(--bg-focus);
      box-shadow: var(--focus-ring);
    }

    &:active {
      transform: translateY(-50%) scale(0.95) translateZ(0);
      background-color: var(--bg-active);
      border-color: var(--border-primary);
    }

    &:focus {
      outline: none;
    }
  }

  // Icon container styles
  .auth-form-field__icon {
    display: flex;
    align-items: center;
    justify-content: center;

    width: clamp(var(--text-lg), 4vw, var(--text-xl));
    height: clamp(var(--text-lg), 4vw, var(--text-xl));

    // Performance optimizations
    contain: layout style;
    transform: translateZ(0);

    &--hide {
      display: none;
    }

    &--hidden {
      display: none !important;
    }
  }

  // SVG icon styles
  .auth-form-field__svg-icon {
    width: var(--width-full);
    height: var(--height-full);

    flex-shrink: 0;

    // Performance optimizations
    contain: layout style;
    transform: translateZ(0);
  }

  // Responsive design
  @media (min-width: 48em) {
    .auth-form-field__toggle-password {
      min-width: calc(var(--touch-target-enhanced) + var(--space-sm));
      min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
    }

    .auth-form-field__icon {
      width: var(--text-xl);
      height: var(--text-xl);
    }
  }

  @media (max-width: 39.9375em) {
    .auth-form-field__toggle-password {
      min-width: var(--touch-target-enhanced);
      min-height: var(--touch-target-enhanced);
    }

    .auth-form-field__icon {
      width: var(--text-lg);
      height: var(--text-lg);
    }
  }

  @media (max-width: 23.4375em) {
    .auth-form-field__toggle-password {
      right: var(--space-xs);
      padding: var(--space-xs);
    }

    .auth-form-field__icon {
      width: var(--text-base);
      height: var(--text-base);
    }
  }

  // High contrast mode support
  @media (prefers-contrast: high) {
    .auth-form-field__toggle-password {
      border: var(--border-width-thick) solid var(--text-primary);
      background-color: var(--bg-primary);

      &:focus-visible {
        outline-width: var(--border-width-thick);
        background-color: var(--bg-secondary);
      }
    }
  }

  // Touch device optimizations
  @media (hover: none) and (pointer: coarse) {
    .auth-form-field__toggle-password {
      padding: var(--space-md);
      min-width: calc(var(--touch-target-enhanced) + var(--space-sm));
      min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
      border: var(--border-width-thin) solid var(--border-secondary);

      &:hover {
        transform: translateY(-50%) translateZ(0);
        background-color: var(--bg-hover);
      }

      &:active {
        background-color: var(--bg-active);
        border-color: var(--border-primary);
        transform: translateY(-50%) scale(0.95) translateZ(0);
      }
    }

    .auth-form-field__icon {
      width: var(--text-2xl);
      height: var(--text-2xl);
    }
  }

  // Reduced motion support
  @media (prefers-reduced-motion: reduce) {
    .auth-form-field__toggle-password {
      transition: var(--transition-instant);
      animation: none;
      will-change: auto;

      &:hover,
      &:active {
        transform: translateY(-50%) translateZ(0);
      }
    }
  }

  // Enhanced text spacing support for WCAG AAA
  .enhanced-text-spacing .auth-form-field__toggle-password {
    letter-spacing: var(--letter-spacing-enhanced);
    word-spacing: var(--word-spacing-enhanced);
    line-height: var(--leading-enhanced);
    padding: calc(var(--space-sm) * 1.2);
    max-width: var(--width-full);
    overflow: visible;
    text-overflow: clip;
    white-space: nowrap;
  }

  // Print styles
  @media print {
    .auth-form-field__toggle-password {
      display: none !important;
    }
  }

  // Forced colors mode support
  @media (forced-colors: active) {
    .auth-form-field__toggle-password {
      border: var(--border-width-thin) solid CanvasText;
      background-color: Canvas;
      color: CanvasText;
      forced-color-adjust: none;

      &:hover {
        background-color: Highlight;
        color: HighlightText;
      }

      &:focus-visible {
        outline: var(--border-width-thick) solid Highlight;
      }
    }
  }

  // Container queries for component-specific responsiveness
  @container (max-width: 20em) {
    .auth-form-field__toggle-password {
      right: var(--space-xs);
      padding: var(--space-xs);
      min-width: var(--touch-target-enhanced);
      min-height: var(--touch-target-enhanced);
    }

    .auth-form-field__icon {
      width: var(--text-base);
      height: var(--text-base);
    }
  }

  @container (min-width: 30em) {
    .auth-form-field__toggle-password {
      right: var(--space-lg);
      padding: var(--space-md);
      min-width: calc(var(--touch-target-enhanced) + var(--space-md));
      min-height: calc(var(--touch-target-enhanced) + var(--space-md));
    }

    .auth-form-field__icon {
      width: var(--text-2xl);
      height: var(--text-2xl);
    }
  }
</style>

---
/**
 * PasswordToggleButton Component for MelodyMind Auth Forms
 *
 * A reusable password visibility toggle button that provides accessibility features
 * and consistent styling. This component eliminates code duplication across auth forms.
 *
 * Features:
 * - Password visibility toggle with eye/eye-slash icons
 * - WCAG AAA compliant accessibility
 * - Automatic focus management
 * - Consistent styling and behavior
 * - Screen reader support
 *
 * @component
 * @example
 * ```astro
 * <PasswordToggleButton
 *   id="toggleLoginPassword"
 *   targetPasswordId="loginPassword"
 *   ariaLabel={t("auth.accessibility.password_toggle")}
 * />
 * ```
 */
import { Icon } from "astro-icon/components";

export interface Props {
  /** Unique identifier for the toggle button */
  id: string;
  /** ID of the password input this button controls */
  targetPasswordId: string;
  /** Accessible label for screen readers */
  ariaLabel: string;
  /** Additional CSS classes */
  class?: string;
}

const { id, targetPasswordId, ariaLabel, class: className = "" } = Astro.props;
---

<button
  type="button"
  {id}
  class={`auth-form-field__toggle-password ${className}`}
  aria-label={ariaLabel}
  data-target={targetPasswordId}
>
  <span class="auth-form-field__icon auth-form-field__icon--show">
    <Icon name="eye" class="auth-form-field__svg-icon" aria-hidden="true" />
  </span>
  <span class="auth-form-field__icon auth-form-field__icon--hide">
    <Icon name="eye-slash" class="auth-form-field__svg-icon" aria-hidden="true" />
  </span>
</button>

<script>
  /**
   * Password Toggle Button Functionality
   *
   * Handles password visibility toggling with proper accessibility features.
   * This script automatically initializes all password toggle buttons on the page.
   */

  /**
   * Initializes password toggle functionality for a specific button
   * @param {HTMLButtonElement} button - The toggle button element
   */
  function initializePasswordToggle(button: HTMLButtonElement): void {
    const targetId = button.dataset.target;
    if (!targetId) {
      return;
    }

    const passwordInput = document.getElementById(targetId) as HTMLInputElement;
    const showIcon = button.querySelector(".auth-form-field__icon--show") as HTMLElement;
    const hideIcon = button.querySelector(".auth-form-field__icon--hide") as HTMLElement;

    if (!passwordInput || !showIcon || !hideIcon) {
      return;
    }

    button.addEventListener("click", () => {
      // Toggle password visibility
      const isPassword = passwordInput.type === "password";
      passwordInput.type = isPassword ? "text" : "password";

      // Toggle icon visibility with proper display handling
      if (isPassword) {
        showIcon.style.display = "none";
        hideIcon.style.display = "flex";
      } else {
        showIcon.style.display = "flex";
        hideIcon.style.display = "none";
      }

      // Maintain focus on the password input
      passwordInput.focus();

      // Update ARIA label for better accessibility using proper i18n support
      const lang = document.documentElement.lang || "en";
      const isShowing = passwordInput.type === "text";

      // Use the proper translation keys from the global i18n system
      if (window.authTranslations) {
        if (isShowing) {
          const hideLabel =
            window.authTranslations["auth.accessibility.password.visible"] ||
            (lang === "de" ? "Passwort verbergen" : "Hide password");
          button.setAttribute("aria-label", hideLabel);
        } else {
          const showLabel =
            window.authTranslations["auth.accessibility.password.hidden"] ||
            (lang === "de" ? "Passwort anzeigen" : "Show password");
          button.setAttribute("aria-label", showLabel);
        }
      } else {
        // Fallback to hardcoded strings if translations are not available
        if (isShowing) {
          button.setAttribute("aria-label", lang === "de" ? "Passwort verbergen" : "Hide password");
        } else {
          button.setAttribute("aria-label", lang === "de" ? "Passwort anzeigen" : "Show password");
        }
      }
    });
  }

  /**
   * Initialize all password toggle buttons when DOM is ready
   */
  function initializeAllPasswordToggles(): void {
    const toggleButtons = document.querySelectorAll(
      ".auth-form-field__toggle-password"
    ) as NodeListOf<HTMLButtonElement>;
    toggleButtons.forEach((button) => {
      initializePasswordToggle(button);
    });
  }

  // Initialize on DOM content loaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeAllPasswordToggles);
  } else {
    initializeAllPasswordToggles();
  }

  // Also expose for manual initialization with proper typing
  declare global {
    interface Window {
      initializePasswordToggle: typeof initializePasswordToggle;
    }
  }
  window.initializePasswordToggle = initializePasswordToggle;
</script>

<style>
  /**
   * Password Toggle Button Component Styles
   * Uses BEM methodology and CSS variables from global.css
   * WCAG AAA compliant with enhanced accessibility features
   */

  /* Block element within auth-form-field */
  .auth-form-field__toggle-password {
    position: absolute;
    right: var(--space-sm);
    top: 50%;
    transform: translateY(-50%);
    background-color: transparent;
    border: none;
    padding: var(--space-sm);
    cursor: pointer;
    color: var(--text-secondary);
    border-radius: var(--radius-md);
    transition: all var(--transition-normal);
    z-index: var(--z-dropdown);
    display: flex;
    align-items: center;
    justify-content: center;
    /* Enhanced touch target size for optimal accessibility - 48px is better than 44px */
    min-width: 48px;
    min-height: 48px;
    /* Improved touch area with visual feedback */
    touch-action: manipulation;
    /* Better visual feedback on interaction */
    background-color: transparent;
    border: 1px solid transparent;
  }

  .auth-form-field__toggle-password:hover {
    color: var(--interactive-primary-hover);
    background-color: var(--bg-secondary);
  }

  .auth-form-field__toggle-password:focus-visible {
    outline: var(--focus-outline);
    outline-offset: 2px;
    color: var(--interactive-primary);
    background-color: var(--bg-secondary);
  }

  /* Icon container element */
  .auth-form-field__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.25rem;
    height: 1.25rem;
  }

  /* Modifier: hidden state for hide icon */
  .auth-form-field__icon--hide {
    display: none;
  }

  /* SVG icon element */
  .auth-form-field__svg-icon {
    width: 100%;
    height: 100%;
    flex-shrink: 0;
  }

  /* Responsive adjustments */
  @media (min-width: 768px) {
    .auth-form-field__toggle-password {
      right: var(--space-md);
      padding: var(--space-sm);
      /* Even larger touch targets on tablets and desktop for better UX */
      min-width: 52px;
      min-height: 52px;
    }

    .auth-form-field__icon {
      width: 1.5rem;
      height: 1.5rem;
    }
  }

  /* Extra large screens - further enhance touch targets */
  @media (min-width: 1024px) {
    .auth-form-field__toggle-password {
      min-width: 56px;
      min-height: 56px;
    }

    .auth-form-field__icon {
      width: 1.75rem;
      height: 1.75rem;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .auth-form-field__toggle-password {
      border: 1px solid currentColor;
      background-color: var(--color-background);
    }

    .auth-form-field__toggle-password:focus-visible {
      outline-width: 4px;
    }
  }

  /* Ultra-high contrast mode */
  @media (prefers-contrast: more) {
    .auth-form-field__toggle-password {
      border: 2px solid currentColor;
      background-color: var(--color-background);
    }

    .auth-form-field__toggle-password:focus-visible {
      outline-width: 5px;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .auth-form-field__toggle-password {
      transition: none;
    }
  }

  /* Touch devices optimization with enhanced touch targets */
  @media (hover: none) and (pointer: coarse) {
    .auth-form-field__toggle-password {
      padding: var(--space-md);
      right: var(--space-sm);
      /* Significantly larger touch targets for mobile devices */
      min-width: 56px;
      min-height: 56px;
      /* Add subtle visual feedback for touch */
      border: 1px solid transparent;
    }

    .auth-form-field__toggle-password:active {
      background-color: var(--bg-secondary);
      border-color: var(--border-secondary);
      transform: translateY(-50%) scale(0.95);
    }

    .auth-form-field__icon {
      width: 1.75rem;
      height: 1.75rem;
    }
  }

  /* Enhanced active state for better feedback */
  .auth-form-field__toggle-password:active {
    transform: translateY(-50%) scale(0.95);
    background-color: var(--bg-tertiary);
  }

  /* Keyboard navigation enhancement */
  .auth-form-field__toggle-password:focus {
    outline: none; /* Custom focus handling via focus-visible */
  }

  /* Enhanced focus for keyboard users */
  .auth-form-field__toggle-password:focus-visible {
    outline: var(--focus-outline);
    outline-offset: 3px;
    color: var(--interactive-primary);
    background-color: var(--bg-secondary);
    /* Ensure focus is visible even on touch devices */
    box-shadow: 0 0 0 4px var(--color-primary-200);
  }

  /* Light mode overrides using semantic variables */
  @media (prefers-color-scheme: light) {
    .auth-form-field__toggle-password {
      color: var(--text-secondary);
    }

    .auth-form-field__toggle-password:hover {
      color: var(--interactive-primary-hover);
    }

    .auth-form-field__toggle-password:focus-visible {
      color: var(--interactive-primary);
    }
  }
</style>

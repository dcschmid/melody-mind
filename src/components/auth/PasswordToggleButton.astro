---
/**
 * PasswordToggleButton Component for MelodyMind Auth Forms
 *
 * A reusable password visibility toggle button with accessibility features.
 * Provides password visibility toggle with eye/eye-slash icons and WCAG AAA compliance.
 *
 * @component
 * @example
 * ```astro
 * <PasswordToggleButton
 *   id="toggleLoginPassword"
 *   targetPasswordId="loginPassword"
 *   ariaLabel={t("auth.accessibility.password_toggle")}
 * />
 * ```
 */
import { Icon } from "astro-icon/components";
import { getLangFromUrl, useTranslations } from "@utils/i18n";

// Get current language and translations
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Prepare translations for client-side scripts
const clientTranslations = {
  "auth.accessibility.password_toggle_empty": t("auth.accessibility.password_toggle_empty"),
  "auth.accessibility.password.visible": t("auth.accessibility.password.visible"),
  "auth.accessibility.password.hidden": t("auth.accessibility.password.hidden"),
  "auth.accessibility.password.visible_status": t("auth.accessibility.password.visible_status"),
  "auth.accessibility.password.hidden_status": t("auth.accessibility.password.hidden_status"),
};

export interface Props {
  /** Unique identifier for the toggle button */
  id: string;
  /** ID of the password input this button controls */
  targetPasswordId: string;
  /** Accessible label for screen readers */
  ariaLabel: string;
  /** Additional CSS classes */
  class?: string;
}

const { id, targetPasswordId, ariaLabel, class: className = "" } = Astro.props;
---

<button
  type="button"
  {id}
  class={`auth-form-field__toggle-password ${className}`}
  aria-label={ariaLabel}
  aria-pressed="false"
  aria-describedby={`${id}Status ${id}Help`}
  data-target={targetPasswordId}
>
  <span class="auth-form-field__icon auth-form-field__icon--show">
    <Icon name="eye" class="auth-form-field__svg-icon" aria-hidden="true" />
  </span>
  <span class="auth-form-field__icon auth-form-field__icon--hide">
    <Icon name="eye-slash" class="auth-form-field__svg-icon" aria-hidden="true" />
  </span>
</button>

<!-- Hidden status announcement for screen readers -->
<div id={`${id}Status`} class="sr-only" aria-live="polite" aria-atomic="true"></div>

<!-- Contextual help for accessibility -->
<div id={`${id}Help`} class="sr-only">
  {t("auth.accessibility.password_toggle_help")}
</div>

<script define:vars={{ clientTranslations }}>
  /**
   * Password Toggle Button Functionality
   * Modern ES6+ implementation with enhanced accessibility features.
   */

  // Make translations available globally
  if (!window.authTranslations) {
    window.authTranslations = {};
  }
  Object.assign(window.authTranslations, clientTranslations);

  /**
   * Get required DOM elements for password toggle
   */
  const getToggleElements = (button) => {
    const targetId = button.dataset.target;
    if (!targetId) {
      return null;
    }

    const passwordInput = document.getElementById(targetId);
    const showIcon = button.querySelector(".auth-form-field__icon--show");
    const hideIcon = button.querySelector(".auth-form-field__icon--hide");
    const statusElement = document.getElementById(`${button.id}Status`);

    if (!passwordInput || !showIcon || !hideIcon) {
      return null;
    }

    return { passwordInput, showIcon, hideIcon, statusElement };
  };

  /**
   * Toggle icon visibility with CSS classes
   */
  const toggleIconVisibility = (showIcon, hideIcon, isPassword) => {
    const hiddenClass = "auth-form-field__icon--hidden";

    if (isPassword) {
      showIcon.classList.add(hiddenClass);
      hideIcon.classList.remove(hiddenClass);
    } else {
      showIcon.classList.remove(hiddenClass);
      hideIcon.classList.add(hiddenClass);
    }
  };

  /**
   * Update accessibility attributes and announcements
   */
  const updateAccessibilityState = (button, statusElement, isShowing) => {
    button.setAttribute("aria-pressed", isShowing ? "true" : "false");

    if (window.authTranslations) {
      const labelKey = isShowing
        ? "auth.accessibility.password.visible"
        : "auth.accessibility.password.hidden";
      const statusKey = isShowing
        ? "auth.accessibility.password.visible_status"
        : "auth.accessibility.password.hidden_status";

      const label = window.authTranslations[labelKey];
      if (label) {
        button.setAttribute("aria-label", label);
      }

      if (statusElement) {
        const statusText = window.authTranslations[statusKey];
        if (statusText) {
          statusElement.textContent = statusText;
        }
      }
    }
  };

  /**
   * Show error message and focus input
   */
  const showEmptyPasswordError = (passwordInput, statusElement) => {
    if (statusElement) {
      const errorMessage =
        window.authTranslations?.["auth.accessibility.password_toggle_empty"] ||
        "Enter a password first before toggling visibility.";
      statusElement.textContent = errorMessage;
    }
    passwordInput.focus();
  };

  /**
   * Initialize password toggle functionality
   */
  const initializePasswordToggle = (button) => {
    const elements = getToggleElements(button);
    if (!elements) {
      return;
    }

    const { passwordInput, showIcon, hideIcon, statusElement } = elements;

    button.addEventListener("click", () => {
      if (!passwordInput.value.trim()) {
        showEmptyPasswordError(passwordInput, statusElement);
        return;
      }

      const isPassword = passwordInput.type === "password";
      passwordInput.type = isPassword ? "text" : "password";

      toggleIconVisibility(showIcon, hideIcon, isPassword);
      updateAccessibilityState(button, statusElement, passwordInput.type === "text");

      passwordInput.focus();
    });
  };

  /**
   * Initialize all password toggle buttons
   */
  const initializeAllPasswordToggles = () => {
    const toggleButtons = document.querySelectorAll(".auth-form-field__toggle-password");
    toggleButtons.forEach(initializePasswordToggle);
  };

  /**
   * Find target toggle button for keyboard shortcuts
   */
  const findTargetToggleButton = (activeElement) => {
    if (activeElement?.type === "password") {
      const inputId = activeElement.id;
      return document.querySelector(`[data-target="${inputId}"]`);
    }
    return document.querySelector(".auth-form-field__toggle-password");
  };

  /**
   * Announce keyboard shortcut usage
   */
  const announceKeyboardShortcut = (targetButton) => {
    const statusElement = document.getElementById(`${targetButton.id}Status`);
    if (statusElement) {
      const lang = document.documentElement.lang || "en";
      const shortcutMessage =
        lang === "de"
          ? "Tastenkombination Strg+Umschalt+H verwendet"
          : "Keyboard shortcut Ctrl+Shift+H used";

      setTimeout(() => {
        statusElement.textContent = shortcutMessage;
      }, 500);
    }
  };

  /**
   * Initialize keyboard shortcuts
   */
  const initializeKeyboardShortcuts = () => {
    document.addEventListener("keydown", (event) => {
      if (event.ctrlKey && event.shiftKey && event.key === "H") {
        event.preventDefault();

        const activeElement = document.activeElement;
        const targetButton = findTargetToggleButton(activeElement);

        if (targetButton) {
          targetButton.click();
          announceKeyboardShortcut(targetButton);
        }
      }
    });
  };

  // Initialize on DOM content loaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initializeAllPasswordToggles();
      initializeKeyboardShortcuts();
    });
  } else {
    initializeAllPasswordToggles();
    initializeKeyboardShortcuts();
  }

  // Expose for manual initialization
  window.initializePasswordToggle = initializePasswordToggle;
</script>

<style lang="scss">
  /**
   * Password Toggle Button Component Styles
   * Modern SCSS with responsive design and WCAG AAA compliance
   */

  .auth-form-field__toggle-password {
    // Base positioning and layout
    position: absolute;
    right: var(--space-sm);
    top: 50%;
    transform: translateY(-50%);
    z-index: var(--z-dropdown);

    // Visual styling
    background-color: transparent;
    border: var(--border-width-thin) solid transparent;
    border-radius: var(--radius-md);
    color: var(--text-secondary);

    // Sizing and spacing
    padding: var(--space-sm);
    min-width: var(--touch-target-enhanced);
    min-height: var(--touch-target-enhanced);

    // Layout
    display: flex;
    align-items: center;
    justify-content: center;

    // Interactions
    cursor: pointer;
    touch-action: manipulation;

    // Transitions
    transition: all var(--transition-normal);

    // Hover state
    &:hover {
      color: var(--interactive-primary-hover);
      background-color: var(--bg-secondary);
    }

    // Focus state with enhanced accessibility
    &:focus-visible {
      outline: var(--focus-outline);
      outline-offset: var(--space-xs);
      color: var(--interactive-primary);
      background-color: var(--bg-secondary);
      box-shadow: var(--focus-enhanced-shadow);
    }

    // Active state
    &:active {
      transform: translateY(-50%) scale(var(--scale-hover));
      background-color: var(--bg-tertiary);
    }

    // Remove default focus outline
    &:focus {
      outline: none;
    }

    // Responsive design for larger screens
    @media (min-width: var(--breakpoint-md)) {
      right: var(--space-md);
      padding: var(--space-sm);
      min-width: calc(var(--touch-target-enhanced) + var(--space-xs));
      min-height: calc(var(--touch-target-enhanced) + var(--space-xs));
    }

    @media (min-width: var(--breakpoint-lg)) {
      min-width: calc(var(--touch-target-enhanced) + var(--space-sm));
      min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
    }

    // High contrast mode support
    @media (prefers-contrast: high) {
      border: var(--border-width-thin) solid currentColor;
      background-color: var(--bg-primary);

      &:focus-visible {
        outline-width: var(--space-xs);
      }
    }

    @media (prefers-contrast: more) {
      border: var(--border-width-thick) solid currentColor;
      background-color: var(--bg-primary);

      &:focus-visible {
        outline-width: calc(var(--space-xs) + 1px);
      }
    }

    // Touch device optimizations
    @media (hover: none) and (pointer: coarse) {
      padding: var(--space-md);
      right: var(--space-sm);
      min-width: calc(var(--touch-target-enhanced) + var(--space-sm));
      min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
      border: var(--border-width-thin) solid transparent;

      &:active {
        background-color: var(--bg-secondary);
        border-color: var(--border-secondary);
        transform: translateY(-50%) scale(var(--scale-hover));
      }
    }

    // Reduced motion support
    @media (prefers-reduced-motion: reduce) {
      transition: none;
    }
  }

  // Icon container styles
  .auth-form-field__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--text-lg);
    height: var(--text-lg);

    // Hide icon by default
    &--hide {
      display: none;
    }

    // Hidden state
    &--hidden {
      display: none !important;
    }

    // Responsive sizing
    @media (min-width: var(--breakpoint-md)) {
      width: var(--text-xl);
      height: var(--text-xl);
    }

    @media (min-width: var(--breakpoint-lg)) {
      width: var(--text-2xl);
      height: var(--text-2xl);
    }

    // Touch device icon sizing
    @media (hover: none) and (pointer: coarse) {
      width: var(--text-2xl);
      height: var(--text-2xl);
    }
  }

  // SVG icon styles
  .auth-form-field__svg-icon {
    width: 100%;
    height: 100%;
    flex-shrink: 0;
  }

  // Enhanced text spacing support for WCAG AAA
  .enhanced-text-spacing .auth-form-field__toggle-password {
    letter-spacing: var(--letter-spacing-enhanced);
    word-spacing: var(--word-spacing-enhanced);
    line-height: var(--line-height-enhanced);
    padding: calc(var(--space-sm) * 1.2);
    max-width: 100%;
    overflow: visible;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  // Container query support for responsive behavior
  @container (min-width: var(--container-query-lg)) {
    .auth-form-field__toggle-password {
      right: var(--space-md);
      padding: var(--space-md);
      min-width: calc(var(--touch-target-enhanced) + var(--space-sm));
      min-height: calc(var(--touch-target-enhanced) + var(--space-sm));
    }

    .auth-form-field__icon {
      width: var(--text-xl);
      height: var(--text-xl);
    }
  }

  @container (min-width: var(--container-query-md)) {
    .auth-form-field__toggle-password {
      right: var(--space-sm);
      padding: var(--space-sm);
      min-width: var(--touch-target-enhanced);
      min-height: var(--touch-target-enhanced);
    }

    .auth-form-field__icon {
      width: var(--text-lg);
      height: var(--text-lg);
    }
  }

  // Print styles
  @media print {
    .auth-form-field__toggle-password {
      display: none;
    }
  }

  // Forced colors mode support
  @media (forced-colors: active) {
    .auth-form-field__toggle-password {
      border: var(--border-width-thin) solid CanvasText;
      background-color: Canvas;
      color: CanvasText;

      &:hover {
        background-color: Highlight;
        color: HighlightText;
      }

      &:focus-visible {
        outline: var(--border-width-thick) solid Highlight;
      }
    }
  }
</style>

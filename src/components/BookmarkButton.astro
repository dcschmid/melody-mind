---
import { Icon } from "astro-icon/components";
import {
  DEFAULT_BOOKMARK_CATEGORY,
  type BookmarkCategory,
} from "@utils/bookmarks/clientBookmarks";

interface Props {
  articleSlug: string;
  articleTitle: string;
  defaultCategory?: BookmarkCategory;
}

const {
  articleSlug,
  articleTitle,
  defaultCategory = DEFAULT_BOOKMARK_CATEGORY,
} = Astro.props;
---

<button
  type="button"
  class="bookmark-button"
  data-bookmark-button
  data-bookmark-slug={articleSlug}
  data-bookmark-title={articleTitle}
  data-bookmark-category={defaultCategory}
  data-bookmark-state="empty"
  aria-pressed="false"
>
  <Icon name="bookmark" class="bookmark-button__icon" aria-hidden="true" />
  <span data-bookmark-label>Save</span>
</button>

<script>
  import {
    BOOKMARK_CATEGORIES,
    BOOKMARK_CHANGE_EVENT,
    DEFAULT_BOOKMARK_CATEGORY,
    getBookmarkBySlug,
    normalizeBookmarkSlug,
    toggleBookmark,
  } from "@utils/bookmarks/clientBookmarks";

  const isBookmarkCategory = (
    value: string
  ): value is (typeof BOOKMARK_CATEGORIES)[number] =>
    (BOOKMARK_CATEGORIES as readonly string[]).includes(value);

  const buttons = Array.from(
    document.querySelectorAll<HTMLButtonElement>("[data-bookmark-button]")
  );

  const updateButtonState = (button: HTMLButtonElement): void => {
    const slug = normalizeBookmarkSlug(button.dataset.bookmarkSlug || "");
    if (!slug) return;

    const label = button.querySelector<HTMLElement>("[data-bookmark-label]");
    const isSaved = Boolean(getBookmarkBySlug(slug));

    button.dataset.bookmarkState = isSaved ? "saved" : "empty";
    button.setAttribute("aria-pressed", isSaved ? "true" : "false");
    button.setAttribute(
      "aria-label",
      isSaved ? "Remove bookmark for this article" : "Save this article as bookmark"
    );
    if (label) {
      label.textContent = isSaved ? "Saved" : "Save";
    }
  };

  buttons.forEach((button) => {
    updateButtonState(button);

    button.addEventListener("click", () => {
      const slug = button.dataset.bookmarkSlug || "";
      const title = button.dataset.bookmarkTitle || "";
      const category = button.dataset.bookmarkCategory;
      const safeCategory =
        typeof category === "string" && isBookmarkCategory(category)
          ? category
          : DEFAULT_BOOKMARK_CATEGORY;
      toggleBookmark({
        articleSlug: slug,
        articleTitle: title,
        category: safeCategory,
      });
      updateButtonState(button);
    });
  });

  window.addEventListener(BOOKMARK_CHANGE_EVENT, () => {
    buttons.forEach((button) => updateButtonState(button));
  });
</script>

<style>
  .bookmark-button {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    min-height: 2.2rem;
    padding: 0.35rem 0.85rem;
    border-radius: 999px;
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    background: color-mix(in srgb, var(--gn-bg) 80%, transparent);
    color: var(--gn-ink);
    font-weight: 600;
    cursor: pointer;
    transition:
      transform 160ms ease,
      border-color 160ms ease,
      box-shadow 160ms ease;
  }

  .bookmark-button__icon {
    width: 1rem;
    height: 1rem;
    color: var(--color-gn-amber-300);
  }

  .bookmark-button[data-bookmark-state="saved"] {
    border-color: color-mix(in srgb, var(--gn-accent) 45%, transparent);
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3);
  }

  .bookmark-button:hover {
    transform: translateY(-2px);
  }

  .bookmark-button:focus-visible {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 3px;
  }
</style>

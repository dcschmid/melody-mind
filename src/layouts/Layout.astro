---
/**
 * @component Layout
 * @description The main layout component used throughout the MelodyMind application.
 * This layout implements WCAG AAA accessibility standards and performance optimizations
 * including reduced motion support, proper document structure, optimized resource loading,
 * and mobile-friendly viewport configurations.
 *
 * Features:
 * - Complete semantic document structure
 * - Optimized font loading strategy
 * - Proper page landmark regions
 * - Adherence to WCAG AAA accessibility standards
 * - Performance-optimized resource loading
 * - High contrast mode compatibility
 * - Reduced motion support
 * - View transition support for smoother page navigation
 *
 * @prop {string} title - Page title
 * @prop {string} [description] - Page meta description
 * @prop {string} [keywords] - Page meta keywords
 * @prop {string} [image] - Social sharing image URL
 * @prop {"website"|"article"|"music"|"game"} [type="website"] - Page content type
 * @prop {Date} [publishDate] - Content publish date for SEO
 * @prop {Date} [modifiedDate] - Content modification date for SEO
 * @prop {boolean} [showHeader=true] - Whether to show the header navigation
 * @prop {boolean} [showHeaderIcons=true] - Whether to show icons in the header
 * @prop {boolean} [showCoins=false] - Whether to show the coin counter
 *
 * @example
 * <Layout
 *   title="Music Quiz"
 *   description="Test your music knowledge"
 *   type="game"
 *   showCoins={true}
 * >
 *   <YourPageContent />
 * </Layout>
 */
import { When } from "@astropub/flow";

// Import fonts with display=swap for better performance
import "@fontsource/source-sans-pro/400.css";
import "@fontsource/source-sans-pro/700.css";
import "@fontsource/source-sans-pro/900.css";

import ShowCoins from "@components/Shared/ShowCoins.astro";
import Navigation from "@components/Header/Navigation.astro";
import SEO from "@components/SEO.astro";
import SkipLink from "@components/Shared/SkipLink.astro";
import Footer from "@components/Footer.astro";
import { getLangFromUrl } from "@utils/i18n";
import "../styles/global.css";
import "../styles/wcag-aaa.css";

interface Props {
  /**
   * The page title
   */
  title: string;

  /**
   * Page meta description for SEO
   */
  description?: string;

  /**
   * Page meta keywords for SEO
   */
  keywords?: string;

  /**
   * Social sharing image URL
   */
  image?: string;

  /**
   * Page content type for SEO
   * @default "website"
   */
  type?: "website" | "article" | "music" | "game";

  /**
   * Content publish date for SEO
   */
  publishDate?: Date;

  /**
   * Content modification date for SEO
   */
  modifiedDate?: Date;

  /**
   * Whether to show the header navigation
   * @default true
   */
  showHeader?: boolean;

  /**
   * Whether to show icons in the header
   * @default true
   */
  showHeaderIcons?: boolean;

  /**
   * Whether to show the coin counter
   * @default false
   */
  showCoins?: boolean;

  /**
   * Music-specific OpenGraph meta tags
   */
  ogMusic?: {
    creator?: string;
    album?: string;
    musician?: string;
  };
}

const {
  title,
  description,
  keywords,
  image,
  type = "website",
  publishDate,
  modifiedDate,
  showHeader = true,
  showHeaderIcons = true,
  showCoins = false,
  ogMusic,
} = Astro.props;

const lang = getLangFromUrl(Astro.url);

// Preloaded critical resources for performance
const preloadedResources = [
  { href: "https://cdn.usefathom.com", crossorigin: "", as: "script" },
];
---

<!doctype html>
<html lang={lang} class="box-border m-0 h-full scroll-smooth" dir="ltr">
  <head>
    <!-- Character set and viewport configuration for mobile optimization -->
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <!-- Color scheme and theme color for browser UI -->
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#18181b" />
    <!-- zinc-900 -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <!-- Resource hints for performance -->
    {
      preloadedResources.map((resource) => (
        <link
          rel="preconnect"
          href={resource.href}
          crossorigin={resource.crossorigin}
        />
      ))
    }

    <!-- Structured data and SEO -->
    <link rel="sitemap" href="/sitemap-index.xml" />
    <meta
      name="google-site-verification"
      content="ImN0-TS4_aAOFIXaGxvsGSmqsgHxI94WARi8bW7fm9M"
    />
    <SEO
      title={title}
      description={description}
      keywords={keywords}
      image={image}
      type={type}
      publishDate={publishDate}
      modifiedDate={modifiedDate}
      ogMusic={ogMusic}
    />

    <!-- Analytics with performance and privacy optimizations -->
    <script
      src="https://cdn.usefathom.com/script.js"
      data-site="RKHOWTTO"
      data-spa="auto"
      data-auto="false"
      defer
      is:inline></script>

    <!-- View Transitions API for smooth page transitions -->
    <meta name="view-transition" content="same-origin" />
  </head>
  <body
    class="w-full max-w-6xl mx-auto p-3 md:p-6 text-base leading-7 tracking-wide
           text-wrap bg-zinc-900 text-zinc-50 min-h-screen flex flex-col antialiased
           motion-safe:scroll-smooth"
    data-theme="dark"
  >
    <!-- Skip link for keyboard navigation -->
    <SkipLink />

    <!-- Conditional header/navigation based on page type -->
    <When test={showHeader && !showCoins}>
      <header role="banner">
        <Navigation showHeaderIcons={showHeaderIcons} />
      </header>
    </When>

    <When test={showCoins}>
      <div class="absolute top-4 right-4 z-40">
        <ShowCoins />
      </div>
    </When>

    <!-- Main content area -->
    <main
      id="main-content"
      class="max-w-full mx-auto py-6 px-0 text-base leading-relaxed text-pretty flex-grow"
      tabindex="-1"
    >
      <slot />
    </main>

    <!-- Footer area -->
    <Footer />

    <!-- Deferred script execution for performance -->
    <script>
      /**
       * Extend Window interface to include Fathom analytics
       */
      declare global {
        interface Window {
          fathom?: {
            trackPageview: () => void;
            [key: string]: unknown;
          };
        }
      }

      /**
       * Check if reduced motion is preferred and add appropriate class
       */
      document.addEventListener("DOMContentLoaded", function () {
        // Apply reduced motion preference if set
        if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
          document.documentElement.classList.add("motion-reduce");
        }

        // Initialize Fathom analytics after page is interactive
        if (typeof window.fathom === "object") {
          window.addEventListener("load", function () {
            if (window.fathom && "trackPageview" in window.fathom) {
              window.fathom.trackPageview();
            }
          });
        }
      });

      /**
       * Handle theme switching between light/dark modes
       */
      function updateThemePreference() {
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        document.body.dataset.theme = prefersDark ? "dark" : "light";
      }

      // Initial theme setting
      updateThemePreference();

      // Listen for theme changes
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", updateThemePreference);
    </script>

    <!-- WCAG AAA Enhancements Script -->
    <script src="/scripts/wcag-aaa-enhancements.js" defer></script>
  </body>
</html>

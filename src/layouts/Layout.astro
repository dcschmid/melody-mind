---
/**
 * @component Layout
 * @description The main layout component used throughout the MelodyMind application.
 * This layout implements WCAG AAA accessibility standards and performance optimizations
 * including reduced motion support, proper document structure, optimized resource loading,
 * and mobile-friendly viewport configurations.
 *
 * Features:
 * - Complete semantic document structure with proper landmarks
 * - Optimized font loading strategy with preload directives
 * - High contrast mode compatibility for better visual accessibility
 * - Reduced motion support for vestibular disorders
 * - Screen reader announcements for preference changes
 * - Proper focus indicators for keyboard navigation
 * - Print-specific styles for better document printing
 * - Touch-friendly targets (minimum 44x44px)
 * - View Transitions for smooth page navigation
 *
 * @implements {WCAG AAA compliance}
 *
 * @prop {string} title - Page title
 * @prop {string} [description] - Page meta description
 * @prop {string} [keywords] - Page meta keywords
 * @prop {string} [image] - Social sharing image URL
 * @prop {"website"|"article"|"music"|"game"} [type="website"] - Page content type
 * @prop {Date} [publishDate] - Content publish date for SEO
 * @prop {Date} [modifiedDate] - Content modification date for SEO
 * @prop {boolean} [showHeader=true] - Whether to show the header navigation
 * @prop {boolean} [showHeaderIcons=true] - Whether to show icons in the header
 * @prop {boolean} [showCoins=false] - Whether to show the coin counter
 *
 * @example
 * <Layout
 *   title="Music Quiz"
 *   description="Test your music knowledge"
 *   type="game"
 *   showCoins={true}
 * >
 *   <YourPageContent />
 * </Layout>
 */
import { When } from "@astropub/flow";

// Import fonts with display=swap for better performance
import "@fontsource/source-sans-pro/400.css";
import "@fontsource/source-sans-pro/700.css";
import "@fontsource/source-sans-pro/900.css";

import ShowCoins from "@components/Shared/ShowCoins.astro";
import Navigation from "@components/Header/Navigation.astro";
import SEO from "@components/SEO.astro";
import SkipLink from "@components/Shared/SkipLink.astro";
import Footer from "@components/Footer.astro";
import { getLangFromUrl } from "@utils/i18n";
import "../styles/global.css";
//import "../styles/wcag-aaa.css";
//import "../styles/keyboard-shortcuts.css";

interface Props {
  /**
   * The page title
   */
  title: string;

  /**
   * Page meta description for SEO
   */
  description?: string;

  /**
   * Page meta keywords for SEO
   */
  keywords?: string;

  /**
   * Social sharing image URL
   */
  image?: string;

  /**
   * Page content type for SEO
   * @default "website"
   */
  type?: "website" | "article" | "music" | "game";

  /**
   * Content publish date for SEO
   */
  publishDate?: Date;

  /**
   * Content modification date for SEO
   */
  modifiedDate?: Date;

  /**
   * Whether to show the header navigation
   * @default true
   */
  showHeader?: boolean;

  /**
   * Whether to show icons in the header
   * @default true
   */
  showHeaderIcons?: boolean;

  /**
   * Whether to show the coin counter
   * @default false
   */
  showCoins?: boolean;

  /**
   * Music-specific OpenGraph meta tags
   */
  ogMusic?: {
    creator?: string;
    album?: string;
    musician?: string;
  };
}

const {
  title,
  description,
  keywords,
  image,
  type = "website",
  publishDate,
  modifiedDate,
  showHeader = true,
  showHeaderIcons = true,
  showCoins = false,
  ogMusic,
} = Astro.props;

const lang = getLangFromUrl(Astro.url);

// Preloaded critical resources for performance
const preloadedResources = [
  { href: "https://cdn.usefathom.com", crossorigin: "", as: "script" },
  { href: "/styles/global.css", as: "style" },
];

// Font preloading for critical fonts
const fontPreloads = [
  {
    href: "/fonts/source-sans-pro-latin-400-normal.woff2",
    as: "font",
    type: "font/woff2",
    crossorigin: "anonymous",
  },
  {
    href: "/fonts/source-sans-pro-latin-700-normal.woff2",
    as: "font",
    type: "font/woff2",
    crossorigin: "anonymous",
  },
];

// DNS prefetch for external domains
const dnsPrefetch = [{ href: "https://cdn.usefathom.com" }];
---

<!doctype html>
<html lang={String(lang)} class="layout-html" dir="ltr">
  <head>
    <!-- Character set and viewport configuration for mobile optimization -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}

    <!-- Color scheme and theme color for browser UI -->
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#18181b" media="(prefers-color-scheme: dark)" />
    <meta name="theme-color" content="#f4f4f5" media="(prefers-color-scheme: light)" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <!-- Resource hints for performance -->
    {dnsPrefetch.map((resource) => <link rel="dns-prefetch" href={resource.href} />)}

    {
      preloadedResources.map((resource) => (
        <link rel="preconnect" href={resource.href} crossorigin={resource.crossorigin} />
      ))
    }

    <!-- Font preloading for critical fonts -->
    {
      fontPreloads.map((font) => (
        <link
          rel="preload"
          href={font.href}
          as={font.as}
          type={font.type}
          crossorigin={font.crossorigin}
        />
      ))
    }

    <!-- Structured data and SEO -->
    <link rel="sitemap" href="/sitemap-index.xml" />
    <meta name="google-site-verification" content="ImN0-TS4_aAOFIXaGxvsGSmqsgHxI94WARi8bW7fm9M" />
    <SEO {title} {description} {keywords} {image} {type} {publishDate} {modifiedDate} {ogMusic} />

    <!-- Critical CSS inline for performance -->
    <style is:inline>
      /* Print styles for better document printing */
      @media print {
        body {
          background-color: white;
          color: black;
        }

        .no-print {
          display: none !important;
        }

        main {
          width: 100%;
          padding: 0;
          margin: 0;
        }

        a::after {
          content: " (" attr(href) ")";
          font-size: 0.9em;
        }
      }
    </style>

    <!-- Layout-specific CSS -->
    <style>
      /**
       * Layout-spezifische CSS-Definitionen
       * Diese Styles gelten nur für das Layout-Grundgerüst und definieren 
       * keine Komponenten, die in anderen Dateien wiederverwendet werden.
       */

      /* Verwenden der globalen Variablen direkt */
      :root {
        /* Nur wirklich layoutspezifische Variablen hier definieren */
        --layout-padding-small: var(--spacing-md, 0.75rem);
        --layout-padding-large: var(--spacing-lg, 1.5rem);
      }

      /* HTML-Basis-Styling */
      .layout-html {
        margin: 0;
        box-sizing: border-box;
        height: 100%;
        scroll-behavior: smooth;
      }

      /* Body-Styling mit flexiblem Layout */
      .layout-body {
        margin-left: auto;
        margin-right: auto;
        display: flex;
        min-height: 100vh;
        width: 100%;
        max-width: var(--layout-max-width, 72rem);
        flex-direction: column;
        background-color: var(--color-background, #18181b);
        padding: var(--layout-padding-small);
        font-size: var(--font-size-lg, 1.125rem);
        line-height: var(--line-height-relaxed, 2rem);
        letter-spacing: var(--letter-spacing, 0.025em);
        text-wrap: wrap;
        color: var(--color-text-primary, #fafafa);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Unterstützung für reduzierte Animationen */
      @media (prefers-reduced-motion: no-preference) {
        .layout-body {
          scroll-behavior: smooth;
        }
      }

      /* Responsive Design mit Breakpoint-Variablen */
      @media (min-width: var(--breakpoint-md, 768px)) {
        .layout-body {
          padding: var(--layout-padding-large);
        }
      }

      /* Header-Bereich */
      .layout-header {
        width: 100%;
      }

      /* Münzen-Anzeige mit Touch-Target-Mindestgröße */
      .layout-coins {
        position: absolute;
        top: var(--layout-padding-small);
        right: var(--layout-padding-small);
        z-index: var(--z-index-overlay, 40);
        min-height: var(--touch-target-min-size, 44px);
        min-width: var(--touch-target-min-size, 44px);
      }

      /* Responsive Anpassung für Tablet und Desktop */
      @media (min-width: var(--breakpoint-sm, 640px)) {
        .layout-coins {
          top: var(--layout-padding-large);
          right: var(--layout-padding-large);
        }
      }

      /* Hauptinhalt-Bereich */
      .layout-main {
        margin-left: auto;
        margin-right: auto;
        max-width: 100%;
        flex-grow: 1;
        padding-left: 0;
        padding-right: 0;
        padding-top: var(--layout-padding-large);
        padding-bottom: var(--layout-padding-large);
        font-size: var(--font-size-lg, 1.125rem);
        line-height: var(--line-height-relaxed, 2rem);
        text-wrap: pretty;
      }
    </style>

    <!-- Analytics with performance and privacy optimizations -->
    <script
      src="https://cdn.usefathom.com/script.js"
      data-site="RKHOWTTO"
      data-spa="auto"
      data-auto="false"
      defer
      is:inline></script>
  </head>
  <body class="layout-body" data-theme="dark">
    <!-- Skip link for keyboard navigation -->
    <SkipLink />

    <!-- Conditional header/navigation based on page type -->
    <When test={showHeader && !showCoins}>
      <header role="banner" class="layout-header">
        <Navigation {showHeaderIcons} />
      </header>
    </When>

    <When test={showCoins}>
      <div class="layout-coins">
        <ShowCoins />
      </div>
    </When>

    <!-- Main content area -->
    <main id="main-content" class="layout-main" tabindex="-1" role="main">
      <slot />
    </main>

    <!-- Footer area -->
    <Footer />

    <!-- Deferred script execution for performance -->
    <script>
      /**
       * Extend Window interface to include Fathom analytics
       */
      declare global {
        interface Window {
          fathom?: {
            trackPageview: (opts?: object) => void;
            [key: string]: unknown;
          };
        }
      }

      /**
       * Check if reduced motion is preferred and add appropriate class
       */
      const setReducedMotionClass = (): void => {
        if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
          document.documentElement.classList.add("motion-reduce");
          // Announce to screen readers that reduced motion is active
          const statusElement =
            document.getElementById("a11y-status") || document.createElement("div");
          if (!document.getElementById("a11y-status")) {
            statusElement.id = "a11y-status";
            statusElement.setAttribute("aria-live", "polite");
            statusElement.className = "sr-only";
            document.body.appendChild(statusElement);
          }
          statusElement.textContent = "Reduced motion mode enabled";
        } else {
          document.documentElement.classList.remove("motion-reduce");
        }
      };

      /**
       * Handle theme switching between light/dark modes
       */
      const updateThemePreference = (): void => {
        // Wir setzen immer das dunkle Theme, unabhängig von den Systemeinstellungen
        document.body.dataset.theme = "dark";
        document.documentElement.classList.add("dark");
        document.documentElement.classList.remove("light");
      };

      // Register document-level events
      document.addEventListener("DOMContentLoaded", () => {
        // Initial setup when DOM is loaded
        setReducedMotionClass();
        updateThemePreference();

        // Initialize analytics
        if (typeof window.fathom === "object" && window.fathom?.trackPageview) {
          window.fathom.trackPageview({
            url: window.location.href,
          });
        }
      });

      // Listen for reduced motion preference changes
      window
        .matchMedia("(prefers-reduced-motion: reduce)")
        .addEventListener("change", setReducedMotionClass);

      // Handle page visibility for better performance
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
          // Re-render animations or update time-sensitive UI
        }
      });
    </script>
  </body>
</html>

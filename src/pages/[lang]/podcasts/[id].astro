---
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import Layout from "@layouts/Layout.astro";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";
import type { PodcastData } from "../../../types/podcast";
import enPodcastsJson from "../../../data/podcasts/en.json" assert { type: "json" };

/**
 * Static path generation for internationalization
 * Generates paths for all supported languages and podcast IDs
 */
export const getStaticPaths = async () => {
  const supportedLanguages = [
    "de",
    "en",
    "es",
    "fr",
    "it",
    "pt",
    "da",
    "nl",
    "sv",
    "fi",
    "cn",
    "ru",
    "jp",
    "uk",
  ];

  const podcasts = enPodcastsJson.podcasts;
  const paths: Array<{ params: { lang: string; id: string } }> = [];

  // Generate paths for all languages and all podcast IDs
  supportedLanguages.forEach((lang) => {
    podcasts.forEach((podcast) => {
      paths.push({
        params: { lang, id: podcast.id },
      });
    });
  });

  return paths;
};

/**
 * Enable static site generation for this page
 */
export const prerender = true;

/**
 * Language and translation setup
 */
const lang = String(getLangFromUrl(Astro.url));
const t = useTranslations(String(lang));
const podcastId = Astro.params.id;

/**
 * Find the specific podcast by ID
 */
const findPodcastById = (id: string): PodcastData | null => {
  const podcasts = enPodcastsJson.podcasts;
  return podcasts.find((podcast) => podcast.id === id) || null;
};

const podcast = findPodcastById(podcastId || "");

// If podcast not found, return 404
if (!podcast) {
  return Astro.redirect("/404");
}

// SEO and page metadata
const title = podcast.title;
const description = podcast.description;
const currentUrl = new URL(Astro.url.pathname, Astro.site);
const baseUrl = Astro.site?.toString().replace(/\/$/, "") || "";

/**
 * Generate PodcastEpisode schema for SEO
 */
const generatePodcastSchema = () => ({
  "@context": "https://schema.org",
  "@type": "PodcastEpisode",
  name: podcast.title,
  description: podcast.description,
  url: currentUrl.toString(),
  inLanguage: lang,
  datePublished: podcast.publishedAt,
  image: {
    "@type": "ImageObject",
    url: new URL(podcast.imageUrl, baseUrl).toString(),
  },
  isPartOf: {
    "@type": "PodcastSeries",
    name: "MelodyMind Podcast",
    url: `${baseUrl}/${lang}/podcasts`,
  },
  ...(podcast.audioUrl && {
    audio: {
      "@type": "AudioObject",
      url: podcast.audioUrl,
      encodingFormat: "audio/mpeg",
    },
  }),
});

const pageSchema = generatePodcastSchema();

/**
 * Format the published date
 */
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

/**
 * Get the previous and next podcast for navigation
 */
const getNavigationPodcasts = () => {
  const podcasts = enPodcastsJson.podcasts.filter((p) => p.isAvailable);
  const currentIndex = podcasts.findIndex((p) => p.id === podcastId);

  if (currentIndex === -1) {
    return { prev: null, next: null };
  }

  const prev = currentIndex > 0 ? podcasts[currentIndex - 1] : null;
  const next = currentIndex < podcasts.length - 1 ? podcasts[currentIndex + 1] : null;

  return { prev, next };
};

const { prev, next } = getNavigationPodcasts();
---

<Layout {title} {description} type="article" image={podcast.imageUrl}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(pageSchema)} />

    <!-- Open Graph for Podcast Episode -->
    <meta property="og:type" content="music.song" />
    <meta property="music:creator" content="MelodyMind" />
    <meta property="article:published_time" content={podcast.publishedAt} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={podcast.title} />
    <meta name="twitter:description" content={podcast.description} />
    <meta name="twitter:image" content={new URL(podcast.imageUrl, baseUrl).toString()} />
  </Fragment>

  <main class="min-h-screen bg-gray-900 py-8 text-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <!-- Navigation Back -->
      <nav class="mb-8" aria-label={t("podcast.navigation.aria")}>
        <a
          href={`/${lang}/podcasts`}
          class="inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-semibold text-purple-400 transition-all duration-300 hover:-translate-x-1 hover:bg-purple-500/10 hover:text-purple-300"
        >
          {t("podcast.back_to_all")}
        </a>
      </nav>

      <!-- Hero Section -->
      <section class="mb-12 rounded-2xl border border-gray-700 bg-gray-800 p-8 shadow-xl">
        <div class="mb-8 flex flex-col gap-8 text-center md:flex-row md:text-left">
          <div class="flex-shrink-0">
            <img
              src={podcast.imageUrl}
              alt={podcast.title}
              width="200"
              height="200"
              loading="eager"
              class="h-48 w-48 rounded-2xl shadow-2xl"
            />
          </div>

          <div class="flex-1">
            <Headline level="h1" textSize="3xl" className="mb-4 text-white">
              {podcast.title}
            </Headline>

            <Paragraph textSize="lg" className="mb-6 text-gray-300">
              {podcast.description}
            </Paragraph>

            <div class="flex flex-wrap items-center justify-center gap-6 md:justify-start">
              <time class="text-sm text-gray-400" datetime={podcast.publishedAt}>
                üìÖ {formatDate(podcast.publishedAt)}
              </time>
              <span class="text-sm text-gray-400">üéôÔ∏è Episode</span>
            </div>
          </div>
        </div>

        {/* Audio Player */}
        {
          podcast.audioUrl && (
            <div class="rounded-2xl border border-gray-600 bg-gradient-to-br from-gray-800 via-gray-700 to-gray-800 p-8 text-center shadow-xl">
              <Headline level="h2" textSize="lg" className="mb-6 text-white">
                üéß {t("podcast.listen_to_episode")}
              </Headline>

              {/* Functional Audio Player */}
              <div class="mb-6 rounded-xl border border-gray-600 bg-gray-900 p-6 shadow-inner">
                <div class="mb-4 flex items-center justify-center gap-4">
                  <div class="flex h-16 w-16 items-center justify-center rounded-full bg-purple-600 shadow-lg">
                    <svg class="h-8 w-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z" />
                    </svg>
                  </div>
                  <div class="text-left">
                    <div class="text-lg font-semibold text-white">{podcast.title}</div>
                    <div class="text-sm text-gray-400">{t("podcast.episode_label")}</div>
                  </div>
                </div>

                {/* Hidden Audio Element */}
                <audio id="podcast-audio" preload="metadata" class="hidden">
                  <source src={podcast.audioUrl} type="audio/mpeg" />
                  {podcast.subtitleUrl ? (
                    <track kind="captions" src={podcast.subtitleUrl} label="English" />
                  ) : (
                    <track kind="captions" src="" label="No captions available" />
                  )}
                  Your browser does not support the audio element.
                </audio>

                {/* Progress Bar */}
                <div
                  class="mb-4 h-2 w-full cursor-pointer rounded-full bg-gray-700"
                  id="progress-container"
                >
                  <div
                    class="h-2 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 transition-all duration-300"
                    id="progress-bar"
                    style="width: 0%"
                  />
                </div>

                {/* Time Display */}
                <div class="mb-4 flex justify-between text-sm text-gray-400">
                  <span id="current-time">0:00</span>
                  <span id="total-time">0:00</span>
                </div>

                {/* Audio Controls */}
                <div class="flex items-center justify-center gap-6">
                  <button
                    class="text-gray-400 transition-colors duration-200 hover:text-white"
                    id="rewind-btn"
                    title="Rewind 10s"
                  >
                    <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
                    </svg>
                  </button>
                  <button
                    class="flex h-12 w-12 items-center justify-center rounded-full bg-purple-600 shadow-lg transition-colors duration-200 hover:bg-purple-700"
                    id="play-pause-btn"
                  >
                    <svg
                      class="h-8 w-8 text-white"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                      id="play-icon"
                    >
                      <path d="M8 5v14l11-7z" />
                    </svg>
                    <svg
                      class="hidden h-8 w-8 text-white"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                      id="pause-icon"
                    >
                      <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                    </svg>
                  </button>
                  <button
                    class="text-gray-400 transition-colors duration-200 hover:text-white"
                    id="forward-btn"
                    title="Forward 10s"
                  >
                    <svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6h2c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8z" />
                    </svg>
                  </button>
                </div>
              </div>

              {/* Action Buttons */}
              <div class="flex flex-wrap justify-center gap-4">
                <a
                  href={podcast.audioUrl}
                  class="inline-flex items-center gap-3 rounded-xl bg-gradient-to-r from-purple-600 to-purple-700 px-6 py-3 text-sm font-semibold text-white shadow-lg transition-all duration-300 hover:-translate-y-1 hover:from-purple-700 hover:to-purple-800 hover:shadow-xl"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                  </svg>
                  Download Audio
                </a>
                {podcast.subtitleUrl && (
                  <a
                    href={podcast.subtitleUrl}
                    class="inline-flex items-center gap-3 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-3 text-sm font-semibold text-white shadow-lg transition-all duration-300 hover:-translate-y-1 hover:from-blue-700 hover:to-blue-800 hover:shadow-xl"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
                    </svg>
                    View Subtitles
                  </a>
                )}
              </div>
            </div>
          )
        }
      </section>

      <!-- Main Content -->
      <section class="mb-12">
        <article class="rounded-2xl border border-gray-700 bg-gray-800 p-8 shadow-lg">
          <div class="prose prose-invert prose-lg max-w-none" set:html={podcast.showNotesHtml} />
        </article>
      </section>

      {/* Navigation Between Episodes */}
      {
        (prev || next) && (
          <nav class="mb-12" aria-label="Episode navigation">
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              {prev && (
                <a
                  href={`/${lang}/podcasts/${prev.id}`}
                  class="flex items-center gap-4 rounded-xl border border-gray-700 bg-gray-800 p-6 text-white shadow-lg transition-all duration-300 hover:-translate-y-1 hover:border-gray-600 hover:bg-gray-700 hover:shadow-xl"
                >
                  <span class="text-2xl text-purple-400">‚Üê</span>
                  <div class="flex-1">
                    <span class="mb-1 block text-xs tracking-wide text-gray-400 uppercase">
                      Previous Episode
                    </span>
                    <span class="block text-sm leading-tight font-semibold">{prev.title}</span>
                  </div>
                </a>
              )}

              {next && (
                <a
                  href={`/${lang}/podcasts/${next.id}`}
                  class="flex items-center gap-4 rounded-xl border border-gray-700 bg-gray-800 p-6 text-white shadow-lg transition-all duration-300 hover:-translate-y-1 hover:border-gray-600 hover:bg-gray-700 hover:shadow-xl md:col-start-2"
                >
                  <div class="flex-1 text-right">
                    <span class="mb-1 block text-xs tracking-wide text-gray-400 uppercase">
                      Next Episode
                    </span>
                    <span class="block text-sm leading-tight font-semibold">{next.title}</span>
                  </div>
                  <span class="text-2xl text-purple-400">‚Üí</span>
                </a>
              )}
            </div>
          </nav>
        )
      }

      {/* Call to Action */}
      <div
        class="w-full rounded-2xl border border-purple-500/30 bg-gradient-to-br from-purple-900 via-blue-800 to-gray-900 p-12 text-center shadow-2xl"
      >
        <Headline level="h2" textSize="xl" className="mb-4 text-white">
          Want More Music Stories?
        </Headline>
        <Paragraph className="mb-8 text-lg text-gray-300">
          Explore our complete collection of podcast episodes and discover the fascinating world of
          music history, culture, and innovation.
        </Paragraph>
        <a
          href={`/${lang}/podcasts`}
          class="inline-flex items-center gap-2 rounded-xl bg-purple-600 px-8 py-4 text-base font-semibold text-white shadow-lg transition-colors duration-300 hover:-translate-y-1 hover:bg-purple-700 hover:shadow-xl"
        >
          Browse All Episodes
        </a>
      </div>
    </div>
  </main>

  <script>
    import { initAudioPlayerAuto } from "../../../utils/components/audioPlayerUtils";

    // Initialize Audio Player functionality
    document.addEventListener("DOMContentLoaded", () => {
      initAudioPlayerAuto();
    });
  </script>
</Layout>

---
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import PlaylistItem from "@components/PlaylistItem.astro";
import Layout from "@layouts/Layout.astro";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";
import { extractKeywords, generateMetaDescription } from "@utils/seo";
import CategoryFilter from "@components/CategoryFilter.astro";

import EmptyState from "@components/EmptyState.astro";
import LoadingState from "@components/LoadingState.astro";
import BackToTop from "@components/Shared/BackToTop.astro";

/**
 * Static path generation for internationalization
 * Required for Astro dynamic routes to work properly
 */
export async function getStaticPaths(): Promise<{ params: { lang: string } }[]> {
  const supportedLanguages = [
    "de",
    "en",
    "es",
    "fr",
    "it",
    "pt",
    "da",
    "nl",
    "sv",
    "fi",
    "cn",
    "ru",
    "jp",
    "uk",
  ] as const;

  return supportedLanguages.map((lang) => ({
    params: { lang },
  }));
}

/**
 * Enable static site generation for this page
 */
export const prerender = true;

/**
 * Language and translation setup
 * Sets the current language based on URL and loads appropriate translations
 */
const lang = String(getLangFromUrl(Astro.url));
const t = useTranslations(String(lang));

/**
 * Interface defining the structure of a music category
 */
interface Category {
  isPlayable: boolean;
  headline: string;
  categoryUrl?: string;
  imageUrl: string;
  introSubline: string;
  slug: string;
  text: string;
  categoryType:
    | "decade"
    | "female"
    | "genre"
    | "other"
    | "classic-rock"
    | "metal-classic"
    | "metal-modern"
    | "metal-avantgarde"
    | "mainstream-pop"
    | "indie-alternative"
    | "global-pop"
    | "jazz-soul-funk"
    | "hip-hop-rap"
    | "house-techno"
    | "club-sounds"
    | "breaks-experimental"
    | "latin-vibes"
    | "caribbean-afro"
    | "folk-regional"
    | "classical-orchestral"
    | "countries-regional"
    | "emotional"
    | "seasonal"
    | "situational";
}

/**
 * Generates WebApplication schema for the game home page
 */
function generateGameApplicationSchema(
  title: string,
  description: string,
  currentUrl: string,
  lang: string
) {
  return {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    name: `MelodyMind - ${title}`,
    description: description,
    url: currentUrl,
    applicationCategory: "GameApplication",
    applicationSubCategory: "MusicTrivia",
    operatingSystem: "Web Browser",
    genre: "Music Trivia",
    inLanguage: lang,
    creator: {
      "@type": "Organization",
      name: "MelodyMind Team",
    },
    datePublished: "2024-01-01",
    dateModified: new Date().toISOString(),
    isAccessibleForFree: true,
  };
}

/**
 * Generates ItemList schema for game categories
 */
function generateCategoryListSchema(baseUrl: string, lang: string, playableCategories: Category[]) {
  return {
    "@context": "https://schema.org",
    "@type": "ItemList",
    name: "Music Game Categories",
    description: "Available music trivia categories in MelodyMind",
    numberOfItems: playableCategories.length,
    itemListElement: playableCategories.slice(0, 10).map((category, index) => ({
      "@type": "ListItem",
      position: index + 1,
      item: {
        "@type": "Game",
        name: category.headline,
        description: category.introSubline,
        url: `${baseUrl}/${lang}${category.categoryUrl}`,
        genre: "Music Trivia",
        applicationCategory: "Game",
      },
    })),
  };
}

/**
 * Generates client-side translations with fallbacks
 */
function generateClientTranslations(t: (_key: string) => string) {
  return {
    search: {
      placeholder: t("game.search.label"),
      showingAll: t("game.search.showing.all"),
      resultsFound: t("game.search.results"),
      noResults: t("game.search.no.results"),
      clear: t("game.search.clear"),
    },
    accessibility: {
      skipToContent: t("accessibility.skip.to.content"),
      searchLabel: t("game.search.label"),
    },
  };
}

/**
 * Asynchronously loads category data with fallback mechanisms
 * First attempts to load using the alias path, then tries relative path if that fails
 * @returns {Promise<Category[]>} Array of category objects
 */
async function loadCategoriesForLanguage(language: string): Promise<Category[]> {
  try {
    // First try using the alias path
    return await import(`@json/${language}_categories.json`)
      .then((module) => module.default)
      .catch(async () => {
        // Fallback to relative path if alias fails
        console.warn(`Attempting to load ${language}_categories.json using relative path`);
        return await import(`../../json/${language}_categories.json`)
          .then((module) => module.default)
          .catch((_err) => {
            return [];
          });
      });
  } catch (error) {
    console.error(`Error loading categories for ${language}:`, error);
    return [];
  }
}

// Load categories and ensure we have a valid array
const categoriesList = await loadCategoriesForLanguage(lang);
const categories = Array.isArray(categoriesList) ? categoriesList : [];

/**
 * Type guard that checks if an item is a valid playable category
 * @param item - The item to check
 * @returns Boolean indicating if item is a valid playable category
 */

function isPlayableCategory(item: any): item is Category & { categoryUrl: string } {
  return (
    item &&
    typeof item === "object" &&
    item.isPlayable === true &&
    typeof item.headline === "string" &&
    typeof item.imageUrl === "string" &&
    typeof item.introSubline === "string" &&
    typeof item.slug === "string" &&
    typeof item.text === "string" &&
    typeof item.categoryUrl === "string" &&
    typeof item.categoryType === "string" &&
    Boolean(item.categoryUrl)
  );
}

// Filter categories by playability status
const playableCategories = categories.filter(isPlayableCategory);
const nonPlayableCategories = categories.filter((item) => item && !item.isPlayable);

// Sort categories by type and then by name within each type
function sortCategoriesByType(categories: Category[]): Category[] {
  const typeOrder = {
    decade: 1,
    female: 2,
    "classic-rock": 3,
    "metal-classic": 4,
    "metal-modern": 5,
    "metal-avantgarde": 6,
    "mainstream-pop": 7,
    "indie-alternative": 8,
    "global-pop": 9,
    "jazz-soul-funk": 10,
    "hip-hop-rap": 11,
    "house-techno": 12,
    "club-sounds": 13,
    "breaks-experimental": 14,
    "latin-vibes": 15,
    "caribbean-afro": 16,
    "folk-regional": 17,
    "classical-orchestral": 18,
    "countries-regional": 19,
    emotional: 20,
    seasonal: 21,
    situational: 22,
    genre: 23,
    other: 24,
  };

  return categories.sort((a, b) => {
    // First sort by type
    if (typeOrder[a.categoryType] !== typeOrder[b.categoryType]) {
      return typeOrder[a.categoryType] - typeOrder[b.categoryType];
    }

    // Within same type, sort decades chronologically, others alphabetically
    if (a.categoryType === "decade") {
      return a.slug.localeCompare(b.slug);
    }

    return a.headline.localeCompare(b.headline);
  });
}

// Sort categories by type and playability
const sortedPlayableCategories = sortCategoriesByType(playableCategories);
const sortedNonPlayableCategories = sortCategoriesByType(nonPlayableCategories);

// Combined categories with playable ones first, sorted by type
const sortedCategories = [...sortedPlayableCategories, ...sortedNonPlayableCategories];

// Enhanced SEO content generation for better search visibility
const title = t("game.select");
const description = t("game.welcome");

// Create rich SEO content combining category information
const enrichedContent = `${title} ${description} ${t("game.genre.selection.description")} ${sortedCategories.map((c) => `${c.headline} ${c.introSubline} ${c.text || ""}`).join(" ")}`;

// Generate optimized meta description and keywords using enhanced content
const optimizedDescription = generateMetaDescription(enrichedContent, 158); // Leave room for ellipsis
const seoKeywords = extractKeywords(enrichedContent, 12, lang) || t("meta.keywords");

// Create category-specific keywords for better targeting
const categoryNames = sortedCategories.map((c) => c.headline.toLowerCase()).join(", ");
const combinedKeywords = `${seoKeywords}, ${categoryNames}, ${t("meta.keywords")}`.substring(
  0,
  255
);

// Enhanced structured data for GameHub/CategoryList
const baseUrl = Astro.site?.toString() || "https://melody-mind.de";
const currentUrl = `${baseUrl}/${lang}/gamehome`;

// JSON-LD structured data for better search engine understanding
const gameApplicationSchema = generateGameApplicationSchema(
  title,
  optimizedDescription,
  currentUrl,
  lang
);

// ItemList schema for game categories
const categoryListSchema = generateCategoryListSchema(baseUrl, lang, playableCategories);

// Additional structured data parameters for enhanced SEO
const pageType = "website";
const publishDate = new Date("2024-01-01");
const modifiedDate = new Date();

// Prepare fallback text for empty states
const emptyCategoriesHeadline = t("game.categories.empty.headline");
const emptyCategoriesText = t("game.categories.empty.text");

// Client-side translations for enhanced interactivity
const clientTranslations = generateClientTranslations(t);
---

<Layout
  {title}
  description={optimizedDescription}
  keywords={combinedKeywords}
  image={`/og-images/social-share-gamehome-${String(lang)}.jpg`}
  type={pageType}
  {publishDate}
  {modifiedDate}
>
  <!-- Enhanced structured data for SEO -->
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(gameApplicationSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(categoryListSchema)} />

    <!-- Additional SEO meta tags -->
    <meta name="robots" content="index, follow, max-image-preview:large" />
    <meta name="googlebot" content="index, follow" />
    <link rel="canonical" href={currentUrl} />

    <!-- Enhanced OpenGraph tags for social sharing -->
    <meta property="og:type" content="website" />
    <meta property="og:locale" content={`${lang}_${lang.toUpperCase()}`} />
    <meta property="article:section" content="Gaming" />
    <meta property="article:tag" content="Music Trivia" />
    <meta property="article:tag" content="Online Game" />
    <meta property="article:tag" content="Music Knowledge" />
  </Fragment>

  <!-- Make translations available for JavaScript functionality -->
  <script is:inline define:vars={{ clientTranslations }}>
    window.gameHomeTranslations = clientTranslations;
  </script>

  <main
    id="main-content"
    class="w-full max-w-7xl mx-auto min-h-screen flex flex-col contain-layout style paint p-4 md:p-6 sm:p-3"
    role="main"
    aria-labelledby="welcome-heading"
  >
    <!-- Hero section with improved semantics and accessibility -->
    <header
      class="relative overflow-hidden bg-gradient-to-br from-purple-900 via-purple-700 to-blue-800 shadow-2xl border border-purple-600 contain-layout style paint mb-6 md:mb-8 sm:mb-4 p-4 md:p-6 sm:p-3 rounded-xl"
      aria-labelledby="welcome-heading"
    >
      <!-- Decorative background elements with aria-hidden -->
      <div
        class="absolute inset-0 opacity-10 pointer-events-none contain-layout style paint"
        aria-hidden="true"
      >
        <div class="absolute -top-8 -right-8 w-24 h-24 rounded-full bg-white"></div>
        <div class="absolute -bottom-8 -left-8 w-48 h-48 rounded-full bg-white"></div>
        <div
          class="absolute top-1/2 -right-4 w-16 h-16 rounded-full bg-white transform -translate-y-1/2"
        >
        </div>
      </div>

      <div class="relative z-10 text-center text-white contain-layout style w-full">
        <Headline level="h1" textSize="3xl" textAlign="center">
          {t("game.welcome")}
        </Headline>
        <div class="bg-blue-400 rounded-full w-12 h-1 mx-auto my-8 contain-layout style paint">
        </div>
        <Paragraph textSize="lg" textAlign="center">
          {t("game.select")}
        </Paragraph>
        <!-- Additional descriptive content for SEO -->
        <Paragraph className="sr-only">
          {t("game.genre.selection.description")}
        </Paragraph>
      </div>
    </header>

    <section class="flex-grow contain-layout style" aria-labelledby="playlist-heading">
      <!-- Category Filter Dropdown -->
      <CategoryFilter
        categories={[
          { type: "decade", title: t("game.filter.decades") || "Decades", icon: "📅" },
          { type: "female", title: t("game.filter.female") || "Female Artists", icon: "👩‍🎤" },
          {
            type: "classic-rock",
            title: t("game.filter.classic-rock") || "Classic Rock & Hard Rock",
            icon: "🎸",
          },
          {
            type: "metal-classic",
            title: t("game.filter.metal-classic") || "Metal – Klassiker",
            icon: "⚡",
          },
          {
            type: "metal-modern",
            title: t("game.filter.metal-modern") || "Modern Metal",
            icon: "🔥",
          },
          {
            type: "metal-avantgarde",
            title: t("game.filter.metal-avantgarde") || "Avantgarde & Extreme Metal",
            icon: "🎭",
          },
          {
            type: "mainstream-pop",
            title: t("game.filter.mainstream-pop") || "Mainstream Pop",
            icon: "🎤",
          },
          {
            type: "indie-alternative",
            title: t("game.filter.indie-alternative") || "Indie & Alternative",
            icon: "🎶",
          },
          {
            type: "global-pop",
            title: t("game.filter.global-pop") || "Global Pop Scenes",
            icon: "🌏",
          },
          {
            type: "jazz-soul-funk",
            title: t("game.filter.jazz-soul-funk") || "Jazz, Soul & Funk",
            icon: "🎷",
          },
          {
            type: "hip-hop-rap",
            title: t("game.filter.hip-hop-rap") || "Hip Hop & Rap",
            icon: "🎤",
          },
          {
            type: "house-techno",
            title: t("game.filter.house-techno") || "House & Techno",
            icon: "🎛️",
          },
          { type: "club-sounds", title: t("game.filter.club-sounds") || "Club Sounds", icon: "🎚️" },
          {
            type: "breaks-experimental",
            title: t("game.filter.breaks-experimental") || "Breaks & Experimental",
            icon: "🌀",
          },
          { type: "latin-vibes", title: t("game.filter.latin-vibes") || "Latin Vibes", icon: "🎺" },
          {
            type: "caribbean-afro",
            title: t("game.filter.caribbean-afro") || "Caribbean & Afro",
            icon: "🌴",
          },
          {
            type: "folk-regional",
            title: t("game.filter.folk-regional") || "Folk & Regional",
            icon: "🪕",
          },
          {
            type: "classical-orchestral",
            title: t("game.filter.classical-orchestral") || "Classical & Orchestral",
            icon: "🎼",
          },
          {
            type: "countries-regional",
            title: t("game.filter.countries-regional") || "Countries & Regional",
            icon: "🌍",
          },
          {
            type: "emotional",
            title: t("game.filter.emotional") || "Emotional Genres",
            icon: "💫",
          },
          { type: "seasonal", title: t("game.filter.seasonal") || "Seasonal Genres", icon: "❄️" },
          {
            type: "situational",
            title: t("game.filter.situational") || "Situational & Activity-Based",
            icon: "🎉",
          },
          { type: "other", title: t("game.filter.other") || "Other Categories", icon: "📚" },
        ]}
        selectedValue="all"
      />

      <!-- Enhanced genre grid with semantic markup -->
      <div class="flex-grow contain-layout style">
        <Headline level="h2" textSize="base" className="sr-only">
          {t("game.categories.title")}
        </Headline>

        {
          categories && categories.length > 0 ? (
            <>
              {/* Dynamic Category Groups */}
              {(() => {
                const categoryGroups = [
                  { type: "decade", title: t("game.categories.decades") || "Decades", icon: "📅" },
                  {
                    type: "female",
                    title: t("game.categories.female") || "Female Artists",
                    icon: "👩‍🎤",
                  },
                  {
                    type: "classic-rock",
                    title: t("game.filter.classic-rock") || "Classic Rock & Hard Rock",
                    icon: "🎸",
                  },
                  {
                    type: "metal-classic",
                    title: t("game.filter.metal-classic") || "Metal – Classics",
                    icon: "⚡",
                  },
                  {
                    type: "metal-modern",
                    title: t("game.filter.metal-modern") || "Modern Metal",
                    icon: "🔥",
                  },
                  {
                    type: "metal-avantgarde",
                    title: t("game.filter.metal-avantgarde") || "Avantgarde & Extreme Metal",
                    icon: "🎭",
                  },
                  {
                    type: "mainstream-pop",
                    title: t("game.filter.mainstream-pop") || "Mainstream Pop",
                    icon: "🎤",
                  },
                  {
                    type: "indie-alternative",
                    title: t("game.filter.indie-alternative") || "Indie & Alternative",
                    icon: "🎶",
                  },
                  {
                    type: "global-pop",
                    title: t("game.filter.global-pop") || "Global Pop Scenes",
                    icon: "🌏",
                  },
                  {
                    type: "jazz-soul-funk",
                    title: t("game.filter.jazz-soul-funk") || "Jazz, Soul & Funk",
                    icon: "🎷",
                  },
                  {
                    type: "hip-hop-rap",
                    title: t("game.filter.hip-hop-rap") || "Hip Hop & Rap",
                    icon: "🎤",
                  },
                  {
                    type: "house-techno",
                    title: t("game.filter.house-techno") || "House & Techno",
                    icon: "🎛️",
                  },
                  {
                    type: "club-sounds",
                    title: t("game.filter.club-sounds") || "Club Sounds",
                    icon: "🎚️",
                  },
                  {
                    type: "breaks-experimental",
                    title: t("game.filter.breaks-experimental") || "Breaks & Experimental",
                    icon: "🌀",
                  },
                  {
                    type: "latin-vibes",
                    title: t("game.filter.latin-vibes") || "Latin Vibes",
                    icon: "🎺",
                  },
                  {
                    type: "caribbean-afro",
                    title: t("game.filter.caribbean-afro") || "Caribbean & Afro",
                    icon: "🌴",
                  },
                  {
                    type: "folk-regional",
                    title: t("game.filter.folk-regional") || "Folk & Regional",
                    icon: "🪕",
                  },
                  {
                    type: "classical-orchestral",
                    title: t("game.filter.classical-orchestral") || "Classical & Orchestral",
                    icon: "🎼",
                  },
                  {
                    type: "countries-regional",
                    title: t("game.filter.countries-regional") || "Countries & Regional",
                    icon: "🌍",
                  },
                  {
                    type: "emotional",
                    title: t("game.filter.emotional") || "Emotional Genres",
                    icon: "💫",
                  },
                  {
                    type: "seasonal",
                    title: t("game.filter.seasonal") || "Seasonal Genres",
                    icon: "❄️",
                  },
                  {
                    type: "situational",
                    title: t("game.filter.situational") || "Situational & Activity-Based",
                    icon: "🎉",
                  },
                  {
                    type: "other",
                    title: t("game.categories.other") || "Other Categories",
                    icon: "📚",
                  },
                ];

                return categoryGroups.map((group) => {
                  const groupCategories = sortedCategories.filter(
                    (cat) => cat.categoryType === group.type
                  );
                  if (groupCategories.length === 0) {
                    return null;
                  }

                  return (
                    <div class="mb-8" data-category-type={group.type}>
                      <h3 class="text-2xl md:text-3xl font-bold text-white mb-6 text-center md:text-left bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent px-4 py-2 rounded-lg bg-gray-800/20 backdrop-blur-sm border border-purple-500/30">
                        {group.icon} {group.title}
                      </h3>
                      <div
                        class="grid grid-cols-1 gap-4 md:gap-6 lg:gap-8 mb-8 contain-layout style paint sm:gap-3 sm:mb-6"
                        style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));"
                        role="list"
                        aria-label={t("game.genre.list")}
                        aria-live="polite"
                        itemscope
                        itemtype="https://schema.org/ItemList"
                      >
                        {groupCategories.map((category) => (
                          <PlaylistItem
                            headline={category.headline}
                            subheadline={category.introSubline}
                            image={category.imageUrl}
                            imageAlt={`${category.headline} music category`}
                            href={category.categoryUrl ? `/${lang}${category.categoryUrl}` : "#"}
                            isDisabled={!category.isPlayable}
                          />
                        ))}
                      </div>
                    </div>
                  );
                });
              })()}
            </>
          ) : (
            <div
              class="grid grid-cols-1 gap-4 md:gap-6 lg:gap-8 mb-8 contain-layout style paint sm:gap-3 sm:mb-6"
              style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));"
              role="list"
              aria-label={t("game.genre.list")}
              aria-live="polite"
              itemscope
              itemtype="https://schema.org/ItemList"
            >
              <EmptyState
                headline={emptyCategoriesHeadline}
                text={emptyCategoriesText}
                iconName="music-note"
                className="col-span-full"
              />
            </div>
          )
        }
      </div>

      <!-- Loading state for better UX -->
      <LoadingState text={t("game.categories.loading")} className="hidden" visible={false} />
    </section>
  </main>

  <!-- Back to Top Component for improved UX and accessibility -->
  <BackToTop {lang} />
</Layout>

---
/**
 * @component TimePressureGamePage
 * @description Renders a time pressure music trivia game page with mixed difficulty questions.
 * Features strict time limits, progressive scoring, and enhanced UI for urgency feedback.
 * This page implements full WCAG AAA accessibility standards.
 *
 * @prop {Object} categoryData - Data about the selected music category
 * @prop {string} categoryData.headline - Display name of the category
 * @prop {string} categoryData.slug - URL-safe identifier for the category
 * @prop {string} lang - Language code for the page content
 */
import { error as logError } from "../../utils/logging/logger";
import Layout from "@layouts/Layout.astro";
import FeedbackOverlay from "@components/Overlays/FeedbackOverlay.astro";
import EndOverlay from "@components/Overlays/EndOverlay.astro";
import LoadingSpinner from "@components/Game/LoadingSpinner.astro";

import { getLangFromUrl, useTranslations } from "@utils/i18n";
import { Icon } from "astro-icon/components";

// Server-side rendering for cookie-based authentication
export const prerender = false;

/**
 * Generates static paths for all supported languages and categories.
 * Time pressure mode doesn't use difficulty selection - all difficulties are mixed.
 * @returns {Array} Array of path objects with params and props
 */
export async function getStaticPaths() {
  // Define all supported languages for type safety
  const supportedLanguages = [
    "de",
    "en",
    "es",
    "fr",
    "it",
    "pt",
    "da",
    "nl",
    "sv",
    "fi",
    "cn",
    "ru",
    "jp",
    "uk",
  ] as const;

  const paths = [];

  for (const lang of supportedLanguages) {
    // Load categories based on language with proper fallback mechanism
    let categories;
    try {
      categories = await import(`@json/${lang}_categories.json`);
    } catch {
      // Fallback to default language if the specific language file doesn't exist
      categories = await import(`@json/en_categories.json`);
    }

    // Create a path for each category (no difficulty needed for time pressure)
    for (const categoryData of categories.default) {
      paths.push({
        params: {
          lang,
          category: categoryData.slug,
        },
        props: {
          categoryData,
          lang,
        },
      });
    }
  }

  return paths;
}

// Types for route props
interface Props {
  categoryData: {
    headline: string;
    slug: string;
  };
  lang: string;
}

// Extract props and URL parameters
const { categoryData: propsCategoryData } = Astro.props;
const lang = String(getLangFromUrl(Astro.url));
const t = useTranslations(lang);

// Guest session for game play
const guestId = `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
const authResult = {
  authenticated: true,
  user: { id: guestId, email: "guest@melodymind.app" },
};

const { category } = Astro.params;

// Fallback mechanism for category data if props are not available
let categoryData = propsCategoryData;
if (!categoryData && category) {
  try {
    // Try to load category data dynamically
    const categories = await import(`@json/${lang}_categories.json`);
    const foundCategory = categories.default.find((cat: { slug: string }) => cat.slug === category);

    if (foundCategory) {
      categoryData = {
        headline: foundCategory.headline,
        slug: foundCategory.slug,
      };
    } else {
      // Try English fallback
      const enCategories = await import(`@json/en_categories.json`);
      const enFoundCategory = enCategories.default.find(
        (cat: { slug: string }) => cat.slug === category
      );

      if (enFoundCategory) {
        categoryData = {
          headline: enFoundCategory.headline,
          slug: enFoundCategory.slug,
        };
      }
    }

    if (!categoryData) {
      // Provide a fallback category data
      categoryData = {
        headline: category || "Unknown Category",
        slug: category || "unknown",
      };
    }
  } catch (error) {
    logError("Failed to load category data", error);
    // Provide a fallback category data
    categoryData = {
      headline: category || "Unknown Category",
      slug: category || "unknown",
    };
  }
}

// Page metadata and SEO
const gameTitle = `${t("game.timepressure.title")} - ${categoryData.headline}`;
const gameDescription = t("game.timepressure.description").replace(
  "{category}",
  categoryData.headline
);

// Enhanced structured data for time pressure mode
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Game",
  name: gameTitle,
  description: gameDescription,
  genre: "Music Trivia",
  gameLocation: "Online",
  applicationCategory: "Game",
  operatingSystem: "Web Browser",
  isAccessibleForFree: true,
  inLanguage: lang,
  offers: {
    "@type": "Offer",
    price: "0",
    priceCurrency: "EUR",
  },
  aggregateRating: {
    "@type": "AggregateRating",
    ratingValue: "4.8",
    ratingCount: "150",
  },
};
---

<Layout
  title={gameTitle}
  description={gameDescription}
  keywords={`${t("meta.keywords")}, time pressure, speed game`}
  image={`/og-images/social-share-time-pressure-${category}-${lang}.jpg`}
  type="website"
  showHeader={false}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
    <meta name="robots" content="noindex, nofollow" />
  </Fragment>

  <main
    class="relative flex min-h-screen flex-col bg-gray-900 text-white"
    id="game-container"
    aria-live="polite"
    data-userID={authResult.user?.id || "guest"}
    data-categoryName={categoryData?.headline}
    data-genre={String(category)}
  >
    {/* Screen Reader Only Game Instructions */}
    <div class="sr-only" id="game-instructions">
      <h1>{gameTitle}</h1>
      <p>{t("game.timepressure.instructions")}</p>
      <p>{t("game.timepressure.controls")}</p>
    </div>

    {/* Loading State */}
    <div
      id="loading-container"
      class="flex min-h-screen items-center justify-center"
      aria-label={t("game.loading")}
    >
      <LoadingSpinner label={t("game.loading.questions")} />
    </div>

    {/* Game UI Container */}
    <div
      id="game-ui"
      class="mx-auto flex w-full max-w-6xl flex-1 flex-col p-4"
      style="display: none;"
      aria-labelledby="question-text"
    >
      {/* Time Pressure Header */}
      <header
        class="relative mb-6 overflow-hidden rounded-2xl bg-gradient-to-br from-purple-600 to-blue-600 p-4 shadow-2xl"
      >
        <div class="relative z-10">
          <div class="mb-4 grid grid-cols-2 gap-2 md:mb-6 md:grid-cols-4 md:gap-4">
            <div
              class="flex flex-col items-center rounded-lg border border-white/20 bg-white/15 p-2 text-center shadow-lg backdrop-blur-md"
            >
              <Icon name="target" class="mb-1 h-5 w-5 text-white/90" aria-hidden="true" />
              <span class="mb-1 text-xs font-medium tracking-wider text-white/80 uppercase"
                >{t("game.score")}</span
              >
              <span id="score-display" class="text-lg font-bold text-white drop-shadow-sm">0</span>
            </div>

            <div
              class="flex flex-col items-center rounded-lg border border-white/20 bg-white/15 p-2 text-center shadow-lg backdrop-blur-md"
            >
              <Icon name="zap" class="mb-1 h-5 w-5 text-white/90" aria-hidden="true" />
              <span class="mb-1 text-xs font-medium tracking-wider text-white/80 uppercase"
                >{t("game.timepressure.streak")}</span
              >
              <span id="streak-display" class="text-lg font-bold text-white drop-shadow-sm">0</span>
            </div>

            <div
              class="flex flex-col items-center rounded-lg border border-white/20 bg-white/15 p-2 text-center shadow-lg backdrop-blur-md"
            >
              <Icon name="percent" class="mb-1 h-5 w-5 text-white/90" aria-hidden="true" />
              <span class="mb-1 text-xs font-medium tracking-wider text-white/80 uppercase"
                >{t("game.accuracy")}</span
              >
              <span id="accuracy-display" class="text-lg font-bold text-white drop-shadow-sm"
                >0%</span
              >
            </div>

            <div
              class="relative flex flex-col items-center rounded-lg border border-white/20 bg-white/15 p-2 text-center shadow-lg backdrop-blur-md"
            >
              <div
                id="countdown-circle"
                class="relative mb-1 h-7 w-7"
                role="timer"
                aria-label={t("game.timepressure.countdown")}
              >
                <svg class="absolute inset-0 h-full w-full -rotate-90" viewBox="0 0 40 40">
                  <circle cx="20" cy="20" r="18" class="fill-none stroke-white/30 stroke-2"
                  ></circle>
                  <circle
                    id="countdown-progress"
                    cx="20"
                    cy="20"
                    r="18"
                    class="stroke-linecap-round stroke-dasharray-113 stroke-dashoffset-113 fill-none stroke-white stroke-2 drop-shadow-sm transition-all duration-300"
                  ></circle>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span
                    id="countdown-time"
                    class="text-xs leading-none font-bold text-white drop-shadow-sm">0</span
                  >
                </div>
              </div>
              <span class="mb-1 text-xs font-medium tracking-wider text-white/80 uppercase"
                >{t("game.timepressure.seconds")}</span
              >
              <div id="difficulty-indicator" class="mt-1">
                <span
                  id="difficulty-text"
                  class="text-xs font-medium tracking-wider text-white/80 uppercase"></span>
              </div>
            </div>
          </div>

          <div class="mb-4 flex items-center gap-4">
            <div
              class="relative h-1.5 flex-1 overflow-hidden rounded-full bg-white/20 shadow-inner"
            >
              <div
                id="progress-fill"
                class="relative h-full rounded-full bg-gradient-to-r from-white to-white/80 shadow-sm transition-all duration-300 ease-out"
                role="progressbar"
                aria-valuenow="0"
                aria-valuemin="0"
                aria-valuemax="100"
              >
              </div>
            </div>
            <span class="text-xs font-medium whitespace-nowrap text-white/90 drop-shadow-sm">
              <span id="current-round">1</span> / <span id="total-rounds">20</span>
            </span>
          </div>
        </div>
      </header>

      {/* Question Display */}
      <div
        class="relative mb-8 overflow-hidden rounded-2xl bg-gradient-to-br from-gray-800 to-gray-700 p-6 text-center shadow-2xl"
      >
        <div
          id="question-text"
          class="relative z-10 mb-6 text-lg leading-relaxed font-semibold text-white drop-shadow-sm"
          aria-live="assertive"
        >
        </div>
        <div id="question-image" class="mx-auto my-8 max-w-xs" style="display: none;">
          <img
            id="question-img"
            alt=""
            loading="lazy"
            class="h-auto w-full rounded-2xl shadow-lg"
          />
        </div>
      </div>

      {/* Answer Options */}
      <div
        id="answer-options"
        class="mb-8 grid grid-cols-1 gap-3 md:mb-12 md:grid-cols-2 md:gap-4"
        role="radiogroup"
        aria-labelledby="question-text"
      >
        {/* Answer buttons will be dynamically generated */}
      </div>

      {/* Game Controls */}
      <div class="mt-auto flex flex-col justify-center gap-3 p-4 md:flex-row md:gap-6 md:p-6">
        <button
          type="button"
          id="pause-btn"
          class="relative flex min-h-[44px] cursor-pointer items-center justify-center gap-3 overflow-hidden rounded-lg border-2 border-gray-500 bg-gradient-to-br from-gray-700 to-gray-600 px-4 py-3 text-sm font-semibold whitespace-nowrap text-white shadow-lg transition-all duration-300"
          aria-label={t("game.pause")}
        >
          <span class="icon flex flex-shrink-0 items-center justify-center">
            <Icon name="pause" class="h-4 w-4" aria-hidden="true" />
          </span>
          <span class="text text-sm font-semibold">{t("game.pause")}</span>
        </button>

        <button
          type="button"
          id="skip-btn"
          class="relative flex min-h-[44px] cursor-pointer items-center justify-center gap-3 overflow-hidden rounded-lg border-2 border-gray-500 bg-gradient-to-br from-gray-700 to-gray-600 px-4 py-3 text-sm font-semibold whitespace-nowrap text-white shadow-lg transition-all duration-300"
          aria-label={t("game.timepressure.skip")}
        >
          <span class="icon flex flex-shrink-0 items-center justify-center">
            <Icon name="skip-forward" class="h-4 w-4" aria-hidden="true" />
          </span>
          <span class="text text-sm font-semibold">{t("game.timepressure.skip")}</span>
          <span id="skip-cost" class="ml-1 text-xs opacity-80">(-10 pts)</span>
        </button>
      </div>
    </div>

    {/* Overlays */}
    <FeedbackOverlay buttonId="time-pressure-next-round-button" />
    <EndOverlay
      id="endgame-popup"
      data-score="0"
      data-category={category}
      data-categoryName={categoryData.headline}
      data-difficulty="mixed"
      data-mode="time-pressure"
    />
  </main>
</Layout>

<!-- Time Pressure Game Engine Script -->
<script>
  import { initTimePressureGameAuto } from "../../utils/components/timePressureGameInitUtils";

  // Initialize Time Pressure Game
  initTimePressureGameAuto();
</script>

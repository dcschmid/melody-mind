---
/**
 * @component ChronologyGamePage
 * @description Moderne Chronologie-Spielseite für das MelodyMind-Projekt
 *
 * Funktionen:
 * - Schwierigkeitsgrade (Easy: 4 Alben, Medium: 5 Alben, Hard: 6 Alben)
 * - Intuitive Buttons zum Verschieben der Elemente
 * - Vollständige Tastatursteuerung
 * - Punkteberechnung basierend auf korrekter Reihenfolge
 * - Lösungsoverlay nach jeder Runde
 * - Endoverlay mit Gesamtergebnis
 * - Modernes, ansprechendes Design mit CSS-Variablen
 * - Datenbank-Speicherung der Spielergebnisse
 */

// 1. Imports
import Layout from "@layouts/Layout.astro";
import EndOverlay from "@components/Overlays/EndOverlay.astro";
import LoadingSpinner from "@components/Game/LoadingSpinner.astro";
import ChronologyFeedbackOverlay from "@components/Overlays/ChronologyFeedbackOverlay.astro";
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import { Icon } from "astro-icon/components";
import { requireAuth } from "../../../middleware/auth.js";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";

// Server-side rendering for cookie-based authentication
export const prerender = false;

/**
 * Generiert statische Pfade für alle unterstützten Sprachen, Kategorien und Schwierigkeitsgrade
 */
export async function getStaticPaths() {
  const supportedLanguages = [
    "de",
    "en",
    "es",
    "fr",
    "it",
    "pt",
    "da",
    "nl",
    "sv",
    "fi",
    "cn",
    "ru",
    "jp",
    "uk",
  ] as const;
  const difficultyLevels = ["easy", "medium", "hard"] as const;
  const paths = [];

  for (const lang of supportedLanguages) {
    let categories;
    try {
      categories = await import(`@json/${lang}_categories.json`);
    } catch {
      categories = await import(`@json/en_categories.json`);
    }

    for (const categoryData of categories.default) {
      for (const difficulty of difficultyLevels) {
        paths.push({
          params: { lang, category: categoryData.slug, difficulty },
          props: { categoryData, lang },
        });
      }
    }
  }

  return paths;
}

// 2. Props und Parameter verarbeitung
interface Props {
  categoryData: { headline: string; slug: string };
  lang: string;
}

const { categoryData } = Astro.props;
const lang = getLangFromUrl(Astro.url) as string;
const t = useTranslations(lang);
const { category, difficulty } = Astro.params;

// 3. Authentifizierung prüfen
// Check if Astro.request is available (for SSR compatibility)
let authResult: { authenticated: boolean; user?: { id: string; email: string } } = {
  authenticated: false,
  user: undefined,
};

if (Astro.request) {
  authResult = await requireAuth(Astro.request);
}
const user = { id: authResult.user?.id || "guest" };

// 4. Meta-Daten für SEO
const metaDescription = `${t("game.chronology.title")} - ${categoryData?.headline} (${t(`difficulty.${difficulty}`)})`;
---

<Layout
  title={`${t("game.chronology.title")} - ${categoryData?.headline}`}
  description={metaDescription}
  showHeader={false}
  showCoins={false}
>
  <!-- Feedback- und End-Overlays -->
  <ChronologyFeedbackOverlay />
  <EndOverlay
    id="endgame-popup"
    data-score="0"
    data-category={category || ""}
    data-difficulty={difficulty || ""}
    data-mode="chronology"
  />

  <!-- Loading Spinner -->
  <LoadingSpinner />

  <!-- Spielbereich -->
  <main
    id="chronology-container"
    class="chronology-game"
    data-category={category}
    data-difficulty={difficulty}
    data-user-id={user.id}
    data-category-name={categoryData?.headline || category || ""}
    aria-label={t("game.chronology.aria.main")}
  >
    <!-- Game Header -->
    <header class="game-header">
      <!-- Game Info Badges -->
      <div class="game-info" role="banner" aria-label={t("game.chronology.info.aria")}>
        <div class="badge">
          <Icon name="trophy" class="badge__icon" />
          <span class="badge__text" id="score-display">0</span>
        </div>
        <div class="badge">
          <Icon name="target" class="badge__icon" />
          <span class="badge__text">
            <span id="round-display">1</span>/10
          </span>
        </div>
        <div class="badge">
          <Icon name="gauge" class="badge__icon" />
          <span class="badge__text">{t(`difficulty.${difficulty}`)}</span>
        </div>
      </div>
    </header>

    <!-- Game Content -->
    <div class="game-content">
      <Headline level="h1" size="xl" textAlign="center" className="game-title"
        >{t("game.chronology.sort.albums")}</Headline
      >
      <Paragraph textSize="lg" align="center" className="game-description"
        >{t("game.chronology.instructions")}</Paragraph
      >

      <!-- Chronology Container -->
      <div id="chronology-items-container" class="chronology-container">
        <div class="loading-placeholder">
          <Icon name="loader" class="loading-icon" />
          <Paragraph>{t("loading.albums")}</Paragraph>
        </div>
      </div>

      <!-- Game Controls -->
      <div class="game-controls">
        <!-- Move Buttons -->
        <div class="move-buttons">
          <button
            id="move-up-btn"
            type="button"
            class="move-button"
            disabled
            aria-label={t("game.move.up.aria")}
          >
            <Icon name="chevron-up" class="move-button__icon" />
            {t("game.move.up")}
          </button>
          <button
            id="move-down-btn"
            type="button"
            class="move-button"
            disabled
            aria-label={t("game.move.down.aria")}
          >
            <Icon name="chevron-down" class="move-button__icon" />
            {t("game.move.down")}
          </button>
        </div>

        <!-- Submit Button -->
        <button
          id="submit-btn"
          type="button"
          class="submit-button"
          disabled
          aria-label={t("game.submit.answer.aria")}
        >
          <Icon name="check" class="submit-button__icon" />
          {t("game.submit.answer")}
        </button>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Import chronology game engine
  import "../../../utils/game/chronologyGameEngine.ts";
</script>

<style lang="scss" is:global>
  /* ======================================
   * CHRONOLOGY GAME STYLES - OPTIMIZED FOR STYLE GUARDIAN
   * BEM Methodology + Global Variables + Mobile-First
   * ====================================== */

  .chronology-game {
    min-height: 100vh;
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: var(--space-xs); // Mobile: minimal horizontal spacing
    max-width: var(--container-xl);
    margin: 0 auto;
    contain: layout style paint;
  }

  /* ======================================
   * GAME HEADER
   * ====================================== */
  .game-header {
    margin-bottom: var(--space-md);
    text-align: center;
    contain: layout style;
  }

  .game-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    margin-top: var(--space-sm);
    flex-wrap: wrap;
    contain: layout style;
  }

  .badge {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    background: var(--bg-secondary);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-md);
    border: var(--border-width-thin) solid var(--border-secondary);
    transition: all var(--transition-base);
    min-width: var(--stat-width-sm);
    contain: layout style paint;

    &__icon {
      width: var(--icon-size-sm);
      height: var(--icon-size-sm);
      color: var(--interactive-primary);
      flex-shrink: 0;
      contain: layout style paint;
    }

    &__text {
      font-weight: var(--font-medium);
      font-size: var(--text-md);
      white-space: nowrap;
      min-width: var(--coin-number-min-width);
      contain: layout style;
    }
  }

  /* ======================================
   * GAME CONTENT
   * ====================================== */
  .game-content {
    max-width: var(--container-md);
    margin: 0 auto;
    width: var(--width-full);
    contain: layout style;
  }

  /* ======================================
   * CHRONOLOGY CONTAINER
   * ====================================== */
  .chronology-container {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    margin-bottom: var(--space-md);
    border: var(--border-width-thin) solid var(--card-border);
    min-height: var(--container-intrinsic-height-card);
    position: relative;
    box-shadow: var(--card-shadow);
    contain: layout style paint;
  }

  .loading-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    height: var(--container-intrinsic-height-component);
    color: var(--text-secondary);
    text-align: center;
    contain: layout style;

    p {
      margin-top: var(--space-sm);
      font-size: var(--text-sm);
      contain: layout style;
    }
  }

  .loading-icon {
    width: var(--icon-size-md);
    height: var(--icon-size-md);
    margin-bottom: var(--space-sm);
    animation: spin var(--animation-pulse-duration) linear infinite;
    color: var(--interactive-primary);
    contain: layout style paint;
  }

  /* ======================================
   * CHRONOLOGY ITEMS
   * ====================================== */
  .chronology-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    background: var(--card-bg);
    border: var(--border-width-thick) solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-sm);
    margin-bottom: var(--space-sm);
    cursor: pointer;
    transition: all var(--transition-base);
    position: relative;
    box-shadow: var(--card-shadow);
    contain: layout style paint;
    min-height: var(--touch-target-standard);

    &:last-child {
      margin-bottom: 0;
    }

    &:hover {
      border-color: var(--interactive-primary);
      box-shadow: var(--card-shadow-hover);
    }

    &:focus {
      outline: none;
      border-color: var(--interactive-primary);
      box-shadow: var(--focus-ring);
    }

    &:focus-visible {
      outline: 3px solid var(--interactive-primary);
      outline-offset: 2px;
    }

    &--selected {
      border-color: var(--interactive-primary);
      background: var(--bg-tertiary);
      box-shadow: var(--card-shadow-hover);

      .chronology-item__position {
        background: var(--interactive-secondary);
      }
    }

    &__position {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--interactive-primary);
      color: var(--color-white);
      border-radius: var(--radius-full);
      font-weight: var(--font-bold);
      font-size: var(--text-base);
      flex-shrink: 0;
      transition: all var(--transition-base);
      border: var(--border-width-thin) solid transparent;
      contain: layout style paint;
    }

    &__content {
      flex: 1;
      min-width: 0;
      contain: layout style;
    }

    &__title {
      font-weight: var(--font-semibold);
      font-size: var(--text-lg);
      margin-bottom: var(--space-micro);
      color: var(--text-primary);
      line-height: var(--leading-tight);
      contain: layout style;
    }

    &__artist {
      color: var(--text-secondary);
      font-size: var(--text-xs);
      line-height: var(--leading-normal);
      font-weight: var(--font-normal);
      contain: layout style;
    }
  }

  /* ======================================
   * GAME CONTROLS
   * ====================================== */
  .game-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: var(--space-md);
    width: var(--width-full);
    max-width: var(--container-sm);
    margin: 0 auto;
    padding: var(--space-lg);
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.1) 0%,
      rgba(255, 255, 255, 0.05) 100%
    );
    backdrop-filter: blur(var(--backdrop-blur)) saturate(180%);
    border-radius: var(--radius-xl);
    border: var(--border-width-thin) solid rgba(255, 255, 255, 0.2);
    box-shadow: var(--shadow-xl);
    contain: layout style paint;
  }

  .move-buttons {
    display: flex;
    gap: var(--space-sm);
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    width: var(--width-full);
    contain: layout style;
  }

  .move-button {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    background: var(--bg-secondary);
    border: var(--border-width-thick) solid var(--border-secondary);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    padding: var(--space-sm) var(--space-md);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-base);
    justify-content: center;
    min-width: var(--grid-min-width-sm);
    text-align: center;
    min-height: var(--touch-target-standard);
    font-size: var(--text-sm);
    contain: layout style paint;

    &:not(:disabled):hover {
      background: var(--interactive-primary);
      color: var(--color-white);
      box-shadow: var(--card-shadow-hover);
    }

    &:not(:disabled):active {
      box-shadow: var(--shadow-sm);
    }

    &:disabled {
      background: var(--bg-tertiary);
      color: var(--text-disabled);
      opacity: var(--opacity-disabled);
      cursor: not-allowed;
    }

    &:focus {
      outline: var(--focus-ring);
      outline-offset: var(--focus-ring-offset);
    }

    &__icon {
      width: var(--icon-size-sm);
      height: var(--icon-size-sm);
      flex-shrink: 0;
      contain: layout style paint;
    }
  }

  .submit-button {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    background: var(--btn-primary-bg);
    border: none;
    border-radius: var(--radius-md);
    color: var(--btn-primary-text);
    padding: var(--space-sm) var(--space-lg);
    font-weight: var(--font-semibold);
    font-size: var(--text-base);
    cursor: pointer;
    transition: all var(--transition-base);
    justify-content: center;
    min-width: var(--grid-min-width-md);
    text-align: center;
    min-height: var(--touch-target-standard);
    box-shadow: var(--shadow-md);
    contain: layout style paint;

    &:not(:disabled):hover {
      background: var(--btn-primary-hover);
      box-shadow: var(--card-shadow-hover);
    }

    &:not(:disabled):active {
      box-shadow: var(--shadow-sm);
    }

    &:disabled {
      opacity: var(--opacity-disabled);
      cursor: not-allowed;
    }

    &:focus {
      outline: var(--focus-ring);
      outline-offset: var(--focus-ring-offset);
    }

    &__icon {
      width: var(--icon-size-md);
      height: var(--icon-size-md);
      flex-shrink: 0;
      contain: layout style paint;
    }
  }

  /* ======================================
   * ANIMATIONS
   * ====================================== */
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* ======================================
   * FOCUS STYLES
   * ====================================== */
  :focus {
    outline: var(--focus-ring);
    outline-offset: var(--focus-ring-offset);

    &:not(:focus-visible) {
      outline: none;
    }
  }

  :focus-visible {
    outline: var(--focus-ring);
    outline-offset: var(--focus-ring-offset);
  }
</style>

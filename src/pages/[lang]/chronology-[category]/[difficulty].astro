---
/**
 * @component ChronologyGamePage
 * @description Moderne Chronologie-Spielseite für das MelodyMind-Projekt
 *
 * Funktionen:
 * - Schwierigkeitsgrade (Easy: 4 Alben, Medium: 5 Alben, Hard: 6 Alben)
 * - Intuitive Buttons zum Verschieben der Elemente
 * - Vollständige Tastatursteuerung
 * - Punkteberechnung basierend auf korrekter Reihenfolge
 * - Lösungsoverlay nach jeder Runde
 * - Endoverlay mit Gesamtergebnis
 * - Modernes, ansprechendes Design mit CSS-Variablen
 * - Datenbank-Speicherung der Spielergebnisse
 */

// 1. Imports
import Layout from "@layouts/Layout.astro";
import EndOverlay from "@components/Overlays/EndOverlay.astro";
import ChronologyFeedbackOverlay from "@components/Overlays/ChronologyFeedbackOverlay.astro";
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import { Icon } from "astro-icon/components";

import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";

// Server-side rendering for cookie-based authentication
export const prerender = false;

/**
 * Generiert statische Pfade für alle unterstützten Sprachen, Kategorien und Schwierigkeitsgrade
 */
export async function getStaticPaths() {
  const supportedLanguages = [
    "de",
    "en",
    "es",
    "fr",
    "it",
    "pt",
    "da",
    "nl",
    "sv",
    "fi",
    "cn",
    "ru",
    "jp",
    "uk",
  ] as const;
  const difficultyLevels = ["easy", "medium", "hard"] as const;
  const paths = [];

  for (const lang of supportedLanguages) {
    let categories;
    try {
      categories = await import(`@json/${lang}_categories.json`);
    } catch {
      categories = await import(`@json/en_categories.json`);
    }

    for (const categoryData of categories.default) {
      for (const difficulty of difficultyLevels) {
        paths.push({
          params: { lang, category: categoryData.slug, difficulty },
          props: { categoryData, lang },
        });
      }
    }
  }

  return paths;
}

// 2. Props und Parameter verarbeitung
interface Props {
  categoryData: { headline: string; slug: string };
  lang: string;
}

const { categoryData } = Astro.props;
const lang = getLangFromUrl(Astro.url) as string;
const t = useTranslations(lang);
const { category, difficulty } = Astro.params;

// 3. Authentifizierung prüfen
// Check if Astro.request is available (for SSR compatibility)
let authResult: { authenticated: boolean; user?: { id: string; email: string } } = {
  authenticated: false,
  user: undefined,
};

const guestId = `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
authResult = {
  authenticated: true,
  user: { id: guestId, email: "guest@melodymind.app" },
};
const user = { id: authResult.user?.id || "guest" };

// 4. Meta-Daten für SEO
const metaDescription = `${t("game.chronology.title")} - ${categoryData?.headline} (${t(`difficulty.${difficulty}`)})`;
---

<Layout
  title={`${t("game.chronology.title")} - ${categoryData?.headline}`}
  description={metaDescription}
  showHeader={false}
  showCoins={false}
>
  <!-- Feedback- und End-Overlays -->
  <ChronologyFeedbackOverlay />
  <EndOverlay
    id="endgame-popup"
    data-score="0"
    data-category={category || ""}
    data-difficulty={difficulty || ""}
    data-mode="chronology"
  />

  <!-- Spielbereich -->
  <main
    id="chronology-container"
    class="min-h-screen bg-slate-900 text-white p-4 max-w-7xl mx-auto"
    data-category={category}
    data-difficulty={difficulty}
    data-user-id={user.id}
    data-category-name={categoryData?.headline || category || ""}
    aria-label={t("game.chronology.aria.main")}
  >
    <!-- Game Header -->
    <header class="mb-6 text-center">
      <!-- Game Info Badges -->
      <div
        class="flex items-center justify-center gap-3 mt-3 flex-wrap"
        role="banner"
        aria-label={t("game.chronology.info.aria")}
      >
        <div
          class="flex items-center justify-center gap-3 bg-slate-700 px-3 py-2 rounded-lg border border-slate-600 transition-all duration-200 min-w-24"
        >
          <Icon name="trophy" class="w-5 h-5 text-blue-500 flex-shrink-0" />
          <span class="font-medium text-base whitespace-nowrap min-w-16" id="score-display">0</span>
        </div>
        <div
          class="flex items-center justify-center gap-3 bg-slate-700 px-3 py-2 rounded-lg border border-slate-600 transition-all duration-200 min-w-24"
        >
          <Icon name="target" class="w-5 h-5 text-blue-500 flex-shrink-0" />
          <span class="font-medium text-base whitespace-nowrap min-w-16">
            <span id="round-display">1</span>/10
          </span>
        </div>
        <div
          class="flex items-center justify-center gap-3 bg-slate-700 px-3 py-2 rounded-lg border border-slate-600 transition-all duration-200 min-w-24"
        >
          <Icon name="gauge" class="w-5 h-5 text-blue-500 flex-shrink-0" />
          <span class="font-medium text-base whitespace-nowrap min-w-16"
            >{t(`difficulty.${difficulty}`)}</span
          >
        </div>
      </div>
    </header>

    <!-- Game Content -->
    <div class="max-w-4xl mx-auto w-full">
      <Headline
        level="h1"
        textSize="xl"
        textAlign="center"
        className="text-3xl font-bold text-center mb-6 text-white"
        >{t("game.chronology.sort.albums")}</Headline
      >
      <Paragraph textSize="lg" textAlign="center" className="text-lg text-center mb-8 text-gray-300"
        >{t("game.chronology.instructions")}</Paragraph
      >

      <!-- Chronology Container -->
      <div
        id="chronology-items-container"
        class="bg-slate-800/50 rounded-2xl p-6 mb-6 border border-slate-600/30 min-h-96 relative shadow-xl backdrop-blur-sm"
      >
        <div class="flex items-center justify-center flex-col h-80 text-gray-400 text-center">
          <div
            class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"
          >
          </div>
          <Paragraph className="text-gray-400">{t("loading.albums")}</Paragraph>
        </div>
      </div>

      <!-- Game Controls -->
      <div
        class="flex items-center justify-center flex-col gap-8 w-full max-w-2xl mx-auto p-8 bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-md rounded-3xl border border-slate-600/50 shadow-2xl"
      >
        <!-- Move Buttons -->
        <div class="flex gap-4 justify-center items-center w-full">
          <button
            id="move-up-btn"
            type="button"
            class="group flex items-center gap-3 bg-gradient-to-r from-slate-700 to-slate-800 border-2 border-slate-600 rounded-xl text-white px-6 py-4 font-semibold cursor-pointer transition-all duration-300 justify-center min-w-36 text-center min-h-14 text-base hover:from-blue-600 hover:to-blue-700 hover:border-blue-500 hover:text-white hover:shadow-xl hover:-translate-y-1 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-900 disabled:from-slate-800 disabled:to-slate-900 disabled:text-gray-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none disabled:hover:shadow-none"
            disabled
            aria-label={t("game.move.up.aria")}
          >
            <Icon
              name="chevron-up"
              class="w-6 h-6 flex-shrink-0 group-hover:scale-110 transition-transform duration-200"
            />
            {t("game.move.up")}
          </button>
          <button
            id="move-down-btn"
            type="button"
            class="group flex items-center gap-3 bg-gradient-to-r from-slate-700 to-slate-800 border-2 border-slate-600 rounded-xl text-white px-6 py-4 font-semibold cursor-pointer transition-all duration-300 justify-center min-w-36 text-center min-h-14 text-base hover:from-blue-600 hover:to-blue-700 hover:border-blue-500 hover:text-white hover:shadow-xl hover:-translate-y-1 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-900 disabled:from-slate-800 disabled:to-slate-900 disabled:text-gray-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none disabled:hover:shadow-none"
            disabled
            aria-label={t("game.move.down.aria")}
          >
            <Icon
              name="chevron-down"
              class="w-6 h-6 flex-shrink-0 group-hover:scale-110 transition-transform duration-200"
            />
            {t("game.move.down")}
          </button>
        </div>

        <!-- Submit Button -->
        <button
          id="submit-btn"
          type="button"
          class="group flex items-center gap-4 bg-gradient-to-r from-blue-600 via-blue-700 to-blue-800 border-none rounded-2xl text-white px-8 py-5 font-bold text-lg cursor-pointer transition-all duration-300 justify-center min-w-48 text-center min-h-16 shadow-2xl hover:from-blue-700 hover:via-blue-800 hover:to-blue-900 hover:shadow-blue-500/25 hover:-translate-y-2 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500/50 focus:ring-offset-2 focus:ring-offset-slate-900 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none disabled:hover:shadow-none"
          disabled
          aria-label={t("game.submit.answer.aria")}
        >
          <Icon
            name="check"
            class="w-7 h-7 flex-shrink-0 group-hover:scale-110 transition-transform duration-200"
          />
          {t("game.submit.answer")}
        </button>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Import chronology game engine
  import "../../../utils/game/chronologyGameEngine.ts";
</script>

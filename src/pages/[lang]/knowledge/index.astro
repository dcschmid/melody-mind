---
/**
 * Knowledge Index Page Component
 *
 * This page displays a searchable and filterable grid of knowledge articles.
 * It's pre-rendered at build time for all supported languages to optimize performance.
 *
 * Accessibility Features:
 * - Semantic HTML with proper ARIA attributes (WCAG AAA compliance)
 * - High contrast text with 7:1 ratio for normal text
 * - Keyboard navigation between articles with arrow keys
 * - Screen reader announcements for search results
 * - Focus management for interactive elements
 * - Reduced motion support for animations
 *
 * Performance Optimizations:
 * - Static pre-rendering (SSG) for fast initial load
 * - Debounced search with batch processing for smooth UI
 * - Efficient DOM updates with requestAnimationFrame
 * - Optimized image loading with responsive sizes
 * - Touch interaction optimizations for mobile devices
 */
import type { AnyCollectionEntry, KnowledgeLanguage } from "astro:content";
import { getCollection } from "astro:content";
import KnowledgeCard from "@components/KnowledgeCard.astro";
import Layout from "@layouts/Layout.astro";
import { ui } from "../../../i18n/ui";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";
import { Icon } from "astro-icon/components";
import { calculateReadingTime } from "@utils/readingTime";
import { extractKeywords, generateMetaDescription } from "@utils/seo";

// Mark this route for static generation (SSG)
export const prerender = true;

/**
 * Generates static paths for all supported languages
 * This ensures fast page loads as everything is pre-rendered at build time
 * @returns {Array} Array of path objects with params and props
 */
export async function getStaticPaths() {
  // Define all supported languages for type safety
  const supportedLanguages = ["de", "en", "es", "fr", "it", "pt", "da", "nl", "sv", "fi"] as const;

  // Process each language to generate static paths
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const collectionName = `knowledge-${lang}` as const;
      const articles = await getCollection(collectionName);

      // Extract and deduplicate keywords for filtering
      const allKeywords = [
        ...new Set(articles.flatMap((article) => article.data.keywords || [])),
      ].sort();

      return {
        params: { lang },
        props: { articles, allKeywords },
      };
    })
  );

  return paths;
}

/**
 * Props interface for the Knowledge Index page
 */
interface Props {
  articles: AnyCollectionEntry[];
}

// Get language from URL params and props from getStaticPaths
const { lang } = Astro.params as { lang: KnowledgeLanguage };
const { articles } = Astro.props;

/**
 * Type guard to check if language is a valid UI language
 * @param {KnowledgeLanguage} lang - The language code to check
 * @returns {boolean} True if language is supported in UI
 */
const isUiLanguage = (lang: KnowledgeLanguage): lang is keyof typeof ui => {
  return Object.keys(ui).includes(lang);
};

// Use English as fallback if language is not supported
const uiLang = isUiLanguage(lang) ? lang : "en";

// Calculate reading time for articles if not already provided
const articlesWithReadingTime = articles.map((article) => {
  if (article.data.readingTime === undefined) {
    const articleContent = article.body || article.data.description || "";
    const estimatedTime = calculateReadingTime(articleContent);

    return {
      ...article,
      data: {
        ...article.data,
        readingTime: estimatedTime,
      },
    };
  }
  return article;
});

// Sort articles alphabetically by image path for consistent ordering
const sortedArticles = [...articlesWithReadingTime].sort((a, b) =>
  (a.data.image || "").localeCompare(b.data.image || "", undefined, {
    sensitivity: "base",
  })
);

// Generate SEO content
const title = ui[uiLang]["knowledge.title"];
const description = ui[uiLang]["knowledge.intro"];

// Enhanced SEO content using utility functions
const pageContent = `${title} ${description} ${sortedArticles.map((a) => `${a.data.title} ${a.data.description}`).join(" ")}`;

// Generate optimized meta description and keywords
const optimizedDescription = generateMetaDescription(pageContent);
const keywords = extractKeywords(pageContent) || ui[uiLang]["meta.keywords"];

// Additional structured data parameters for SEO
const pageType = "website";
const publishDate = new Date("2024-01-01");
const modifiedDate = new Date();

// Create structured data for CollectionPage
const collectionPageStructuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "@id": `${Astro.site}${lang}/knowledge/`,
  name: title,
  description: optimizedDescription,
  inLanguage: lang,
  datePublished: publishDate.toISOString(),
  dateModified: modifiedDate.toISOString(),
  isPartOf: {
    "@type": "WebSite",
    "@id": `${Astro.site}`,
    name: "Melody Mind",
    url: Astro.site?.toString() || "https://melodymind.app",
  },
  hasPart: {
    "@type": "ItemList",
    itemListElement: sortedArticles.map((article, index) => ({
      "@type": "ListItem",
      position: index + 1,
      item: {
        "@type": "Article",
        "@id": `${Astro.site}${lang}/knowledge/${article.slug}`,
        headline: article.data.title,
        description: article.data.description,
        image: article.data.image
          ? `${Astro.site}${article.data.image.startsWith("/") ? article.data.image : `/${article.data.image}`}`
          : `${Astro.site}/default-cover.jpg`,
        datePublished:
          article.data.createdAt instanceof Date
            ? article.data.createdAt.toISOString()
            : new Date().toISOString(),
        dateModified:
          article.data.updatedAt instanceof Date
            ? article.data.updatedAt.toISOString()
            : new Date().toISOString(),
        author: {
          "@type": "Organization",
          name: "Melody Mind Team",
        },
        publisher: {
          "@type": "Organization",
          name: "Melody Mind",
          logo: {
            "@type": "ImageObject",
            url: `${Astro.site}/melody-mind.png`,
            width: 192,
            height: 192,
          },
        },
        inLanguage: lang,
        mainEntityOfPage: {
          "@type": "WebPage",
          "@id": `${Astro.site}${lang}/knowledge/${article.slug}`,
        },
      },
    })),
  },
};

// Generate article structured data for each article
const articlesStructuredData = sortedArticles.map((article) => {
  const createdAt =
    article.data.createdAt instanceof Date
      ? article.data.createdAt
      : article.data.createdAt
        ? new Date(article.data.createdAt)
        : new Date();

  return {
    "@context": "https://schema.org",
    "@type": "Article",
    "@id": `${Astro.site}${lang}/knowledge/${article.slug}`,
    headline: article.data.title,
    description: article.data.description,
    image: article.data.image
      ? `${Astro.site}${article.data.image.startsWith("/") ? article.data.image : `/${article.data.image}`}`
      : `${Astro.site}/default-cover.jpg`,
    datePublished: createdAt.toISOString(),
    dateModified:
      article.data.updatedAt instanceof Date
        ? article.data.updatedAt.toISOString()
        : createdAt.toISOString(),
    author: {
      "@type": "Organization",
      name: "Melody Mind Team",
    },
    publisher: {
      "@type": "Organization",
      name: "Melody Mind",
      logo: {
        "@type": "ImageObject",
        url: `${Astro.site}/melody-mind.png`,
        width: 192,
        height: 192,
      },
    },
    inLanguage: lang,
    mainEntityOfPage: {
      "@type": "WebPage",
      "@id": `${Astro.site}${lang}/knowledge/${article.slug}`,
    },
  };
});
---

<Layout
  {title}
  description={optimizedDescription}
  {keywords}
  image={`/og-images/social-share-knowledge-${lang}.jpg`}
  type={pageType}
  {publishDate}
  {modifiedDate}
>
  <!-- Screen reader announcements for dynamic content changes -->
  <div id="sr-announce" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <main class="knowledge-page" id="main-content">
    <!-- Breadcrumbs navigation with structured data -->
    <nav aria-label="Breadcrumb" class="breadcrumb">
      <ol class="breadcrumb__list">
        <li class="breadcrumb__item">
          <a
            href={`/${String(lang)}/`}
            class="breadcrumb__link"
            aria-label={ui[uiLang]["nav.home"] || "Home"}
          >
            <Icon name="home" class="breadcrumb__icon" aria-hidden="true" />
            <span class="sr-only">{ui[uiLang]["nav.home"] || "Home"}</span>
          </a>
          <span class="breadcrumb__separator" aria-hidden="true">/</span>
        </li>
        <li class="breadcrumb__item breadcrumb__item--current" aria-current="page">
          {ui[uiLang]["knowledge.title"] || "Knowledge"}
        </li>
      </ol>
    </nav>

    <!-- Page header with improved semantic structure -->
    <header class="knowledge-page__header">
      <Headline
        title={ui[uiLang]["knowledge.title"]}
        level="h1"
        className="knowledge-page__title"
        id="page-heading"
      />
      <div class="knowledge-page__divider" aria-hidden="true"></div>

      <Paragraph description={ui[uiLang]["knowledge.intro"]} className="knowledge-page__intro" />
    </header>

    <div class="knowledge-page__content">
      <!-- Improved search and filtering with enhanced ARIA support -->
      <section class="search-container" role="search" aria-labelledby="search-heading">
        <h2 class="search-container__heading" id="search-heading">
          {ui[uiLang]["knowledge.search.heading"] || "Search Articles"}
        </h2>
        <div class="search-container__form">
          <div class="search-container__input-wrapper">
            <label for="searchInput" class="sr-only">
              {ui[uiLang]["knowledge.search.label"] || "Search by title, description or keywords"}
            </label>
            <div class="search-container__input-group">
              <div class="search-container__icon-wrapper" aria-hidden="true">
                <Icon name="search" class="search-container__icon" />
              </div>
              <input
                type="search"
                id="searchInput"
                placeholder={ui[uiLang]["knowledge.search.placeholder"] || "Search articles..."}
                class="search-container__input"
                aria-controls="articlesGrid search-results-region"
                aria-describedby="search-description search-status"
                autocomplete="off"
                aria-autocomplete="list"
                aria-required="false"
                data-search-input
              />
              <div id="search-description" class="sr-only">
                {
                  ui[uiLang]["knowledge.search.description"] ||
                    "Articles will filter automatically as you type. Use arrow keys to navigate between results."
                }
              </div>
            </div>
          </div>

          <!-- Reset button for search field - Enhanced accessibility -->
          <button
            id="reset-search-inline"
            class="search-container__reset-button"
            aria-label={ui[uiLang]["knowledge.search.reset"] || "Reset search"}
            type="button"
            aria-controls="articlesGrid"
          >
            <Icon name="close" class="search-container__reset-icon" aria-hidden="true" />
            <span>{ui[uiLang]["knowledge.search.reset.text"] || "Reset"}</span>
          </button>
        </div>

        <!-- Search status information for screen readers - Enhanced -->
        <div
          id="search-status"
          class="sr-only"
          aria-live="polite"
          aria-atomic="true"
          role="status"
          data-search-status
        >
          {ui[uiLang]["knowledge.search.initial"] || "Showing all articles. Type to filter."}
        </div>

        <!-- Additional detailed search status for screen readers -->
        <div
          id="search-details"
          class="sr-only"
          aria-live="polite"
          aria-atomic="true"
          role="status"
        >
          <!-- Will be populated via JavaScript -->
        </div>
      </section>

      <!-- No results message (initially hidden) - Improved for accessibility -->
      <div
        id="no-results"
        class="no-results"
        role="status"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="no-results__content">
          <Icon
            name="search-no-results"
            class="no-results__icon"
            aria-hidden="true"
            role="presentation"
          />
          <h2 class="no-results__title">
            {ui[uiLang]["knowledge.no.results"] || "No articles found"}
          </h2>
          <p class="no-results__description">
            {
              ui[uiLang]["knowledge.no.results.help"] ||
                "Try different search terms or reset your search"
            }
          </p>
          <button
            id="reset-search"
            class="no-results__button"
            aria-label={ui[uiLang]["knowledge.search.reset"] || "Reset search"}
            type="button"
            aria-controls="articlesGrid"
          >
            <Icon name="refresh" class="no-results__button-icon" aria-hidden="true" />
            <span>{ui[uiLang]["knowledge.search.reset"] || "Reset Search"}</span>
          </button>
        </div>
      </div>

      <!-- Keyboard navigation instructions - Enhanced for screen readers -->
      <div
        class="sr-only"
        aria-live="polite"
        id="keyboard-instructions"
        role="region"
        aria-label="Keyboard navigation instructions"
      >
        <p>
          {
            ui[uiLang]["knowledge.keyboard.instructions"] ||
              "Use arrow keys to navigate between articles. Press Enter to open an article."
          }
        </p>
      </div>

      <!-- Articles grid with improved accessibility -->
      <section
        aria-labelledby="articles-heading"
        class="articles-section"
        id="search-results-region"
      >
        <h2 id="articles-heading" class="sr-only">
          {ui[uiLang]["knowledge.articles.heading"] || "Knowledge Articles"}
        </h2>

        <ul id="articlesGrid" class="articles-grid" aria-labelledby="articles-heading">
          {
            sortedArticles.length > 0 ? (
              sortedArticles.map((article, index) => {
                // Handle date - ensure it's a valid Date object
                const createdAt =
                  article.data.createdAt instanceof Date
                    ? article.data.createdAt
                    : article.data.createdAt
                      ? new Date(article.data.createdAt)
                      : new Date();

                return (
                  <li
                    class="articles-grid__item"
                    style={`animation-delay: ${Math.min(index * 50, 500)}ms`}
                  >
                    <KnowledgeCard
                      title={article.data.title}
                      description={article.data.description}
                      image={article.data.image as string}
                      createdAt={createdAt}
                      slug={article.slug}
                      lang={lang}
                      readingTime={article.data.readingTime}
                      articleUrl={`/${String(lang)}/knowledge/${article.slug}`}
                      keywords={article.data.keywords?.join(", ")}
                      index={index}
                    />
                  </li>
                );
              })
            ) : (
              <li class="articles-grid__empty">
                <div class="articles-grid__empty-content">
                  <Icon name="info" class="articles-grid__empty-icon" aria-hidden="true" />
                  <p class="articles-grid__empty-text">
                    {ui[uiLang]["knowledge.empty"] || "No articles found for this language"}
                  </p>
                </div>
              </li>
            )
          }
        </ul>
      </section>
    </div>

    <!-- "Back to top" button with enhanced accessibility -->
    <button
      id="back-to-top"
      class="back-to-top"
      aria-label={ui[uiLang]["common.back.to.top"] || "Back to top"}
      type="button"
      aria-controls="page-heading"
      aria-hidden="true"
    >
      <Icon name="arrow-up" class="back-to-top__icon" aria-hidden="true" />
      <span class="sr-only">{ui[uiLang]["common.back.to.top"] || "Back to top"}</span>
    </button>
  </main>

  <!-- Structured Data for CollectionPage -->
  <script type="application/ld+json" set:html={JSON.stringify(collectionPageStructuredData)} />

  <!-- Structured Data for Articles -->
  {
    articlesStructuredData.map((articleData) => (
      <script type="application/ld+json" set:html={JSON.stringify(articleData)} />
    ))
  }

  <!-- Breadcrumb Structured Data -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      itemListElement: [
        {
          "@type": "ListItem",
          position: 1,
          name: "Home",
          item: `${Astro.site}${lang}/`,
        },
        {
          "@type": "ListItem",
          position: 2,
          name: ui[uiLang]["knowledge.title"] || "Knowledge",
          item: `${Astro.site}${lang}/knowledge/`,
        },
      ],
    })}
  />

  <!-- Optimized Search Function -->
  <script>
    /**
     * Knowledge Page Search & Interaction Module
     *
     * Features:
     * - High-performance search with debouncing and batch DOM updates
     * - Optimized keyboard navigation for WCAG AAA compliance
     * - Responsive touch interactions for mobile devices
     * - Screen reader announcements for search results
     * - ESC key to reset search
     * - Back-to-top functionality with proper focus management
     *
     * Performance Optimizations:
     * - Request Animation Frame for smooth UI updates
     * - Efficient DOM querying with cached selectors
     * - Batched processing for large article collections
     */

    /**
     * Generic debounce function to limit function call frequency
     * @param {Function} func - The function to debounce
     * @param {number} [wait=300] - The debounce wait time in milliseconds
     * @returns {Function} A debounced version of the input function
     */
    function debounce<T extends unknown[]>(
      func: (...args: T) => unknown,
      wait = 300
    ): (...args: T) => void {
      let timeout: ReturnType<typeof setTimeout> | undefined;
      return function executedFunction(...args: T): void {
        const later = (): void => {
          if (timeout) {
            clearTimeout(timeout);
          }
          func(...args);
        };
        if (timeout) {
          clearTimeout(timeout);
        }
        timeout = setTimeout(later, wait);
      };
    }

    /**
     * Updates the screen reader status with search results count
     * @param {HTMLElement} statusElement - The status element to update
     * @param {number} count - Number of items found
     * @param {number} total - Total number of items
     * @returns {void}
     */
    function updateSearchStatus(
      statusElement: HTMLElement,
      count: number,
      total: number = 0
    ): void {
      let message = "";

      // Static translations for client-side script
      const translations = {
        noArticles: "No articles found",
        oneArticle: "1 article found",
        allArticles: "All {count} articles displayed",
        countArticles: "{count} of {total} articles found",
        resultsFormat:
          'Search results for "{term}": {count} of {total} articles match your search.',
        noResultsFormat: 'No articles match your search for "{term}". Try different keywords.',
        showingAll: "Showing all {total} articles.",
      };

      if (count === 0) {
        message = translations.noArticles;
      } else if (count === 1) {
        message = translations.oneArticle;
      } else if (count === total) {
        message = translations.allArticles.replace("{count}", count.toString());
      } else {
        message = translations.countArticles
          .replace("{count}", count.toString())
          .replace("{total}", total.toString());
      }

      statusElement.textContent = message;

      // Update detailed search information for screen readers
      const searchDetailsElement = document.getElementById("search-details");
      if (searchDetailsElement) {
        const searchInput = document.getElementById("searchInput") as HTMLInputElement;
        const searchTerm = searchInput?.value || "";

        if (searchTerm) {
          const detailedMessage =
            count > 0
              ? translations.resultsFormat
                  .replace("{term}", searchTerm)
                  .replace("{count}", count.toString())
                  .replace("{total}", total.toString())
              : translations.noResultsFormat.replace("{term}", searchTerm);

          searchDetailsElement.textContent = detailedMessage;
        } else {
          searchDetailsElement.textContent = translations.showingAll.replace(
            "{total}",
            total.toString()
          );
        }
      }

      // Update aria-expanded state based on whether we're filtering
      const searchInput = document.getElementById("searchInput") as HTMLInputElement;
      if (searchInput) {
        searchInput.setAttribute("aria-expanded", searchInput.value.length > 0 ? "true" : "false");
      }
    }

    /**
     * Processes a batch of search results for smoother UI updates
     * @param {Object} params - Parameters for batch processing
     * @returns {void}
     */
    function processBatch(params: {
      batchIndex: number;
      batches: number;
      term: string;
      articleDataMap: Map<HTMLElement, { element: HTMLElement; searchText: string }>;
      batchSize: number;
      noResultsElement: HTMLElement;
      statusElement: HTMLElement;
      visibleCount: number;
      firstVisible: HTMLElement | null;
      totalArticles: number;
    }): void {
      const {
        batchIndex,
        batches,
        term,
        articleDataMap,
        batchSize,
        noResultsElement,
        statusElement,
        totalArticles,
      } = params;

      let visibleCount = params.visibleCount;
      let firstVisible = params.firstVisible;

      if (batchIndex >= batches) {
        // All batches processed, update UI
        if (noResultsElement) {
          if (visibleCount === 0) {
            noResultsElement.classList.remove("hidden");
            noResultsElement.classList.add("flex");
          } else {
            noResultsElement.classList.add("hidden");
            noResultsElement.classList.remove("flex");
          }
        }

        updateSearchStatus(statusElement, visibleCount, totalArticles);
        return;
      }

      const start = batchIndex * batchSize;
      const end = Math.min(start + batchSize, articleDataMap.size);

      // Process current batch
      Array.from(articleDataMap.entries())
        .slice(start, end)
        .forEach(([_article, item]) => {
          const matches = item.searchText.includes(term);
          item.element.style.display = matches ? "" : "none";
          if (matches && !firstVisible) {
            firstVisible = item.element;
          }
          if (matches) {
            visibleCount++;
          }
        });

      // Schedule next batch with updated counts
      requestAnimationFrame(() => {
        processBatch({
          ...params,
          batchIndex: batchIndex + 1,
          visibleCount: visibleCount,
          firstVisible: firstVisible,
        });
      });
    }

    /**
     * Creates a search function that processes results in batches
     * @param {Object} params - Parameters for the search function
     * @returns {Function} A debounced search function
     */
    function createSearchFunction(params: {
      allArticles: HTMLElement[];
      totalArticles: number;
      articleDataMap: Map<HTMLElement, { element: HTMLElement; searchText: string }>;
      elements: {
        noResults: HTMLElement;
        searchStatus: HTMLElement;
      };
      config: {
        batchSize: number;
        debounceWait: number;
      };
    }): (searchTerm: string) => void {
      const { allArticles, totalArticles, articleDataMap, elements, config } = params;

      return debounce((searchTerm: string): void => {
        // Use requestAnimationFrame for smoother UI updates
        requestAnimationFrame(() => {
          const term = searchTerm.toLowerCase().trim();

          // Skip processing if search term is empty
          if (!term) {
            allArticles.forEach((article) => {
              article.style.display = "";
            });
            elements.noResults.classList.add("hidden");
            elements.noResults.classList.remove("flex");
            updateSearchStatus(elements.searchStatus, totalArticles, totalArticles);
            return;
          }

          // Start batch processing with initial values
          processBatch({
            batchIndex: 0,
            batches: Math.ceil(articleDataMap.size / config.batchSize),
            term,
            articleDataMap,
            batchSize: config.batchSize,
            noResultsElement: elements.noResults,
            statusElement: elements.searchStatus,
            visibleCount: 0,
            firstVisible: null,
            totalArticles,
          });
        });
      }, config.debounceWait);
    }

    /**
     * Handles keyboard navigation between articles
     * @param {KeyboardEvent} e - Keyboard event
     * @param {HTMLElement} articlesGrid - The articles grid element
     * @param {HTMLElement[]} allArticles - Array of all article elements
     * @returns {void}
     */
    function handleKeyboardNavigation(
      e: KeyboardEvent,
      articlesGrid: HTMLElement,
      allArticles: HTMLElement[]
    ): void {
      // Only handle arrow keys when focus is within the articles grid
      if (!articlesGrid.contains(document.activeElement)) {
        return;
      }

      const visibleArticles = allArticles.filter((article) => article.style.display !== "none");

      if (visibleArticles.length === 0) {
        return;
      }

      const currentIndex = visibleArticles.findIndex((article) =>
        article.contains(document.activeElement as Node)
      );

      if (currentIndex === -1) {
        return;
      }

      let nextIndex: number;

      // Determine number of columns based on viewport width for better navigation
      const columns = window.innerWidth >= 1024 ? 3 : window.innerWidth >= 640 ? 2 : 1;

      switch (e.key) {
        case "ArrowRight":
          nextIndex = (currentIndex + 1) % visibleArticles.length;
          e.preventDefault();
          break;
        case "ArrowLeft":
          nextIndex = (currentIndex - 1 + visibleArticles.length) % visibleArticles.length;
          e.preventDefault();
          break;
        case "ArrowDown":
          // Move to the article below (using responsive column count)
          nextIndex =
            currentIndex + columns < visibleArticles.length ? currentIndex + columns : currentIndex;
          e.preventDefault();
          break;
        case "ArrowUp":
          // Move to the article above (using responsive column count)
          nextIndex = currentIndex - columns >= 0 ? currentIndex - columns : currentIndex;
          e.preventDefault();
          break;
        default:
          return;
      }

      // Focus the link in the next article
      const nextArticle = visibleArticles[nextIndex];
      const focusableElement = nextArticle.querySelector("a") || nextArticle;
      if (focusableElement && "focus" in focusableElement) {
        (focusableElement as HTMLElement).focus();
      }
    }

    // Main initialization function when DOM is ready
    document.addEventListener("DOMContentLoaded", () => {
      // DOM elements and global state
      const elements = {
        searchInput: document.getElementById("searchInput") as HTMLInputElement,
        articlesGrid: document.getElementById("articlesGrid") as HTMLElement,
        noResults: document.getElementById("no-results") as HTMLElement,
        searchStatus: document.getElementById("search-status") as HTMLElement,
        searchDetails: document.getElementById("search-details") as HTMLElement,
        resetButtons: document.querySelectorAll("#reset-search, #reset-search-inline"),
        backToTopButton: document.getElementById("back-to-top") as HTMLElement,
      };

      // Config
      const config = {
        batchSize: 10,
        debounceWait: 150, // Reduced for more responsive feel
        topButtonThreshold: 400,
      };

      // Exit if essential elements are missing
      if (
        !elements.searchInput ||
        !elements.articlesGrid ||
        !elements.noResults ||
        !elements.searchStatus
      ) {
        return;
      }

      // Initialize the knowledge page functionality
      initKnowledgePage(elements, config);
    });

    /**
     * Main function to initialize the knowledge page functionality
     * @param {Object} elements - DOM elements used by the page
     * @param {Object} config - Configuration options
     * @returns {void}
     */
    function initKnowledgePage(
      elements: {
        searchInput: HTMLInputElement;
        articlesGrid: HTMLElement;
        noResults: HTMLElement;
        searchStatus: HTMLElement;
        resetButtons: NodeListOf<Element>;
        backToTopButton: HTMLElement;
      },
      config: {
        batchSize: number;
        debounceWait: number;
        topButtonThreshold: number;
      }
    ): void {
      // Initialize article data for search
      const { allArticles, totalArticles, articleDataMap } = initializeArticleData(
        elements.articlesGrid
      );

      // Initialize all functionality
      initSearchFunctionality(elements, config, allArticles, totalArticles, articleDataMap);
      initKeyboardNavigation(elements.articlesGrid, allArticles);
      initBackToTopButton(elements.backToTopButton, config.topButtonThreshold);

      // Declare the custom property type before using it
      interface KnowledgeCenter {
        filterByQuery: (query: string) => void;
        reset: () => void;
      }

      // Expose public API (useful for testing and potential external integrations)
      (
        window as Window & typeof globalThis & { knowledgeCenter?: KnowledgeCenter }
      ).knowledgeCenter = {
        filterByQuery: (query: string): void => {
          if (elements.searchInput) {
            elements.searchInput.value = query;
            const event = new Event("input", { bubbles: true });
            elements.searchInput.dispatchEvent(event);
          }
        },
        reset: (): void => {
          if (elements.searchInput) {
            elements.searchInput.value = "";
            const event = new Event("input", { bubbles: true });
            elements.searchInput.dispatchEvent(event);
            elements.searchInput.focus();
          }
        },
      };
    }

    /**
     * Initializes article data for search functionality
     * @param {HTMLElement} articlesGrid - The grid element containing all articles
     * @returns {Object} Object containing articles and article data map
     */
    function initializeArticleData(articlesGrid: HTMLElement): {
      allArticles: HTMLElement[];
      totalArticles: number;
      articleDataMap: Map<HTMLElement, { element: HTMLElement; searchText: string }>;
    } {
      // Cache all article elements for faster access
      const allArticles = Array.from(articlesGrid.querySelectorAll("li")) as HTMLElement[];
      const totalArticles = allArticles.length;

      // Create a Map for faster lookups during search
      const articleDataMap = new Map<
        HTMLElement,
        {
          element: HTMLElement;
          searchText: string;
        }
      >();

      // Pre-process article data once
      allArticles.forEach((article) => {
        const card = article.querySelector('[data-testid="knowledge-card"]');
        if (card) {
          const title = card.getAttribute("data-title") || "";
          const description = card.getAttribute("data-description") || "";
          const keywords = card.getAttribute("data-keywords") || "";

          // Store pre-processed lowercase text for faster comparison
          articleDataMap.set(article, {
            element: article,
            searchText: `${title} ${description} ${keywords}`.toLowerCase(),
          });
        }
      });

      return { allArticles, totalArticles, articleDataMap };
    }

    /**
     * Initializes the search functionality with debouncing and batch processing
     * @param {Object} elements - DOM elements used by the search functionality
     * @param {Object} config - Configuration options
     * @param {HTMLElement[]} allArticles - Array of all article elements
     * @param {number} totalArticles - Total number of articles
     * @param {Map} articleDataMap - Map of article elements to their search data
     * @returns {void}
     */
    function initSearchFunctionality(
      elements: {
        searchInput: HTMLInputElement;
        noResults: HTMLElement;
        searchStatus: HTMLElement;
        resetButtons: NodeListOf<Element>;
      },
      config: {
        batchSize: number;
        debounceWait: number;
      },
      allArticles: HTMLElement[],
      totalArticles: number,
      articleDataMap: Map<HTMLElement, { element: HTMLElement; searchText: string }>
    ): void {
      // Create the optimized search function
      const performSearch = createSearchFunction({
        allArticles,
        totalArticles,
        articleDataMap,
        elements: {
          noResults: elements.noResults,
          searchStatus: elements.searchStatus,
        },
        config,
      });

      // Event listeners
      elements.searchInput.addEventListener("input", (e) => {
        const target = e.target as HTMLInputElement;
        if (target) {
          performSearch(target.value);
        }
      });

      elements.resetButtons.forEach((button) => {
        button.addEventListener("click", () => {
          elements.searchInput.value = "";
          performSearch("");
          elements.searchInput.focus();
        });
      });

      // Add ESC key handler to reset search
      document.addEventListener("keydown", (event: KeyboardEvent) => {
        if (event.key === "Escape" && elements.searchInput?.value) {
          elements.searchInput.value = "";
          performSearch("");
          elements.searchInput.focus();
          event.preventDefault();
        }
      });

      // Initialize with empty search to ensure proper state
      performSearch("");
    }

    /**
     * Sets up keyboard navigation for articles with arrow keys
     * @param {HTMLElement} articlesGrid - The articles grid element
     * @param {HTMLElement[]} allArticles - Array of all article elements
     * @returns {void}
     */
    function initKeyboardNavigation(articlesGrid: HTMLElement, allArticles: HTMLElement[]): void {
      document.addEventListener("keydown", (e) => {
        handleKeyboardNavigation(e, articlesGrid, allArticles);
      });
    }

    /**
     * Initializes the back to top button functionality
     * @param {HTMLElement} backToTopButton - The back to top button element
     * @param {number} threshold - Scroll threshold to show the button
     * @returns {void}
     */
    function initBackToTopButton(backToTopButton: HTMLElement, threshold: number): void {
      if (!backToTopButton) {
        return;
      }

      // Performance optimization for scroll events
      let isScrolling = false;

      // Show/hide button based on scroll position
      window.addEventListener(
        "scroll",
        () => {
          if (!isScrolling) {
            isScrolling = true;

            requestAnimationFrame(() => {
              if (window.scrollY > threshold) {
                backToTopButton.setAttribute("data-visible", "true");
              } else {
                backToTopButton.removeAttribute("data-visible");
              }
              isScrolling = false;
            });
          }
        },
        { passive: true }
      );

      // Scroll to top when clicked
      backToTopButton.addEventListener("click", () => {
        // Announce to screen readers
        const srAnnounce = document.getElementById("sr-announce");
        if (srAnnounce) {
          srAnnounce.textContent = "Scrolling to top of page";
        }

        // Get motion preferences (single declaration for the entire function)
        const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        const shouldUseSmooth = !prefersReducedMotion;

        // Use native smooth scroll if supported and not disabled
        if (shouldUseSmooth && "scrollBehavior" in document.documentElement.style) {
          window.scrollTo({
            top: 0,
            behavior: "smooth",
          });
        } else {
          // Immediate scroll for reduced motion or fallback
          window.scrollTo(0, 0);

          // Provide immediate feedback for screen readers when using instant scroll
          if (srAnnounce) {
            srAnnounce.textContent = "Scrolled to top of page";
          }
        }

        // Return focus to the search input after scrolling for better keyboard navigation
        setTimeout(
          () => {
            const searchInput = document.getElementById("searchInput");
            if (searchInput) {
              searchInput.focus();
              // Announce focus to screen readers
              if (srAnnounce) {
                srAnnounce.textContent = "Search input is now focused";
              }
            }
          },
          shouldUseSmooth ? 300 : 0
        );
      });
    }
  </script>

  <style>
    /* Knowledge Page - Main Layout */
    .knowledge-page {
      max-width: var(--breakpoint-xl);
      margin-left: auto;
      margin-right: auto;
      padding: var(--spacing-xl) var(--spacing-md);
    }

    /* Breadcrumb Navigation */
    .breadcrumb {
      margin-bottom: var(--spacing-xl);
    }

    .breadcrumb__list {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: var(--font-size-md);
      color: var(--color-gray-300);
    }

    .breadcrumb__item {
      display: flex;
      align-items: center;
    }

    .breadcrumb__item--current {
      font-weight: 500;
      color: var(--color-purple-400);
    }

    .breadcrumb__link {
      display: flex;
      align-items: center;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius-md);
      transition: color 0.2s ease;
    }

    .breadcrumb__link:hover,
    .breadcrumb__link:focus {
      color: var(--color-purple-400);
      outline: none;
    }

    .breadcrumb__link:focus-visible {
      outline: 3px solid var(--color-purple-500);
      outline-offset: 3px;
    }

    .breadcrumb__icon {
      height: 1.25rem;
      width: 1.25rem;
    }

    .breadcrumb__separator {
      margin: 0 var(--spacing-sm);
    }

    /* Page Header */
    .knowledge-page__header {
      margin-bottom: var(--spacing-2xl);
      text-align: center;
    }

    .knowledge-page__title {
      margin-bottom: var(--spacing-md);
      font-size: var(--font-size-3xl);
      font-weight: 700;
      letter-spacing: 0.025em;
      color: var(--color-white);
    }

    .knowledge-page__divider {
      margin: var(--spacing-sm) auto var(--spacing-xl);
      height: 0.25rem;
      width: 6rem;
      background-color: var(--color-purple-500);
      border-radius: var(--border-radius-full);
    }

    .knowledge-page__intro {
      max-width: 42rem;
      margin-left: auto;
      margin-right: auto;
      font-size: var(--font-size-xl);
      line-height: var(--line-height-relaxed);
      color: var(--color-gray-100);
    }

    /* Page Content */
    .knowledge-page__content {
      margin-bottom: var(--spacing-xl);
      width: 100%;
    }

    /* Search Container */
    .search-container {
      margin-bottom: var(--spacing-2xl);
      padding: var(--spacing-xl);
      background-color: var(--color-gray-800);
      background-color: rgba(39, 39, 42, 0.9);
      border: 2px solid var(--color-gray-600);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
    }

    .search-container__heading {
      margin-bottom: var(--spacing-xl);
      font-size: var(--font-size-2xl);
      font-weight: 500;
      color: var(--color-white);
    }

    .search-container__form {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .search-container__input-wrapper {
      position: relative;
      flex-grow: 1;
    }

    .search-container__input-group {
      position: relative;
    }

    .search-container__icon-wrapper {
      position: absolute;
      pointer-events: none;
      top: 0;
      bottom: 0;
      left: var(--spacing-md);
      display: flex;
      align-items: center;
    }

    .search-container__icon {
      height: 1.5rem;
      width: 1.5rem;
      color: var(--color-purple-400);
    }

    .search-container__input {
      width: 100%;
      padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) calc(var(--spacing-md) * 3);
      background-color: var(--color-gray-800);
      border: 2px solid var(--color-gray-600);
      border-radius: var(--border-radius-lg);
      color: var(--color-gray-50);
      font-size: var(--font-size-lg);
      transition: all 0.3s;
    }

    .search-container__input::placeholder {
      color: var(--color-gray-400);
    }

    .search-container__input:focus {
      border-color: var(--color-purple-500);
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.5);
      outline: none;
    }

    .search-container__reset-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md) var(--spacing-xl);
      background-color: var(--color-gray-700);
      border-radius: var(--border-radius-lg);
      color: var(--color-gray-100);
      font-size: var(--font-size-lg);
      font-weight: 500;
      transition: all 0.3s;
    }

    .search-container__reset-button:hover,
    .search-container__reset-button:focus {
      background-color: var(--color-gray-600);
      outline: none;
    }

    .search-container__reset-button:focus-visible {
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.5);
    }

    .search-container__reset-icon {
      height: 1.5rem;
      width: 1.5rem;
    }

    /* No Results */
    .no-results {
      margin-bottom: var(--spacing-2xl);
      display: none;
      background: linear-gradient(to bottom right, var(--color-gray-700), var(--color-gray-800));
      border: 1px solid var(--color-gray-600);
      border-radius: var(--border-radius-lg);
      text-align: center;
      box-shadow: var(--shadow-md);
    }

    .no-results.flex {
      display: block;
    }

    .no-results__content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-2xl);
    }

    .no-results__icon {
      margin-bottom: var(--spacing-xl);
      height: 5rem;
      width: 5rem;
      color: var(--color-gray-300);
    }

    .no-results__title {
      font-size: var(--font-size-2xl);
      font-weight: 500;
      color: var(--color-gray-100);
    }

    .no-results__description {
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
      font-size: var(--font-size-xl);
      color: var(--color-gray-300);
    }

    .no-results__button {
      margin-top: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md) var(--spacing-xl);
      background-color: var(--color-purple-600);
      border-radius: var(--border-radius-md);
      color: var(--color-white);
      font-size: var(--font-size-lg);
      font-weight: 500;
      transition: all 0.3s;
    }

    .no-results__button:hover,
    .no-results__button:focus {
      background-color: var(--color-purple-500);
      outline: none;
    }

    .no-results__button:focus-visible {
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.5);
      outline-offset: 3px;
    }

    .no-results__button-icon {
      height: 1.5rem;
      width: 1.5rem;
    }

    /* Articles Section */
    .articles-section {
      margin-bottom: var(--spacing-2xl);
    }

    /* Articles Grid */
    .articles-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--spacing-xl);
    }

    .articles-grid__item {
      list-style: none;
      transform: translateY(0.5rem);
      opacity: 0;
      animation: fadeIn 0.5s ease-out forwards;
    }

    .articles-grid__empty {
      grid-column: 1 / -1;
    }

    .articles-grid__empty-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-2xl);
      background: linear-gradient(to bottom right, var(--color-gray-700), var(--color-gray-800));
      border: 1px solid var(--color-gray-600);
      border-radius: var(--border-radius-lg);
      text-align: center;
      box-shadow: var(--shadow-md);
    }

    .articles-grid__empty-icon {
      margin-bottom: var(--spacing-xl);
      height: 5rem;
      width: 5rem;
      color: var(--color-gray-300);
    }

    .articles-grid__empty-text {
      font-size: var(--font-size-2xl);
      font-weight: 500;
      color: var(--color-gray-100);
    }

    /* Back to Top Button */
    .back-to-top {
      position: fixed;
      right: var(--spacing-xl);
      bottom: var(--spacing-xl);
      z-index: 10;
      padding: var(--spacing-md);
      background-color: var(--color-purple-600);
      color: var(--color-white);
      border-radius: var(--border-radius-full);
      box-shadow: var(--shadow-lg);
      transition: all 0.3s;
      visibility: hidden;
      opacity: 0;
    }

    .back-to-top[data-visible="true"] {
      visibility: visible;
      opacity: 1;
    }

    .back-to-top:hover,
    .back-to-top:focus {
      background-color: var(--color-purple-500);
      outline: none;
    }

    .back-to-top:focus-visible {
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.5);
      outline-offset: 3px;
    }

    .back-to-top__icon {
      height: 2rem;
      width: 2rem;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(0.5rem);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive Design */
    @media (min-width: 640px) {
      .articles-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 768px) {
      .knowledge-page {
        padding: var(--spacing-xl) var(--spacing-xl);
      }

      .knowledge-page__title {
        font-size: var(--font-size-4xl);
      }

      .search-container__form {
        flex-direction: row;
      }

      .articles-grid {
        gap: var(--spacing-2xl);
      }
    }

    @media (min-width: 1024px) {
      .articles-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Respect user preference for reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.001s !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.001s !important;
        scroll-behavior: auto !important;
      }

      .articles-grid__item {
        opacity: 1 !important;
        transform: none !important;
        animation: none !important;
      }

      @keyframes fadeIn {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    }

    /* Support for text spacing preferences */
    @media (prefers-increased-text-spacing) {
      p,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      li,
      input,
      button {
        letter-spacing: 0.12em !important;
        word-spacing: 0.16em !important;
        line-height: 1.8 !important;
      }
    }
  </style>
</Layout>

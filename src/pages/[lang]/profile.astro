---
/**
 * User Profile Page
 *
 * This page displays the user profile with personal information,
 * game statistics, and recent game results.
 *
 * Features:
 * - Display of user information (name, email, creation date)
 * - Statistics for quiz and chronology game modes
 * - List of recent game results
 * - Responsive design with Tailwind CSS
 * - WCAG AAA compliant
 *
 * URL: /[lang]/profile
 */
import Layout from "@layouts/Layout.astro";
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import { Icon } from "astro-icon/components";
import { formatDate } from "@utils/dateUtils";
import { requireAuth } from "src/middleware/auth";

// Interface for user profile data
interface UserProfile {
  user: {
    username: string;
    email: string;
    createdAt: string;
  };
  stats: {
    quiz: {
      totalScore: number;
      gamesPlayed: number;
      highestScore: number;
    };
    chronology: {
      totalScore: number;
      gamesPlayed: number;
      highestScore: number;
    };
  };
  recentGames: Array<{
    gameMode: "quiz" | "chronology";
    score: number;
    category: string;
    difficulty: "easy" | "medium" | "hard";
    createdAt: string;
  }>;
}

// Get language from URL and initialize translations
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(String(lang));

// Auth check: Verify if the user is logged in
const authResult = await requireAuth(Astro.request);
if (!authResult.authenticated && authResult.redirectToLogin) {
  return authResult.redirectToLogin;
}

// Extract user ID from auth context
const userId = authResult.user?.id || "guest";

// Default values for user data
let profileData: UserProfile | null = null;
let isLoading = true;
let error: string | null = null;

// Fetch user data from API endpoint
try {
  // Pass user ID as parameter
  const response = await fetch(
    `${Astro.url.origin}/${String(lang)}/api/user/profile?userId=${userId}`,
    {
      headers: {
        "Content-Type": "application/json",
      },
      credentials: "include", // Important: Send cookies
    }
  );

  const data = await response.json();

  if (data.success) {
    profileData = data.profile;
  } else {
    error = data.error || t("profile.error");
  }
} catch (err) {
  console.error("Error fetching profile data:", err);
  error = t("profile.error");
} finally {
  isLoading = false;
}

// Format the date for display
const formatUserDate = (dateString: string): string => {
  try {
    return formatDate(dateString, String(lang));
  } catch (err) {
    return dateString;
  }
};

// Game mode names for display
const gameModeNames = {
  quiz: t("profile.stats.quiz"),
  chronology: t("profile.stats.chronology"),
};

// Difficulty level names for display
const difficultyNames = {
  easy: t("difficulty.easy"),
  medium: t("difficulty.medium"),
  hard: t("difficulty.hard"),
};
---

<Layout title={t("profile.title")} description={t("profile.description")} type="website">
  <div class="mx-auto max-w-4xl">
    <h1 class="mb-8 text-center text-3xl font-bold text-white">
      {t("profile.title")}
    </h1>

    {
      isLoading && (
        <div class="flex min-h-[300px] items-center justify-center" aria-live="polite">
          <div class="text-center">
            <Icon
              name="loader"
              class="mx-auto h-10 w-10 animate-spin text-purple-400"
              aria-hidden="true"
            />
            <p class="mt-4 text-lg text-zinc-300">{t("profile.loading")}</p>
          </div>
        </div>
      )
    }

    {
      error && (
        <div
          class="mb-8 rounded-lg border border-red-700 bg-red-900/30 p-4 text-white"
          role="alert"
        >
          <p class="font-medium">{error}</p>
          <p class="mt-2">{t("profile.auth.required")}</p>
        </div>
      )
    }

    {
      profileData && (
        <div class="space-y-10">
          <section
            class="rounded-xl border border-zinc-700 bg-gradient-to-b from-zinc-800 to-zinc-900 p-6 shadow-lg"
            aria-labelledby="user-info-heading"
          >
            <h2 id="user-info-heading" class="mb-4 text-2xl font-bold text-white">
              {t("profile.user.info")}
            </h2>

            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
              <div class="space-y-2">
                <div class="flex items-center">
                  <Icon name="user" class="mr-2 h-5 w-5 text-purple-400" aria-hidden="true" />
                  <span class="mr-2 text-zinc-400">{t("auth.register.username")}:</span>
                  <span class="font-medium text-white">{profileData.user.username}</span>
                </div>

                <div class="flex items-center">
                  <Icon name="mail" class="mr-2 h-5 w-5 text-purple-400" aria-hidden="true" />
                  <span class="mr-2 text-zinc-400">{t("auth.login.email")}:</span>
                  <span class="font-medium text-white">{profileData.user.email}</span>
                </div>
              </div>

              <div>
                <div class="flex items-center">
                  <Icon name="calendar" class="mr-2 h-5 w-5 text-purple-400" aria-hidden="true" />
                  <span class="mr-2 text-zinc-400">{t("profile.user.since")}:</span>
                  <span class="font-medium text-white">
                    {formatUserDate(profileData.user.createdAt)}
                  </span>
                </div>
              </div>
            </div>
          </section>

          <section
            class="rounded-xl border border-zinc-700 bg-gradient-to-b from-zinc-800 to-zinc-900 p-6 shadow-lg"
            aria-labelledby="stats-heading"
          >
            <h2 id="stats-heading" class="mb-6 text-2xl font-bold text-white">
              {t("profile.stats.title")}
            </h2>

            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
              <div class="rounded-lg border border-zinc-700 bg-zinc-900/50 p-5">
                <h3 class="mb-4 flex items-center text-xl font-bold text-white">
                  <Icon name="quiz" class="mr-2 h-6 w-6 text-yellow-400" aria-hidden="true" />
                  {t("profile.stats.quiz")}
                </h3>

                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <span class="text-zinc-300">{t("profile.stats.total.score")}</span>
                    <span class="text-lg font-bold text-white">
                      {profileData.stats.quiz.totalScore}
                    </span>
                  </div>

                  <div class="flex items-center justify-between">
                    <span class="text-zinc-300">{t("profile.stats.games.played")}</span>
                    <span class="text-lg font-bold text-white">
                      {profileData.stats.quiz.gamesPlayed}
                    </span>
                  </div>

                  <div class="flex items-center justify-between">
                    <span class="text-zinc-300">{t("profile.stats.highest.score")}</span>
                    <span class="text-lg font-bold text-white">
                      {profileData.stats.quiz.highestScore}
                    </span>
                  </div>
                </div>
              </div>

              <div class="rounded-lg border border-zinc-700 bg-zinc-900/50 p-5">
                <h3 class="mb-4 flex items-center text-xl font-bold text-white">
                  <Icon name="chronology" class="mr-2 h-6 w-6 text-blue-400" aria-hidden="true" />
                  {t("profile.stats.chronology")}
                </h3>

                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <span class="text-zinc-300">{t("profile.stats.total.score")}</span>
                    <span class="text-lg font-bold text-white">
                      {profileData.stats.chronology.totalScore}
                    </span>
                  </div>

                  <div class="flex items-center justify-between">
                    <span class="text-zinc-300">{t("profile.stats.games.played")}</span>
                    <span class="text-lg font-bold text-white">
                      {profileData.stats.chronology.gamesPlayed}
                    </span>
                  </div>

                  <div class="flex items-center justify-between">
                    <span class="text-zinc-300">{t("profile.stats.highest.score")}</span>
                    <span class="text-lg font-bold text-white">
                      {profileData.stats.chronology.highestScore}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section
            class="rounded-xl border border-zinc-700 bg-gradient-to-b from-zinc-800 to-zinc-900 p-6 shadow-lg"
            aria-labelledby="recent-games-heading"
          >
            <h2 id="recent-games-heading" class="mb-6 text-2xl font-bold text-white">
              {t("profile.recent.games")}
            </h2>

            {profileData.recentGames.length === 0 ? (
              <p class="py-8 text-center text-zinc-400">{t("profile.recent.games.empty")}</p>
            ) : (
              <div class="overflow-x-auto">
                <table class="w-full border-collapse" aria-describedby="recent-games-heading">
                  <thead>
                    <tr class="border-b border-zinc-700">
                      <th scope="col" class="px-4 py-3 text-left font-medium text-zinc-300">
                        {t("profile.recent.game.mode")}
                      </th>
                      <th scope="col" class="px-4 py-3 text-left font-medium text-zinc-300">
                        {t("profile.recent.game.category")}
                      </th>
                      <th scope="col" class="px-4 py-3 text-left font-medium text-zinc-300">
                        {t("profile.recent.game.difficulty")}
                      </th>
                      <th scope="col" class="px-4 py-3 text-right font-medium text-zinc-300">
                        {t("profile.recent.game.score")}
                      </th>
                      <th scope="col" class="px-4 py-3 text-right font-medium text-zinc-300">
                        {t("profile.recent.game.date")}
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {profileData.recentGames.map(
                      (game: {
                        gameMode: "quiz" | "chronology";
                        score: number;
                        category: string;
                        difficulty: "easy" | "medium" | "hard";
                        createdAt: string;
                      }) => (
                        <tr class="border-b border-zinc-800 transition-colors hover:bg-zinc-800/50">
                          <td class="px-4 py-3">
                            <span
                              class={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${game.gameMode === "quiz" ? "bg-yellow-900/30 text-yellow-300" : "bg-blue-900/30 text-blue-300"}`}
                            >
                              {gameModeNames[game.gameMode as keyof typeof gameModeNames] ||
                                game.gameMode}
                            </span>
                          </td>
                          <td class="px-4 py-3 text-white">{game.category}</td>
                          <td class="px-4 py-3">
                            <span
                              class={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
                                game.difficulty === "easy"
                                  ? "bg-green-900/30 text-green-300"
                                  : game.difficulty === "medium"
                                    ? "bg-orange-900/30 text-orange-300"
                                    : "bg-red-900/30 text-red-300"
                              }`}
                            >
                              {difficultyNames[game.difficulty as keyof typeof difficultyNames] ||
                                game.difficulty}
                            </span>
                          </td>
                          <td class="px-4 py-3 text-right font-bold text-white">{game.score}</td>
                          <td class="px-4 py-3 text-right text-zinc-300">
                            {formatUserDate(game.createdAt)}
                          </td>
                        </tr>
                      )
                    )}
                  </tbody>
                </table>
              </div>
            )}
          </section>
        </div>
      )
    }
  </div>
</Layout>

<script>
  // Helper function for formatting dates
  function formatDateClient(dateString: string, locale: string): string {
    try {
      const date = new Date(dateString);
      return new Intl.DateTimeFormat(locale, {
        year: "numeric",
        month: "long",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      }).format(date);
    } catch (err) {
      console.error("Error formatting date:", err);
      return dateString;
    }
  }
</script>

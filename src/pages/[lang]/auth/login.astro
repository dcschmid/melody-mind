---
/**
 * @component LoginPage
 * @description Login Page for MelodyMind that displays the auth form in login mode.
 * The page is optimized according to WCAG AAA standards for maximum accessibility
 * and provides a seamless login experience with form validation and error handling.
 *
 * Features:
 * - High contrast text with 7:1 ratio for WCAG AAA compliance
 * - Proper focus indicators for keyboard navigation
 * - Screen reader announcements for form errors
 * - Responsive design for all device sizes
 * - Seamless page transitions with View Transitions API
 * - Performance optimized with prefetch hints and GPU acceleration
 */

// Performance: Enable static site generation for optimal performance
export const prerender = true;

// Generate static paths for all supported languages
export async function getStaticPaths() {
  return [
    { params: { lang: "en" } },
    { params: { lang: "de" } },
    { params: { lang: "fr" } },
    { params: { lang: "es" } },
    { params: { lang: "it" } },
    { params: { lang: "pt" } },
    { params: { lang: "da" } },
    { params: { lang: "nl" } },
    { params: { lang: "sv" } },
    { params: { lang: "fi" } },
  ];
}

// 1. Imports - Optimized for performance
import AuthForm from "@components/auth/AuthForm.astro";
import { getLangFromUrl, useTranslations } from "@utils/i18n";
import Layout from "@layouts/Layout.astro";
import { Icon } from "astro-icon/components";

// 2. Data processing - Optimized translation batching
// Extract language code from the current URL for internationalization
const lang = getLangFromUrl(Astro.url);
// Initialize translation function with the extracted language - ensure lang is a string
const t = useTranslations(lang.toString());

// 3. Reactive variables and derived state - Batched for better performance
// Batch all translation calls to reduce overhead
const translations = {
  pageTitle: t("auth.login.title"),
  pageDescription: t("auth.login.description"),
  backToHomeLabel: t("auth.login.back_to_home"),
  headingText: t("auth.login.heading"),
  helpText: t("auth.login.help_text"),
};

// Destructure for easier access
const { pageTitle, pageDescription, backToHomeLabel, headingText, helpText } = translations;
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- Login container with responsive layout and improved accessibility -->
  <!-- Back to home link for improved navigation with preload optimization -->
  <div class="back-to-home">
    <a
      href={`/${String(lang)}/`}
      class="back-to-home__link"
      aria-label={backToHomeLabel}
      rel="prefetch"
    >
      <Icon name="arrow-left" class="back-to-home__icon" aria-hidden="true" />
      <span>{backToHomeLabel}</span>
    </a>
  </div>

  <h1 id="login-heading" class="login-heading" aria-level="1">
    {headingText}
  </h1>

  <!-- Auth form with login mode and enhanced contrast for accessibility -->
  <div class="auth-form-container" aria-live="polite" aria-labelledby="login-heading" role="region">
    <AuthForm initialMode="login" />
  </div>
</Layout>

<!-- Performance optimized script for better user experience -->
<script>
  // Preload critical auth form resources for faster interaction
  document.addEventListener("DOMContentLoaded", () => {
    // Preconnect to authentication API endpoint
    const preconnectLink = document.createElement("link");
    preconnectLink.rel = "preconnect";
    preconnectLink.href = "/api/auth";
    document.head.appendChild(preconnectLink);

    // Optimize form focus management
    const authContainer = document.querySelector(".auth-form-container");
    if (authContainer) {
      // Use IntersectionObserver for efficient visibility detection
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              // Form is visible, preload any additional resources if needed
              const element = entry.target as HTMLElement;
              element.style.willChange = "auto"; // Reset will-change for performance
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.1 }
      );
      observer.observe(authContainer);
    }
  });
</script>

<style>
  /* ======================================
   * LOGIN PAGE STYLES - WCAG AAA 2.2 COMPLIANT
   * Using CSS variables from global.css only
   * ====================================== */

  /* Back to home navigation - Optimized for performance */
  .back-to-home {
    margin-bottom: var(--space-md);
    text-align: left;
  }

  .back-to-home__link {
    display: inline-flex;
    align-items: center;
    min-height: var(--min-touch-size);
    min-width: var(--min-touch-size);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    color: var(--color-primary-300);
    text-decoration: none;
    transition: all var(--transition-normal);
    letter-spacing: var(--letter-spacing-base);

    /* Performance optimizations */
    contain: layout style;
    will-change: transform, background-color;

    /* Enhanced focus styles for WCAG AAA */
    outline: none;
  }

  .back-to-home__link:hover {
    background-color: var(--bg-tertiary);
    color: var(--color-primary-200);
    transform: translateX(calc(-1 * var(--space-xs)));
  }

  .back-to-home__link:focus {
    outline: var(--focus-enhanced-outline-dark);
    outline-offset: var(--focus-ring-offset);
    box-shadow: var(--focus-enhanced-shadow);
  }

  .back-to-home__icon {
    width: var(--icon-size-md);
    height: var(--icon-size-md);
    margin-right: var(--space-xs);
    color: currentColor;
  }

  /* Main heading styles */
  .login-heading {
    margin-bottom: var(--space-2xl);
    text-align: center;
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    line-height: var(--leading-enhanced);
    letter-spacing: var(--letter-spacing-enhanced);
    color: var(--text-primary);
    word-spacing: var(--word-spacing-enhanced);
  }

  /* Auth form container - Enhanced performance optimizations */
  .auth-form-container {
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    transition: all var(--transition-normal);
    animation: fadeIn var(--animation-duration-medium) ease-out;

    /* Performance optimizations */
    contain: layout style;
    will-change: opacity, transform;
  }

  /* Help text styling */
  .login-help-text {
    margin-top: var(--space-2xl);
    text-align: center;
    font-size: var(--text-sm);
    color: var(--color-primary-200);
    line-height: var(--leading-enhanced);
    letter-spacing: var(--letter-spacing-base);
    word-spacing: var(--word-spacing-enhanced);
  }

  /* Responsive design */
  @media (min-width: 768px) {
    .login-heading {
      font-size: var(--text-3xl);
    }

    .login-help-text {
      font-size: var(--text-base);
    }
  }

  @media (min-width: 1024px) {
    .login-heading {
      font-size: var(--text-4xl);
    }

    .login-help-text {
      font-size: var(--text-lg);
    }
  }

  /* Fade-in animation for better UX - GPU accelerated */
  @keyframes fadeIn {
    from {
      opacity: var(--animation-opacity-start);
      transform: translateY(var(--animation-y-offset)) translateZ(0);
    }
    to {
      opacity: var(--animation-opacity-full);
      transform: translateY(0) translateZ(0);
    }
  }

  /* Reduced motion support for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .auth-form-container {
      animation: none;
      transition: none;
    }

    .back-to-home__link {
      transition: none;
    }

    @keyframes fadeIn {
      from,
      to {
        opacity: var(--animation-opacity-full);
        transform: translateY(0);
      }
    }
  }

  /* Enhanced contrast for high contrast mode */
  @media (prefers-contrast: high) {
    .back-to-home__link {
      border: var(--border-width-thick) solid var(--border-primary);
    }

    .login-heading {
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
    }

    .auth-form-container {
      border: var(--border-width-thick) solid var(--border-primary);
    }
  }
</style>

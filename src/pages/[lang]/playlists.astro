---
import Layout from "@layouts/Layout.astro";
import { useTranslations } from "@utils/i18n";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";
import { Icon } from "astro-icon/components";

/**
 * Enable static site generation for all supported languages.
 * This ensures the playlist pages are pre-rendered at build time.
 */
export const prerender = true;

/**
 * Define supported languages and generate static paths for each language.
 * This creates separate routes for each language version of the playlist page.
 */
export async function getStaticPaths() {
  // Define all languages supported by the application
  const supportedLanguages = [
    "de",
    "en",
    "es",
    "fr",
    "it",
    "pt",
    "da",
    "nl",
    "sv",
    "fi",
  ] as const;

  // Process data for each language
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      // Try to load playlist data for the specific language
      let playlists = [];
      try {
        const playlistData = await import(
          /* @vite-ignore */ `@json/${lang}_playlist.json`
        );
        playlists = playlistData.default;
      } catch (error) {
        // Fallback to English if language file doesn't exist
        try {
          console.info(
            `No playlist data found for ${lang}, falling back to English`,
          );
          const fallbackData = await import(
            /* @vite-ignore */ `@json/en_playlist.json`
          );
          playlists = fallbackData.default;
        } catch (fallbackError) {
          console.error(
            `Error loading playlist data for ${lang}:`,
            fallbackError,
          );
        }
      }

      return {
        params: { lang },
        props: {
          lang,
          playlists,
        },
      };
    }),
  );

  return paths;
}

/**
 * Type definition for component props
 */
interface Props {
  lang: "de" | "en" | "es" | "fr" | "it" | "pt" | "da" | "nl" | "sv" | "fi";
  playlists: Playlist[];
}

/**
 * Type definition for playlist objects
 */
interface Playlist {
  headline: string;
  imageUrl: string;
  introSubline: string;
  spotifyPlaylist?: string;
  deezerPlaylist?: string;
  appleMusicPlaylist?: string;
}

// Extract data from props with default empty array for playlists
const { lang, playlists = [] } = Astro.props;

// Use the i18n utilities for translations
const t = useTranslations(lang);

// Sort playlists chronologically (assuming decade in headline format like "1950s")
const sortedPlaylists = [...playlists].sort((a, b) =>
  a.imageUrl.localeCompare(b.imageUrl, undefined, { sensitivity: "base" }),
);
---

<Layout title={t("playlist.page.title")}>
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Page heading and description -->
    <div class="text-center mb-12">
      <Headline
        title={t("playlist.page.heading")}
        level="h1"
        className="text-white font-bold text-3xl md:text-4xl mb-4"
      />
      <div class="h-1 w-24 bg-purple-500 rounded-full mx-auto mt-2 mb-6"></div>
      <Paragraph
        description={t("playlist.page.description")}
        className="max-w-2xl mx-auto text-zinc-100"
      />
    </div>

    <!-- Search and filter section -->
    <div
      class="search-filter-container bg-zinc-800/90 rounded-xl p-6 border border-zinc-700 shadow-lg mb-10"
      role="search"
    >
      <h2 class="sr-only" id="search-heading">
        {t("playlist.search.label")}
      </h2>

      <div class="flex flex-col md:flex-row gap-4 mb-4">
        <!-- Search field -->
        <div class="relative flex-grow">
          <label for="playlist-search" class="sr-only">
            {t("playlist.search.placeholder")}
          </label>
          <div class="relative">
            <div
              class="absolute inset-y-0 left-3 flex items-center pointer-events-none"
            >
              <Icon name="search" class="h-5 w-5 text-purple-400" />
            </div>
            <input
              type="search"
              id="playlist-search"
              placeholder={t("playlist.search.placeholder")}
              class="w-full py-3 pl-10 pr-4 bg-zinc-800 border-2 border-zinc-600
                    rounded-xl text-zinc-50 placeholder-zinc-300
                    focus:outline-none focus:border-purple-500 focus:ring-3
                    focus:ring-purple-500/50 transition-all duration-300"
              aria-controls="playlist-grid"
              aria-describedby="search-playlist-description"
            />
            <div id="search-playlist-description" class="sr-only">
              Results are filtered automatically as you type
            </div>
          </div>
        </div>

        <!-- Search status for screen readers -->
        <div id="search-results-status" class="sr-only" aria-live="polite">
        </div>
      </div>

      <!-- No results message (initially hidden) -->
      <div
        id="no-results"
        class="hidden flex flex-col items-center justify-center p-12 bg-gradient-to-br from-zinc-700 to-zinc-800 rounded-xl border border-zinc-600 text-center shadow-md mb-10"
        aria-live="polite"
      >
        <Icon name="search-no-results" class="w-16 h-16 text-zinc-300 mb-4" />
        <p class="text-zinc-100 text-lg font-medium">
          {t("playlist.no.results")}
        </p>
        <button
          id="reset-search"
          class="mt-4 px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg focus:outline-none focus:ring-3 focus:ring-purple-500/50 focus:ring-offset-2 focus:ring-offset-zinc-800 transition-all duration-300"
        >
          Reset search
        </button>
      </div>

      <!-- Playlist Grid -->
      <div
        id="playlist-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8"
        role="region"
        aria-label={t("playlist.page.heading")}
      >
        {
          sortedPlaylists.map((playlist, index) => {
            // Extract decade for filtering
            const decadeMatch = playlist.headline.match(/\d{4}/);
            const decade = decadeMatch
              ? decadeMatch[0].substring(0, 3) + "0s"
              : "Other";

            return (
              <div
                class="playlist-card animate-fadeIn"
                style={{ animationDelay: `${index * 0.05}s` }}
                data-searchable={`${playlist.headline.toLowerCase()} ${playlist.introSubline.toLowerCase()}`}
                data-decade={decade}
              >
                <div class="h-full bg-zinc-800 rounded-xl overflow-hidden border border-zinc-700 shadow-lg transition-all duration-300 hover:shadow-xl hover:translate-y-[-5px]">
                  <div class="p-0.5 bg-gradient-to-r from-purple-500 to-indigo-500" />

                  <div class="relative aspect-video overflow-hidden">
                    <img
                      src={
                        playlist.imageUrl ||
                        "/images/playlists/default-cover.jpg"
                      }
                      alt={`Cover image for ${playlist.headline}`}
                      class="w-full h-full object-cover"
                      loading={index < 2 ? "eager" : "lazy"}
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-900/60 to-transparent" />
                    <div class="absolute bottom-0 left-0 w-full p-4">
                      <h2 class="text-xl font-bold text-white mb-2">
                        {playlist.headline}
                      </h2>
                    </div>
                  </div>

                  <div class="p-5 space-y-4">
                    <p class="text-zinc-200 text-sm">{playlist.introSubline}</p>

                    <div class="flex flex-wrap gap-3 mt-4">
                      {playlist.spotifyPlaylist && (
                        <a
                          href={playlist.spotifyPlaylist}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-2 px-4 py-2 bg-[#1DB954] rounded-full text-white text-sm font-medium hover:bg-opacity-90 transition-all"
                          aria-label={`${t("playlist.listen.spotify")} - ${playlist.headline}`}
                        >
                          <Icon name="spotify" class="h-4 w-4" />
                          <span>Spotify</span>
                        </a>
                      )}

                      {playlist.deezerPlaylist && (
                        <a
                          href={playlist.deezerPlaylist}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-2 px-4 py-2 bg-[#FF0092] rounded-full text-white text-sm font-medium hover:bg-opacity-90 transition-all"
                          aria-label={`${t("playlist.listen.deezer")} - ${playlist.headline}`}
                        >
                          <Icon name="deezer" class="h-4 w-4" />
                          <span>Deezer</span>
                        </a>
                      )}

                      {playlist.appleMusicPlaylist && (
                        <a
                          href={playlist.appleMusicPlaylist}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-2 px-4 py-2 bg-[#FB233B] rounded-full text-white text-sm font-medium hover:bg-opacity-90 transition-all"
                          aria-label={`${t("playlist.listen.apple")} - ${playlist.headline}`}
                        >
                          <Icon name="apple" class="h-4 w-4" />
                          <span>Apple Music</span>
                        </a>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            );
          })
        }
      </div>

      <!-- Back to top button -->
      <button
        id="back-to-top"
        class="fixed bottom-8 right-8 p-3 bg-purple-600 text-white rounded-full shadow-lg opacity-0 invisible transition-all duration-300 hover:bg-purple-500 focus:outline-none focus:ring-3 focus:ring-purple-500/50 focus:ring-offset-2 focus:ring-offset-zinc-800"
        aria-label="Back to top of page"
      >
        <Icon name="arrow-up" class="h-6 w-6" />
      </button>
    </div>
  </div>

  <style>
    /* Improved color contrast for WCAG AAA (7:1) */
    :root {
      --text-primary: #ffffff; /* Maximum contrast */
      --text-secondary: #e2e2e7; /* Higher contrast than standard zinc-300 */
      --bg-card: #27272a; /* zinc-800 */
      --border-card: rgba(161, 161, 170, 0.3); /* zinc-400 with transparency */
      --accent-primary: #a855f7; /* purple-500 */
      --accent-secondary: #c084fc; /* purple-400 */
    }

    /* Improved focus states for keyboard navigation */
    :focus-visible {
      outline: 3px solid var(--accent-primary);
      outline-offset: 3px;
    }

    /* Animations for cards */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out forwards;
      opacity: 0;
    }

    /* Improved back-to-top button animation */
    #back-to-top.visible {
      opacity: 1;
      visibility: visible;
    }

    /* Disable animations if user prefers reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *,
      ::before,
      ::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }

      .animate-fadeIn {
        opacity: 1;
        animation: none;
        transform: translateY(0);
      }

      .playlist-card:hover {
        transform: none !important;
        box-shadow: none !important;
      }
    }
  </style>

  <script>
    /**
     * Playlist Page Manager
     *
     * This script handles the interactive functionality of the playlist page:
     * - Search and filtering system for playlists
     * - Decade-based filtering
     * - Accessibility for screen readers
     * - Back-to-top button functionality
     */
    document.addEventListener("DOMContentLoaded", function () {
      // Cache DOM elements for better performance
      const searchInput = document.getElementById(
        "playlist-search",
      ) as HTMLInputElement;
      const decadeFilter = document.getElementById(
        "decadeFilter",
      ) as HTMLSelectElement;
      const playlistCards = document.querySelectorAll(".playlist-card");
      const noResultsElement = document.getElementById("no-results");
      const searchStatusElement = document.getElementById(
        "search-results-status",
      );
      const resetSearchButton = document.getElementById("reset-search");
      const backToTopButton = document.getElementById("back-to-top");

      // Filter playlists based on search input and decade selection
      function filterPlaylists() {
        if (!searchInput) return;

        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedDecade = decadeFilter?.value || "all";

        let visibleCount = 0;

        // Filter playlist cards by search term and decade
        playlistCards.forEach((card) => {
          const searchable = card.getAttribute("data-searchable") || "";
          const decade = card.getAttribute("data-decade") || "";

          const matchesSearch =
            searchTerm === "" || searchable.includes(searchTerm);
          const matchesDecade =
            selectedDecade === "all" || decade === selectedDecade;

          const isVisible = matchesSearch && matchesDecade;

          if (isVisible) {
            card.classList.remove("hidden");
            visibleCount++;
          } else {
            card.classList.add("hidden");
          }
        });

        // Show/hide "No results" message
        if (noResultsElement) {
          noResultsElement.classList.toggle("hidden", visibleCount > 0);
        }

        // Update status for screen readers
        if (searchStatusElement) {
          if (visibleCount === 0) {
            searchStatusElement.textContent = "No playlists found.";
          } else if (visibleCount === 1) {
            searchStatusElement.textContent = "1 playlist found.";
          } else if (visibleCount === playlistCards.length) {
            searchStatusElement.textContent = `All ${visibleCount} playlists are displayed.`;
          } else {
            searchStatusElement.textContent = `${visibleCount} of ${playlistCards.length} playlists found.`;
          }
        }
      }

      // Event listeners for search and filter
      if (searchInput) {
        searchInput.addEventListener("input", filterPlaylists);
      }

      if (decadeFilter) {
        decadeFilter.addEventListener("change", filterPlaylists);
      }

      // Reset search and filters
      if (resetSearchButton) {
        resetSearchButton.addEventListener("click", function () {
          if (searchInput) searchInput.value = "";
          if (decadeFilter) decadeFilter.value = "all";
          filterPlaylists();
          searchInput.focus();
        });
      }

      // Back to top button functionality
      if (backToTopButton) {
        window.addEventListener("scroll", function () {
          const scrollTop =
            window.scrollY || document.documentElement.scrollTop;

          if (scrollTop > 500) {
            backToTopButton.classList.add("visible");
          } else {
            backToTopButton.classList.remove("visible");
          }
        });

        backToTopButton.addEventListener("click", function () {
          window.scrollTo({
            top: 0,
            behavior: "smooth",
          });
        });
      }

      // Initialize the filter on page load
      filterPlaylists();
    });
  </script>
</Layout>

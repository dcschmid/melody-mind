---
import Layout from "../../layouts/Layout.astro";
import StartOverlay from "../../components/Overlays/StartOverlay.astro";
import TimeupsOverlay from "../../components/Overlays/TimeupsOverlay.astro";
import IntroText from "../../components/Shared/IntroText.astro";
import Timer from "../../components/Round/Timer.astro";
import CoverFlow from "../../components/Round/CoverFlow.astro";
import { shuffleArray } from "../../utils/share/shuffleArray";
import categories from "../../json/categories.json";
import Joker from "../../components/Round/Joker.astro";
import ShowCoins from "../../components/Shared/ShowCoins.astro";
import { fetchRoundUIData } from "../../utils/share/fetchRoundUIData";

const { category, round } = Astro.params;

const currentCategory = categories.find((cat) => cat.slug === category);
const currentRound = currentCategory?.rounds.find((rnd) => rnd.slug === round);

const randomizedCoverflowData = shuffleArray(currentRound?.coverData ?? []);
const jokerText = randomizedCoverflowData?.[0].jokerText;
const jokerData = randomizedCoverflowData?.[0].data;
const jokerCoverUrl = randomizedCoverflowData?.[0].coverSrc;

const uiData = await fetchRoundUIData(round as string);
---

<Layout title=`${currentCategory?.name} - ${uiData?.headline}` ` showUserLink={false}>
  <div slot="left-headercol">
    <ShowCoins />
  </div>

  <StartOverlay headline={uiData?.headline} whiteText={uiData?.startOverlayText} />

  <TimeupsOverlay />

  <IntroText headline={uiData?.headline} subline={uiData?.introSubline} whiteText={uiData?.sortToText} />

  <CoverFlow
    randomizedCoverflowData={randomizedCoverflowData}
    upText={uiData?.upToLabel}
    downText={uiData?.downToLabel}
    dataCategory={category}
    dataSolution={currentRound?.solutionsArray}
    dataRound={round}
  />

  <div class="timerSection">
    <Joker jokerCoverUrl={jokerCoverUrl} jokerText={jokerText} jokerData={jokerData} />

    <Timer minutes="01" seconds="30" />
  </div>
</Layout>

<style>
  .timerSection {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: var(--spacing-spacing-xxl);
  }
</style>

<script>
  // Import functions from the utils directory
  /**
   * This function handles the end round click event
   * It initializes the overlay and cover elements,
   * and handles the end round click event
   */
  import { handleEndRoundClick } from "../../utils/round/handleEndRoundClick";
  /**
   * This function initializes the cover elements
   */
  import { initializeCovers } from "../../utils/round/initializeCovers";
  /**
   * This function initializes the overlay with the initial time remaining and timer interval
   */
  import { initializeOverlay } from "../../utils/round/initializeOverlay";
  import { showJoker } from "../../utils/round/showJoker";

  // Set the initial time remaining and timer interval
  /**
   * This variable stores the initial time remaining in seconds
   */
  let timeRemaining = 90;
  /**
   * This variable stores the initial timer interval in milliseconds
   */
  let timerInterval: number | 0 = 0;

  /**
   * Get the category value from the data attribute of the coverFlowRoot element
   */
  // Select the coverFlowRoot element and typecast it to HTMLElement
  const categoryDataElement = document.querySelector(".coverFlowRoot") as HTMLElement;
  // Get the value of the data-category attribute from the coverFlowRoot element
  const categoryValue = categoryDataElement.getAttribute("data-category")!;
  // Get the value of the data-round attribute from the coverFlowRoot element
  const dataRound = categoryDataElement.getAttribute("data-round")!;
  // Get the value of the data-solution attribute from the coverFlowRoot element
  const solutionAttribute = categoryDataElement.getAttribute("data-solution");
  // If the solution attribute exists, parse it as a JSON array, otherwise assign an empty array
  const solutionArray = solutionAttribute ? JSON.parse(solutionAttribute) : [];

  /**
   * Add an event listener to the window load event
   * This function is called when the page has finished loading
   * It initializes the round game, resets the local storage,
   * and handles the end round click event
   */
  window.addEventListener("load", function () {
    // Initialize the overlay and cover elements
    initializeOverlay(timerInterval, timeRemaining); // Initialize the overlay with the initial time remaining and timer interval
    initializeCovers(); // Initialize the cover elements
    showJoker(); // Call the showJoker function

    // Handle the end round click event
    handleEndRoundClick(
      solutionArray, // Solution for the current round
      `/${categoryValue}/result/${dataRound}`, // URL for the results page
      `${categoryValue}-AllCorrect-${dataRound}`, // Key for the local storage item that stores the correct answers
      `${categoryValue}-Points-${dataRound}`, // Key for the local storage item that stores the points earned in this round
      `${categoryValue}-Results-${dataRound}` // Key for the local storage item that stores the results for this round
    );
  });
</script>

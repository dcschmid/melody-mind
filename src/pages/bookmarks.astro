---
import Layout from "@layouts/Layout.astro";
import PageShell from "@components/Shared/PageShell.astro";
import BookmarkManager from "@components/BookmarkManager.astro";
import { buildPageSeo, type StructuredData } from "@utils/seo/buildPageSeo";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { normalizeDate } from "@utils/content/dateUtils";
import { resolvePageUrl } from "@utils/siteUrls";

export const prerender = true;

const title = "Bookmarks";
const description =
  "Your saved Melody Mind Knowledge articles, stored locally in your browser.";
const currentUrl = resolvePageUrl(Astro.site, "/bookmarks");

const breadcrumbs = [
  { name: "Home", url: resolvePageUrl(Astro.site, "/") },
  { name: title, url: currentUrl },
];

let entries: Array<{
  slug: string;
  title: string;
  description?: string;
  updatedAt?: string;
}> = [];

try {
  const collection = await getCollectionCached("knowledge-en").catch(() => []);
  entries = (collection || [])
    .map((entry: any) => {
      const rawSlug = entry?.slug || entry?.id;
      if (!rawSlug) return null;
      const slug = String(rawSlug).replace(/^\/+/, "");
      const updated = normalizeDate(entry?.data?.updatedAt || entry?.data?.createdAt);
      return {
        slug,
        title: entry?.data?.title || slug,
        description: entry?.data?.description || "",
        updatedAt: updated ? updated.toISOString() : "",
      };
    })
    .filter(Boolean) as typeof entries;
} catch (e) {
  globalThis.console?.warn?.("bookmarks: collection load issue", {
    error: (e as any)?.message || e,
  });
}

const pageSeo = buildPageSeo({
  title,
  description,
  url: currentUrl,
  contentKind: "generic",
  breadcrumbs,
  structuredData: [] as StructuredData[],
  enrichedParts: [title, description],
  fallbackKeywords: ["bookmarks", "saved articles", "local storage"],
  keywordLimit: 24,
  maxDescription: 155,
  image: "/melody-mind.jpg",
  publishDate: new Date(),
  modifiedDate: new Date(),
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo}>
  <PageShell className="page-shell--aurora page-shell--grid">
    <div class="bookmarks-page">
      <header class="bookmarks-page__header">
        <p class="bookmarks-page__eyebrow">Library</p>
        <h1 class="bookmarks-page__title">Bookmarks</h1>
        <p class="bookmarks-page__lead">
          Saved locally in your browser. Nothing is synced or tracked.
        </p>
      </header>

      <section class="bookmarks-panel" aria-live="polite">
        <BookmarkManager entries={entries} />
      </section>
    </div>
  </PageShell>
</Layout>

<style>
  .bookmarks-page {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .bookmarks-page__header {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .bookmarks-page__eyebrow {
    font-size: 1.125rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    font-weight: 600;
    color: var(--color-gn-amber-300);
  }

  .bookmarks-page__title {
    margin: 0;
    font-size: 2.25rem;
    color: var(--gn-ink);
  }

  .bookmarks-page__lead {
    margin: 0;
    font-size: 1.125rem;
    color: var(--gn-ink-muted);
    max-width: 60ch;
  }

  .bookmarks-panel {
    position: relative;
    border-radius: 1.5rem;
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    background: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
    box-shadow: var(--gn-offset-shadow);
    padding: 1.5rem;
  }

  .bookmarks-panel::after {
    content: "";
    position: absolute;
    inset: 4px;
    border-radius: 1.2rem;
    border: 1px solid var(--gn-panel-inner);
    pointer-events: none;
  }
</style>

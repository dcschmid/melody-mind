---
/**
 * Knowledge Article Page (English only)
 */
import { Picture } from "astro:assets";
import Layout from "@layouts/Layout.astro";
import ButtonLink from "@components/ButtonLink.astro";
import { useTranslations } from "@utils/i18n";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";
import Prose from "@components/Prose.astro";
import TableOfContents from "@components/TableOfContents.astro";
import KnowledgeQuiz from "@components/Knowledge/KnowledgeQuiz.astro";
import KnowledgeTakeaways from "@components/Knowledge/KnowledgeTakeaways.astro";
import BackToTop from "@components/Shared/BackToTop.astro";
import { Icon } from "astro-icon/components";
import { buildPageSeo } from "@utils/seo/buildPageSeo";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { getReadingTime } from "@utils/readingTime";
import { resolveAbsoluteUrl, resolveBaseUrl, resolvePageUrl } from "@utils/siteUrls";
import { getKnowledgeQuiz } from "../../data/knowledgeQuizzes";
import { quizDecades } from "../../data/knowledgeQuizzes";
import { knowledgeTakeaways, takeawaysDecades } from "../../data/knowledgeTakeaways";

export const prerender = true;

export async function getStaticPaths() {
  const entries: any[] = await getCollectionCached("knowledge-en").catch(() => []);
  const paths: Array<{ params: { slug: string }; props: { entry: any } }> = [];
  for (const entry of entries) {
    const slug = entry?.slug || entry?.id;
    if (!slug) continue;
    paths.push({ params: { slug }, props: { entry } });
  }
  return paths;
}

const lang = "en";
let entry: any = (Astro.props as { entry?: any }).entry;

const slugParam = (Astro as any).params?.slug;
const resolvedSlug = Array.isArray(slugParam) ? slugParam.join("/") : slugParam;

if (!entry) {
  try {
    const articles: any[] = await getCollectionCached("knowledge-en").catch(() => []);
    if (resolvedSlug) {
      entry = articles.find((a) => a.slug === resolvedSlug || a.id === resolvedSlug);
    }
  } catch (e) {
    globalThis.console?.warn?.("knowledge article: collection load issue (fallback)", {
      error: (e as any)?.message || e,
    });
  }
}

if (!entry) {
  return new Response("Not found", { status: 404 });
}

const slugKey = resolvedSlug || entry?.slug || entry?.id || "";
const quizQuestions = quizDecades.includes(slugKey as (typeof quizDecades)[number])
  ? getKnowledgeQuiz(slugKey)
  : [];

if (!entry.data.readingTime && entry.body) {
  try {
    entry = {
      ...entry,
      data: {
        ...entry.data,
        readingTime: getReadingTime(entry.body || "", { languageCode: lang }).minutes,
      },
    };
  } catch {
    // ignore reading time calculation errors
  }
}

const t = useTranslations(lang);

const { headings, Content } = await entry.render();
const mergedHeadings = headings;
const fallbackTakeaways = takeawaysDecades.includes(
  slugKey as (typeof takeawaysDecades)[number]
)
  ? knowledgeTakeaways[slugKey] || []
  : [];
const takeaways =
  entry.data.takeaways && entry.data.takeaways.length
    ? entry.data.takeaways
    : fallbackTakeaways;

const rawImage = entry.data.image;
const isValidImage =
  typeof rawImage === "string" && /\.(png|jpg|jpeg|webp|avif)$/i.test(rawImage);
const imageSource = isValidImage ? rawImage : "/default-cover.jpg";
const title = entry.data.title;
const description = entry.data.description;
const pageContent = `${title} ${description} ${entry.data.keywords?.join(" ") || ""}`;
const optimizedDescription = pageContent;

const baseSite = resolveBaseUrl(Astro.site);
const imageAbsolute = resolveAbsoluteUrl(Astro.site, imageSource);
const imageWidth = 1200;
const imageHeight = 800;

const canonical = resolvedSlug
  ? resolvePageUrl(Astro.site, `/knowledge/${resolvedSlug}`)
  : resolvePageUrl(Astro.site, "/");
const podcastBase = "https://podcasts.melody-mind.de";
const podcastSlug =
  [entry.data.podcastSlug, entry.data.podcast]
    .find((value) => typeof value === "string" && value.trim())
    ?.trim() || "";
const podcastUrl =
  typeof entry.data.podcastUrl === "string" && entry.data.podcastUrl.trim()
    ? entry.data.podcastUrl.trim()
    : podcastSlug
      ? `${podcastBase}/${encodeURI(podcastSlug)}`
      : null;
const seoBreadcrumbsBase = [
  { name: t("nav.home") || "Home", url: resolvePageUrl(Astro.site, "/") },
];
const seoCategoryCrumb =
  entry.data.category && typeof entry.data.category === "string"
    ? {
        name: entry.data.category,
        url: resolvePageUrl(Astro.site, `/categories/${entry.data.category}`),
      }
    : null;
const seoBreadcrumbs = [
  ...seoBreadcrumbsBase,
  ...(seoCategoryCrumb ? [seoCategoryCrumb] : []),
  { name: title, url: canonical },
];
const breadcrumbs = seoBreadcrumbs.map((crumb) => ({
  ...crumb,
  url: crumb.url ? crumb.url.replace(baseSite, "") || "/" : crumb.url,
}));
const schemaType = podcastUrl ? "PodcastEpisode" : "Article";
const structuredDataExtra = [
  {
    "@context": "https://schema.org",
    "@type": schemaType,
    headline: title,
    name: title,
    description: description,
    image: {
      "@type": "ImageObject",
      url: imageAbsolute,
      width: imageWidth,
      height: imageHeight,
    },
    url: canonical,
    author: { "@type": "Organization", name: "Melody Mind" },
    publisher: {
      "@type": "Organization",
      name: "Melody Mind",
      logo: {
        "@type": "ImageObject",
        url: "https://melody-mind.de/melody-mind.png",
      },
    },
    ...(podcastUrl
      ? {
          isPartOf: {
            "@type": "PodcastSeries",
            name: "Melody Mind Podcasts",
            url: podcastBase,
          },
          potentialAction: {
            "@type": "ListenAction",
            target: podcastUrl,
          },
        }
      : {}),
    datePublished: entry.data.createdAt?.toISOString(),
    dateModified: entry.data.updatedAt?.toISOString(),
    mainEntityOfPage: { "@type": "WebPage", "@id": canonical },
    inLanguage: lang,
    keywords: entry.data.keywords?.join(", ") || "",
    articleSection: t("knowledge.title") || "Music Knowledge",
    wordCount: entry.body?.length || 0,
  },
];

const wordsCount = entry.body ? entry.body.trim().split(/\s+/).length : 0;
const readingResult = getReadingTime(entry.body || "", { languageCode: lang });
const publishedDate = new Date(
  entry.data.updatedAt || entry.data.createdAt || new Date()
);
const publishedDateLabel = publishedDate.toLocaleDateString(lang, {
  year: "numeric",
  month: "long",
  day: "numeric",
});

function translate(key: string, fallback: string): string {
  try {
    return t(key);
  } catch {
    return fallback;
  }
}

const pageSeo = buildPageSeo({
  title,
  description: optimizedDescription,
  url: canonical,
  contentKind: "generic",
  breadcrumbs: seoBreadcrumbs,
  structuredData: structuredDataExtra,
  enrichedParts: [title, description].filter(Boolean) as string[],
  fallbackKeywords: (entry.data.keywords || []).slice(0, 20),
  keywordLimit: 24,
  maxDescription: 155,
  image: imageAbsolute,
  publishDate: entry.data.createdAt ? new Date(entry.data.createdAt) : new Date(),
  modifiedDate: entry.data.updatedAt ? new Date(entry.data.updatedAt) : new Date(),
  index: true,
  follow: true,
  autoSocialImage: false,
});

const shareUrl = canonical;
const shareTitle = `${title} | Melody Mind`;
const shareText = `${title} - ${description || ""}`.trim();
const shareMailSubject = encodeURIComponent(shareTitle);
const shareMailBody = encodeURIComponent(`${description || ""}\n\n${shareUrl}`);
const mastodonShareUrl = `https://mastodon.social/share?text=${encodeURIComponent(
  `${shareText} ${shareUrl}`
)}`;
const storageSlug = resolvedSlug || entry?.slug || entry?.id || "";
const storageUpdatedAtRaw = entry?.data?.updatedAt || entry?.data?.createdAt || "";
const parsedStorageDate = storageUpdatedAtRaw ? new Date(storageUpdatedAtRaw) : null;
const storageUpdatedAt =
  parsedStorageDate && !Number.isNaN(parsedStorageDate.valueOf())
    ? parsedStorageDate.toISOString()
    : "";
---

<Layout {pageSeo} {breadcrumbs} mainLabelledBy="article-title">
  <Fragment slot="head"></Fragment>

  <div class="reading-progress">
    <div
      id="reading-progress-bar"
      class="reading-progress__bar"
      role="presentation"
      aria-hidden="true"
    >
    </div>
    <span id="reading-progress-label" class="knowledge__sr">Reading progress: 0%</span>
  </div>

  <div class="knowledge">
    <div class="knowledge__backdrop"></div>
    <div class="knowledge__texture"></div>

    <div class="knowledge__container">
      <div class="knowledge__hero">
        <header class="panel knowledge__hero-panel">
          <div class="knowledge__meta">
            <span class="knowledge__pill knowledge__pill--label">In-depth report</span>
            <span class="knowledge__pill">
              <Icon name="calendar" class="knowledge__pill-icon" aria-hidden="true" />
              <time datetime={publishedDate.toISOString()}>{publishedDateLabel}</time>
            </span>
            <span class="knowledge__pill">
              <Icon name="clock" class="knowledge__pill-icon" aria-hidden="true" />
              <span>
                {readingResult.minutes}
                {t("knowledge.reading.time")}
              </span>
            </span>
            {
              entry.data.category ? (
                <span class="knowledge__pill">
                  <Icon
                    name="tag"
                    class="knowledge__pill-icon knowledge__pill-icon--teal"
                    aria-hidden="true"
                  />
                  <span>{entry.data.category}</span>
                </span>
              ) : null
            }
          </div>
          <Headline
            level="h1"
            textSize="xl"
            textAlign="left"
            className="knowledge__title"
            id="article-title"
          >
            {entry.data.title}
          </Headline>
          <Paragraph textSize="lg" textAlign="left" className="knowledge__summary">
            {entry.data.description}
          </Paragraph>
          <div class="knowledge__stats">
            <div class="knowledge__pill">
              <Icon
                name="file-text"
                class="knowledge__pill-icon knowledge__pill-icon--teal"
                aria-hidden="true"
              />
              <span>{t("knowledge.word_count", { count: wordsCount })}</span>
            </div>
            {
              quizQuestions.length ? (
                <a href="#knowledge-quiz" class="knowledge__quiz-link">
                  <Icon
                    name="help-circle"
                    class="knowledge__pill-icon knowledge__pill-icon--teal"
                    aria-hidden="true"
                  />
                  <span>Jump to quiz</span>
                </a>
              ) : null
            }
            <button
              type="button"
              class="bookmark-button"
              data-bookmark-toggle
              aria-pressed="false"
            >
              <Icon name="bookmark" class="bookmark-button__icon" aria-hidden="true" />
              <span data-bookmark-label>Save</span>
            </button>
          </div>
        </header>

        <div class="knowledge__aside">
          <div class="panel knowledge__media-panel">
            {
              imageSource ? (
                <div class="knowledge__media-frame">
                  <div class="knowledge__media-overlay" aria-hidden="true" />
                  <Picture
                    class="knowledge__media-image"
                    src={imageSource}
                    widths={[600, 800, 1000, 1200]}
                    sizes="(max-width: 640px) 100vw, (max-width: 1024px) 600px, (max-width: 1280px) 800px, 1000px"
                    formats={["avif", "webp", "jpg"]}
                    alt={entry.data.title}
                    loading="eager"
                    fetchpriority="high"
                    width={1200}
                    height={800}
                    decoding="async"
                  />
                </div>
              ) : (
                <div
                  class="knowledge__media-placeholder"
                  role="img"
                  aria-label={t("category.no_image_available")}
                >
                  <div class="knowledge__media-placeholder-content">
                    <Icon
                      name="image"
                      class="knowledge__media-placeholder-icon"
                      aria-hidden="true"
                    />
                    <span>{t("category.no_image_available")}</span>
                  </div>
                </div>
              )
            }
          </div>

          {
            entry.data.playlists?.spotifyPlaylist ||
            entry.data.playlists?.deezerPlaylist ? (
              <div class="panel panel--compact">
                <div class="knowledge__panel-title">
                  <Icon name="music" class="knowledge__panel-icon" aria-hidden="true" />
                  Play this article's playlist on:
                </div>
                <div class="knowledge__panel-actions">
                  {entry.data.playlists?.spotifyPlaylist ? (
                    <ButtonLink
                      href={entry.data.playlists?.spotifyPlaylist}
                      variant="secondary"
                      icon="spotify"
                      className="button-link--sm"
                      aria-label={`Open the ${t("musicPlatforms.platform.spotify")} playlist for ${entry.data.title}`}
                    >
                      {t("musicPlatforms.platform.spotify")}
                    </ButtonLink>
                  ) : null}
                  {entry.data.playlists?.deezerPlaylist ? (
                    <ButtonLink
                      href={entry.data.playlists?.deezerPlaylist}
                      variant="secondary"
                      icon="deezer"
                      className="button-link--sm"
                      aria-label={`Open the ${t("musicPlatforms.platform.deezer")} playlist for ${entry.data.title}`}
                    >
                      {t("musicPlatforms.platform.deezer")}
                    </ButtonLink>
                  ) : null}
                </div>
              </div>
            ) : null
          }
        </div>
      </div>

      <div class="knowledge__body">
        <div class="knowledge__main">
          {
            podcastUrl ? (
              <div class="panel panel--compact knowledge__podcast-wide">
                <div class="knowledge__podcast">
                  <div class="knowledge__podcast-icon">
                    <Icon name="headphones" aria-hidden="true" />
                  </div>
                  <div class="knowledge__podcast-body">
                    <div class="knowledge__podcast-label">Podcast companion</div>
                    <div class="knowledge__podcast-text">
                      Listen to the episode for this decade or explore the full podcast
                      series.
                    </div>
                    <div class="knowledge__podcast-actions">
                      <ButtonLink
                        href={podcastUrl}
                        icon="headphones"
                        className="button-link--md"
                        aria-label={`Open the podcast page for ${entry.data.title}`}
                      >
                        Open podcast page
                      </ButtonLink>
                      <ButtonLink
                        href={podcastBase}
                        variant="secondary"
                        icon="mic"
                        className="button-link--md"
                        aria-label="Browse all Melody Mind podcasts"
                      >
                        All podcast episodes
                      </ButtonLink>
                    </div>
                  </div>
                </div>
              </div>
            ) : null
          }

          <TableOfContents headings={mergedHeadings} lang={lang} />

          {takeaways.length ? <KnowledgeTakeaways items={takeaways} /> : null}

          <article id="article-content" class="panel knowledge-article">
            <div id="article-title" class="knowledge__title-sr">{entry.data.title}</div>
            <div
              role="region"
              aria-labelledby="article-title"
              aria-label={translate("accessibility.main_content", "Main content")}
            >
              <Prose fullWidth={true}>
                <Content />
              </Prose>
            </div>
          </article>

          {
            quizQuestions.length ? (
              <KnowledgeQuiz title="Quick Quiz" questions={quizQuestions} />
            ) : null
          }

          <section
            class="panel panel--compact knowledge-share"
            id="share-section"
            aria-labelledby="share-section-title"
            data-share-url={shareUrl}
            data-share-title={shareTitle}
            data-share-text={shareText}
            data-share-success={translate("knowledge.share.copied", "Link copied!")}
            data-share-error={translate(
              "knowledge.share.copy_error",
              "Copy failed - please copy it manually."
            )}
            data-share-fallback={translate(
              "knowledge.share.native_fallback",
              "Sharing isn't available here, so we've copied the link for you."
            )}
          >
            <div class="knowledge-share__header">
              <h2 class="knowledge-share__title" id="share-section-title">
                <Icon name="share-2" class="knowledge__panel-icon" aria-hidden="true" />
                <span>
                  {
                    translate(
                      "knowledge.share.heading",
                      "Share this article (privacy-friendly)"
                    )
                  }
                </span>
              </h2>
              <div class="knowledge-share__actions">
                <button
                  type="button"
                  data-share="native"
                  class="share-button share-button--primary"
                  aria-label={translate(
                    "knowledge.share.native",
                    "Share via your device"
                  )}
                >
                  <Icon name="send" class="share-button__icon" aria-hidden="true" />
                  <span>{translate("knowledge.share.native", "Share")}</span>
                </button>
                <button
                  type="button"
                  data-share="copy"
                  class="share-button"
                  aria-label={translate(
                    "knowledge.share.copy",
                    "Copy link to this article"
                  )}
                >
                  <Icon name="copy" class="share-button__icon" aria-hidden="true" />
                  <span>{translate("knowledge.share.copy", "Copy link")}</span>
                </button>
                <a
                  href={`mailto:?subject=${shareMailSubject}&body=${shareMailBody}`}
                  class="share-button"
                  aria-label={translate("knowledge.share.email", "Share via email")}
                >
                  <Icon name="mail" class="share-button__icon" aria-hidden="true" />
                  <span>{translate("knowledge.share.email", "Email")}</span>
                </a>
                <a
                  href={mastodonShareUrl}
                  target="_blank"
                  rel="noreferrer noopener"
                  class="share-button"
                  aria-label={translate(
                    "knowledge.share.mastodon",
                    "Share on Mastodon (opens in a new tab)"
                  )}
                >
                  <Icon
                    name="message-circle"
                    class="share-button__icon"
                    aria-hidden="true"
                  />
                  <span>{translate("knowledge.share.mastodon", "Mastodon")}</span>
                </a>
              </div>
            </div>
            <p data-share-status class="knowledge-share__note" aria-live="polite">
              {
                translate(
                  "knowledge.share.privacy_note",
                  "Privacy-friendly: nothing loads until you click a share option."
                )
              }
            </p>
          </section>

          <div class="knowledge__back">
            <ButtonLink
              href="/"
              icon="arrow-left"
              aria-label={translate("knowledge.back.to.list", "Back to knowledge list")}
            >
              <span>{translate("knowledge.back.to.list", "Back to knowledge list")}</span>
            </ButtonLink>
          </div>
        </div>
      </div>
      <div
        id="recent-read-data"
        data-slug={storageSlug}
        data-title={title}
        data-updated-at={storageUpdatedAt}
        hidden
      >
      </div>
    </div>
  </div>

  <script>
    (() => {
      const shareSection = document.getElementById("share-section");
      if (!shareSection) return;

      const shareUrl = shareSection.dataset.shareUrl || "";
      const shareTitle = shareSection.dataset.shareTitle || "";
      const shareText = shareSection.dataset.shareText || "";
      const copySuccessMessage = shareSection.dataset.shareSuccess || "";
      const copyErrorMessage = shareSection.dataset.shareError || "";
      const nativeShareUnavailable = shareSection.dataset.shareFallback || "";
      const statusEl = shareSection.querySelector("[data-share-status]");
      const defaultStatus = statusEl?.textContent || "";
      let resetTimer: number | undefined;

      const setStatus = (message: string | null) => {
        if (!statusEl) return;
        statusEl.textContent = message;
        if (resetTimer) window.clearTimeout(resetTimer);
        resetTimer = window.setTimeout(() => {
          statusEl.textContent = defaultStatus;
        }, 4500);
      };

      const copyLink = async () => {
        try {
          if (!navigator.clipboard) throw new Error("clipboard unavailable");
          await navigator.clipboard.writeText(shareUrl);
          setStatus(copySuccessMessage);
        } catch {
          setStatus(copyErrorMessage);
        }
      };

      const copyButton = document.querySelector('[data-share="copy"]');
      copyButton?.addEventListener("click", () => copyLink());

      const nativeButton = document.querySelector('[data-share="native"]');
      nativeButton?.addEventListener("click", async () => {
        if (navigator.share) {
          try {
            await navigator.share({ title: shareTitle, text: shareText, url: shareUrl });
            setStatus(copySuccessMessage);
            return;
          } catch (error: any) {
            if (error?.name === "AbortError") return;
          }
        }

        setStatus(nativeShareUnavailable);
        copyLink();
      });
    })();
  </script>

  <script>
    (() => {
      const storageKey = "mm_recent_reads";
      const dataEl = document.getElementById("recent-read-data");
      if (!dataEl) return;
      const recentEntry = {
        slug: dataEl.dataset.slug || "",
        title: dataEl.dataset.title || "",
        updatedAt: dataEl.dataset.updatedAt || "",
      };

      if (!recentEntry.slug || !recentEntry.title) return;
      if (typeof window === "undefined" || !window.localStorage) return;

      try {
        const normalizedSlug = recentEntry.slug.replace(/^\/+/, "");
        const raw = window.localStorage.getItem(storageKey);
        const parsed = raw ? JSON.parse(raw) : [];
        const items = Array.isArray(parsed)
          ? parsed.filter(
              (item) =>
                item && typeof item.slug === "string" && typeof item.title === "string"
            )
          : [];

        const next = [
          { ...recentEntry, slug: normalizedSlug },
          ...items.filter((item) => item.slug !== normalizedSlug),
        ];
        window.localStorage.setItem(storageKey, JSON.stringify(next.slice(0, 3)));
      } catch {
        // ignore storage errors
      }
    })();
  </script>

  <script>
    (() => {
      const storageKey = "mm_bookmarks";
      const dataEl = document.getElementById("recent-read-data");
      const button = document.querySelector("[data-bookmark-toggle]");
      const label = button?.querySelector("[data-bookmark-label]");
      if (!dataEl || !button || !label) return;

      const slug = (dataEl.dataset.slug || "").replace(/^\/+/, "");
      if (!slug) return;

      const load = () => {
        try {
          const raw = window.localStorage?.getItem(storageKey);
          const parsed = raw ? JSON.parse(raw) : [];
          return Array.isArray(parsed)
            ? parsed.filter((item) => typeof item === "string")
            : [];
        } catch {
          return [];
        }
      };

      const save = (items: string[]) => {
        try {
          window.localStorage?.setItem(storageKey, JSON.stringify(items));
        } catch {
          // ignore storage errors
        }
      };

      const update = (isSaved: boolean) => {
        button.setAttribute("aria-pressed", isSaved ? "true" : "false");
        (button as HTMLElement).dataset.bookmarkState = isSaved ? "saved" : "empty";
        label.textContent = isSaved ? "Saved" : "Save";
      };

      let items = load();
      update(items.includes(slug));

      button.addEventListener("click", () => {
        items = load();
        if (items.includes(slug)) {
          items = items.filter((item) => item !== slug);
        } else {
          items = [slug, ...items.filter((item) => item !== slug)];
        }
        save(items);
        update(items.includes(slug));
      });
    })();
  </script>

  <script>
    (() => {
      const bar = document.getElementById("reading-progress-bar");
      const label = document.getElementById("reading-progress-label");
      if (!bar || !label) return;
      const progressData = document.getElementById("recent-read-data");
      const progressSlug = progressData?.dataset.slug
        ? progressData.dataset.slug.replace(/^\/+/, "")
        : "";
      const progressKey = "mm_read_progress";

      const prefersReduced =
        window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches ?? false;
      if (!prefersReduced) {
        bar.style.transition = "width 120ms ease-out";
      }

      const getProgressStore = () => {
        if (!progressSlug) return null;
        try {
          const raw = window.localStorage?.getItem(progressKey);
          const parsed = raw ? JSON.parse(raw) : {};
          return parsed && typeof parsed === "object" ? parsed : {};
        } catch {
          return {};
        }
      };

      const setProgressStore = (store: Record<string, unknown>) => {
        if (!progressSlug) return;
        try {
          window.localStorage?.setItem(progressKey, JSON.stringify(store));
        } catch {
          // ignore storage errors
        }
      };

      const restoreProgress = () => {
        if (!progressSlug) return;
        const store = getProgressStore();
        if (!store || typeof store !== "object") return;
        const entry = (store as any)[progressSlug];
        const progress = entry && typeof entry.progress === "number" ? entry.progress : 0;
        if (progress < 0.02 || progress > 0.95) return;
        const doc = document.documentElement;
        const scrollable = doc.scrollHeight - doc.clientHeight;
        if (scrollable <= 0) return;
        if (doc.scrollTop > 4) return;
        const target = Math.round(scrollable * progress);
        window.scrollTo({ top: target, behavior: prefersReduced ? "auto" : "smooth" });
      };

      let ticking = false;
      let hasInteracted = false;
      let lastSavedAt = 0;
      const compute = () => {
        const doc = document.documentElement;
        const scrollable = doc.scrollHeight - doc.clientHeight;
        const raw = scrollable > 0 ? (doc.scrollTop / scrollable) * 100 : 0;
        const clamped = Math.min(Math.max(raw, 0), 100);
        bar.style.width = `${clamped}%`;
        label.textContent = `Reading progress: ${clamped.toFixed(0)}%`;

        if (progressSlug && scrollable > 0 && hasInteracted) {
          const now = Date.now();
          if (now - lastSavedAt > 1000) {
            lastSavedAt = now;
            const store = getProgressStore() || {};
            if (clamped >= 98) {
              if (store && typeof store === "object") {
                delete (store as any)[progressSlug];
              }
              setProgressStore(store as Record<string, unknown>);
            } else {
              (store as any)[progressSlug] = {
                progress: clamped / 100,
                updatedAt: new Date().toISOString(),
              };
              setProgressStore(store as Record<string, unknown>);
            }
          }
        }

        ticking = false;
      };

      const onScroll = () => {
        hasInteracted = true;
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(compute);
      };

      window.addEventListener("scroll", onScroll, { passive: true });
      window.addEventListener("resize", onScroll);
      compute();
      const scheduleRestore = () => {
        window.setTimeout(() => {
          if (!hasInteracted) restoreProgress();
        }, 200);
      };
      scheduleRestore();
      window.addEventListener("load", scheduleRestore, { once: true });
      window.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "hidden" && hasInteracted) compute();
      });
    })();
  </script>

  <BackToTop lang={lang} />
</Layout>
<style>
  .panel {
    --panel-radius: 1.5rem;
    --panel-padding: 1.5rem;
    --panel-bg: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
    --panel-border: color-mix(in srgb, var(--gn-panel-border) 85%, transparent);

    position: relative;
    padding: var(--panel-padding);
    background: var(--panel-bg);
    border: 2px solid var(--panel-border);
    border-radius: var(--panel-radius);
    box-shadow: var(--gn-offset-shadow);
  }

  .panel::after {
    position: absolute;
    inset: 4px;
    pointer-events: none;
    content: "";
    border: 1px solid var(--gn-panel-inner);
    border-radius: calc(var(--panel-radius) - 0.25rem);
  }

  .panel--compact {
    --panel-padding: 1rem;
  }

  .panel--tight {
    --panel-padding: 1.25rem;
  }

  .panel--card {
    --panel-radius: 1.25rem;
    --panel-padding: 1.25rem;
  }

  .reading-progress {
    position: fixed;
    inset-block-start: 0;
    inset-inline: 0;
    z-index: 60;
    block-size: 0.25rem;
    background: color-mix(in srgb, var(--color-gn-soot-950) 70%, transparent);
    backdrop-filter: blur(6px);
  }

  .reading-progress__bar {
    inline-size: 0;
    block-size: 100%;
    background: linear-gradient(
      90deg,
      var(--color-gn-amber-400),
      var(--color-gn-amber-300),
      var(--color-gn-amber-200)
    );
    box-shadow: 0 0 10px rgba(95, 199, 255, 0.45);
  }

  @media (width >= 640px) {
    .reading-progress {
      block-size: 0.375rem;
    }
  }

  @media (width >= 1024px) {
    .reading-progress {
      block-size: 0.5rem;
    }
  }

  .knowledge {
    position: relative;
    min-block-size: 100vb;
    overflow-inline: hidden;
    font-family: var(--font-sans);
    line-height: var(--line-height-relaxed);
    color: var(--gn-ink);
    background-color: var(--gn-bg);
  }

  .knowledge__backdrop {
    position: absolute;
    inset: 0;
    z-index: 0;
    pointer-events: none;
    background: linear-gradient(
      180deg,
      var(--color-gn-soot-900) 0%,
      var(--color-gn-soot-950) 65%,
      #000 100%
    );
  }

  .knowledge__texture {
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    background-image: var(--gn-halftone), var(--gn-noise);
    background-blend-mode: screen, normal;
    opacity: 0.2;
  }

  .knowledge__container {
    position: relative;
    z-index: 2;
    max-inline-size: 82rem;
    padding: clamp(2rem, 2.6vi, 3.5rem) clamp(1rem, 3vi, 2.5rem)
      clamp(3.5rem, 6vi, 5.5rem);
    margin: 0 auto;
  }

  @media (width >= 1280px) {
    .knowledge__container {
      max-inline-size: 88rem;
    }
  }

  .knowledge__hero {
    display: grid;
    gap: clamp(1.25rem, 2vi, 2rem);
    margin-block-end: 2.5rem;
  }

  @media (width >= 1024px) {
    .knowledge__hero {
      grid-template-columns: 1.1fr 0.9fr;
      align-items: stretch;
    }
  }

  .knowledge__hero-panel {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    min-inline-size: 0;
  }

  .knowledge__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    font-size: 1rem;
    color: var(--gn-ink-muted);
  }

  @media (width >= 640px) {
    .knowledge__meta {
      font-size: 1.125rem;
    }
  }

  .knowledge__pill {
    display: inline-flex;
    gap: 0.45rem;
    align-items: center;
    padding: 0.35rem 0.85rem;
    font-weight: 600;
    line-height: var(--line-height-tight);
    text-transform: none;
    background: color-mix(in srgb, var(--gn-bg) 75%, transparent);
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    border-radius: 999px;
  }

  .knowledge__pill--label {
    font-size: 1.125rem;
    color: var(--color-gn-amber-200);
    text-transform: uppercase;
    letter-spacing: 0.16em;
    background: rgba(123, 214, 255, 0.18);
    border-color: color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
  }

  .knowledge__pill--accent {
    color: var(--color-gn-amber-200);
    background: rgba(123, 214, 255, 0.16);
  }

  .knowledge__pill-icon {
    display: block;
    flex-shrink: 0;
    inline-size: 1rem;
    block-size: 1rem;
    color: var(--color-gn-amber-300);
  }

  .knowledge__pill-icon--teal {
    color: var(--color-gn-teal-300);
  }

  .knowledge__title {
    margin: 0;
    color: var(--gn-ink);
  }

  .knowledge__summary {
    max-inline-size: 64ch;
    margin: 0;
    color: var(--color-gn-parchment-100);
  }

  .knowledge__stats {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    font-size: 1rem;
    color: var(--gn-ink-muted);
  }

  @media (width >= 640px) {
    .knowledge__stats {
      font-size: 1.125rem;
    }
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .bookmark-button {
      display: inline-flex;
      gap: 0.4rem;
      align-items: center;
      min-block-size: 2.2rem;
      padding: 0.35rem 0.85rem;
      font-weight: 600;
      color: var(--gn-ink);
      cursor: pointer;
      background: color-mix(in srgb, var(--gn-bg) 80%, transparent);
      border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
      border-radius: 999px;
      transition: none;
    }
  }

  .bookmark-button {
    display: inline-flex;
    gap: 0.4rem;
    align-items: center;
    min-block-size: 2.2rem;
    padding: 0.35rem 0.85rem;
    font-weight: 600;
    color: var(--gn-ink);
    cursor: pointer;
    background: color-mix(in srgb, var(--gn-bg) 80%, transparent);
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    border-radius: 999px;
    transition:
      transform 160ms ease,
      border-color 160ms ease,
      box-shadow 160ms ease;
  }

  .bookmark-button__icon {
    inline-size: 1rem;
    block-size: 1rem;
    color: var(--color-gn-amber-300);
  }

  .bookmark-button[data-bookmark-state="saved"] {
    border-color: color-mix(in srgb, var(--gn-accent) 45%, transparent);
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3);
  }

  .bookmark-button:hover,
  .bookmark-button:focus {
    transform: translateY(-2px);
  }

  .bookmark-button:focus-visible {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 3px;
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .knowledge__quiz-link {
      display: inline-flex;
      gap: 0.45rem;
      align-items: center;
      padding: 0.35rem 0.85rem;
      font-weight: 600;
      line-height: var(--line-height-tight);
      color: var(--gn-ink);
      text-decoration: none;
      background: color-mix(in srgb, var(--gn-bg) 80%, transparent);
      border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
      border-radius: 999px;
      transition: none;
    }
  }

  .knowledge__quiz-link {
    display: inline-flex;
    gap: 0.45rem;
    align-items: center;
    padding: 0.35rem 0.85rem;
    font-weight: 600;
    line-height: var(--line-height-tight);
    color: var(--gn-ink);
    text-decoration: none;
    background: color-mix(in srgb, var(--gn-bg) 80%, transparent);
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    border-radius: 999px;
    transition:
      transform 160ms ease,
      border-color 160ms ease,
      box-shadow 160ms ease;
  }

  .knowledge__quiz-link:hover,
  .knowledge__quiz-link:focus {
    transform: translateY(-2px);
  }

  .knowledge__quiz-link:focus-visible {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 3px;
  }

  .knowledge__aside {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    min-inline-size: 0;
  }

  @media (width >= 1024px) {
    .knowledge__aside {
      gap: 1.5rem;
    }
  }

  .knowledge__media-panel {
    --panel-padding: 0;

    overflow: hidden;
  }

  .knowledge__media-frame {
    position: relative;
    aspect-ratio: 3 / 2;
    overflow: hidden;
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .knowledge__media-image {
      position: absolute;
      inset: 0;
      z-index: 1;
      inline-size: 100%;
      block-size: 100%;
      object-fit: cover;
      transition: none;
    }
  }

  .knowledge__media-image {
    position: absolute;
    inset: 0;
    z-index: 1;
    inline-size: 100%;
    block-size: 100%;
    object-fit: cover;
    transition: transform var(--transition-base);
  }

  .knowledge__media-image img {
    inline-size: 100%;
    block-size: 100%;
    object-fit: cover;
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .knowledge__media-overlay {
      position: absolute;
      inset: 0;
      z-index: 2;
      transition: none;
    }
  }

  .knowledge__media-overlay {
    position: absolute;
    inset: 0;
    z-index: 2;
    transition: opacity var(--transition-base);
  }

  .knowledge__media-panel:hover .knowledge__media-image,
  .knowledge__media-panel:focus .knowledge__media-image {
    transform: scale(1.03);
  }

  .knowledge__media-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    aspect-ratio: 3 / 2;
    padding: 2rem;
    color: var(--gn-ink-muted);
    text-align: center;
    background: var(--gn-bg-muted);
  }

  .knowledge__media-placeholder-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    align-items: center;
  }

  .knowledge__media-placeholder-icon {
    inline-size: 4rem;
    block-size: 4rem;
  }

  @media (width >= 1024px) {
    .knowledge__media-placeholder-icon {
      inline-size: 5rem;
      block-size: 5rem;
    }
  }

  .knowledge__panel-title {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-block-end: 0.75rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gn-ink-muted);
    text-transform: uppercase;
    letter-spacing: 0.12em;
  }

  .knowledge__panel-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .knowledge__panel-icon {
    display: block;
    flex-shrink: 0;
    inline-size: 1rem;
    block-size: 1rem;
    color: var(--color-gn-amber-300);
  }

  .knowledge__podcast {
    display: flex;
    gap: 0.75rem;
  }

  .knowledge__podcast-icon {
    display: inline-flex;
    flex-shrink: 0;
    align-items: center;
    justify-content: center;
    inline-size: 2.75rem;
    block-size: 2.75rem;
    color: var(--color-gn-amber-100);
    background: rgba(123, 214, 255, 0.12);
    border: 2px solid var(--gn-panel-border);
    border-radius: 0.9rem;
  }

  .knowledge__podcast-icon svg {
    display: block;
    inline-size: 1.25rem;
    block-size: 1.25rem;
  }

  .knowledge__podcast-body {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .knowledge__podcast-label {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gn-ink-muted);
    text-transform: uppercase;
    letter-spacing: 0.12em;
  }

  .knowledge__podcast-text {
    font-size: 1.125rem;
    color: var(--gn-ink-muted);
  }

  .knowledge__podcast-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding-block-start: 0.25rem;
  }

  .knowledge__podcast-wide {
    margin: 0;
  }

  .knowledge-article {
    margin: 0;
  }

  .knowledge-share {
    margin: 0;
  }

  .knowledge-share__header {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }

  .knowledge-share__title {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gn-ink);
    text-transform: uppercase;
    letter-spacing: 0.12em;
  }

  .knowledge-share__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 1.125rem;
  }

  .knowledge-share__note {
    margin-block-start: 0.75rem;
    font-size: 1.125rem;
    color: var(--gn-ink-muted);
  }

  .knowledge__back {
    display: flex;
    justify-content: center;
    margin: 0;
  }

  .knowledge__body {
    display: grid;
    gap: 2rem;
  }

  .knowledge__main {
    display: grid;
    gap: 2rem;
    min-inline-size: 0;
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .share-button {
      display: inline-flex;
      gap: 0.45rem;
      align-items: center;
      min-block-size: 44px;
      padding: 0.4rem 0.9rem;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gn-ink);
      text-decoration: none;
      cursor: pointer;
      background: color-mix(in srgb, var(--gn-bg-muted) 85%, transparent);
      border: 2px solid var(--gn-panel-border);
      border-radius: 999px;
      transition: none;
    }
  }

  .share-button {
    display: inline-flex;
    gap: 0.45rem;
    align-items: center;
    min-block-size: 44px;
    padding: 0.4rem 0.9rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gn-ink);
    text-decoration: none;
    cursor: pointer;
    background: color-mix(in srgb, var(--gn-bg-muted) 85%, transparent);
    border: 2px solid var(--gn-panel-border);
    border-radius: 999px;
    transition:
      transform var(--transition-fast),
      box-shadow var(--transition-fast),
      background-color var(--transition-fast),
      border-color var(--transition-fast),
      color var(--transition-fast);
  }

  .share-button:hover,
  .share-button:focus {
    background: color-mix(in srgb, var(--gn-bg-muted) 75%, transparent);
    box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.8);
    transform: translateY(-2px);
  }

  .share-button:focus-visible {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 2px;
  }

  .share-button--primary {
    color: var(--color-gn-soot-950);
    background: var(--color-gn-amber-500);
    border-color: color-mix(in srgb, var(--gn-panel-border) 80%, transparent);
  }

  .share-button--primary:hover,
  .share-button--primary:focus {
    background: var(--color-gn-amber-400);
  }

  .share-button__icon {
    display: block;
    flex-shrink: 0;
    inline-size: 1rem;
    block-size: 1rem;
  }

  .knowledge__sr,
  .knowledge__title-sr {
    position: absolute;
    inline-size: var(--sr-only-width);
    block-size: var(--sr-only-height);
    margin: var(--sr-only-margin);
    overflow: hidden;
    white-space: nowrap;
    border: 0;
    clip-path: var(--sr-only-clip-path);
  }
</style>

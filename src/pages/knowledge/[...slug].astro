---
/**
 * Knowledge Article Page (English only)
 */
import { Picture } from "astro:assets";
import Layout from "@layouts/Layout.astro";
import ButtonLink from "@components/ButtonLink.astro";
import { useTranslations } from "@utils/i18n";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";
import Prose from "@components/Prose.astro";
import TableOfContents from "@components/TableOfContents.astro";
import BackToTop from "@components/Shared/BackToTop.astro";
import { Icon } from "astro-icon/components";
import { buildPageSeo } from "@utils/seo/buildPageSeo";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { getReadingTime } from "@utils/readingTime";

export const prerender = true;

export async function getStaticPaths() {
  const entries: any[] = await getCollectionCached("knowledge-en").catch(
    () => []
  );
  const paths: Array<{ params: { slug: string }; props: { entry: any } }> = [];
  for (const entry of entries) {
    const slug = entry?.slug || entry?.id;
    if (!slug) continue;
    paths.push({ params: { slug }, props: { entry } });
  }
  return paths;
}

const lang = "en";
let entry: any = (Astro.props as { entry?: any }).entry;

const slugParam = (Astro as any).params?.slug;
const resolvedSlug = Array.isArray(slugParam) ? slugParam.join("/") : slugParam;

if (!entry) {
  try {
    const articles: any[] = await getCollectionCached("knowledge-en").catch(
      () => []
    );
    if (resolvedSlug) {
      entry = articles.find(
        (a) => a.slug === resolvedSlug || a.id === resolvedSlug
      );
    }
  } catch (e) {
    globalThis.console?.warn?.(
      "knowledge article: collection load issue (fallback)",
      {
        error: (e as any)?.message || e,
      }
    );
  }
}

if (!entry) {
  return new Response("Not found", { status: 404 });
}

if (!entry.data.readingTime && entry.body) {
  try {
    entry = {
      ...entry,
      data: {
        ...entry.data,
        readingTime: getReadingTime(entry.body || "", { languageCode: lang })
          .minutes,
      },
    };
  } catch {
    // ignore reading time calculation errors
  }
}

const t = useTranslations(lang);

const { headings, Content } = await entry.render();
const mergedHeadings = headings;

const rawImage = entry.data.image;
const isValidImage =
  typeof rawImage === "string" && /\.(png|jpg|jpeg|webp|avif)$/i.test(rawImage);
const imageSource = isValidImage ? rawImage : "/default-cover.jpg";
const title = entry.data.title;
const description = entry.data.description;
const pageContent = `${title} ${description} ${entry.data.keywords?.join(" ") || ""}`;
const optimizedDescription = pageContent;

const baseSite =
  Astro.site?.toString().replace(/\/$/, "") || "https://melody-mind.de";
const toAbsoluteUrl = (path: string): string => {
  if (!path) return baseSite;
  if (/^https?:\/\//i.test(path)) return path;
  const normalized = baseSite.replace(/\/$/, "");
  const cleaned = path.startsWith("/") ? path : `/${path}`;
  return `${normalized}${cleaned}`;
};
const imageAbsolute = toAbsoluteUrl(imageSource);
const imageWidth = 1200;
const imageHeight = 800;

const canonical = resolvedSlug
  ? `${baseSite}/knowledge/${resolvedSlug}`
  : `${baseSite}`;
const podcastBase = "https://podcasts.melody-mind.de";
const podcastSlug =
  [entry.data.podcastSlug, entry.data.podcast].find(
    (value) => typeof value === "string" && value.trim()
  )?.trim() || "";
const podcastUrl =
  typeof entry.data.podcastUrl === "string" && entry.data.podcastUrl.trim()
    ? entry.data.podcastUrl.trim()
    : podcastSlug
      ? `${podcastBase}/${encodeURI(podcastSlug)}`
      : null;
const seoBreadcrumbsBase = [{ name: t("nav.home") || "Home", url: `${baseSite}/` }];
const seoCategoryCrumb =
  entry.data.category && typeof entry.data.category === "string"
    ? {
        name: entry.data.category,
        url: `${baseSite}/categories/${entry.data.category}`,
      }
    : null;
const seoBreadcrumbs = [
  ...seoBreadcrumbsBase,
  ...(seoCategoryCrumb ? [seoCategoryCrumb] : []),
  { name: title, url: canonical },
];
const breadcrumbs = seoBreadcrumbs.map((crumb) => ({
  ...crumb,
  url: crumb.url ? crumb.url.replace(baseSite, "") || "/" : crumb.url,
}));
const schemaType = podcastUrl ? "PodcastEpisode" : "Article";
const structuredDataExtra = [
  {
    "@context": "https://schema.org",
    "@type": schemaType,
    headline: title,
    name: title,
    description: description,
    image: {
      "@type": "ImageObject",
      url: imageAbsolute,
      width: imageWidth,
      height: imageHeight,
    },
    url: canonical,
    author: { "@type": "Organization", name: "Melody Mind" },
    publisher: {
      "@type": "Organization",
      name: "Melody Mind",
      logo: {
        "@type": "ImageObject",
        url: "https://melody-mind.de/melody-mind.png",
      },
    },
    ...(podcastUrl
      ? {
          isPartOf: {
            "@type": "PodcastSeries",
            name: "Melody Mind Podcasts",
            url: podcastBase,
          },
          potentialAction: {
            "@type": "ListenAction",
            target: podcastUrl,
          },
        }
      : {}),
    datePublished: entry.data.createdAt?.toISOString(),
    dateModified: entry.data.updatedAt?.toISOString(),
    mainEntityOfPage: { "@type": "WebPage", "@id": canonical },
    inLanguage: lang,
    keywords: entry.data.keywords?.join(", ") || "",
    articleSection: t("knowledge.title") || "Music Knowledge",
    wordCount: entry.body?.length || 0,
  },
];

const wordsCount = entry.body ? entry.body.trim().split(/\s+/).length : 0;
const readingResult = getReadingTime(entry.body || "", { languageCode: lang });

function translate(key: string, fallback: string): string {
  try {
    return t(key);
  } catch {
    return fallback;
  }
}

const pageSeo = buildPageSeo({
  title,
  description: optimizedDescription,
  url: canonical,
  contentKind: "generic",
  breadcrumbs: seoBreadcrumbs,
  structuredData: structuredDataExtra,
  enrichedParts: [title, description].filter(Boolean) as string[],
  fallbackKeywords: (entry.data.keywords || []).slice(0, 20),
  keywordLimit: 24,
  maxDescription: 155,
  image: imageAbsolute,
  publishDate: entry.data.createdAt
    ? new Date(entry.data.createdAt)
    : new Date(),
  modifiedDate: entry.data.updatedAt
    ? new Date(entry.data.updatedAt)
    : new Date(),
  index: true,
  follow: true,
  autoSocialImage: false,
});

const shareUrl = canonical;
const shareTitle = `${title} | Melody Mind`;
const shareText = `${title} - ${description || ""}`.trim();
const shareMailSubject = encodeURIComponent(shareTitle);
const shareMailBody = encodeURIComponent(`${description || ""}\n\n${shareUrl}`);
const mastodonShareUrl = `https://mastodon.social/share?text=${encodeURIComponent(
  `${shareText} ${shareUrl}`
)}`;
---

<Layout {pageSeo} {breadcrumbs}>
  <Fragment slot="head"></Fragment>

  <div class="relative min-h-screen overflow-hidden text-gn-parchment-50 graphic-novel">
    <div class="absolute inset-0 bg-linear-to-b from-gn-soot-900 via-gn-soot-950 to-black"></div>
    <div class="absolute inset-0 opacity-20" style="background-image: var(--gn-halftone);"></div>

    <div class="relative mx-auto max-w-6xl px-4 pb-16 pt-10 sm:px-6 lg:px-8">
      <div class="mb-8 grid gap-5 lg:grid-cols-[1.1fr_0.9fr] lg:items-stretch">
        <header
          class="space-y-5 rounded-3xl gn-panel bg-gn-soot-800/90 p-6"
        >
          <div
            class="flex flex-wrap items-center justify-between gap-3 text-xs font-semibold uppercase tracking-[0.12em] text-gn-parchment-200 sm:text-sm"
          >
            <span
              class="rounded-full bg-gn-amber-500/20 px-3 py-1.5 text-gn-amber-200 ring-2 ring-gn-soot-700"
            >
              In-depth report
            </span>
            <span class="flex items-center gap-2 text-gn-parchment-200">
              <Icon
                name="calendar"
                class="h-4 w-4 text-gn-amber-300"
                aria-hidden="true"
              />
              {
                new Date(
                  entry.data.updatedAt || entry.data.createdAt || new Date()
                ).toLocaleDateString(lang, {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })
              }
            </span>
          </div>
          <Headline
            level="h1"
            textSize="xl"
            textAlign="left"
            className="text-gn-parchment-50"
          >
            {entry.data.title}
          </Headline>
          <Paragraph
            textSize="lg"
            textAlign="left"
            className="max-w-4xl text-gn-parchment-100"
          >
            {entry.data.description}
          </Paragraph>
          <div class="flex flex-wrap gap-3 text-sm text-gn-parchment-200">
            <div
              class="flex items-center gap-2 rounded-full bg-gn-soot-800 px-3 py-1.5 ring-2 ring-gn-soot-700"
            >
              <Icon
                name="clock"
                class="h-4 w-4 text-gn-amber-300"
                aria-hidden="true"
              />
              <span class="font-semibold">
                {readingResult.minutes}
                {t("knowledge.reading.time")}
              </span>
            </div>
            <div
              class="flex items-center gap-2 rounded-full bg-gn-soot-800 px-3 py-1.5 ring-2 ring-gn-soot-700"
            >
              <Icon
                name="file-text"
                class="h-4 w-4 text-gn-teal-300"
                aria-hidden="true"
              />
              <span class="font-semibold"
                >{t("knowledge.word_count", { count: wordsCount })}</span
              >
            </div>
          </div>
        </header>

        <div class="flex flex-col gap-3 lg:gap-4">
          <div
            class="group relative overflow-hidden rounded-3xl gn-panel bg-gn-soot-800/90"
          >
            {
              imageSource ? (
                <div class="relative aspect-video">
                  <div class="absolute inset-0 bg-linear-to-t from-gn-soot-950 via-gn-soot-900/75 to-transparent transition duration-300 group-hover:from-gn-soot-950/90" />
                  <Picture
                    class="absolute inset-0 h-full w-full object-cover"
                    src={imageSource}
                    widths={[600, 800, 1000, 1200]}
                    sizes="(max-width: 640px) 100vw, (max-width: 1024px) 600px, (max-width: 1280px) 800px, 1000px"
                    formats={["avif", "webp", "jpg"]}
                    alt={entry.data.title}
                    loading="eager"
                    fetchpriority="high"
                    width={1200}
                    height={800}
                    decoding="async"
                  />
                </div>
              ) : (
                <div
                  class="flex aspect-video w-full items-center justify-center bg-gn-soot-900 p-8 text-center text-gn-parchment-200"
                  role="img"
                  aria-label={t("category.no_image_available")}
                >
                  <div class="flex flex-col items-center gap-3">
                    <Icon
                      name="image"
                      class="h-16 w-16 lg:h-20 lg:w-20"
                      aria-hidden="true"
                    />
                    <span class="text-lg">
                      {t("category.no_image_available")}
                    </span>
                  </div>
                </div>
              )
            }
          </div>

          {
            entry.data.playlists?.spotifyPlaylist ||
            entry.data.playlists?.deezerPlaylist ? (
              <div
                class="rounded-2xl gn-panel bg-gn-soot-800/90 p-3"
              >
                <div class="mb-2 flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.12em] text-gn-parchment-200">
                  <Icon name="music" class="h-4 w-4 text-gn-amber-300" aria-hidden="true" />
                  Play this article's playlist on:
                </div>
                <div class="flex flex-wrap gap-2">
                  {
                    entry.data.playlists?.spotifyPlaylist ? (
                      <ButtonLink
                        href={entry.data.playlists?.spotifyPlaylist}
                        variant="secondary"
                        icon="spotify"
                        className="h-9 min-w-[110px] justify-center px-3 text-sm"
                        aria-label={`Open the ${t("musicPlatforms.platform.spotify")} playlist for ${entry.data.title}`}
                      >
                        {t("musicPlatforms.platform.spotify")}
                      </ButtonLink>
                    ) : null
                  }
                  {
                    entry.data.playlists?.deezerPlaylist ? (
                      <ButtonLink
                        href={entry.data.playlists?.deezerPlaylist}
                        variant="secondary"
                        icon="deezer"
                        className="h-9 min-w-[110px] justify-center px-3 text-sm"
                        aria-label={`Open the ${t("musicPlatforms.platform.deezer")} playlist for ${entry.data.title}`}
                      >
                        {t("musicPlatforms.platform.deezer")}
                      </ButtonLink>
                    ) : null
                  }
                </div>
              </div>
            ) : null
          }

          {
            podcastUrl ? (
              <div
                class="rounded-2xl gn-panel bg-gn-soot-800/90 p-4"
              >
                <div class="flex items-start gap-3">
                  <div
                    class="flex h-11 w-11 shrink-0 items-center justify-center rounded-2xl bg-gn-amber-500/15 text-gn-amber-100 ring-2 ring-gn-soot-700"
                  >
                    <Icon name="headphones" class="h-5 w-5" aria-hidden="true" />
                  </div>
                  <div class="space-y-2">
                    <div class="text-xs font-semibold uppercase tracking-[0.12em] text-gn-parchment-200">
                      Podcast companion
                    </div>
                    <div class="text-sm text-gn-parchment-200">
                      Listen to the episode for this decade or explore the full podcast series.
                    </div>
                    <div class="flex flex-wrap gap-2 pt-1">
                      <ButtonLink
                        href={podcastUrl}
                        icon="headphones"
                        className="h-10 min-w-[140px] justify-center px-3 text-sm"
                        aria-label={`Open the podcast page for ${entry.data.title}`}
                      >
                        Open podcast page
                      </ButtonLink>
                      <ButtonLink
                        href={podcastBase}
                        variant="secondary"
                        icon="mic"
                        className="h-10 min-w-[140px] justify-center px-3 text-sm"
                        aria-label="Browse all Melody Mind podcasts"
                      >
                        All podcast episodes
                      </ButtonLink>
                    </div>
                  </div>
                </div>
              </div>
            ) : null
          }
        </div>
      </div>

      <div
        class="mb-8 rounded-3xl gn-panel bg-gn-soot-800/90 p-5"
      >
        <TableOfContents headings={mergedHeadings} lang={lang} />
      </div>

      <article
        id="article-content"
        class="rounded-3xl gn-panel bg-gn-soot-800/90 p-6 sm:p-7"
      >
        <div id="article-title" class="sr-only">{entry.data.title}</div>
        <div
          role="region"
          aria-labelledby="article-title"
          aria-label={translate("accessibility.main_content", "Main content")}
        >
          <Prose>
            <Content />
          </Prose>
        </div>
      </article>

      <div
        class="mt-10 rounded-3xl gn-panel bg-gn-soot-800/90 p-5"
        id="share-section"
        data-share-url={shareUrl}
        data-share-title={shareTitle}
        data-share-text={shareText}
        data-share-success={translate("knowledge.share.copied", "Link copied!")}
        data-share-error={translate(
          "knowledge.share.copy_error",
          "Copy failed - please copy it manually."
        )}
        data-share-fallback={translate(
          "knowledge.share.native_fallback",
          "Sharing isn't available here, so we've copied the link for you."
        )}
      >
        <div class="flex flex-wrap items-center gap-3">
          <div
            class="flex items-center gap-2 text-sm font-semibold uppercase tracking-[0.12em] text-gn-parchment-50"
          >
            <Icon name="share-2" class="h-4 w-4 text-gn-amber-300" aria-hidden="true" />
            <span
              >{
                translate(
                  "knowledge.share.heading",
                  "Share this article (privacy-friendly)"
                )
              }</span
            >
          </div>
          <div class="flex flex-wrap gap-2 text-sm">
            <button
              type="button"
              data-share="native"
              class="flex min-h-[44px] items-center gap-2 rounded-full bg-gn-amber-500 px-3 py-1.5 text-gn-soot-950 ring-2 ring-gn-soot-700 transition duration-200 hover:-translate-y-0.5 hover:bg-gn-amber-400 focus-visible:outline-none focus-visible:ring-3 focus-visible:ring-gn-amber-300 focus-visible:ring-offset-2 focus-visible:ring-offset-gn-soot-900"
              aria-label={translate("knowledge.share.native", "Share via your device")}
            >
              <Icon name="send" class="h-4 w-4 text-gn-soot-950" aria-hidden="true" />
              <span>{translate("knowledge.share.native", "Share")}</span>
            </button>
            <button
              type="button"
              data-share="copy"
              class="flex min-h-[44px] items-center gap-2 rounded-full bg-gn-soot-800 px-3 py-1.5 text-gn-parchment-50 ring-2 ring-gn-soot-700 transition duration-200 hover:-translate-y-0.5 hover:bg-gn-soot-700 focus-visible:outline-none focus-visible:ring-3 focus-visible:ring-gn-amber-300 focus-visible:ring-offset-2 focus-visible:ring-offset-gn-soot-900"
              aria-label={translate(
                "knowledge.share.copy",
                "Copy link to this article"
              )}
            >
              <Icon name="copy" class="h-4 w-4 text-gn-parchment-50" aria-hidden="true" />
              <span>{translate("knowledge.share.copy", "Copy link")}</span>
            </button>
            <a
              href={`mailto:?subject=${shareMailSubject}&body=${shareMailBody}`}
              class="flex min-h-[44px] items-center gap-2 rounded-full bg-gn-soot-800 px-3 py-1.5 text-gn-parchment-50 ring-2 ring-gn-soot-700 transition duration-200 hover:-translate-y-0.5 hover:bg-gn-soot-700 focus-visible:outline-none focus-visible:ring-3 focus-visible:ring-gn-amber-300 focus-visible:ring-offset-2 focus-visible:ring-offset-gn-soot-900"
              aria-label={translate("knowledge.share.email", "Share via email")}
            >
              <Icon name="mail" class="h-4 w-4 text-gn-parchment-50" aria-hidden="true" />
              <span>{translate("knowledge.share.email", "Email")}</span>
            </a>
            <a
              href={mastodonShareUrl}
              target="_blank"
              rel="noreferrer noopener"
              class="flex min-h-[44px] items-center gap-2 rounded-full bg-gn-soot-800 px-3 py-1.5 text-gn-parchment-50 ring-2 ring-gn-soot-700 transition duration-200 hover:-translate-y-0.5 hover:bg-gn-soot-700 focus-visible:outline-none focus-visible:ring-3 focus-visible:ring-gn-amber-300 focus-visible:ring-offset-2 focus-visible:ring-offset-gn-soot-900"
              aria-label={translate(
                "knowledge.share.mastodon",
                "Share on Mastodon (opens in a new tab)"
              )}
            >
              <Icon
                name="message-circle"
                class="h-4 w-4 text-gn-parchment-50"
                aria-hidden="true"
              />
              <span>{translate("knowledge.share.mastodon", "Mastodon")}</span>
            </a>
          </div>
        </div>
        <p
          data-share-status
          class="mt-3 text-xs text-gn-parchment-200"
          aria-live="polite"
        >
          {translate(
            "knowledge.share.privacy_note",
            "Privacy-friendly: nothing loads until you click a share option."
          )}
        </p>
      </div>

      <div class="mt-12 flex justify-center">
        <ButtonLink
          href="/"
          icon="arrow-left"
          aria-label={translate(
            "knowledge.back.to.list",
            "Back to knowledge list"
          )}
          className="rounded-full border-2 border-gn-soot-700 bg-gn-soot-800 px-6 py-3 text-gn-parchment-50 transition-all duration-300 hover:-translate-y-1 hover:border-gn-amber-300 hover:bg-gn-soot-700 hover:text-gn-parchment-50 hover:shadow-[5px_5px_0_rgba(0,0,0,0.8)]"
        >
          <span class="flex items-center gap-2">
            <span
              >{
                translate("knowledge.back.to.list", "Back to knowledge list")
              }</span
            >
          </span>
        </ButtonLink>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const shareSection = document.getElementById("share-section");
      if (!shareSection) return;

      const shareUrl = shareSection.dataset.shareUrl || "";
      const shareTitle = shareSection.dataset.shareTitle || "";
      const shareText = shareSection.dataset.shareText || "";
      const copySuccessMessage = shareSection.dataset.shareSuccess || "";
      const copyErrorMessage = shareSection.dataset.shareError || "";
      const nativeShareUnavailable = shareSection.dataset.shareFallback || "";
      const statusEl = shareSection.querySelector("[data-share-status]");
      const defaultStatus = statusEl?.textContent || "";
      let resetTimer: number | undefined;

      const setStatus = (message: string | null) => {
        if (!statusEl) return;
        statusEl.textContent = message;
        if (resetTimer) window.clearTimeout(resetTimer);
        resetTimer = window.setTimeout(() => {
          statusEl.textContent = defaultStatus;
        }, 4500);
      };

      const copyLink = async () => {
        try {
          if (!navigator.clipboard) throw new Error("clipboard unavailable");
          await navigator.clipboard.writeText(shareUrl);
          setStatus(copySuccessMessage);
        } catch {
          setStatus(copyErrorMessage);
        }
      };

      const copyButton = document.querySelector('[data-share="copy"]');
      copyButton?.addEventListener("click", () => copyLink());

      const nativeButton = document.querySelector('[data-share="native"]');
      nativeButton?.addEventListener("click", async () => {
        if (navigator.share) {
          try {
            await navigator.share({ title: shareTitle, text: shareText, url: shareUrl });
            setStatus(copySuccessMessage);
            return;
          } catch (error: any) {
            if (error?.name === "AbortError") return;
          }
        }

        setStatus(nativeShareUnavailable);
        copyLink();
      });
    })();
  </script>

  <BackToTop lang={lang} />
</Layout>

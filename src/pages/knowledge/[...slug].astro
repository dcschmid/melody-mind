---
/**
 * Knowledge Article Page (English only)
 */
import { Picture } from "astro:assets";
import { render } from "astro:content";
import Layout from "@layouts/Layout.astro";
import ButtonLink from "@components/ButtonLink.astro";
import { useTranslations } from "@utils/i18n";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";
import Prose from "@components/Prose.astro";
import TableOfContents from "@components/TableOfContents.astro";
import ReadingControls from "@components/ReadingControls.astro";
import KnowledgeQuiz from "@components/Knowledge/KnowledgeQuiz.astro";
import KnowledgeTakeaways from "@components/Knowledge/KnowledgeTakeaways.astro";
import BookmarkButton from "@components/BookmarkButton.astro";
import PrintButton from "@components/PrintButton.astro";
import BackToTop from "@components/Shared/BackToTop.astro";
import AIContentBadge from "@components/AIContentBadge.astro";
import { Icon } from "astro-icon/components";
import { buildPageSeo } from "@utils/seo/buildPageSeo";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { getReadingTime } from "@utils/readingTime";
import { resolveAbsoluteUrl, resolvePageUrl } from "@utils/siteUrls";
import { getKnowledgeQuiz } from "../../data/knowledgeQuizzes";
import { quizDecades } from "../../data/knowledgeQuizzes";
import { knowledgeTakeaways, takeawaysDecades } from "../../data/knowledgeTakeaways";

export const prerender = true;

export async function getStaticPaths() {
  const entries: any[] = await getCollectionCached("knowledge-en").catch(() => []);
  const paths: Array<{ params: { slug: string }; props: { entry: any } }> = [];
  for (const entry of entries) {
    const slug = entry?.slug || entry?.id;
    if (!slug) continue;
    paths.push({ params: { slug }, props: { entry } });
  }
  return paths;
}

const lang = "en";
let entry: any = (Astro.props as { entry?: any }).entry;

const slugParam = (Astro as any).params?.slug;
const resolvedSlug = Array.isArray(slugParam) ? slugParam.join("/") : slugParam;

if (!entry) {
  try {
    const articles: any[] = await getCollectionCached("knowledge-en").catch(() => []);
    if (resolvedSlug) {
      entry = articles.find((a) => a.slug === resolvedSlug || a.id === resolvedSlug);
    }
  } catch (e) {
    globalThis.console?.warn?.("knowledge article: collection load issue (fallback)", {
      error: (e as any)?.message || e,
    });
  }
}

if (!entry) {
  return new Response("Not found", { status: 404 });
}

const slugKey = resolvedSlug || entry?.slug || entry?.id || "";
const quizQuestions = quizDecades.includes(slugKey as (typeof quizDecades)[number])
  ? getKnowledgeQuiz(slugKey)
  : [];

if (!entry.data.readingTime && entry.body) {
  try {
    entry = {
      ...entry,
      data: {
        ...entry.data,
        readingTime: getReadingTime(entry.body || "", { languageCode: lang }).minutes,
      },
    };
  } catch {
    // ignore reading time calculation errors
  }
}

const t = useTranslations(lang);

const { headings, Content } = await render(entry);
const mergedHeadings = headings;
const fallbackTakeaways = takeawaysDecades.includes(
  slugKey as (typeof takeawaysDecades)[number]
)
  ? knowledgeTakeaways[slugKey] || []
  : [];
const takeaways =
  entry.data.takeaways && entry.data.takeaways.length
    ? entry.data.takeaways
    : fallbackTakeaways;

const rawImage = entry.data.image;
const isValidImage =
  typeof rawImage === "string" && /\.(png|jpg|jpeg|webp|avif)$/i.test(rawImage);
const imageSource = isValidImage ? rawImage : "/default-cover.jpg";
const title = entry.data.title;
const description = entry.data.description;
const pageContent = `${title} ${description} ${entry.data.keywords?.join(" ") || ""}`;
const optimizedDescription = pageContent;

const imageAbsolute = resolveAbsoluteUrl(Astro.site, imageSource);
const imageWidth = 1200;
const imageHeight = 800;

const canonical = resolvedSlug
  ? resolvePageUrl(Astro.site, `/knowledge/${resolvedSlug}`)
  : resolvePageUrl(Astro.site, "/");
const podcastBase = "https://podcasts.melody-mind.de";
const podcastSlug =
  [entry.data.podcastSlug, entry.data.podcast]
    .find((value) => typeof value === "string" && value.trim())
    ?.trim() || "";
const podcastUrl =
  typeof entry.data.podcastUrl === "string" && entry.data.podcastUrl.trim()
    ? entry.data.podcastUrl.trim()
    : podcastSlug
      ? `${podcastBase}/${encodeURI(podcastSlug)}`
      : null;
const seoBreadcrumbsBase = [
  { name: t("nav.home") || "Home", url: resolvePageUrl(Astro.site, "/") },
];
const seoCategoryCrumb =
  entry.data.category && typeof entry.data.category === "string"
    ? {
        name: entry.data.category,
        url: resolvePageUrl(Astro.site, `/categories/${entry.data.category}`),
      }
    : null;
const seoBreadcrumbs = [
  ...seoBreadcrumbsBase,
  ...(seoCategoryCrumb ? [seoCategoryCrumb] : []),
  { name: title, url: canonical },
];
const schemaType = podcastUrl ? "PodcastEpisode" : "Article";
const structuredDataExtra = [
  {
    "@context": "https://schema.org",
    "@type": schemaType,
    headline: title,
    name: title,
    description: description,
    image: {
      "@type": "ImageObject",
      url: imageAbsolute,
      width: imageWidth,
      height: imageHeight,
    },
    url: canonical,
    author: { "@type": "Organization", name: "Melody Mind" },
    publisher: {
      "@type": "Organization",
      name: "Melody Mind",
      logo: {
        "@type": "ImageObject",
        url: "https://melody-mind.de/melody-mind.png",
      },
    },
    ...(podcastUrl
      ? {
          isPartOf: {
            "@type": "PodcastSeries",
            name: "Melody Mind Podcasts",
            url: podcastBase,
          },
          potentialAction: {
            "@type": "ListenAction",
            target: podcastUrl,
          },
        }
      : {}),
    datePublished: entry.data.createdAt?.toISOString(),
    dateModified: entry.data.updatedAt?.toISOString(),
    mainEntityOfPage: { "@type": "WebPage", "@id": canonical },
    inLanguage: lang,
    keywords: entry.data.keywords?.join(", ") || "",
    articleSection: t("knowledge.title") || "Music Knowledge",
    wordCount: entry.body?.length || 0,
  },
];

const wordsCount = entry.body ? entry.body.trim().split(/\s+/).length : 0;
const readingResult = getReadingTime(entry.body || "", { languageCode: lang });
const publishedDate = new Date(
  entry.data.updatedAt || entry.data.createdAt || new Date()
);
const publishedDateLabel = publishedDate.toLocaleDateString(lang, {
  year: "numeric",
  month: "long",
  day: "numeric",
});

function translate(key: string, fallback: string): string {
  try {
    return t(key);
  } catch {
    return fallback;
  }
}

const pageSeo = buildPageSeo({
  title,
  description: optimizedDescription,
  url: canonical,
  contentKind: "generic",
  breadcrumbs: seoBreadcrumbs,
  structuredData: structuredDataExtra,
  enrichedParts: [title, description].filter(Boolean) as string[],
  fallbackKeywords: (entry.data.keywords || []).slice(0, 20),
  keywordLimit: 24,
  maxDescription: 155,
  image: imageAbsolute,
  publishDate: entry.data.createdAt ? new Date(entry.data.createdAt) : new Date(),
  modifiedDate: entry.data.updatedAt ? new Date(entry.data.updatedAt) : new Date(),
  index: true,
  follow: true,
  autoSocialImage: false,
});

const shareUrl = canonical;
const shareTitle = `${title} | Melody Mind`;
const shareText = `${title} - ${description || ""}`.trim();
const shareMailSubject = encodeURIComponent(shareTitle);
const shareMailBody = encodeURIComponent(`${description || ""}\n\n${shareUrl}`);
const mastodonShareUrl = `https://mastodon.social/share?text=${encodeURIComponent(
  `${shareText} ${shareUrl}`
)}`;
const storageSlug = resolvedSlug || entry?.slug || entry?.id || "";
const storageUpdatedAtRaw = entry?.data?.updatedAt || entry?.data?.createdAt || "";
const parsedStorageDate = storageUpdatedAtRaw ? new Date(storageUpdatedAtRaw) : null;
const storageUpdatedAt =
  parsedStorageDate && !Number.isNaN(parsedStorageDate.valueOf())
    ? parsedStorageDate.toISOString()
    : "";
---

<Layout {pageSeo}>
  <Fragment slot="head"></Fragment>

  <div class="reading-progress">
    <div
      id="reading-progress-bar"
      class="reading-progress__bar"
      role="presentation"
      aria-hidden="true"
    >
    </div>
    <span id="reading-progress-label" class="knowledge__sr">Reading progress: 0%</span>
  </div>

  <div
    class="knowledge"
    data-analytics-article="true"
    data-analytics-article-slug={slugKey}
    data-analytics-article-category={entry.data.category || "uncategorized"}
    data-analytics-has-quiz={quizQuestions.length ? "true" : "false"}
  >
    <div class="knowledge__backdrop"></div>
    <div class="knowledge__texture"></div>

    <div class="knowledge__container">
      <div class="knowledge__hero">
        <header class="panel knowledge__hero-panel">
          <div class="knowledge__meta">
            <span class="knowledge__pill knowledge__pill--label">In-depth report</span>
            {
              entry.data.aiGenerated ? (
                <AIContentBadge
                  aiTools={entry.data.aiTools}
                  size="md"
                  className="knowledge__ai-badge"
                />
              ) : null
            }
            <span class="knowledge__pill">
              <Icon name="calendar" class="knowledge__pill-icon" aria-hidden="true" />
              <time datetime={publishedDate.toISOString()}>{publishedDateLabel}</time>
            </span>
            <span class="knowledge__pill">
              <Icon name="clock" class="knowledge__pill-icon" aria-hidden="true" />
              <span>{readingResult.text}</span>
            </span>
            {
              entry.data.category ? (
                <span class="knowledge__pill">
                  <Icon
                    name="tag"
                    class="knowledge__pill-icon knowledge__pill-icon--teal"
                    aria-hidden="true"
                  />
                  <span>{entry.data.category}</span>
                </span>
              ) : null
            }
          </div>
          <Headline
            level="h1"
            textSize="xl"
            textAlign="left"
            className="knowledge__title"
          >
            {entry.data.title}
          </Headline>
          <Paragraph textSize="lg" textAlign="left" className="knowledge__summary">
            {entry.data.description}
          </Paragraph>
          <div class="knowledge__stats">
            <div class="knowledge__pill">
              <Icon
                name="file-text"
                class="knowledge__pill-icon knowledge__pill-icon--teal"
                aria-hidden="true"
              />
              <span>{t("knowledge.word_count", { count: wordsCount })}</span>
            </div>
            {
              quizQuestions.length ? (
                <a href="#knowledge-quiz" class="knowledge__quiz-link">
                  <Icon
                    name="help-circle"
                    class="knowledge__pill-icon knowledge__pill-icon--teal"
                    aria-hidden="true"
                  />
                  <span>Jump to quiz</span>
                </a>
              ) : null
            }
            <BookmarkButton articleSlug={storageSlug} articleTitle={title} />
            <PrintButton />
          </div>
        </header>

        <div class="knowledge__aside">
          <div class="panel knowledge__media-panel">
            {
              imageSource ? (
                <div class="knowledge__media-frame">
                  <div class="knowledge__media-overlay" aria-hidden="true" />
                  <Picture
                    class="knowledge__media-image"
                    src={imageSource}
                    widths={[600, 800, 1000, 1200]}
                    sizes="(max-width: 640px) 100vw, (max-width: 1024px) 600px, (max-width: 1280px) 800px, 1000px"
                    formats={["avif", "webp", "jpg"]}
                    alt={entry.data.title}
                    loading="eager"
                    fetchpriority="high"
                    width={1200}
                    height={800}
                    decoding="async"
                  />
                </div>
              ) : (
                <div
                  class="knowledge__media-placeholder"
                  role="img"
                  aria-label={t("category.no_image_available")}
                >
                  <div class="knowledge__media-placeholder-content">
                    <Icon
                      name="image"
                      class="knowledge__media-placeholder-icon"
                      aria-hidden="true"
                    />
                    <span>{t("category.no_image_available")}</span>
                  </div>
                </div>
              )
            }
          </div>

          {
            entry.data.playlists?.spotifyPlaylist ||
            entry.data.playlists?.deezerPlaylist ||
            podcastUrl ? (
              <div class="panel panel--compact">
                <div class="knowledge__panel-title">
                  <Icon name="music" class="knowledge__panel-icon" aria-hidden="true" />
                  Listen & Explore
                </div>
                <div class="knowledge__panel-actions">
                  {entry.data.playlists?.spotifyPlaylist ? (
                    <ButtonLink
                      href={entry.data.playlists?.spotifyPlaylist}
                      variant="secondary"
                      icon="spotify"
                      className="button-link--sm"
                      aria-label={`Open ${t("musicPlatforms.platform.spotify")} playlist for ${entry.data.title}`}
                    >
                      {t("musicPlatforms.platform.spotify")}
                    </ButtonLink>
                  ) : null}
                  {entry.data.playlists?.deezerPlaylist ? (
                    <ButtonLink
                      href={entry.data.playlists?.deezerPlaylist}
                      variant="secondary"
                      icon="deezer"
                      className="button-link--sm"
                      aria-label={`Open ${t("musicPlatforms.platform.deezer")} playlist for ${entry.data.title}`}
                    >
                      {t("musicPlatforms.platform.deezer")}
                    </ButtonLink>
                  ) : null}
                  {podcastUrl ? (
                    <ButtonLink
                      href={podcastUrl}
                      icon="headphones"
                      variant="primary"
                      className="button-link--sm"
                      analyticsPodcastTarget="episode"
                      aria-label={`Open podcast page for ${entry.data.title}`}
                    >
                      Open podcast page
                    </ButtonLink>
                  ) : null}
                </div>
              </div>
            ) : null
          }
        </div>
      </div>

      <div class="knowledge__body">
        <div class="knowledge__main">
          <ReadingControls />

          <TableOfContents headings={mergedHeadings} lang={lang} />

          {takeaways.length ? <KnowledgeTakeaways items={takeaways} /> : null}

          <article id="article-content" class="panel knowledge-article">
            <div id="article-title" class="knowledge__title-sr">{entry.data.title}</div>
            <div
              role="region"
              aria-labelledby="article-title"
              aria-label={translate("accessibility.main_content", "Main content")}
            >
              <Prose fullWidth={true}>
                <Content />
              </Prose>
            </div>
          </article>

          {
            quizQuestions.length ? (
              <KnowledgeQuiz title="Quick Quiz" questions={quizQuestions} />
            ) : null
          }

          <section
            class="panel panel--compact knowledge-share"
            id="share-section"
            aria-labelledby="share-section-title"
            data-share-url={shareUrl}
            data-share-title={shareTitle}
            data-share-text={shareText}
            data-share-success={translate("knowledge.share.copied", "Link copied!")}
            data-share-error={translate(
              "knowledge.share.copy_error",
              "Copy failed - please copy it manually."
            )}
            data-share-fallback={translate(
              "knowledge.share.native_fallback",
              "Sharing isn't available here, so we've copied the link for you."
            )}
          >
            <div class="knowledge-share__header">
              <h2 class="knowledge-share__title" id="share-section-title">
                <Icon name="share-2" class="knowledge__panel-icon" aria-hidden="true" />
                <span>
                  {
                    translate(
                      "knowledge.share.heading",
                      "Share this article (privacy-friendly)"
                    )
                  }
                </span>
              </h2>
              <div class="knowledge-share__actions">
                <button
                  type="button"
                  data-share="native"
                  class="share-button share-button--primary"
                  aria-label={translate(
                    "knowledge.share.native",
                    "Share via your device"
                  )}
                >
                  <Icon name="send" class="share-button__icon" aria-hidden="true" />
                  <span>{translate("knowledge.share.native", "Share")}</span>
                </button>
                <button
                  type="button"
                  data-share="copy"
                  class="share-button"
                  aria-label={translate(
                    "knowledge.share.copy",
                    "Copy link to this article"
                  )}
                >
                  <Icon name="copy" class="share-button__icon" aria-hidden="true" />
                  <span>{translate("knowledge.share.copy", "Copy link")}</span>
                </button>
                <a
                  href={`mailto:?subject=${shareMailSubject}&body=${shareMailBody}`}
                  class="share-button"
                  aria-label={translate("knowledge.share.email", "Share via email")}
                >
                  <Icon name="mail" class="share-button__icon" aria-hidden="true" />
                  <span>{translate("knowledge.share.email", "Email")}</span>
                </a>
                <a
                  href={mastodonShareUrl}
                  target="_blank"
                  rel="noreferrer noopener"
                  class="share-button"
                  aria-label={translate(
                    "knowledge.share.mastodon",
                    "Share on Mastodon (opens in a new tab)"
                  )}
                >
                  <Icon
                    name="message-circle"
                    class="share-button__icon"
                    aria-hidden="true"
                  />
                  <span>{translate("knowledge.share.mastodon", "Mastodon")}</span>
                </a>
              </div>
            </div>
            <p data-share-status class="knowledge-share__note" aria-live="polite">
              {
                translate(
                  "knowledge.share.privacy_note",
                  "Privacy-friendly: nothing loads until you click a share option."
                )
              }
            </p>
          </section>

          <div class="knowledge__back">
            <ButtonLink
              href="/"
              icon="arrow-left"
              aria-label={translate("knowledge.back.to.list", "Back to knowledge list")}
            >
              <span>{translate("knowledge.back.to.list", "Back to knowledge list")}</span>
            </ButtonLink>
          </div>
          <aside class="print-footer" aria-hidden="true">
            <span class="print-footer__url">melody-mind.de</span> &mdash; {title} &mdash; {
              publishedDateLabel
            }
          </aside>
          <div
            id="recent-read-data"
            data-slug={storageSlug}
            data-title={title}
            data-updated-at={storageUpdatedAt}
            hidden
          >
          </div>
        </div>
      </div>

      <script>
        (() => {
          const shareSection = document.getElementById("share-section");
          if (!shareSection) return;

          const shareUrl = shareSection.dataset.shareUrl || "";
          const shareTitle = shareSection.dataset.shareTitle || "";
          const shareText = shareSection.dataset.shareText || "";
          const copySuccessMessage = shareSection.dataset.shareSuccess || "";
          const copyErrorMessage = shareSection.dataset.shareError || "";
          const nativeShareUnavailable = shareSection.dataset.shareFallback || "";
          const statusEl = shareSection.querySelector("[data-share-status]");
          const defaultStatus = statusEl?.textContent || "";
          let resetTimer: number | undefined;

          const setStatus = (message: string | null) => {
            if (!statusEl) return;
            statusEl.textContent = message;
            if (resetTimer) window.clearTimeout(resetTimer);
            resetTimer = window.setTimeout(() => {
              statusEl.textContent = defaultStatus;
            }, 4500);
          };

          const copyLink = async () => {
            try {
              if (!navigator.clipboard) throw new Error("clipboard unavailable");
              await navigator.clipboard.writeText(shareUrl);
              setStatus(copySuccessMessage);
            } catch {
              setStatus(copyErrorMessage);
            }
          };

          const copyButton = document.querySelector('[data-share="copy"]');
          copyButton?.addEventListener("click", () => copyLink());

          const nativeButton = document.querySelector('[data-share="native"]');
          nativeButton?.addEventListener("click", async () => {
            if (navigator.share) {
              try {
                await navigator.share({
                  title: shareTitle,
                  text: shareText,
                  url: shareUrl,
                });
                setStatus(copySuccessMessage);
                return;
              } catch (error: any) {
                if (error?.name === "AbortError") return;
              }
            }

            setStatus(nativeShareUnavailable);
            copyLink();
          });
        })();
      </script>

      <script>
        (() => {
          const storageKey = "mm_recent_reads";
          const dataEl = document.getElementById("recent-read-data");
          if (!dataEl) return;
          const recentEntry = {
            slug: dataEl.dataset.slug || "",
            title: dataEl.dataset.title || "",
            updatedAt: dataEl.dataset.updatedAt || "",
          };

          if (!recentEntry.slug || !recentEntry.title) return;
          if (typeof window === "undefined" || !window.localStorage) return;

          try {
            const normalizedSlug = recentEntry.slug.replace(/^\/+/, "");
            const raw = window.localStorage.getItem(storageKey);
            const parsed = raw ? JSON.parse(raw) : [];
            const items = Array.isArray(parsed)
              ? parsed.filter(
                  (item) =>
                    item &&
                    typeof item.slug === "string" &&
                    typeof item.title === "string"
                )
              : [];

            const next = [
              { ...recentEntry, slug: normalizedSlug },
              ...items.filter((item) => item.slug !== normalizedSlug),
            ];
            window.localStorage.setItem(storageKey, JSON.stringify(next.slice(0, 3)));
          } catch {
            // ignore storage errors
          }
        })();
      </script>

      <script>
        (() => {
          const key = "readingPreferences";
          const root = document.querySelector(".knowledge") as HTMLElement | null;
          if (!root) return;

          type ReadingPrefs = {
            fontSize: "small" | "medium" | "large";
            lineHeight: "compact" | "normal" | "relaxed";
            readingMode: boolean;
          };

          const defaults: ReadingPrefs = {
            fontSize: "medium",
            lineHeight: "normal",
            readingMode: false,
          };

          const modeToggle = document.querySelector(
            "[data-reading-mode-toggle]"
          ) as HTMLButtonElement | null;
          const fontButtons = Array.from(
            document.querySelectorAll("[data-reading-font-size]")
          ) as HTMLButtonElement[];
          const lineButtons = Array.from(
            document.querySelectorAll("[data-reading-line-height]")
          ) as HTMLButtonElement[];

          const isFontSize = (value: unknown): value is ReadingPrefs["fontSize"] =>
            value === "small" || value === "medium" || value === "large";
          const isLineHeight = (value: unknown): value is ReadingPrefs["lineHeight"] =>
            value === "compact" || value === "normal" || value === "relaxed";

          const read = (): ReadingPrefs => {
            try {
              const raw = window.localStorage?.getItem(key);
              const parsed = raw ? JSON.parse(raw) : null;

              return {
                fontSize: isFontSize(parsed?.fontSize)
                  ? parsed.fontSize
                  : defaults.fontSize,
                lineHeight: isLineHeight(parsed?.lineHeight)
                  ? parsed.lineHeight
                  : defaults.lineHeight,
                readingMode:
                  typeof parsed?.readingMode === "boolean"
                    ? parsed.readingMode
                    : defaults.readingMode,
              };
            } catch {
              return { ...defaults };
            }
          };

          const write = (prefs: ReadingPrefs) => {
            try {
              window.localStorage?.setItem(key, JSON.stringify(prefs));
            } catch {
              // ignore storage failures
            }
          };

          const render = (prefs: ReadingPrefs) => {
            root.dataset.readingFontSize = prefs.fontSize;
            root.dataset.readingLineHeight = prefs.lineHeight;
            root.classList.toggle("knowledge--reading-mode", prefs.readingMode);

            fontButtons.forEach((button) => {
              const isActive = button.dataset.readingFontSize === prefs.fontSize;
              button.dataset.active = isActive ? "true" : "false";
              button.setAttribute("aria-pressed", isActive ? "true" : "false");
            });

            lineButtons.forEach((button) => {
              const isActive = button.dataset.readingLineHeight === prefs.lineHeight;
              button.dataset.active = isActive ? "true" : "false";
              button.setAttribute("aria-pressed", isActive ? "true" : "false");
            });

            if (modeToggle) {
              modeToggle.setAttribute(
                "aria-pressed",
                prefs.readingMode ? "true" : "false"
              );
              modeToggle.textContent = prefs.readingMode
                ? "Reading mode: on"
                : "Reading mode: off";
            }

            window.dispatchEvent(
              new CustomEvent("reading-preferences:change", {
                detail: { preferences: prefs },
              })
            );
          };

          let prefs = read();
          render(prefs);

          fontButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const next = button.dataset.readingFontSize;
              if (!isFontSize(next)) return;
              prefs = { ...prefs, fontSize: next };
              write(prefs);
              render(prefs);
            });
          });

          lineButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const next = button.dataset.readingLineHeight;
              if (!isLineHeight(next)) return;
              prefs = { ...prefs, lineHeight: next };
              write(prefs);
              render(prefs);
            });
          });

          modeToggle?.addEventListener("click", () => {
            prefs = { ...prefs, readingMode: !prefs.readingMode };
            write(prefs);
            render(prefs);
          });

          window.addEventListener("reading-settings:open", () => {
            const controls = document.querySelector(
              ".reading-controls"
            ) as HTMLElement | null;
            controls?.scrollIntoView({ behavior: "smooth", block: "center" });
            const firstControl = controls?.querySelector(
              "button"
            ) as HTMLButtonElement | null;
            firstControl?.focus();
          });
        })();
      </script>

      <script>
        (() => {
          const bar = document.getElementById("reading-progress-bar");
          const label = document.getElementById("reading-progress-label");
          if (!bar || !label) return;
          const progressData = document.getElementById("recent-read-data");
          const progressSlug = progressData?.dataset.slug
            ? progressData.dataset.slug.replace(/^\/+/, "")
            : "";
          const progressKey = "mm_read_progress";

          const prefersReduced =
            window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches ?? false;
          if (!prefersReduced) {
            bar.style.transition = "width 120ms ease-out";
          }

          const getProgressStore = () => {
            if (!progressSlug) return null;
            try {
              const raw = window.localStorage?.getItem(progressKey);
              const parsed = raw ? JSON.parse(raw) : {};
              return parsed && typeof parsed === "object" ? parsed : {};
            } catch {
              return {};
            }
          };

          const setProgressStore = (store: Record<string, unknown>) => {
            if (!progressSlug) return;
            try {
              window.localStorage?.setItem(progressKey, JSON.stringify(store));
            } catch {
              // ignore storage errors
            }
          };

          const restoreProgress = () => {
            if (!progressSlug) return;
            const store = getProgressStore();
            if (!store || typeof store !== "object") return;
            const entry = (store as any)[progressSlug];
            const progress =
              entry && typeof entry.progress === "number" ? entry.progress : 0;
            if (progress < 0.02 || progress > 0.95) return;
            const doc = document.documentElement;
            const scrollable = doc.scrollHeight - doc.clientHeight;
            if (scrollable <= 0) return;
            if (doc.scrollTop > 4) return;
            const target = Math.round(scrollable * progress);
            window.scrollTo({
              top: target,
              behavior: prefersReduced ? "auto" : "smooth",
            });
          };

          let ticking = false;
          let hasInteracted = false;
          let lastSavedAt = 0;
          const compute = () => {
            const doc = document.documentElement;
            const scrollable = doc.scrollHeight - doc.clientHeight;
            const raw = scrollable > 0 ? (doc.scrollTop / scrollable) * 100 : 0;
            const clamped = Math.min(Math.max(raw, 0), 100);
            bar.style.width = `${clamped}%`;
            label.textContent = `Reading progress: ${clamped.toFixed(0)}%`;

            if (progressSlug && scrollable > 0 && hasInteracted) {
              const now = Date.now();
              if (now - lastSavedAt > 1000) {
                lastSavedAt = now;
                const store = getProgressStore() || {};
                if (clamped >= 98) {
                  if (store && typeof store === "object") {
                    delete (store as any)[progressSlug];
                  }
                  setProgressStore(store as Record<string, unknown>);
                } else {
                  (store as any)[progressSlug] = {
                    progress: clamped / 100,
                    updatedAt: new Date().toISOString(),
                  };
                  setProgressStore(store as Record<string, unknown>);
                }
              }
            }

            ticking = false;
          };

          const onScroll = () => {
            hasInteracted = true;
            if (ticking) return;
            ticking = true;
            requestAnimationFrame(compute);
          };

          window.addEventListener("scroll", onScroll, { passive: true });
          window.addEventListener("resize", onScroll);
          compute();
          const scheduleRestore = () => {
            window.setTimeout(() => {
              if (!hasInteracted) restoreProgress();
            }, 200);
          };
          scheduleRestore();
          window.addEventListener("load", scheduleRestore, { once: true });
          window.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden" && hasInteracted) compute();
          });
        })();
      </script>

      <BackToTop lang={lang} />
    </div>
    <style>
      .panel {
        --panel-radius: 1.5rem;
        --panel-padding: 1.5rem;
        --panel-bg: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
        --panel-border: color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
        position: relative;
        border-radius: var(--panel-radius);
        background: var(--panel-bg);
        border: 2px solid var(--panel-border);
        box-shadow: var(--gn-offset-shadow);
        padding: var(--panel-padding);
      }

      .panel::after {
        content: "";
        position: absolute;
        inset: 4px;
        border: 1px solid var(--gn-panel-inner);
        border-radius: calc(var(--panel-radius) - 0.25rem);
        pointer-events: none;
      }

      .panel--compact {
        --panel-padding: 1rem;
      }

      .panel--tight {
        --panel-padding: 1.25rem;
      }

      .panel--card {
        --panel-radius: 1.25rem;
        --panel-padding: 1.25rem;
      }

      .reading-progress {
        position: fixed;
        inset-inline: 0;
        top: 0;
        z-index: 60;
        height: 0.25rem;
        background: color-mix(in srgb, var(--color-gn-soot-950) 70%, transparent);
        backdrop-filter: blur(6px);
      }

      .reading-progress__bar {
        height: 100%;
        width: 0;
        background: linear-gradient(
          90deg,
          var(--color-gn-amber-400),
          var(--color-gn-amber-300),
          var(--color-gn-amber-200)
        );
        box-shadow: 0 0 10px rgba(95, 199, 255, 0.45);
      }

      @media (min-width: 640px) {
        .reading-progress {
          height: 0.375rem;
        }
      }

      @media (min-width: 1024px) {
        .reading-progress {
          height: 0.5rem;
        }
      }

      .knowledge {
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        color: var(--gn-ink);
        background-color: var(--gn-bg);
        font-family: var(--font-sans);
        line-height: var(--line-height-relaxed);
      }

      .knowledge[data-reading-font-size="small"] {
        --knowledge-prose-size: 1.05rem;
      }

      .knowledge[data-reading-font-size="medium"] {
        --knowledge-prose-size: 1.175rem;
      }

      .knowledge[data-reading-font-size="large"] {
        --knowledge-prose-size: 1.325rem;
      }

      .knowledge[data-reading-line-height="compact"] {
        --knowledge-prose-line-height: 1.5;
      }

      .knowledge[data-reading-line-height="normal"] {
        --knowledge-prose-line-height: 1.62;
      }

      .knowledge[data-reading-line-height="relaxed"] {
        --knowledge-prose-line-height: 1.78;
      }

      .knowledge--reading-mode .knowledge__hero,
      .knowledge--reading-mode .knowledge-share,
      .knowledge--reading-mode .knowledge__back,
      .knowledge--reading-mode #knowledge-quiz {
        display: none;
      }

      .knowledge--reading-mode .knowledge__main {
        gap: 1rem;
      }

      .knowledge--reading-mode .knowledge-article {
        border-color: color-mix(
          in srgb,
          var(--color-gn-amber-300) 38%,
          var(--gn-panel-border)
        );
      }

      .knowledge__backdrop {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          180deg,
          var(--color-gn-soot-900) 0%,
          var(--color-gn-soot-950) 65%,
          #000000 100%
        );
        z-index: 0;
        pointer-events: none;
      }

      .knowledge__texture {
        position: absolute;
        inset: 0;
        opacity: 0.2;
        background-image: var(--gn-halftone), var(--gn-noise);
        background-blend-mode: screen, normal;
        pointer-events: none;
        z-index: 1;
      }

      .knowledge__container {
        position: relative;
        z-index: 2;
        max-width: 72rem;
        margin: 0 auto;
        padding: 2.5rem 1rem 4rem;
      }

      @media (min-width: 640px) {
        .knowledge__container {
          padding: 3rem 1.5rem 4.5rem;
        }
      }

      @media (min-width: 1024px) {
        .knowledge__container {
          padding: 3.5rem 2rem 5rem;
        }
      }

      .knowledge__hero {
        display: grid;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      @media (min-width: 1024px) {
        .knowledge__hero {
          grid-template-columns: 1.1fr 0.9fr;
          align-items: stretch;
        }
      }

      .knowledge__hero-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        min-inline-size: 0;
      }

      .knowledge__meta {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.125rem;
        color: var(--gn-ink-muted);
      }

      @media (min-width: 640px) {
        .knowledge__meta {
          font-size: 1.125rem;
        }
      }

      .knowledge__pill {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
        background: color-mix(in srgb, var(--gn-bg) 75%, transparent);
        font-weight: 600;
        text-transform: none;
        line-height: 1;
      }

      .knowledge__pill--label {
        background: rgba(123, 214, 255, 0.18);
        border-color: color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
        color: var(--color-gn-amber-200);
        text-transform: uppercase;
        letter-spacing: 0.16em;
        font-size: 1.125rem;
      }

      .knowledge__pill--accent {
        background: rgba(123, 214, 255, 0.16);
        color: var(--color-gn-amber-200);
      }

      :root[data-theme="light"] .knowledge__pill--label {
        background: rgba(15, 79, 121, 0.1);
        border-color: color-mix(in srgb, var(--gn-panel-border) 72%, transparent);
        color: #0f3f68;
      }

      :root[data-theme="light"] .knowledge__pill--accent {
        background: rgba(15, 79, 121, 0.08);
        color: #0f3f68;
      }

      .knowledge__pill-icon {
        display: block;
        width: 1rem;
        height: 1rem;
        flex-shrink: 0;
        color: var(--color-gn-amber-300);
      }

      .knowledge__pill-icon--teal {
        color: var(--color-gn-teal-300);
      }

      .knowledge__title {
        margin: 0;
        color: var(--gn-ink);
      }

      .knowledge__summary {
        margin: 0;
        max-width: 64ch;
        color: var(--color-gn-parchment-100);
      }

      .knowledge__stats {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        font-size: 1rem;
        color: var(--gn-ink-muted);
      }

      @media (min-width: 640px) {
        .knowledge__stats {
          font-size: 1.125rem;
        }
      }

      .knowledge__quiz-link {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
        background: color-mix(in srgb, var(--gn-bg) 80%, transparent);
        color: var(--gn-ink);
        font-weight: 600;
        text-decoration: none;
        line-height: 1;
        transition:
          transform 160ms ease,
          border-color 160ms ease,
          box-shadow 160ms ease;
      }

      .knowledge__quiz-link:hover {
        transform: translateY(-2px);
      }

      .knowledge__quiz-link:focus-visible {
        outline: 3px solid var(--color-gn-amber-300);
        outline-offset: 3px;
      }

      .knowledge__aside {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        min-inline-size: 0;
      }

      @media (min-width: 1024px) {
        .knowledge__aside {
          gap: 1.5rem;
        }
      }

      .knowledge__media-panel {
        --panel-padding: 0;
        overflow: hidden;
      }

      .knowledge__media-frame {
        position: relative;
        aspect-ratio: 3 / 2;
        overflow: hidden;
      }

      .knowledge__media-image {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
        transition: transform var(--transition-base);
      }

      .knowledge__media-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .knowledge__media-overlay {
        position: absolute;
        inset: 0;
        z-index: 2;
        transition: opacity var(--transition-base);
      }

      .knowledge__media-panel:hover .knowledge__media-image {
        transform: scale(1.03);
      }

      .knowledge__media-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        aspect-ratio: 3 / 2;
        text-align: center;
        padding: 2rem;
        background: var(--gn-bg-muted);
        color: var(--gn-ink-muted);
      }

      .knowledge__media-placeholder-content {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        align-items: center;
      }

      .knowledge__media-placeholder-icon {
        width: 4rem;
        height: 4rem;
      }

      @media (min-width: 1024px) {
        .knowledge__media-placeholder-icon {
          width: 5rem;
          height: 5rem;
        }
      }

      .knowledge__panel-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 1.125rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--gn-ink-muted);
        font-weight: 600;
      }

      .knowledge__panel-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .knowledge__panel-icon {
        display: block;
        width: 1rem;
        height: 1rem;
        flex-shrink: 0;
        color: var(--color-gn-amber-300);
      }

      .knowledge-article {
        margin-top: 0.5rem;
      }

      .knowledge-share {
        margin-top: 2.5rem;
      }

      .knowledge-share__header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
      }

      .knowledge-share__title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gn-ink);
      }

      .knowledge-share__actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 1.125rem;
      }

      .knowledge-share__note {
        margin-top: 0.75rem;
        font-size: 1.125rem;
        color: var(--gn-ink-muted);
      }

      .knowledge__back {
        margin-top: 3rem;
        display: flex;
        justify-content: center;
      }

      .share-button {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        min-height: 44px;
        padding: 0.4rem 0.9rem;
        border-radius: 999px;
        border: 2px solid var(--gn-panel-border);
        font-size: 1.125rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        color: var(--gn-ink);
        background: color-mix(in srgb, var(--gn-bg-muted) 85%, transparent);
        transition:
          transform var(--transition-fast),
          box-shadow var(--transition-fast),
          background-color var(--transition-fast),
          border-color var(--transition-fast),
          color var(--transition-fast);
      }

      .share-button:hover {
        background: color-mix(in srgb, var(--gn-bg-muted) 75%, transparent);
        transform: translateY(-2px);
        box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.8);
      }

      .share-button:focus-visible {
        outline: 3px solid var(--color-gn-amber-300);
        outline-offset: 2px;
      }

      .share-button--primary {
        background: var(--color-gn-amber-500);
        color: var(--color-gn-soot-950);
        border-color: color-mix(in srgb, var(--gn-panel-border) 80%, transparent);
      }

      .share-button--primary:hover {
        background: var(--color-gn-amber-400);
      }

      .share-button__icon {
        display: block;
        width: 1rem;
        height: 1rem;
        flex-shrink: 0;
      }

      .knowledge__sr,
      .knowledge__title-sr {
        position: absolute;
        width: var(--sr-only-width);
        height: var(--sr-only-height);
        margin: var(--sr-only-margin);
        overflow: hidden;
        clip-path: var(--sr-only-clip-path);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </div></Layout
>

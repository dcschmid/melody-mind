---
import Layout from "@layouts/Layout.astro";
import KnowledgeCard from "@components/KnowledgeCard.astro";
import BackToTop from "@components/Shared/BackToTop.astro";
import PageShell from "@components/Shared/PageShell.astro";
import { buildPageSeo, type StructuredData } from "@utils/seo/buildPageSeo";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { sortKnowledgeEntries } from "@utils/content/sortKnowledgeEntries";
import { normalizeDate, derivePublishModified } from "@utils/content/dateUtils";
import { calculateReadingTime } from "@utils/readingTime";
import { resolveBaseUrl, resolvePageUrl } from "@utils/siteUrls";
import categories from "../../data/categories.json";
import { Image } from "astro:assets";
import SearchPanel from "@components/Search/SearchPanel.astro";

export const prerender = true;

type CategoryDef = {
  slug: string;
  name: string;
  description: string;
  image: string;
};

export async function getStaticPaths() {
  return (categories as CategoryDef[]).map((cat) => ({
    params: { slug: cat.slug },
  }));
}

const allCategories = categories as CategoryDef[];
const slug = (Astro.params?.slug as string) || "";
const category = allCategories.find((c) => c.slug === slug);

if (!category) {
  return new Response("Not found", { status: 404 });
}

let baseArticles: any[] = [];
try {
  baseArticles = await getCollectionCached("knowledge-en").catch(() => []);
} catch (e) {
  globalThis.console?.warn?.("category page: collection load issue", {
    error: (e as any)?.message || e,
  });
}

const articlesWithReadingTime = baseArticles.map((article: any) => {
  const createdAtRaw = article?.data?.createdAt;
  const updatedAtRaw = article?.data?.updatedAt;
  const createdAt = normalizeDate(createdAtRaw);
  const updatedAt = normalizeDate(updatedAtRaw);
  const readingTime =
    article.data.readingTime || calculateReadingTime(article.body || "");
  return {
    ...article,
    data: { ...article.data, createdAt, updatedAt, readingTime },
  };
});

const filteredArticles = sortKnowledgeEntries(
  articlesWithReadingTime.filter((a) => a.data.category === slug)
);

const keywordPool = filteredArticles.flatMap((article) => article.data.keywords || []);
const metaKeywords = keywordPool.slice(0, 10).join(", ");

let earliestCreated: Date | null = null;
let latestUpdated: Date | null = null;
for (const a of filteredArticles) {
  const c = normalizeDate(a.data.createdAt);
  if (c && (!earliestCreated || c.getTime() < earliestCreated.getTime()))
    earliestCreated = c;
  const u = normalizeDate(a.data.updatedAt);
  if (u && (!latestUpdated || u.getTime() > latestUpdated.getTime())) latestUpdated = u;
}
const collectionDates = derivePublishModified(earliestCreated, latestUpdated);

const baseUrl = resolveBaseUrl(Astro.site);
const currentUrl = resolvePageUrl(Astro.site, `/categories/${category.slug}`);
const seoBreadcrumbs = [
  { name: "Home", url: resolvePageUrl(Astro.site, "/") },
  { name: category.name, url: currentUrl },
];
const breadcrumbs = seoBreadcrumbs.map((crumb) => ({
  ...crumb,
  url: crumb.url.replace(baseUrl, "") || "/",
}));

const breadcrumbSchema = seoBreadcrumbs.length
  ? {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      itemListElement: seoBreadcrumbs.map((crumb, index) => ({
        "@type": "ListItem",
        position: index + 1,
        name: crumb.name,
        item: crumb.url,
      })),
    }
  : undefined;

const itemListSchema = filteredArticles.length
  ? {
      "@context": "https://schema.org",
      "@type": "ItemList",
      name: `${category.name} articles`,
      numberOfItems: filteredArticles.length,
      itemListElement: filteredArticles.map((article, index: number) => {
        const articleSlug = "slug" in article ? article.slug : article.id;
        return {
          "@type": "ListItem",
          position: index + 1,
          item: {
            "@type": "Article",
            name: article.data.title,
            description: article.data.description,
            url: `${baseUrl}/knowledge/${articleSlug}`,
            dateCreated: article.data.createdAt
              ? new Date(String(article.data.createdAt)).toISOString()
              : undefined,
            dateModified: article.data.updatedAt
              ? new Date(String(article.data.updatedAt)).toISOString()
              : undefined,
            keywords: article.data.keywords?.join(", "),
            image: article.data.image,
          },
        };
      }),
    }
  : undefined;

const pageSeo = buildPageSeo({
  title: `${category.name} | Categories`,
  description: category.description,
  url: currentUrl,
  contentKind: "generic",
  breadcrumbs: seoBreadcrumbs,
  structuredData: [breadcrumbSchema, itemListSchema].filter(Boolean) as StructuredData[],
  enrichedParts: [category.name, category.description],
  fallbackKeywords: metaKeywords
    .split(",")
    .map((k) => k.trim())
    .filter(Boolean),
  keywordLimit: 24,
  maxDescription: 150,
  image: category.image,
  publishDate: collectionDates.publishDate || undefined,
  modifiedDate: collectionDates.modifiedDate || undefined,
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo} {breadcrumbs}>
  <PageShell
    className="page-shell--aurora page-shell--grid"
    containerClass="page-shell__container--spacious"
  >
    <div class="category-page">
      <header class="panel category-hero">
        <div class="category-hero__grid">
          <div class="category-hero__media">
            <Image
              src={category.image}
              alt={`${category.name} hero`}
              loading="lazy"
              decoding="async"
              class="category-hero__image"
              width="1920"
              height="1080"
            />
            <div class="category-hero__overlay" aria-hidden="true"></div>
          </div>
          <div class="category-hero__content">
            <div>
              <div class="category-hero__eyebrow">
                <span class="category-hero__dot"></span>
                Explore category
              </div>
              <h1 id="category-heading" class="category-hero__title">
                {category.name}
              </h1>
              <p class="category-hero__description">{category.description}</p>
            </div>
            <div class="category-hero__stats">
              <span class="category-hero__stat">
                <span class="category-hero__dot"></span>
                {filteredArticles.length} articles
              </span>
            </div>
          </div>
        </div>
      </header>

      <section
        class="category-page__section"
        aria-labelledby="category-heading"
        aria-describedby="category-helper-text"
      >
        <p id="category-helper-text" class="category-page__helper">
          Article cards announce title, description, publish date, and estimated reading
          time.
        </p>
        <SearchPanel
          idBase="category-search"
          label="Search articles"
          placeholder="Search by title, description, or keyword"
          ariaControls="category-articles-list"
          statusAllText="Showing all articles"
          statusCountTemplate="{count} articles found"
          noResultsTemplate='No results for "{term}"'
        />
        {
          filteredArticles.length > 0 ? (
            <>
              <ul
                class="category-page__grid"
                id="category-articles-list"
                aria-label={`${category.name} articles`}
              >
                {filteredArticles.map((article, index: number) => {
                  const createdAt =
                    article.data.createdAt instanceof Date
                      ? article.data.createdAt
                      : normalizeDate(article.data.createdAt) || new Date();
                  const articleSlug = "slug" in article ? article.slug : article.id;

                  return (
                    <li
                      data-search-text={`${article.data.title} ${article.data.description} ${article.data.keywords?.join(" ") || ""}`}
                    >
                      <KnowledgeCard
                        title={article.data.title}
                        description={article.data.description}
                        image={article.data.image as string}
                        createdAt={createdAt}
                        slug={articleSlug}
                        lang="en"
                        readingTime={article.data.readingTime}
                        articleUrl={`/knowledge/${articleSlug}`}
                        keywords={article.data.keywords?.join(", ")}
                        index={index}
                      />
                    </li>
                  );
                })}
              </ul>
              <div
                id="category-search-empty"
                class="category-page__empty"
                aria-live="polite"
                hidden
              >
                No results match your search. Try a different keyword.
              </div>
            </>
          ) : (
            <div
              class="category-page__empty"
              role="status"
              aria-live="polite"
              id="category-search-no-results"
            >
              <p class="category-page__empty-title">No articles in this category yet.</p>
              <p class="category-page__empty-text">
                Check back soon for fresh additions.
              </p>
            </div>
          )
        }
      </section>
    </div>
  </PageShell>

  <BackToTop lang="en" />
</Layout>

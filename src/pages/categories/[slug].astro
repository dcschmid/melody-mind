---
import Layout from "@layouts/Layout.astro";
import KnowledgeCard from "@components/KnowledgeCard.astro";
import BackToTop from "@components/Shared/BackToTop.astro";
import PageShell from "@components/Shared/PageShell.astro";
import { buildPageSeo, type StructuredData } from "@utils/seo/buildPageSeo";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { sortKnowledgeEntries } from "@utils/content/sortKnowledgeEntries";
import { normalizeDate, derivePublishModified } from "@utils/content/dateUtils";
import { calculateReadingTime } from "@utils/readingTime";
import { resolveBaseUrl, resolvePageUrl } from "@utils/siteUrls";
import categories from "../../data/categories.json";
import { Image } from "astro:assets";
import SearchPanel from "@components/Search/SearchPanel.astro";

export const prerender = true;

type CategoryDef = {
  slug: string;
  name: string;
  description: string;
  image: string;
};

export async function getStaticPaths() {
  return (categories as CategoryDef[]).map((cat) => ({
    params: { slug: cat.slug },
  }));
}

const allCategories = categories as CategoryDef[];
const slug = (Astro.params?.slug as string) || "";
const category = allCategories.find((c) => c.slug === slug);

if (!category) {
  return new Response("Not found", { status: 404 });
}

let baseArticles: any[] = [];
try {
  baseArticles = await getCollectionCached("knowledge-en").catch(() => []);
} catch (e) {
  globalThis.console?.warn?.("category page: collection load issue", {
    error: (e as any)?.message || e,
  });
}

const articlesWithReadingTime = baseArticles.map((article: any) => {
  const createdAtRaw = article?.data?.createdAt;
  const updatedAtRaw = article?.data?.updatedAt;
  const createdAt = normalizeDate(createdAtRaw);
  const updatedAt = normalizeDate(updatedAtRaw);
  const readingTime =
    article.data.readingTime || calculateReadingTime(article.body || "");
  return {
    ...article,
    data: { ...article.data, createdAt, updatedAt, readingTime },
  };
});

const filteredArticles = sortKnowledgeEntries(
  articlesWithReadingTime.filter((a) => a.data.category === slug)
);

const keywordPool = filteredArticles.flatMap((article) => article.data.keywords || []);
const metaKeywords = keywordPool.slice(0, 10).join(", ");

let earliestCreated: Date | null = null;
let latestUpdated: Date | null = null;
for (const a of filteredArticles) {
  const c = normalizeDate(a.data.createdAt);
  if (c && (!earliestCreated || c.getTime() < earliestCreated.getTime()))
    earliestCreated = c;
  const u = normalizeDate(a.data.updatedAt);
  if (u && (!latestUpdated || u.getTime() > latestUpdated.getTime())) latestUpdated = u;
}
const collectionDates = derivePublishModified(earliestCreated, latestUpdated);

const baseUrl = resolveBaseUrl(Astro.site);
const currentUrl = resolvePageUrl(Astro.site, `/categories/${category.slug}`);
const seoBreadcrumbs = [
  { name: "Home", url: resolvePageUrl(Astro.site, "/") },
  { name: category.name, url: currentUrl },
];
const breadcrumbs = seoBreadcrumbs.map((crumb) => ({
  ...crumb,
  url: crumb.url.replace(baseUrl, "") || "/",
}));

const breadcrumbSchema = seoBreadcrumbs.length
  ? {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      itemListElement: seoBreadcrumbs.map((crumb, index) => ({
        "@type": "ListItem",
        position: index + 1,
        name: crumb.name,
        item: crumb.url,
      })),
    }
  : undefined;

const itemListSchema = filteredArticles.length
  ? {
      "@context": "https://schema.org",
      "@type": "ItemList",
      name: `${category.name} articles`,
      numberOfItems: filteredArticles.length,
      itemListElement: filteredArticles.map((article, index: number) => {
        const articleSlug = "slug" in article ? article.slug : article.id;
        return {
          "@type": "ListItem",
          position: index + 1,
          item: {
            "@type": "Article",
            name: article.data.title,
            description: article.data.description,
            url: `${baseUrl}/knowledge/${articleSlug}`,
            dateCreated: article.data.createdAt
              ? new Date(String(article.data.createdAt)).toISOString()
              : undefined,
            dateModified: article.data.updatedAt
              ? new Date(String(article.data.updatedAt)).toISOString()
              : undefined,
            keywords: article.data.keywords?.join(", "),
            image: article.data.image,
          },
        };
      }),
    }
  : undefined;

const pageSeo = buildPageSeo({
  title: `${category.name} | Categories`,
  description: category.description,
  url: currentUrl,
  contentKind: "generic",
  breadcrumbs: seoBreadcrumbs,
  structuredData: [breadcrumbSchema, itemListSchema].filter(Boolean) as StructuredData[],
  enrichedParts: [category.name, category.description],
  fallbackKeywords: metaKeywords
    .split(",")
    .map((k) => k.trim())
    .filter(Boolean),
  keywordLimit: 24,
  maxDescription: 150,
  image: category.image,
  publishDate: collectionDates.publishDate || undefined,
  modifiedDate: collectionDates.modifiedDate || undefined,
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo} {breadcrumbs}>
  <PageShell
    className="page-shell--aurora page-shell--grid"
    containerClass="page-shell__container--wide"
  >
    <div class="category-page">
      <header class="category-hero">
        <div class="category-hero__headline">
          <div class="category-hero__eyebrow">
            <span class="category-hero__dot"></span>
            Explore category
          </div>
          <h1 id="category-heading" class="category-hero__title">
            {category.name}
          </h1>
        </div>
        <div class="category-hero__media">
          <div class="category-hero__background">
            <Image
              src={category.image}
              alt={`${category.name} hero`}
              loading="lazy"
              decoding="async"
              class="category-hero__image"
              width="1920"
              height="1280"
            />
            <div class="category-hero__overlay" aria-hidden="true"></div>
          </div>
          <div class="category-hero__body">
            <div class="category-hero__content">
              <p class="category-hero__description">{category.description}</p>
              <div class="category-hero__stats">
                <span class="category-hero__stat">
                  <span class="category-hero__dot"></span>
                  {filteredArticles.length} articles
                </span>
              </div>
            </div>
          </div>
        </div>
      </header>

      <section
        class="category-page__section"
        aria-labelledby="category-heading"
        aria-describedby="category-helper-text"
      >
        <div class="category-page__tools">
          <p id="category-helper-text" class="category-page__helper">
            Article cards announce title, description, publish date, and estimated reading
            time.
          </p>
          <div class="category-page__search search-panel-shell">
            <SearchPanel
              idBase="category-search"
              label="Search articles"
              placeholder="Search by title, description, or keyword"
              ariaControls="category-articles-list"
              analyticsSurface="category-articles"
              statusAllText="Showing all articles"
              statusCountTemplate="{count} articles found"
              noResultsTemplate='No results for "{term}"'
            />
          </div>
        </div>
        {
          filteredArticles.length > 0 ? (
            <>
              <ul
                class="category-page__grid"
                id="category-articles-list"
                aria-label={`${category.name} articles`}
              >
                {filteredArticles.map((article, index: number) => {
                  const createdAt =
                    article.data.createdAt instanceof Date
                      ? article.data.createdAt
                      : normalizeDate(article.data.createdAt) || new Date();
                  const articleSlug = "slug" in article ? article.slug : article.id;

                  return (
                    <li
                      data-search-text={`${article.data.title} ${article.data.description} ${article.data.keywords?.join(" ") || ""}`}
                    >
                      <KnowledgeCard
                        title={article.data.title}
                        description={article.data.description}
                        image={article.data.image as string}
                        createdAt={createdAt}
                        slug={articleSlug}
                        lang="en"
                        readingTime={article.data.readingTime}
                        articleUrl={`/knowledge/${articleSlug}`}
                        keywords={article.data.keywords?.join(", ")}
                        index={index}
                      />
                    </li>
                  );
                })}
              </ul>
              <div
                id="category-search-empty"
                class="category-page__empty"
                aria-live="polite"
                hidden
              >
                No results match your search. Try a different keyword.
              </div>
            </>
          ) : (
            <div
              class="category-page__empty"
              role="status"
              aria-live="polite"
              id="category-search-no-results"
            >
              <p class="category-page__empty-title">No articles in this category yet.</p>
              <p class="category-page__empty-text">
                Check back soon for fresh additions.
              </p>
            </div>
          )
        }
      </section>
    </div>
  </PageShell>

  <BackToTop lang="en" />
</Layout>
<style>
  .panel {
    --panel-radius: 1.5rem;
    --panel-padding: 1.5rem;
    --panel-bg: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
    --panel-border: color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    position: relative;
    border-radius: var(--panel-radius);
    background: var(--panel-bg);
    border: 2px solid var(--panel-border);
    box-shadow: var(--gn-offset-shadow);
    padding: var(--panel-padding);
  }

  .panel::after {
    content: "";
    position: absolute;
    inset: 4px;
    border: 1px solid var(--gn-panel-inner);
    border-radius: calc(var(--panel-radius) - 0.25rem);
    pointer-events: none;
  }

  .panel--compact {
    --panel-padding: 1rem;
  }

  .panel--tight {
    --panel-padding: 1.25rem;
  }

  .panel--card {
    --panel-radius: 1.25rem;
    --panel-padding: 1.25rem;
  }

  .category-page {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  .category-page__section {
    display: flex;
    flex-direction: column;
    gap: clamp(1.75rem, 2.4vi, 2.5rem);
  }

  .category-hero {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  @media (min-width: 768px) {
    .category-hero {
      gap: 2rem;
    }
  }

  .category-hero__headline {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .category-hero__media {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  @media (min-width: 768px) {
    .category-hero__media {
      flex-direction: row;
      align-items: stretch;
      gap: 2rem;
    }
  }

  .category-hero__background {
    position: relative;
    width: 100%;
    aspect-ratio: 3 / 2;
    border-radius: 2rem;
    overflow: hidden;
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
    box-shadow:
      0 30px 80px rgba(7, 12, 24, 0.55),
      0 12px 24px rgba(7, 12, 24, 0.35);
  }

  .category-hero__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
  }

  .category-hero__overlay {
    position: absolute;
    inset: 0;
    display: none;
  }

  .category-hero__body {
    width: 100%;
    display: flex;
    justify-content: center;
  }

  @media (min-width: 768px) {
    .category-hero__background,
    .category-hero__body {
      width: 50%;
    }

    .category-hero__body {
      align-items: center;
    }
  }

  @media (min-width: 1024px) {
    .category-hero__background {
      width: 58%;
    }

    .category-hero__body {
      width: 42%;
    }
  }

  .category-hero__content {
    width: min(820px, 100%);
    padding: 2rem 2.25rem;
    border-radius: 1.5rem;
    background: linear-gradient(
      160deg,
      color-mix(in srgb, var(--gn-bg) 70%, transparent),
      color-mix(in srgb, var(--gn-bg) 50%, transparent)
    );
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 60%, transparent);
    box-shadow:
      0 18px 40px rgba(7, 12, 24, 0.45),
      inset 0 1px 0 color-mix(in srgb, var(--gn-ink) 8%, transparent);
    backdrop-filter: blur(12px);
  }

  .category-hero__eyebrow {
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
    font-size: 0.75rem;
    letter-spacing: 0.24em;
    text-transform: uppercase;
    font-weight: 700;
    color: var(--gn-ink);
    margin-bottom: 1.5rem;
    padding: 0.4rem 0.9rem;
    border-radius: 999px;
    background: color-mix(in srgb, var(--gn-bg) 80%, transparent);
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
    box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--gn-ink) 4%, transparent);
  }

  @media (min-width: 640px) {
    .category-hero__eyebrow {
      font-size: 0.875rem;
    }
  }

  .category-hero__dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 999px;
    background: var(--color-gn-amber-300);
    box-shadow: 0 0 10px color-mix(in srgb, var(--color-gn-amber-300) 70%, transparent);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.7;
      transform: scale(0.95);
    }
  }

  .category-hero__title {
    margin: 0;
    font-size: 2.4rem;
    font-weight: 700;
    line-height: 1.1;
    color: var(--gn-ink);
    letter-spacing: -0.02em;
    text-shadow: 0 4px 18px rgba(7, 12, 24, 0.35);
    background: none;
  }

  @media (min-width: 640px) {
    .category-hero__title {
      font-size: 3.25rem;
    }
  }

  @media (min-width: 1024px) {
    .category-hero__title {
      font-size: 4rem;
    }
  }

  .category-hero__description {
    margin: 0 0 2rem;
    font-size: 1.05rem;
    line-height: 1.75;
    color: var(--gn-ink-muted);
    font-weight: 400;
    max-width: 60ch;
    text-shadow: 0 2px 10px rgba(7, 12, 24, 0.3);
  }

  @media (min-width: 640px) {
    .category-hero__description {
      font-size: 1.125rem;
      line-height: 1.75;
    }
  }

  @media (min-width: 1024px) {
    .category-hero__description {
      font-size: 1.2rem;
      margin-bottom: 2.25rem;
    }
  }

  .category-hero__stats {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .category-hero__stat {
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.7rem 1.4rem;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 65%, transparent);
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--gn-bg) 88%, transparent),
      color-mix(in srgb, var(--gn-bg) 72%, transparent)
    );
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--gn-ink);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(12px);
    box-shadow:
      0 4px 12px rgba(0, 0, 0, 0.15),
      inset 0 0 0 1px color-mix(in srgb, var(--gn-ink) 6%, transparent);
  }

  .category-hero__stat:hover {
    border-color: color-mix(in srgb, var(--color-gn-amber-300) 70%, transparent);
    background: color-mix(in srgb, var(--gn-bg) 92%, transparent);
    transform: translateY(-2px);
    box-shadow:
      0 6px 20px rgba(0, 0, 0, 0.2),
      inset 0 0 0 1px color-mix(in srgb, var(--gn-ink) 10%, transparent);
  }

  .category-page__tools {
    display: grid;
    gap: 1.25rem;
  }

  @media (min-width: 960px) {
    .category-page__tools {
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      align-items: stretch;
    }
  }

  .category-page__helper {
    font-size: 1rem;
    color: var(--gn-ink-muted);
    margin: 0;
    line-height: 1.6;
    font-weight: 400;
    padding: 1.25rem 1.5rem;
    border-radius: 1rem;
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--gn-bg-muted) 92%, transparent),
      color-mix(in srgb, var(--gn-bg) 85%, transparent)
    );
    box-shadow:
      0 10px 24px rgba(7, 12, 24, 0.3),
      inset 0 1px 0 color-mix(in srgb, var(--gn-ink) 6%, transparent);
  }

  @media (min-width: 640px) {
    .category-page__helper {
      padding: 1rem 1.2rem;
      font-size: 1.0625rem;
    }
  }

  .category-page__search {
    padding: 1.25rem 1.5rem;
    border-radius: 1.25rem;
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 65%, transparent);
    background: linear-gradient(
      155deg,
      color-mix(in srgb, var(--gn-bg) 92%, transparent),
      color-mix(in srgb, var(--gn-bg-muted) 85%, transparent)
    );
    box-shadow:
      0 16px 32px rgba(7, 12, 24, 0.35),
      inset 0 1px 0 color-mix(in srgb, var(--gn-ink) 6%, transparent);
  }

  .category-page__search :global(.search-panel__input) {
    border-radius: 1.1rem;
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 65%, transparent);
    background: color-mix(in srgb, var(--gn-bg) 88%, transparent);
    box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--gn-ink) 4%, transparent);
    font-size: 1.05rem;
  }

  @media (min-width: 640px) {
    .category-page__search :global(.search-panel__input) {
      font-size: 1.15rem;
    }
  }

  .category-page__search :global(.search-panel__input:hover) {
    border-color: color-mix(in srgb, var(--color-gn-amber-300) 65%, transparent);
    box-shadow:
      0 0 0 1px color-mix(in srgb, var(--gn-ink) 6%, transparent),
      0 10px 18px rgba(7, 12, 24, 0.18);
  }

  .category-page__search :global(.search-panel__input:focus-visible) {
    box-shadow:
      0 0 0 3px color-mix(in srgb, var(--color-gn-amber-300) 35%, transparent),
      0 12px 22px rgba(7, 12, 24, 0.22);
  }

  .category-page__search :global(.search-panel__reset) {
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 60%, transparent);
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--color-gn-amber-400) 85%, transparent),
      color-mix(in srgb, var(--color-gn-amber-300) 75%, transparent)
    );
    color: var(--color-gn-soot-950);
    box-shadow:
      0 8px 18px rgba(7, 12, 24, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.4);
  }

  .category-page__search :global(.search-panel__reset:hover) {
    transform: translateY(-1px);
    box-shadow:
      0 12px 24px rgba(7, 12, 24, 0.25),
      inset 0 1px 0 rgba(255, 255, 255, 0.45);
  }

  .category-page__grid {
    display: grid;
    gap: 2rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  @media (min-width: 640px) {
    .category-page__grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1.75rem;
    }
  }

  @media (min-width: 1024px) {
    .category-page__grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 2rem;
    }
  }

  .category-page__empty {
    padding: 3rem 2rem;
    border-radius: 1.25rem;
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
    background:
      radial-gradient(
        circle at top,
        color-mix(in srgb, var(--color-gn-amber-300) 10%, transparent),
        transparent 55%
      ),
      linear-gradient(
        165deg,
        color-mix(in srgb, var(--gn-bg) 92%, transparent),
        color-mix(in srgb, var(--gn-bg-muted) 82%, transparent)
      );
    text-align: center;
    color: var(--gn-ink-muted);
    box-shadow:
      0 18px 36px rgba(7, 12, 24, 0.35),
      inset 0 1px 0 color-mix(in srgb, var(--gn-ink) 6%, transparent);
  }

  .category-page__empty-title {
    margin: 0;
    font-size: 1.375rem;
    font-weight: 700;
    color: var(--gn-ink);
    letter-spacing: -0.01em;
  }

  .category-page__empty-text {
    margin-top: 0.75rem;
    font-size: 1.0625rem;
    color: var(--gn-ink-muted);
    line-height: 1.6;
  }
</style>

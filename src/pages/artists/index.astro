---
import Layout from "@layouts/Layout.astro";
import PageShell from "@components/Shared/PageShell.astro";
import SearchPanel from "@components/Search/SearchPanel.astro";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { buildPageSeo } from "@utils/seo/buildPageSeo";
import { resolvePageUrl } from "@utils/siteUrls";
import type { ArtistEntry } from "../../types/artist";

export const prerender = true;

const artists = ((await getCollectionCached("artists").catch(() => [])) as ArtistEntry[])
  .filter((artist) => Boolean(artist.id) && Boolean(artist.data?.name))
  .sort((a, b) => a.data.name.localeCompare(b.data.name));

const resolveArtistSlug = (artist: ArtistEntry): string =>
  artist.id.replace(/\.mdx?$/, "");

const pageUrl = resolvePageUrl(Astro.site, "/artists");
const breadcrumbsBase = [
  { name: "Home", url: resolvePageUrl(Astro.site, "/") },
  { name: "Artists", url: pageUrl },
];

const pageSeo = buildPageSeo({
  title: "Artists | Melody Mind",
  description:
    "Explore artist profiles, influences, genre context, and related knowledge articles.",
  url: pageUrl,
  contentKind: "generic",
  breadcrumbs: breadcrumbsBase,
  enrichedParts: ["artists", "music history", "influences", "discography"],
  fallbackKeywords: ["artists", "music", "influences", "genres"],
  keywordLimit: 20,
  maxDescription: 150,
  image: "/melody-mind.jpg",
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo}>
  <PageShell className="page-shell--aurora page-shell--grid">
    <div class="artists-index">
      <header class="artists-index__header">
        <div class="artists-index__headline">
          <p class="artists-index__eyebrow">Artist Profiles</p>
          <h1 class="artists-index__title">Discover the people behind the sound</h1>
          <p class="artists-index__description">
            Browse artist snapshots with biography, genres, and influence context. Open a
            profile to explore timeline, key works, related artists, and linked articles.
          </p>
        </div>
        <div class="artists-index__search search-panel-shell">
          <SearchPanel
            idBase="artists-search"
            label="Search artists"
            placeholder="Search by artist, genre, origin"
            ariaControls="artists-list"
            analyticsSurface="artists-index"
            statusAllText="Showing all artists"
            statusCountTemplate="{count} artists found"
            noResultsTemplate='No artists found for "{term}"'
          />
        </div>
      </header>

      {
        artists.length ? (
          <>
            <ul
              class="artists-index__grid"
              id="artists-list"
              aria-label="Artist profiles"
            >
              {artists.map((artist) => (
                <li
                  class="artist-card"
                  data-search-text={`${artist.data.name} ${artist.data.origin} ${artist.data.genres.join(" ")}`}
                >
                  <a
                    href={`/artists/${resolveArtistSlug(artist)}`}
                    class="artist-card__link"
                  >
                    <div class="artist-card__media">
                      <img
                        src={artist.data.photo || "/default-cover.jpg"}
                        alt={`Portrait of ${artist.data.name}`}
                        class="artist-card__image"
                        loading="lazy"
                      />
                    </div>
                    <div class="artist-card__body">
                      <p class="artist-card__name">{artist.data.name}</p>
                      <p class="artist-card__origin">{artist.data.origin}</p>
                      <p class="artist-card__genres">{artist.data.genres.join(" â€¢ ")}</p>
                      <p class="artist-card__bio">{artist.data.biography}</p>
                    </div>
                  </a>
                </li>
              ))}
            </ul>
            <div
              id="artists-search-empty"
              class="artists-index__empty"
              aria-live="polite"
              hidden
            >
              No artists match your search. Try a different term.
            </div>
          </>
        ) : (
          <div class="artists-index__empty" role="status" aria-live="polite">
            No artist profiles available yet.
          </div>
        )
      }
    </div>
  </PageShell>
</Layout>

<style>
  .artists-index {
    display: grid;
    gap: 2rem;
  }

  .artists-index__header {
    display: grid;
    gap: 1.25rem;
  }

  @media (min-width: 960px) {
    .artists-index__header {
      grid-template-columns: minmax(0, 1fr) minmax(0, 30rem);
      align-items: end;
    }
  }

  .artists-index__headline {
    display: grid;
    gap: 0.65rem;
  }

  .artists-index__eyebrow {
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--gn-ink-muted);
    font-size: 0.95rem;
    font-weight: 700;
  }

  .artists-index__title {
    margin: 0;
    font-size: clamp(2rem, 4.8vw, 3.2rem);
    color: var(--gn-ink);
    line-height: 1.1;
  }

  .artists-index__description {
    margin: 0;
    color: var(--gn-ink-muted);
    font-size: 1.125rem;
    line-height: 1.7;
    max-width: 62ch;
  }

  .artists-index__search {
    margin-inline-start: auto;
    inline-size: 100%;
    --search-shell-max-inline-size: 30rem;
  }

  .artists-index__grid {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 1.25rem;
  }

  @media (min-width: 640px) {
    .artists-index__grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1024px) {
    .artists-index__grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .artist-card {
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    border-radius: 1.2rem;
    background: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
    box-shadow: var(--gn-offset-shadow);
    overflow: hidden;
    transition:
      transform var(--transition-base),
      box-shadow var(--transition-base);
  }

  .artist-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 16px 30px rgba(0, 0, 0, 0.35);
  }

  .artist-card__link {
    display: flex;
    flex-direction: column;
    height: 100%;
    color: inherit;
    text-decoration: none;
  }

  .artist-card__link:focus-visible {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 3px;
  }

  .artist-card__media {
    aspect-ratio: 4 / 3;
    overflow: hidden;
    background: var(--gn-bg);
  }

  .artist-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .artist-card__body {
    display: grid;
    gap: 0.55rem;
    padding: 1rem;
  }

  .artist-card__name {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--gn-ink);
  }

  .artist-card__origin,
  .artist-card__genres,
  .artist-card__bio {
    margin: 0;
    color: var(--gn-ink-muted);
  }

  .artist-card__genres {
    font-size: 0.95rem;
  }

  .artist-card__bio {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    font-size: 1rem;
    line-height: 1.6;
  }

  .artists-index__empty {
    padding: 1.25rem;
    border-radius: 1rem;
    border: 2px solid var(--gn-panel-border);
    background: var(--gn-bg-muted);
    color: var(--gn-ink-muted);
    text-align: center;
  }
</style>

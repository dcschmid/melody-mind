---
import Layout from "@layouts/Layout.astro";
import PageShell from "@components/Shared/PageShell.astro";
import SearchPanel from "@components/Search/SearchPanel.astro";
import BackToTop from "@components/Shared/BackToTop.astro";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { buildPageSeo } from "@utils/seo/buildPageSeo";
import { resolvePageUrl } from "@utils/siteUrls";
import type { ArtistEntry } from "../../types/artist";

export const prerender = true;

const artists = ((await getCollectionCached("artists").catch(() => [])) as ArtistEntry[])
  .filter((artist) => Boolean(artist.id) && Boolean(artist.data?.name))
  .sort((a, b) => a.data.name.localeCompare(b.data.name));

const genreOptions = Array.from(
  new Set(
    artists.flatMap((artist) =>
      (artist.data.genres || []).map((genre) => genre.trim()).filter(Boolean)
    )
  )
).sort((a, b) => a.localeCompare(b));

const resolveArtistSlug = (artist: ArtistEntry): string =>
  artist.id.replace(/\.mdx?$/, "");

const pageUrl = resolvePageUrl(Astro.site, "/artists");
const breadcrumbsBase = [
  { name: "Home", url: resolvePageUrl(Astro.site, "/") },
  { name: "Artists", url: pageUrl },
];

const pageSeo = buildPageSeo({
  title: "Artists | Melody Mind",
  description:
    "Explore artist profiles, influences, genre context, and related knowledge articles.",
  url: pageUrl,
  contentKind: "generic",
  breadcrumbs: breadcrumbsBase,
  enrichedParts: ["artists", "music history", "influences", "discography"],
  fallbackKeywords: ["artists", "music", "influences", "genres"],
  keywordLimit: 20,
  maxDescription: 150,
  image: "/melody-mind.jpg",
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo}>
  <PageShell className="page-shell--aurora page-shell--grid">
    <div class="artists-index">
      <header class="artists-index__header">
        <div class="artists-index__headline">
          <p class="artists-index__eyebrow">Artist Profiles</p>
          <h1 class="artists-index__title">Discover the people behind the sound</h1>
          <p class="artists-index__description">
            Browse artist snapshots with biography, genres, and influence context. Open a
            profile to explore timeline, key works, related artists, and linked articles.
          </p>
        </div>
        <div class="artists-index__controls">
          <div class="artists-index__search search-panel-shell">
            <SearchPanel
              idBase="artists-search"
              label="Search artists"
              placeholder="Search by artist, genre, origin"
              ariaControls="artists-list"
              analyticsSurface="artists-index"
              statusAllText="Showing all artists"
              statusCountTemplate="{count} artists found"
              noResultsTemplate='No artists found for "{term}"'
            />
          </div>

          <div class="artists-index__filters" aria-label="Artist filters">
            <div class="artists-index__genre-filter">
              <label for="artists-genre-filter" class="artists-index__genre-label"
                >Genre filter</label
              >
              <select
                id="artists-genre-filter"
                class="artists-index__genre-input"
                data-search-genre-filter-for="artists-list"
              >
                <option value="">All genres</option>
                {genreOptions.map((genre) => <option value={genre}>{genre}</option>)}
              </select>
            </div>
          </div>
        </div>
      </header>

      {
        artists.length ? (
          <>
            <ul
              class="artists-index__grid"
              id="artists-list"
              aria-label="Artist profiles"
            >
              {artists.map((artist) => (
                <li
                  class="artist-card"
                  data-search-text={`${artist.data.name} ${artist.data.origin} ${artist.data.genres.join(" ")}`}
                  data-search-genres={artist.data.genres.join("||")}
                >
                  <a
                    href={`/artists/${resolveArtistSlug(artist)}`}
                    class="artist-card__link"
                  >
                    <div class="artist-card__media">
                      <img
                        src={artist.data.photo || "/default-cover.jpg"}
                        alt={`Portrait of ${artist.data.name}`}
                        class="artist-card__image"
                        loading="lazy"
                      />
                    </div>
                    <div class="artist-card__body">
                      <p class="artist-card__name">{artist.data.name}</p>
                      <p class="artist-card__origin">{artist.data.origin}</p>
                      <p class="artist-card__genres">{artist.data.genres.join(" â€¢ ")}</p>
                      <p class="artist-card__bio">{artist.data.biography}</p>
                    </div>
                  </a>
                </li>
              ))}
            </ul>
            <div
              id="artists-search-empty"
              class="artists-index__empty"
              aria-live="polite"
              hidden
            >
              No artists match your search. Try a different term.
            </div>
          </>
        ) : (
          <div class="artists-index__empty" role="status" aria-live="polite">
            No artist profiles available yet.
          </div>
        )
      }
    </div>
  </PageShell>
  <BackToTop lang="en" />
</Layout>

<style>
  .artists-index {
    display: grid;
    gap: 2rem;
  }

  .artists-index__header {
    display: grid;
    gap: 1.1rem;
  }

  .artists-index__headline {
    display: grid;
    gap: 0.65rem;
  }

  .artists-index__eyebrow {
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--gn-ink-muted);
    font-size: 0.95rem;
    font-weight: 700;
  }

  .artists-index__title {
    margin: 0;
    font-size: clamp(2rem, 4.8vw, 3.2rem);
    color: var(--gn-ink);
    line-height: 1.1;
  }

  .artists-index__description {
    margin: 0;
    color: var(--gn-ink-muted);
    font-size: 1.125rem;
    line-height: 1.7;
    max-width: 62ch;
  }

  .artists-index__search {
    min-width: 0;
    inline-size: 100%;
    --search-shell-max-inline-size: none;
  }

  .artists-index__controls {
    display: flex;
    flex-wrap: wrap;
    align-items: stretch;
    gap: 1rem;
    inline-size: 100%;
  }

  .artists-index__filters {
    flex: 0 1 19rem;
    min-width: 16rem;
    display: block;
  }

  .artists-index__search {
    flex: 1 1 38rem;
  }

  @media (min-width: 900px) {
    .artists-index__controls {
      flex-wrap: nowrap;
    }
  }

  @media (max-width: 899px) {
    .artists-index__filters {
      min-width: 100%;
      flex-basis: 100%;
    }
  }

  .artists-index__genre-filter {
    inline-size: 100%;
    min-width: 0;
    display: grid;
    gap: 0.45rem;
    padding: 0.85rem 0.95rem;
    border-radius: 1rem;
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 74%, transparent);
    background:
      linear-gradient(
        145deg,
        color-mix(in srgb, var(--gn-bg-muted) 90%, transparent),
        transparent
      ),
      color-mix(in srgb, var(--gn-bg-muted) 82%, transparent);
    box-shadow: var(--gn-offset-shadow);
  }

  .artists-index__genre-label {
    margin: 0;
    color: var(--gn-ink-muted);
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-weight: 700;
  }

  .artists-index__genre-input {
    appearance: none;
    min-height: 44px;
    border-radius: 0.75rem;
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
    background: color-mix(in srgb, var(--gn-bg) 88%, transparent);
    color: var(--gn-ink);
    padding: 0.65rem 2.2rem 0.65rem 0.85rem;
    font-size: 1rem;
    font-weight: 600;
    background-image:
      linear-gradient(
        45deg,
        transparent 50%,
        color-mix(in srgb, var(--gn-ink) 80%, transparent) 50%
      ),
      linear-gradient(
        135deg,
        color-mix(in srgb, var(--gn-ink) 80%, transparent) 50%,
        transparent 50%
      );
    background-position:
      calc(100% - 1rem) calc(50% - 2px),
      calc(100% - 0.7rem) calc(50% - 2px);
    background-size:
      0.35rem 0.35rem,
      0.35rem 0.35rem;
    background-repeat: no-repeat;
    transition:
      border-color var(--transition-fast),
      box-shadow var(--transition-fast);
  }

  .artists-index__genre-input::placeholder {
    color: var(--gn-ink-muted);
  }

  .artists-index__genre-input:hover {
    border-color: color-mix(in srgb, var(--gn-accent) 55%, transparent);
  }

  .artists-index__genre-input:focus-visible {
    outline: none;
    border-color: color-mix(in srgb, var(--gn-accent) 70%, transparent);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--gn-accent) 22%, transparent);
  }

  .artists-index__grid {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 1.25rem;
  }

  @media (min-width: 640px) {
    .artists-index__grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1024px) {
    .artists-index__grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .artist-card {
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    border-radius: 1.2rem;
    background: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
    box-shadow: var(--gn-offset-shadow);
    overflow: hidden;
    transition:
      transform var(--transition-base),
      box-shadow var(--transition-base);
  }

  .artist-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 16px 30px rgba(0, 0, 0, 0.35);
  }

  .artist-card__link {
    display: flex;
    flex-direction: column;
    height: 100%;
    color: inherit;
    text-decoration: none;
  }

  .artist-card__link:focus-visible {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 3px;
  }

  .artist-card__media {
    aspect-ratio: 4 / 3;
    overflow: hidden;
    background: var(--gn-bg);
  }

  .artist-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .artist-card__body {
    display: grid;
    gap: 0.55rem;
    padding: 1rem;
  }

  .artist-card__name {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--gn-ink);
  }

  .artist-card__origin,
  .artist-card__genres,
  .artist-card__bio {
    margin: 0;
    color: var(--gn-ink-muted);
  }

  .artist-card__genres {
    font-size: 0.95rem;
  }

  .artist-card__bio {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    font-size: 1rem;
    line-height: 1.6;
  }

  .artists-index__empty {
    padding: 1.25rem;
    border-radius: 1rem;
    border: 2px solid var(--gn-panel-border);
    background: var(--gn-bg-muted);
    color: var(--gn-ink-muted);
    text-align: center;
  }
</style>

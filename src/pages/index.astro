---
/**
 * Knowledge Index Page - Professional Dark Mode with WCAG AAA
 */
import Layout from "@layouts/Layout.astro";
import { buildPageSeo, type StructuredData } from "@utils/seo/buildPageSeo";
import { buildKnowledgeArticlesItemList } from "@utils/seo/seoSchema";
import { ui } from "@i18n/ui";
import { calculateReadingTime } from "@utils/readingTime";
import BackToTop from "@components/Shared/BackToTop.astro";
import { sortKnowledgeEntries } from "@utils/content/sortKnowledgeEntries";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { normalizeDate, derivePublishModified } from "@utils/content/dateUtils";
import categories from "../data/categories.json";
import { Image } from "astro:assets";
import SearchPanel from "@components/Search/SearchPanel.astro";

export const prerender = true;

const lang = "en";
const safeUi = ui[lang] as Record<string, string>;

// Load English knowledge collection
let baseArticles: any[] = [];
try {
  baseArticles = await getCollectionCached("knowledge-en").catch(() => []);
} catch (e) {
  globalThis.console?.warn?.("knowledge index: collection load issue", {
    error: (e as any)?.message || e,
  });
}

// Process articles
const articlesWithReadingTime = baseArticles.map((article: any) => {
  const createdAtRaw = article?.data?.createdAt;
  const updatedAtRaw = article?.data?.updatedAt;
  const createdAt = normalizeDate(createdAtRaw);
  const updatedAt = normalizeDate(updatedAtRaw);
  const readingTime =
    article.data.readingTime || calculateReadingTime(article.body || "");
  return {
    ...article,
    data: { ...article.data, createdAt, updatedAt, readingTime },
  };
});

const sortedArticles = sortKnowledgeEntries(articlesWithReadingTime);

// SEO
const title = safeUi["knowledge.title"];
const description =
  safeUi["knowledge.description"] ||
  "Curated genre deep dives from roots to todayâ€™s sounds, with stories, listening cues, and playlists that help you explore faster and hear music with more context.";
const baseUrl = Astro.site?.toString().replace(/\/$/, "") || "https://melody-mind.de";
const currentUrl = `${baseUrl}/`;

let earliestCreated: Date | null = null;
let latestUpdated: Date | null = null;
for (const a of articlesWithReadingTime) {
  const c = normalizeDate(a.data.createdAt);
  if (c && (!earliestCreated || c.getTime() < earliestCreated.getTime()))
    earliestCreated = c;
  const u = normalizeDate(a.data.updatedAt);
  if (u && (!latestUpdated || u.getTime() > latestUpdated.getTime())) latestUpdated = u;
}
const collectionDates = derivePublishModified(earliestCreated, latestUpdated);

const seoBreadcrumbs = [{ name: safeUi["nav.home"] || "Home", url: currentUrl }];
const breadcrumbs = [{ name: safeUi["nav.home"] || "Home", url: "/" }];

const articleCollectionSchema = buildKnowledgeArticlesItemList({
  articles: sortedArticles.map((a: any) => ({
    slug: "slug" in a ? a.slug : a.id,
    data: {
      title: a.data.title,
      description: a.data.description,
      createdAt: a.data.createdAt,
      updatedAt: a.data.updatedAt,
      keywords: a.data.keywords,
      image: a.data.image,
    },
  })),
  baseUrl,
  lang,
  listName: safeUi["knowledge.title"] || "Knowledge Articles",
});

const keywordPool = sortedArticles.flatMap((article) => article.data.keywords || []);
const metaKeywords = keywordPool.slice(0, 10).join(", ");

type CategoryDef = {
  slug: string;
  name: string;
  description: string;
  image: string;
};

// Pre-compute counts to avoid repeated filters and handle stray whitespace
const categoryCounts = sortedArticles.reduce<Record<string, number>>((acc, article) => {
  const key = (article.data.category || "").trim();
  if (!key) return acc;
  acc[key] = (acc[key] ?? 0) + 1;
  return acc;
}, {});

const categoryData = (categories as CategoryDef[]).map((cat) => ({
  ...cat,
  count: categoryCounts[cat.slug] ?? 0,
}));

const pageSeo = buildPageSeo({
  title,
  description,
  url: currentUrl,
  contentKind: "generic",
  breadcrumbs: seoBreadcrumbs,
  structuredData: [articleCollectionSchema].filter(Boolean) as StructuredData[],
  enrichedParts: [title, description, keywordPool.slice(0, 25).join(" ")],
  fallbackKeywords: metaKeywords
    .split(",")
    .map((k) => k.trim())
    .filter(Boolean),
  keywordLimit: 28,
  maxDescription: 150,
  image: "/melody-mind.jpg",
  publishDate: collectionDates.publishDate || undefined,
  modifiedDate: collectionDates.modifiedDate || undefined,
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo} {breadcrumbs}>
  <div class="text-gn-parchment-50 relative min-h-screen">
    <div class="pointer-events-none absolute inset-0"></div>

    <div class="relative mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
      <header class="border-gn-soot-700 mb-12 space-y-4 border-b pb-8">
        <div class="space-y-3 text-center">
          <h1 class="text-gn-parchment-50 hidden text-3xl font-semibold sm:text-4xl">
            {title}
          </h1>
          <Image
            class="mx-auto h-auto"
            src="/melody-mind.jpg"
            width="1080"
            height="720"
            alt="Melody Mind Logo"
            loading="eager"
            fetchpriority="high"
          />
        </div>
        <div class="text-gn-parchment-200 space-y-5 text-lg leading-relaxed sm:text-xl">
          <p>
            Melody Mind provides an access route to the world of music. Every guide
            reveals where a genre begins, how it grows, and what gives it its unique sound
            â€“ including its cultural backstory, early pioneers, and contemporary hybrids
            that populate todayâ€™s playlists. ðŸŽ§.
          </p>
          <p>
            We highlight the key artists, movements, and technological turning points that
            shaped every sound, providing you with context that enhances your listening
            experience. As you navigate through the material, you will come across
            essential tracks and curated examples alongside soft listening prompts to help
            you detect patterns, trace influences and learn the emotional vocabulary.
          </p>
          <p>
            You will get to notice the way ideas move across decades in all genres â€“ how
            rhythms travel, styles merge and old ideas come back with a difference. With
            the help of these timelines and insights, you can be able to appreciate your
            faves on a new level and discover new genres.
          </p>
          <p>
            Whether you are here to explore, learn or simply hear, Melody Mind takes you
            through the stories, sounds and cultures behind the music of the world.
          </p>
        </div>
      </header>
    </div>

    <section
      class="mb-12"
      aria-labelledby="knowledge-categories-title"
      aria-describedby="knowledge-categories-help"
    >
      <div class="mx-auto mb-6 max-w-6xl space-y-4 px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <h2
            id="knowledge-categories-title"
            class="text-gn-parchment-50 text-2xl leading-tight font-semibold sm:text-3xl"
          >
            Explore categories
          </h2>
          <p
            id="knowledge-categories-help"
            class="text-gn-parchment-200 text-sm sm:text-base"
          >
            Browse our genre guides; each card announces the number of articles available.
          </p>
        </div>
        <SearchPanel
          idBase="knowledge-search"
          label="Search categories"
          placeholder="Search by genre or description"
          ariaControls="knowledge-categories-list"
          statusAllText="Showing all categories"
          statusCountTemplate="{count} categories found"
          noResultsTemplate='No results for "{term}"'
        />
      </div>
      <ul
        class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"
        aria-label="Knowledge categories"
        id="knowledge-categories-list"
      >
        {
          categoryData.map((cat) => (
            <li
              class="group gn-panel bg-gn-soot-800/90 text-gn-parchment-50 relative overflow-hidden rounded-2xl transition duration-300 hover:-translate-y-1"
              data-search-text={`${cat.name} ${cat.description}`}
            >
              <a
                href={`/categories/${cat.slug}`}
                class="focus-visible:ring-gn-amber-300 focus-visible:ring-offset-gn-soot-900 flex h-full flex-col gap-4 p-5 focus-visible:ring-3 focus-visible:ring-offset-2 focus-visible:outline-none"
                aria-label={`${cat.name} category with ${cat.count} articles`}
              >
                <div class="border-gn-soot-700 bg-gn-soot-900/80 relative aspect-video overflow-hidden rounded-xl border">
                  <Image
                    src={cat.image}
                    alt={`${cat.name} cover`}
                    loading="lazy"
                    decoding="async"
                    class="h-full w-full object-cover transition duration-500 group-hover:scale-105"
                    width="640"
                    height="360"
                  />
                  <div class="from-gn-soot-950 via-gn-soot-900/70 absolute inset-0 bg-linear-to-t to-transparent opacity-70" />
                  <div class="absolute inset-0 flex items-end p-4">
                    <div class="bg-gn-soot-800/80 text-gn-parchment-50 ring-gn-soot-700 flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold tracking-[0.14em] uppercase ring-2">
                      <span class="bg-gn-amber-400 h-2 w-2 rounded-full" />
                      {cat.count} articles
                    </div>
                  </div>
                </div>
                <div class="space-y-2">
                  <p class="text-gn-parchment-50 text-lg font-semibold">{cat.name}</p>
                  <p class="text-gn-parchment-200 text-sm leading-relaxed">
                    {cat.description}
                  </p>
                </div>
              </a>
            </li>
          ))
        }
      </ul>
      <div
        id="knowledge-search-empty"
        class="border-gn-soot-700 bg-gn-soot-900/80 text-gn-parchment-200 mx-4 mt-6 rounded-2xl border-2 p-6 text-center shadow-[4px_4px_0_rgba(0,0,0,0.75)] sm:mx-6 lg:mx-8"
        aria-live="polite"
        hidden
      >
        No categories match your search. Try a different term.
      </div>
    </section>
  </div>

  <BackToTop {lang} />
</Layout>

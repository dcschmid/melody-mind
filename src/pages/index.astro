---
/**
 * Knowledge Index Page - Professional Dark Mode with WCAG AAA
 */
import Layout from "@layouts/Layout.astro";
import PageShell from "@components/Shared/PageShell.astro";
import { buildPageSeo, type StructuredData } from "@utils/seo/buildPageSeo";
import { buildKnowledgeArticlesItemList } from "@utils/seo/seoSchema";
import { ui } from "@i18n/ui";
import { calculateReadingTime } from "@utils/readingTime";
import BackToTop from "@components/Shared/BackToTop.astro";
import { sortKnowledgeEntries } from "@utils/content/sortKnowledgeEntries";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { normalizeDate, derivePublishModified } from "@utils/content/dateUtils";
import { resolveBaseUrl, resolvePageUrl } from "@utils/siteUrls";
import categories from "../data/categories.json";
import { Image } from "astro:assets";
import SearchPanel from "@components/Search/SearchPanel.astro";

export const prerender = true;

const lang = "en";
const safeUi = ui[lang] as Record<string, string>;

// Load English knowledge collection
let baseArticles: any[] = [];
try {
  baseArticles = await getCollectionCached("knowledge-en").catch(() => []);
} catch (e) {
  globalThis.console?.warn?.("knowledge index: collection load issue", {
    error: (e as any)?.message || e,
  });
}

// Process articles
const articlesWithReadingTime = baseArticles.map((article: any) => {
  const createdAtRaw = article?.data?.createdAt;
  const updatedAtRaw = article?.data?.updatedAt;
  const createdAt = normalizeDate(createdAtRaw);
  const updatedAt = normalizeDate(updatedAtRaw);
  const readingTime =
    article.data.readingTime || calculateReadingTime(article.body || "");
  return {
    ...article,
    data: { ...article.data, createdAt, updatedAt, readingTime },
  };
});

const sortedArticles = sortKnowledgeEntries(articlesWithReadingTime);

// SEO
const title = safeUi["knowledge.title"];
const description =
  safeUi["knowledge.description"] ||
  "Curated genre deep dives from roots to todayâ€™s sounds, with stories, listening cues, and playlists that help you explore faster and hear music with more context.";
const baseUrl = resolveBaseUrl(Astro.site);
const currentUrl = resolvePageUrl(Astro.site, "/");

let earliestCreated: Date | null = null;
let latestUpdated: Date | null = null;
for (const a of articlesWithReadingTime) {
  const c = normalizeDate(a.data.createdAt);
  if (c && (!earliestCreated || c.getTime() < earliestCreated.getTime()))
    earliestCreated = c;
  const u = normalizeDate(a.data.updatedAt);
  if (u && (!latestUpdated || u.getTime() > latestUpdated.getTime())) latestUpdated = u;
}
const collectionDates = derivePublishModified(earliestCreated, latestUpdated);

const seoBreadcrumbs = [{ name: safeUi["nav.home"] || "Home", url: currentUrl }];
const breadcrumbs = [{ name: safeUi["nav.home"] || "Home", url: "/" }];

const articleCollectionSchema = buildKnowledgeArticlesItemList({
  articles: sortedArticles.map((a: any) => ({
    slug: "slug" in a ? a.slug : a.id,
    data: {
      title: a.data.title,
      description: a.data.description,
      createdAt: a.data.createdAt,
      updatedAt: a.data.updatedAt,
      keywords: a.data.keywords,
      image: a.data.image,
    },
  })),
  baseUrl,
  lang,
  listName: safeUi["knowledge.title"] || "Knowledge Articles",
});

const keywordPool = sortedArticles.flatMap((article) => article.data.keywords || []);
const metaKeywords = keywordPool.slice(0, 10).join(", ");

type CategoryDef = {
  slug: string;
  name: string;
  description: string;
  image: string;
};

// Pre-compute counts to avoid repeated filters and handle stray whitespace
const categoryCounts = sortedArticles.reduce<Record<string, number>>((acc, article) => {
  const key = (article.data.category || "").trim();
  if (!key) return acc;
  acc[key] = (acc[key] ?? 0) + 1;
  return acc;
}, {});

const categoryData = (categories as CategoryDef[]).map((cat) => ({
  ...cat,
  count: categoryCounts[cat.slug] ?? 0,
}));

const pageSeo = buildPageSeo({
  title,
  description,
  url: currentUrl,
  contentKind: "generic",
  breadcrumbs: seoBreadcrumbs,
  structuredData: [articleCollectionSchema].filter(Boolean) as StructuredData[],
  enrichedParts: [title, description, keywordPool.slice(0, 25).join(" ")],
  fallbackKeywords: metaKeywords
    .split(",")
    .map((k) => k.trim())
    .filter(Boolean),
  keywordLimit: 28,
  maxDescription: 150,
  image: "/melody-mind.jpg",
  publishDate: collectionDates.publishDate || undefined,
  modifiedDate: collectionDates.modifiedDate || undefined,
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo} {breadcrumbs}>
  <PageShell className="page-shell--aurora page-shell--grid">
    <div class="knowledge-index">
      <header class="knowledge-index__intro">
        <div class="knowledge-index__branding">
          <h1 class="sr-only">
            {title}
          </h1>
          <Image
            class="knowledge-index__logo"
            src="/melody-mind.jpg"
            width="1080"
            height="720"
            alt="Melody Mind Logo"
            loading="eager"
            fetchpriority="high"
          />
        </div>
        <div class="knowledge-index__lead">
          <p>
            Melody Mind provides an access route to the world of music. Every guide
            reveals where a genre begins, how it grows, and what gives it its unique sound
            â€“ including its cultural backstory, early pioneers, and contemporary hybrids
            that populate todayâ€™s playlists. ðŸŽ§.
          </p>
          <p>
            We highlight the key artists, movements, and technological turning points that
            shaped every sound, providing you with context that enhances your listening
            experience. As you navigate through the material, you will come across
            essential tracks and curated examples alongside soft listening prompts to help
            you detect patterns, trace influences and learn the emotional vocabulary.
          </p>
          <p>
            You will get to notice the way ideas move across decades in all genres â€“ how
            rhythms travel, styles merge and old ideas come back with a difference. With
            the help of these timelines and insights, you can be able to appreciate your
            faves on a new level and discover new genres.
          </p>
          <p>
            Whether you are here to explore, learn or simply hear, Melody Mind takes you
            through the stories, sounds and cultures behind the music of the world.
          </p>
        </div>
      </header>

      <section
        class="knowledge-index__section"
        aria-labelledby="knowledge-categories-title"
        aria-describedby="knowledge-categories-help"
      >
        <div class="knowledge-index__section-head">
          <div>
            <h2 id="knowledge-categories-title" class="knowledge-index__section-title">
              Explore categories
            </h2>
            <p id="knowledge-categories-help" class="knowledge-index__section-help">
              Browse our genre guides; each card announces the number of articles
              available.
            </p>
          </div>
          <SearchPanel
            idBase="knowledge-search"
            label="Search categories"
            placeholder="Search by genre or description"
            ariaControls="knowledge-categories-list"
            statusAllText="Showing all categories"
            statusCountTemplate="{count} categories found"
            noResultsTemplate='No results for "{term}"'
          />
        </div>
        <ul
          class="knowledge-index__grid"
          aria-label="Knowledge categories"
          id="knowledge-categories-list"
        >
          {
            categoryData.map((cat) => (
              <li
                class="category-card"
                data-search-text={`${cat.name} ${cat.description}`}
              >
                <a
                  href={`/categories/${cat.slug}`}
                  class="category-card__link"
                  aria-label={`${cat.name} category with ${cat.count} articles`}
                >
                  <div class="category-card__media">
                    <Image
                      src={cat.image}
                      alt={`${cat.name} cover`}
                      loading="lazy"
                      decoding="async"
                      class="category-card__image"
                      width="640"
                      height="360"
                    />
                    <div class="category-card__overlay" aria-hidden="true" />
                    <div class="category-card__badge">
                      <span class="category-card__badge-dot" />
                      {cat.count} articles
                    </div>
                  </div>
                  <div class="category-card__body">
                    <p class="category-card__title">{cat.name}</p>
                    <p class="category-card__description">{cat.description}</p>
                  </div>
                </a>
              </li>
            ))
          }
        </ul>
        <div
          id="knowledge-search-empty"
          class="knowledge-index__empty"
          aria-live="polite"
          hidden
        >
          No categories match your search. Try a different term.
        </div>
      </section>
    </div>
  </PageShell>

  <BackToTop {lang} />
</Layout>

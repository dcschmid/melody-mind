---
/**
 * Knowledge Index Page - Professional Dark Mode with WCAG AAA
 */
import Layout from "@layouts/Layout.astro";
import { buildPageSeo, type StructuredData } from "@utils/seo/buildPageSeo";
import { buildKnowledgeArticlesItemList } from "@utils/seo/seoSchema";
import { ui } from "@i18n/ui";
import { useTranslations } from "@utils/i18n";
import { Icon } from "astro-icon/components";
import { calculateReadingTime } from "@utils/readingTime";
import BackToTop from "@components/Shared/BackToTop.astro";
import { sortKnowledgeEntries } from "@utils/content/sortKnowledgeEntries";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { normalizeDate, derivePublishModified } from "@utils/content/dateUtils";
import categories from "../data/categories.json";

export const prerender = true;

const lang = "en";
const t = useTranslations(lang);
const safeUi = ui[lang] as Record<string, string>;

// Load English knowledge collection
let baseArticles: any[] = [];
try {
  baseArticles = await getCollectionCached("knowledge-en").catch(() => []);
} catch (e) {
  globalThis.console?.warn?.("knowledge index: collection load issue", {
    error: (e as any)?.message || e,
  });
}

// Process articles
const articlesWithReadingTime = baseArticles.map((article: any) => {
  const createdAtRaw = article?.data?.createdAt;
  const updatedAtRaw = article?.data?.updatedAt;
  const createdAt = normalizeDate(createdAtRaw);
  const updatedAt = normalizeDate(updatedAtRaw);
  const readingTime =
    article.data.readingTime || calculateReadingTime(article.body || "");
  return {
    ...article,
    data: { ...article.data, createdAt, updatedAt, readingTime },
  };
});

const sortedArticles = sortKnowledgeEntries(articlesWithReadingTime);

// SEO
const title = safeUi["knowledge.title"];
const description = safeUi["knowledge.title"];
const baseUrl =
  Astro.site?.toString().replace(/\/$/, "") ||
  "https://melody-mind.de";
const currentUrl = `${baseUrl}/knowledge`;

let earliestCreated: Date | null = null;
let latestUpdated: Date | null = null;
for (const a of articlesWithReadingTime) {
  const c = normalizeDate(a.data.createdAt);
  if (c && (!earliestCreated || c.getTime() < earliestCreated.getTime()))
    earliestCreated = c;
  const u = normalizeDate(a.data.updatedAt);
  if (u && (!latestUpdated || u.getTime() > latestUpdated.getTime()))
    latestUpdated = u;
}
const collectionDates = derivePublishModified(earliestCreated, latestUpdated);

const breadcrumbs = [
  { name: safeUi["nav.home"] || "Home", url: `${baseUrl}/` },
  { name: safeUi["knowledge.title"] || "Knowledge", url: currentUrl },
];

const articleCollectionSchema = buildKnowledgeArticlesItemList({
  articles: sortedArticles.map((a: any) => ({
    slug: "slug" in a ? a.slug : a.id,
    data: {
      title: a.data.title,
      description: a.data.description,
      createdAt: a.data.createdAt,
      updatedAt: a.data.updatedAt,
      keywords: a.data.keywords,
      image: a.data.image,
    },
  })),
  baseUrl,
  lang,
  listName: safeUi["knowledge.title"] || "Knowledge Articles",
});

const keywordPool = sortedArticles.flatMap(
  (article) => article.data.keywords || []
);
const metaKeywords = keywordPool.slice(0, 10).join(", ");

const formatDate = (value: Date | string | undefined): string => {
  const normalized = normalizeDate(value);
  if (!normalized) return "";
  return normalized.toLocaleDateString(lang, {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
};

type CategoryDef = {
  slug: string;
  name: string;
  description: string;
  image: string;
};

const categoryData = (categories as CategoryDef[]).map((cat) => {
  const count = sortedArticles.filter(
    (a) => a.data.category === cat.slug
  ).length;
  return { ...cat, count };
});

const pageSeo = buildPageSeo({
  title,
  description,
  url: currentUrl,
  contentKind: "generic",
  breadcrumbs,
  structuredData: [articleCollectionSchema].filter(Boolean) as StructuredData[],
  enrichedParts: [title, description, keywordPool.slice(0, 25).join(" ")],
  fallbackKeywords: metaKeywords
    .split(",")
    .map((k) => k.trim())
    .filter(Boolean),
  keywordLimit: 28,
  maxDescription: 150,
  image: "/knowledge.png",
  publishDate: collectionDates.publishDate || undefined,
  modifiedDate: collectionDates.modifiedDate || undefined,
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo} {breadcrumbs}>
  <main class="relative min-h-screen bg-slate-950 text-slate-50">
    <div class="absolute inset-0 bg-slate-950 pointer-events-none"></div>

    <div class="relative mx-auto max-w-6xl px-4 py-12 sm:px-6 lg:px-8 lg:py-18">
      <header class="mb-12 space-y-4 border-b border-white/10 pb-8">
        <div class="space-y-3">
      <img
          class="mx-auto h-auto"
          src="/melody-mind.png"
          width="320"
          height="320"
          alt="Melody Mind Logo - Music Quiz App Logo"
          loading="eager"
          fetchpriority="high"
        />
        </div>
          <p class="text-lg leading-relaxed text-slate-200 sm:text-xl">
            Melody Mind is your gateway to understanding music on a deeper
            level. Each guide explores where a genre comes from, how it evolved,
            and what defines its signature sound â€” from early cultural roots to
            the modern hybrid styles shaping todayâ€™s playlists. ðŸŽ§ <br /> <br /> 
            We highlight the key artists, influential scenes, and technological shifts that
            shaped each genre, giving you context that makes listening more
            meaningful. Youâ€™ll also discover essential tracks, curated examples,
            and subtle listening cues that help you recognize patterns,
            influences, and the emotional language behind the music. <br /><br /> Across all
            genres, youâ€™ll see how sounds connect across decades â€” how ideas
            travel, blend, and return in new forms. These timelines and insights
            make it easier to explore unfamiliar styles, understand your
            favorites more fully, and continuously expand your musical world. <br /><br />
            Whether youâ€™re here to learn, to discover, or simply to listen with
            a sharper ear, Melody Mind guides you through the stories, sounds,
            and cultural threads that shape music everywhere.
          </p>
        </div>
        <div class="flex flex-wrap gap-3 text-sm text-slate-200">
          <span class="rounded-lg bg-white/5 px-3 py-2 ring-1 ring-white/10">
            {sortedArticles.length}
            {t("knowledge.search.articlesFound")}
          </span>
          <span class="rounded-lg bg-white/5 px-3 py-2 ring-1 ring-white/10">
            Updated {
              formatDate(
                collectionDates.modifiedDate ||
                  collectionDates.publishDate ||
                  new Date()
              )
            }
          </span>
        </div>
      </header>

      <section class="mb-12">
        <div class="mb-4 flex items-center gap-3">
          <Icon
            name="grid"
            class="h-6 w-6 text-primary-200"
            aria-hidden="true"
          />
          <h2 class="text-xl font-semibold text-white">Browse by category</h2>
        </div>
        <ul class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {
            categoryData.map((cat) => (
              <li class="group relative overflow-hidden rounded-2xl border border-white/10 bg-slate-900/80 shadow-xl shadow-black/30 transition duration-300 hover:-translate-y-1 hover:border-primary-300/60 hover:shadow-primary-900/30">
                <a
                  href={`/categories/${cat.slug}`}
                  class="flex h-full flex-col gap-4 p-5 focus-visible:outline-none focus-visible:ring-3 focus-visible:ring-primary-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
                >
                  <div class="relative aspect-video overflow-hidden rounded-xl border border-white/10 bg-slate-900/70">
                    <img
                      src={cat.image}
                      alt={`${cat.name} cover`}
                      loading="lazy"
                      decoding="async"
                      class="h-full w-full object-cover transition duration-500 group-hover:scale-105"
                      width="640"
                      height="360"
                    />
                    <div class="absolute inset-0 bg-linear-to-t from-black via-black/50 to-transparent opacity-60" />
                    <div class="absolute inset-0 flex items-end p-4">
                      <div class="flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.14em] text-slate-100 ring-1 ring-white/10">
                        <span class="h-2 w-2 rounded-full bg-primary-300" />
                        {cat.count} articles
                      </div>
                    </div>
                  </div>
                  <div class="space-y-2">
                    <p class="text-lg font-semibold text-white">{cat.name}</p>
                    <p class="text-sm leading-relaxed text-slate-200">
                      {cat.description}
                    </p>
                  </div>
                </a>
              </li>
            ))
          }
        </ul>
      </section>
    </div>

    <BackToTop {lang} />
  </main>
</Layout>

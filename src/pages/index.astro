---
/**
 * Knowledge Index Page - Professional Dark Mode with WCAG AAA
 */
import Layout from "@layouts/Layout.astro";
import { buildPageSeo, type StructuredData } from "@utils/seo/buildPageSeo";
import SearchPanel from "@components/Search/SearchPanel.astro";
import { buildKnowledgeArticlesItemList } from "@utils/seo/seoSchema";
import { ui } from "@i18n/ui";
import { useTranslations } from "@utils/i18n";
import Headline from "@components/Headline.astro";
import Paragraph from "@components/Paragraph.astro";
import { Icon } from "astro-icon/components";
import { calculateReadingTime } from "@utils/readingTime";
import BackToTop from "@components/Shared/BackToTop.astro";
import KnowledgeCard from "@components/KnowledgeCard.astro";
import { sortKnowledgeEntries } from "@utils/content/sortKnowledgeEntries";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { normalizeDate, derivePublishModified } from "@utils/content/dateUtils";

export const prerender = true;

const lang = "en";
const t = useTranslations(lang);
const safeUi = ui[lang] as Record<string, string>;

// Load English knowledge collection
let baseArticles: any[] = [];
try {
  baseArticles = await getCollectionCached("knowledge-en").catch(() => []);
} catch (e) {
  globalThis.console?.warn?.("knowledge index: collection load issue", {
    error: (e as any)?.message || e,
  });
}

// Process articles
const articlesWithReadingTime = baseArticles.map((article: any) => {
  const createdAtRaw = article?.data?.createdAt;
  const updatedAtRaw = article?.data?.updatedAt;
  const createdAt = normalizeDate(createdAtRaw);
  const updatedAt = normalizeDate(updatedAtRaw);
  const readingTime = article.data.readingTime || calculateReadingTime(article.body || "");
  return {
    ...article,
    data: { ...article.data, createdAt, updatedAt, readingTime },
  };
});

const sortedArticles = sortKnowledgeEntries(articlesWithReadingTime);

// SEO
const title = safeUi["knowledge.title"];
const description = safeUi["knowledge.title"];
const baseUrl = Astro.site?.toString().replace(/\/$/, "") || "https://knowledge.melody-mind.de";
const currentUrl = `${baseUrl}/knowledge`;

let earliestCreated: Date | null = null;
let latestUpdated: Date | null = null;
for (const a of articlesWithReadingTime) {
  const c = normalizeDate(a.data.createdAt);
  if (c && (!earliestCreated || c.getTime() < earliestCreated.getTime())) earliestCreated = c;
  const u = normalizeDate(a.data.updatedAt);
  if (u && (!latestUpdated || u.getTime() > latestUpdated.getTime())) latestUpdated = u;
}
const collectionDates = derivePublishModified(earliestCreated, latestUpdated);

const breadcrumbs = [
  { name: safeUi["nav.home"] || "Home", url: `${baseUrl}/` },
  { name: safeUi["knowledge.title"] || "Knowledge", url: currentUrl },
];

const articleCollectionSchema = buildKnowledgeArticlesItemList({
  articles: sortedArticles.map((a: any) => ({
    slug: "slug" in a ? a.slug : a.id,
    data: {
      title: a.data.title,
      description: a.data.description,
      createdAt: a.data.createdAt,
      updatedAt: a.data.updatedAt,
      keywords: a.data.keywords,
      image: a.data.image,
    },
  })),
  baseUrl,
  lang,
  listName: safeUi["knowledge.title"] || "Knowledge Articles",
});

const keywordPool = sortedArticles.flatMap((article) => article.data.keywords || []);
const metaKeywords = keywordPool.slice(0, 10).join(", ");

const averageReadingTime =
  sortedArticles.length > 0
    ? Math.round(
        sortedArticles.reduce((sum, article) => {
          const minutes =
            typeof article.data.readingTime === "number"
              ? article.data.readingTime
              : calculateReadingTime(article.body || "");
          return sum + minutes;
        }, 0) / sortedArticles.length,
      )
    : 0;

const trendingKeywords = Array.from(new Set(keywordPool)).slice(0, 6);

const latestArticles = [...sortedArticles]
  .map((article) => {
    const updated = normalizeDate(article.data.updatedAt);
    const created = normalizeDate(article.data.createdAt);
    const effectiveDate = updated || created || new Date(0);
    return { article, effectiveDate };
  })
  .sort((a, b) => b.effectiveDate.getTime() - a.effectiveDate.getTime())
  .slice(0, 3)
  .map((item) => item.article);

const formatDate = (value: Date | string | undefined): string => {
  const normalized = normalizeDate(value);
  if (!normalized) return "";
  return normalized.toLocaleDateString(lang, {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
};

const clientTranslations = {
  search: {
    showingAll: safeUi["knowledge.search.showing.all"] || "Showing all articles",
    articlesFound: safeUi["knowledge.search.articlesFound"] || "articles found",
    placeholder: safeUi["knowledge.search.placeholder"] || "Search articles...",
    resetText: safeUi["knowledge.search.reset.text"] || "Reset",
    noResultsFor: safeUi["knowledge.search.no_results_for"] || 'No results for "{term}"',
  },
};

const pageSeo = buildPageSeo({
  title,
  description,
  url: currentUrl,
  contentKind: "generic",
  breadcrumbs,
  structuredData: [articleCollectionSchema].filter(Boolean) as StructuredData[],
  enrichedParts: [title, description, keywordPool.slice(0, 25).join(" ")],
  fallbackKeywords: metaKeywords.split(",").map((k) => k.trim()).filter(Boolean),
  keywordLimit: 28,
  maxDescription: 150,
  image: "/knowledge.png",
  publishDate: collectionDates.publishDate || undefined,
  modifiedDate: collectionDates.modifiedDate || undefined,
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo} {breadcrumbs}>
  <script is:inline define:vars={{ clientTranslations }}>
    window.knowledgeTranslations = clientTranslations;
  </script>

  <main class="relative min-h-screen bg-slate-950 text-slate-50">
    <div class="absolute inset-0 bg-slate-950 pointer-events-none"></div>

    <div class="relative mx-auto max-w-6xl px-4 py-12 sm:px-6 lg:px-8 lg:py-18">
      <header class="mb-12 space-y-4 border-b border-white/10 pb-8">
        <div class="space-y-3">
          <h1 class="text-4xl font-semibold leading-tight text-white sm:text-5xl">
            {safeUi["knowledge.title"]}
          </h1>
          <p class="text-lg leading-relaxed text-slate-200 sm:text-xl">
            {safeUi["knowledge.description"]}
          </p>
          <p class="text-base leading-relaxed text-slate-300">
            From roots to remixes, we map every genre with vivid timelines, listening cues, and handpicked cuts so you pick up the stories faster, hear deeper, and keep discovering new favorites. Along the way you’ll get background context, cultural links, and playlists that connect decades, giving you a richer ear and a fresh list of artists to explore.
          </p>
        </div>
        <div class="flex flex-wrap gap-3 text-sm text-slate-200">
          <span class="rounded-lg bg-white/5 px-3 py-2 ring-1 ring-white/10">
            {sortedArticles.length} {t("knowledge.search.articlesFound")}
          </span>
          <span class="rounded-lg bg-white/5 px-3 py-2 ring-1 ring-white/10">
            Updated {formatDate(collectionDates.modifiedDate || collectionDates.publishDate || new Date())}
          </span>
        </div>
      </header>

      <section class="mb-12 grid gap-6 lg:grid-cols-3">
        <div class="lg:col-span-2 rounded-3xl border border-white/10 bg-slate-900/80 p-7 shadow-xl shadow-black/30">
          <div class="mb-4 space-y-2">
            <h2 class="text-xl font-semibold text-white">
              {safeUi["knowledge.search.title"] || "Search articles"}
            </h2>
            <p class="text-sm text-slate-300">
              {safeUi["knowledge.search.subtitle"] || t("knowledge.search.subtitle")}
            </p>
          </div>
          <SearchPanel
            idBase="knowledge-search"
            label={t("knowledge.search.label")}
            placeholder={safeUi["knowledge.search.placeholder"] || "Search articles..."}
            ariaControls="articlesGrid"
            statusAllText={safeUi["knowledge.search.initial"] || "Showing all articles"}
            statusCountTemplate={safeUi["knowledge.search.articlesFound"] ? `{count} ${safeUi["knowledge.search.articlesFound"]}` : "{count} articles found"}
            noResultsTemplate={(safeUi["knowledge.search.no_results_for"] || 'No results for "{term}"') as string}
          />
          {trendingKeywords.length > 0 && (
            <div class="mt-4">
              <p class="mb-2 text-xs font-semibold uppercase tracking-[0.12em] text-slate-400">
                Trending topics
              </p>
              <div class="flex flex-wrap gap-2">
                {trendingKeywords.map((kw) => (
                  <span class="rounded-full bg-white/5 px-3 py-1 text-xs text-slate-200 ring-1 ring-white/10">
                    {kw}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>

        <div class="rounded-3xl border border-white/10 bg-slate-900/80 p-7 shadow-xl shadow-black/30">
          <div class="mb-3 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-white">Latest updates</h2>
            <span class="text-xs uppercase tracking-[0.12em] text-slate-400">Fresh reads</span>
          </div>
          <ul class="space-y-3">
            {latestArticles.length > 0 ? (
              latestArticles.map((article) => {
                const articleSlug = "slug" in article ? article.slug : article.id;
                const createdAt = formatDate(article.data.createdAt);
                const minutes =
                  article.data.readingTime || calculateReadingTime(article.body || "");
                return (
                  <li class="group rounded-2xl border border-white/5 bg-white/5 p-4 transition hover:-translate-y-0.5 hover:border-primary-300/60 hover:bg-white/10">
                    <a
                      href={`/knowledge/${articleSlug}`}
                      class="flex flex-col gap-2 focus-visible:outline-none focus-visible:ring-3 focus-visible:ring-primary-300"
                    >
                      <div class="flex items-center gap-3 text-xs font-semibold uppercase tracking-[0.14em] text-slate-300">
                        <span class="h-2 w-2 rounded-full bg-primary-400"></span>
                        {createdAt}
                        <span aria-hidden="true" class="text-slate-500">•</span>
                        {minutes} {t("knowledge.reading.time")}
                      </div>
                      <p class="text-base font-semibold text-white transition group-hover:text-primary-200">
                        {article.data.title}
                      </p>
                      <p class="text-sm leading-relaxed text-slate-200 line-clamp-2">
                        {article.data.description}
                      </p>
                    </a>
                  </li>
                );
              })
            ) : (
              <li class="rounded-2xl border border-white/5 bg-white/5 p-4 text-sm text-slate-300">
                {safeUi["knowledge.empty"] || "No articles available"}
              </li>
            )}
          </ul>
        </div>
      </section>

      <section class="space-y-4">
        <div class="flex items-center gap-2 text-sm text-slate-300">
          <Icon name="filter" class="h-4 w-4 text-primary-200" aria-hidden="true" />
          <span class="font-semibold text-white">
            {safeUi["knowledge.search.articlesFound"] || "Articles"} ({sortedArticles.length})
          </span>
        </div>

        <h2 class="sr-only">{t("auto._lang_.knowledge.index.knowledge_articles")}</h2>
        <ul id="articlesGrid" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
          {sortedArticles.length > 0 ? (
            sortedArticles.map((article, index: number) => {
              const createdAt =
                article.data.createdAt instanceof Date
                  ? article.data.createdAt
                  : normalizeDate(article.data.createdAt) || new Date();
              const articleSlug = "slug" in article ? article.slug : article.id;

              return (
                <li
                  class="group relative overflow-hidden rounded-2xl border border-white/10 bg-slate-900/80 transition-all duration-300 hover:-translate-y-1 hover:border-primary-300/60 hover:shadow-2xl hover:shadow-primary-900/30"
                  data-article-item
                  data-search-text={article.data.keywords?.join(", ")}
                  itemscope
                  itemtype="https://schema.org/Article"
                >
                  <div class="absolute inset-0 bg-gradient-to-br from-primary-500/5 via-transparent to-transparent opacity-0 transition-opacity duration-500 group-hover:opacity-100"></div>
                  <KnowledgeCard
                    title={article.data.title}
                    description={article.data.description}
                    image={article.data.image as string}
                    createdAt={createdAt}
                    slug={articleSlug}
                    lang={lang}
                    readingTime={article.data.readingTime}
                    articleUrl={`/knowledge/${articleSlug}`}
                    keywords={article.data.keywords?.join(", ")}
                    index={index}
                  />
                  <meta itemprop="name" content={article.data.title} />
                  <meta itemprop="description" content={article.data.description} />
                  <meta itemprop="url" content={`${baseUrl}/knowledge/${articleSlug}`} />
                  <meta itemprop="datePublished" content={createdAt.toISOString()} />
                  {article.data.keywords && (
                    <meta itemprop="keywords" content={article.data.keywords.join(", ")} />
                  )}
                </li>
              );
            })
          ) : (
            <li class="col-span-full rounded-2xl border border-white/10 bg-slate-900/70 py-16 text-center">
              <div class="mx-auto max-w-md">
                <Icon
                  name="info"
                  class="mx-auto mb-6 h-16 w-16 text-slate-500"
                  aria-hidden="true"
                />
                <p class="text-lg text-slate-200">
                  {safeUi["knowledge.empty"] || "No articles available"}
                </p>
              </div>
            </li>
          )}
        </ul>
      </section>
    </div>

    <BackToTop {lang} />
  </main>

  <script>
    import { initSearchPanel } from "@components/Search/initSearchPanel";
    ((): void => {
      const wire = (): void => {
        initSearchPanel({ idBase: "knowledge-search", itemSelector: "[data-article-item]" });
      };
      const schedule = (fn: () => void): void => {
        const idle: (cb: () => void) => void = (window.requestIdleCallback ||
          ((cb: () => void): void => {
            setTimeout(cb, 1);
          })) as (cb: () => void) => void;
        idle(fn);
      };
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => schedule(wire));
      } else {
        schedule(wire);
      }
    })();
  </script>
</Layout>

---
/**
 * Knowledge Index Page - Professional Dark Mode with WCAG AAA
 */
import Layout from "@layouts/Layout.astro";
import { buildPageSeo, type StructuredData } from "@utils/seo/buildPageSeo";
import { buildKnowledgeArticlesItemList } from "@utils/seo/seoSchema";
import { ui } from "@i18n/ui";
import { useTranslations } from "@utils/i18n";
import { calculateReadingTime } from "@utils/readingTime";
import BackToTop from "@components/Shared/BackToTop.astro";
import { sortKnowledgeEntries } from "@utils/content/sortKnowledgeEntries";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { normalizeDate, derivePublishModified } from "@utils/content/dateUtils";
import categories from "../data/categories.json";
import { Image } from "astro:assets";
import SearchPanel from "@components/Search/SearchPanel.astro";

export const prerender = true;

const lang = "en";
const t = useTranslations(lang);
const safeUi = ui[lang] as Record<string, string>;

// Load English knowledge collection
let baseArticles: any[] = [];
try {
  baseArticles = await getCollectionCached("knowledge-en").catch(() => []);
} catch (e) {
  globalThis.console?.warn?.("knowledge index: collection load issue", {
    error: (e as any)?.message || e,
  });
}

// Process articles
const articlesWithReadingTime = baseArticles.map((article: any) => {
  const createdAtRaw = article?.data?.createdAt;
  const updatedAtRaw = article?.data?.updatedAt;
  const createdAt = normalizeDate(createdAtRaw);
  const updatedAt = normalizeDate(updatedAtRaw);
  const readingTime =
    article.data.readingTime || calculateReadingTime(article.body || "");
  return {
    ...article,
    data: { ...article.data, createdAt, updatedAt, readingTime },
  };
});

const sortedArticles = sortKnowledgeEntries(articlesWithReadingTime);

// SEO
const title = safeUi["knowledge.title"];
const description =
  safeUi["knowledge.description"] ||
  "Curated genre deep dives from roots to todayâ€™s sounds, with stories, listening cues, and playlists that help you explore faster and hear music with more context.";
const baseUrl =
  Astro.site?.toString().replace(/\/$/, "") || "https://melody-mind.de";
const currentUrl = `${baseUrl}/`;

let earliestCreated: Date | null = null;
let latestUpdated: Date | null = null;
for (const a of articlesWithReadingTime) {
  const c = normalizeDate(a.data.createdAt);
  if (c && (!earliestCreated || c.getTime() < earliestCreated.getTime()))
    earliestCreated = c;
  const u = normalizeDate(a.data.updatedAt);
  if (u && (!latestUpdated || u.getTime() > latestUpdated.getTime()))
    latestUpdated = u;
}
const collectionDates = derivePublishModified(earliestCreated, latestUpdated);

const seoBreadcrumbs = [{ name: safeUi["nav.home"] || "Home", url: currentUrl }];
const breadcrumbs = [{ name: safeUi["nav.home"] || "Home", url: "/" }];

const articleCollectionSchema = buildKnowledgeArticlesItemList({
  articles: sortedArticles.map((a: any) => ({
    slug: "slug" in a ? a.slug : a.id,
    data: {
      title: a.data.title,
      description: a.data.description,
      createdAt: a.data.createdAt,
      updatedAt: a.data.updatedAt,
      keywords: a.data.keywords,
      image: a.data.image,
    },
  })),
  baseUrl,
  lang,
  listName: safeUi["knowledge.title"] || "Knowledge Articles",
});

const keywordPool = sortedArticles.flatMap(
  (article) => article.data.keywords || []
);
const metaKeywords = keywordPool.slice(0, 10).join(", ");

const formatDate = (value: Date | string | undefined): string => {
  const normalized = normalizeDate(value);
  if (!normalized) return "";
  return normalized.toLocaleDateString(lang, {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
};

type CategoryDef = {
  slug: string;
  name: string;
  description: string;
  image: string;
};

// Pre-compute counts to avoid repeated filters and handle stray whitespace
const categoryCounts = sortedArticles.reduce<Record<string, number>>(
  (acc, article) => {
    const key = (article.data.category || "").trim();
    if (!key) return acc;
    acc[key] = (acc[key] ?? 0) + 1;
    return acc;
  },
  {},
);

const categoryData = (categories as CategoryDef[]).map((cat) => ({
  ...cat,
  count: categoryCounts[cat.slug] ?? 0,
}));

const pageSeo = buildPageSeo({
  title,
  description,
  url: currentUrl,
  contentKind: "generic",
  breadcrumbs: seoBreadcrumbs,
  structuredData: [articleCollectionSchema].filter(Boolean) as StructuredData[],
  enrichedParts: [title, description, keywordPool.slice(0, 25).join(" ")],
  fallbackKeywords: metaKeywords
    .split(",")
    .map((k) => k.trim())
    .filter(Boolean),
  keywordLimit: 28,
  maxDescription: 150,
  image: "/melody-mind.jpg",
  publishDate: collectionDates.publishDate || undefined,
  modifiedDate: collectionDates.modifiedDate || undefined,
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo} {breadcrumbs}>
  <div class="relative min-h-screen bg-slate-950 text-slate-50">
    <div class="absolute inset-0 bg-slate-950 pointer-events-none"></div>

    <div class="relative mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
      <header class="mb-12 space-y-4 border-b border-white/10 pb-8">
        <div class="space-y-3 text-center">
          <h1 class="text-3xl font-semibold text-white sm:text-4xl">
            {title}
          </h1>
          <Image
            class="mx-auto h-auto"
            src="/melody-mind.jpg"
            width="1080"
            height="720"
            alt="Melody Mind Logo"
            loading="eager"
            fetchpriority="high"
          />
        </div>
        <div class="space-y-5 text-lg leading-relaxed text-slate-200 sm:text-xl">
          <p>
            Melody Mind opens a deeper pathway into the world of music. Each
            guide uncovers where a genre begins, how it grows, and what gives it
            its unmistakable voice â€” from its cultural roots and early
            influences to the modern hybrids reshaping todayâ€™s playlists. ðŸŽ§
          </p>
          <p>
            We spotlight the defining artists, landmark movements, and
            technological turning points that shaped every sound, giving you
            context that enriches the way you listen. Along the way, youâ€™ll find
            essential tracks, curated examples, and subtle listening cues
            designed to help you pick up patterns, trace influences, and
            understand the emotional vocabulary behind the music.
          </p>
          <p>
            Across all genres, youâ€™ll see how ideas move between decades â€” how
            rhythms migrate, styles blend, and old concepts return with new
            meaning. These timelines and insights make it easier to dive into
            unfamiliar genres, appreciate your favorites on a new level, and
            continuously expand your musical universe.
          </p>
          <p>
            Whether youâ€™re here to explore, to learn, or simply to hear with
            more clarity, Melody Mind guides you through the stories, sounds,
            and cultural threads that shape music across the world.
          </p>
        </div>
      </header>
    </div>

    <section
      class="mb-12"
      aria-labelledby="knowledge-categories-title"
      aria-describedby="knowledge-categories-help"
    >
      <div class="mx-auto mb-6 max-w-6xl px-4 sm:px-6 lg:px-8 space-y-4">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <h2
            id="knowledge-categories-title"
            class="text-2xl font-semibold leading-tight text-white sm:text-3xl"
          >
            Explore categories
          </h2>
          <p
            id="knowledge-categories-help"
            class="text-sm text-slate-300 sm:text-base"
          >
            Browse our genre guides; each card announces the number of articles available.
          </p>
        </div>
        <SearchPanel
          idBase="knowledge-search"
          label="Search categories"
          placeholder="Search by genre or description"
          ariaControls="knowledge-categories-list"
          statusAllText="Showing all categories"
          statusCountTemplate="{count} categories found"
          noResultsTemplate='No results for "{term}"'
        />
      </div>
      <ul
        class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"
        aria-label="Knowledge categories"
        id="knowledge-categories-list"
      >
        {
          categoryData.map((cat) => (
            <li
              class="group relative overflow-hidden rounded-2xl border border-white/10 bg-slate-900/80 shadow-xl shadow-black/30 transition duration-300 hover:-translate-y-1 hover:border-primary-300/60 hover:shadow-primary-900/30"
              data-search-text={`${cat.name} ${cat.description}`}
            >
              <a
                href={`/categories/${cat.slug}`}
                class="flex h-full flex-col gap-4 p-5 focus-visible:outline-none focus-visible:ring-3 focus-visible:ring-primary-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
                aria-label={`${cat.name} category with ${cat.count} articles`}
              >
                <div class="relative aspect-video overflow-hidden rounded-xl border border-white/10 bg-slate-900/70">
                  <Image
                    src={cat.image}
                    alt={`${cat.name} cover`}
                    loading="lazy"
                    decoding="async"
                    class="h-full w-full object-cover transition duration-500 group-hover:scale-105"
                    width="640"
                    height="360"
                  />
                  <div class="absolute inset-0 bg-linear-to-t from-black via-black/50 to-transparent opacity-60" />
                  <div class="absolute inset-0 flex items-end p-4">
                    <div class="flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.14em] text-slate-100 ring-1 ring-white/10">
                      <span class="h-2 w-2 rounded-full bg-primary-300" />
                      {cat.count} articles
                    </div>
                  </div>
                </div>
                <div class="space-y-2">
                  <p class="text-lg font-semibold text-white">{cat.name}</p>
                  <p class="text-sm leading-relaxed text-slate-200">
                    {cat.description}
                  </p>
                </div>
              </a>
            </li>
          ))
        }
      </ul>
      <div
        id="knowledge-search-empty"
        class="mx-4 mt-6 rounded-2xl border border-white/10 bg-slate-900/70 p-6 text-center text-slate-200 shadow-xl sm:mx-6 lg:mx-8"
        aria-live="polite"
        hidden
      >
        No categories match your search. Try a different term.
      </div>
    </section>
  </div>

  <BackToTop {lang} />
</Layout>

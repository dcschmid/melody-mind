---
/**
 * Knowledge Index Page - Professional Dark Mode with WCAG AAA
 */
import Layout from "@layouts/Layout.astro";
import PageShell from "@components/Shared/PageShell.astro";
import { buildPageSeo, type StructuredData } from "@utils/seo/buildPageSeo";
import { buildKnowledgeArticlesItemList } from "@utils/seo/seoSchema";
import { ui } from "@i18n/ui";
import { calculateReadingTime } from "@utils/readingTime";
import BackToTop from "@components/Shared/BackToTop.astro";
import { sortKnowledgeEntries } from "@utils/content/sortKnowledgeEntries";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { normalizeDate, derivePublishModified } from "@utils/content/dateUtils";
import { resolveBaseUrl, resolvePageUrl } from "@utils/siteUrls";
import categories from "../data/categories.json";
import { Image } from "astro:assets";
import SearchPanel from "@components/Search/SearchPanel.astro";

export const prerender = true;

const lang = "en";
const safeUi = ui[lang] as Record<string, string>;

// Load English knowledge collection
let baseArticles: any[] = [];
try {
  baseArticles = await getCollectionCached("knowledge-en").catch(() => []);
} catch (e) {
  globalThis.console?.warn?.("knowledge index: collection load issue", {
    error: (e as any)?.message || e,
  });
}

// Process articles
const articlesWithReadingTime = baseArticles.map((article: any) => {
  const createdAtRaw = article?.data?.createdAt;
  const updatedAtRaw = article?.data?.updatedAt;
  const createdAt = normalizeDate(createdAtRaw);
  const updatedAt = normalizeDate(updatedAtRaw);
  const readingTime =
    article.data.readingTime || calculateReadingTime(article.body || "");
  return {
    ...article,
    data: { ...article.data, createdAt, updatedAt, readingTime },
  };
});

const sortedArticles = sortKnowledgeEntries(articlesWithReadingTime);

// SEO
const title = safeUi["knowledge.title"];
const description =
  safeUi["knowledge.description"] ||
  "Curated genre deep dives from roots to todayâ€™s sounds, with stories, listening cues, and playlists that help you explore faster and hear music with more context.";
const baseUrl = resolveBaseUrl(Astro.site);
const currentUrl = resolvePageUrl(Astro.site, "/");

let earliestCreated: Date | null = null;
let latestUpdated: Date | null = null;
for (const a of articlesWithReadingTime) {
  const c = normalizeDate(a.data.createdAt);
  if (c && (!earliestCreated || c.getTime() < earliestCreated.getTime()))
    earliestCreated = c;
  const u = normalizeDate(a.data.updatedAt);
  if (u && (!latestUpdated || u.getTime() > latestUpdated.getTime())) latestUpdated = u;
}
const collectionDates = derivePublishModified(earliestCreated, latestUpdated);

const articleCollectionSchema = buildKnowledgeArticlesItemList({
  articles: sortedArticles.map((a: any) => ({
    slug: "slug" in a ? a.slug : a.id,
    data: {
      title: a.data.title,
      description: a.data.description,
      createdAt: a.data.createdAt,
      updatedAt: a.data.updatedAt,
      keywords: a.data.keywords,
      image: a.data.image,
    },
  })),
  baseUrl,
  lang,
  listName: safeUi["knowledge.title"] || "Knowledge Articles",
});

const keywordPool = sortedArticles.flatMap((article) => article.data.keywords || []);
const metaKeywords = keywordPool.slice(0, 10).join(", ");

type CategoryDef = {
  slug: string;
  name: string;
  description: string;
  image: string;
};

// Pre-compute counts to avoid repeated filters and handle stray whitespace
const categoryCounts = sortedArticles.reduce<Record<string, number>>((acc, article) => {
  const key = (article.data.category || "").trim();
  if (!key) return acc;
  acc[key] = (acc[key] ?? 0) + 1;
  return acc;
}, {});

const categoryData = (categories as CategoryDef[]).map((cat) => ({
  ...cat,
  count: categoryCounts[cat.slug] ?? 0,
}));

const pageSeo = buildPageSeo({
  title,
  description,
  url: currentUrl,
  contentKind: "generic",
  structuredData: [articleCollectionSchema].filter(Boolean) as StructuredData[],
  enrichedParts: [title, description, keywordPool.slice(0, 25).join(" ")],
  fallbackKeywords: metaKeywords
    .split(",")
    .map((k) => k.trim())
    .filter(Boolean),
  keywordLimit: 28,
  maxDescription: 150,
  image: "/melody-mind.jpg",
  publishDate: collectionDates.publishDate || undefined,
  modifiedDate: collectionDates.modifiedDate || undefined,
  index: true,
  follow: true,
  autoSocialImage: false,
});
---

<Layout {pageSeo}>
  <PageShell className="page-shell--aurora page-shell--grid">
    <div class="knowledge-index">
      <header class="knowledge-index__intro">
        <div class="knowledge-index__stage">
          <div class="knowledge-index__stage-media">
            <div class="knowledge-index__stage-glow" aria-hidden="true"></div>
            <div class="knowledge-index__stage-frame">
              <Image
                class="knowledge-index__stage-image"
                src="/melody-mind.jpg"
                width="1080"
                height="720"
                alt="Melody Mind Logo"
                loading="eager"
                fetchpriority="high"
              />
            </div>
          </div>
          <div class="knowledge-index__stage-panel">
            <h1 class="knowledge-index__sr">{title}</h1>
            <p class="knowledge-index__eyebrow">Melody Mind Knowledge</p>
            <p class="knowledge-index__hero-text">
              <strong>Discover music's DNA:</strong> From genre origins to today's sounds, we
              decode the cultural stories, key artists, and sonic evolution that shaped every
              style. ðŸŽ§
            </p>
            <div class="knowledge-index__features">
              <span class="knowledge-index__feature-badge">ðŸ“š Curated guides</span>
              <span class="knowledge-index__feature-badge">ðŸŽµ Essential tracks</span>
              <span class="knowledge-index__feature-badge">ðŸ”— Genre connections</span>
              <span class="knowledge-index__feature-badge">ðŸ’¡ Listening insights</span>
            </div>
          </div>
        </div>
      </header>

      <section
        class="knowledge-index__section knowledge-index__section--recent"
        aria-labelledby="recent-reads-title"
      >
        <div class="knowledge-index__section-head">
          <div>
            <h2 id="recent-reads-title" class="knowledge-index__section-title">
              Recently read
            </h2>
            <p class="knowledge-index__section-help">
              Pick up where you left off on your last few guides.
            </p>
          </div>
        </div>
        <div class="recent-reads" id="recent-reads" hidden>
          <ul class="recent-reads__list" id="recent-reads-list" aria-live="polite"></ul>
        </div>
        <div class="recent-reads recent-reads--empty" id="recent-reads-empty">
          <p class="recent-reads__empty-text">
            No recent reads yet. Open a guide and it will show up here.
          </p>
        </div>
      </section>

      <section
        class="knowledge-index__section"
        aria-labelledby="knowledge-categories-title"
        aria-describedby="knowledge-categories-help"
      >
        <div class="knowledge-index__section-head">
          <div>
            <h2 id="knowledge-categories-title" class="knowledge-index__section-title">
              Explore categories
            </h2>
            <p id="knowledge-categories-help" class="knowledge-index__section-help">
              Browse our genre guides; each card announces the number of articles
              available.
            </p>
          </div>
          <SearchPanel
            idBase="knowledge-search"
            label="Search categories"
            placeholder="Search by genre or description"
            ariaControls="knowledge-categories-list"
            statusAllText="Showing all categories"
            statusCountTemplate="{count} categories found"
            noResultsTemplate='No results for "{term}"'
          />
        </div>
        <ul
          class="knowledge-index__grid"
          aria-label="Knowledge categories"
          id="knowledge-categories-list"
        >
          {
            categoryData.map((cat) => (
              <li
                class="category-card"
                data-search-text={`${cat.name} ${cat.description}`}
              >
                <a
                  href={`/categories/${cat.slug}`}
                  class="category-card__link"
                  aria-label={`${cat.name} category with ${cat.count} articles`}
                >
                  <div class="category-card__media">
                    <Image
                      src={cat.image}
                      alt={`${cat.name} cover`}
                      loading="lazy"
                      decoding="async"
                      class="category-card__image"
                      width="640"
                      height="360"
                    />
                    <div class="category-card__overlay" aria-hidden="true" />
                    <div class="category-card__badge">
                      <span class="category-card__badge-dot" />
                      {cat.count} articles
                    </div>
                  </div>
                  <div class="category-card__body">
                    <p class="category-card__title">{cat.name}</p>
                    <p class="category-card__description">{cat.description}</p>
                  </div>
                </a>
              </li>
            ))
          }
        </ul>
        <div
          id="knowledge-search-empty"
          class="knowledge-index__empty"
          aria-live="polite"
          hidden
        >
          No categories match your search. Try a different term.
        </div>
      </section>
    </div>
  </PageShell>

  <BackToTop {lang} />
</Layout>
<script>
  (() => {
    const storageKey = "mm_recent_reads";
    const container = document.getElementById("recent-reads");
    const list = document.getElementById("recent-reads-list");
    const emptyState = document.getElementById("recent-reads-empty");
    if (!container || !list || !emptyState) return;

    let items = [];
    try {
      const raw = window.localStorage?.getItem(storageKey);
      if (raw) items = JSON.parse(raw);
    } catch {
      items = [];
    }

    const sanitized = Array.isArray(items)
      ? items.filter(
          (item) =>
            item && typeof item.slug === "string" && typeof item.title === "string"
        )
      : [];

    if (!sanitized.length) {
      container.hidden = true;
      emptyState.hidden = false;
      return;
    }

    emptyState.hidden = true;
    container.hidden = false;

    const formatter = new Intl.DateTimeFormat("en", {
      year: "numeric",
      month: "short",
      day: "numeric",
    });

    sanitized.slice(0, 3).forEach((item) => {
      const li = document.createElement("li");
      li.className = "recent-reads__item";

      const link = document.createElement("a");
      link.className = "recent-reads__link";
      const normalizedSlug = item.slug.replace(/^\/+/, "");
      link.href = `/knowledge/${normalizedSlug}`;
      link.textContent = item.title;

      li.append(link);

      if (item.updatedAt) {
        const parsed = new Date(item.updatedAt);
        if (!Number.isNaN(parsed.valueOf())) {
          const meta = document.createElement("span");
          meta.className = "recent-reads__meta";
          meta.textContent = `Updated ${formatter.format(parsed)}`;
          li.append(meta);
        }
      }

      list.append(li);
    });
  })();
</script>
<style>
  .knowledge-index {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .knowledge-index__intro {
    padding-bottom: 3rem;
    border-bottom: 1px solid var(--gn-panel-border);
  }

  .knowledge-index__stage {
    position: relative;
    display: grid;
    gap: 2rem;
    align-items: center;
  }

  @media (min-width: 960px) {
    .knowledge-index__stage {
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
    }
  }

  .knowledge-index__stage-media {
    position: relative;
  }

  .knowledge-index__stage-glow {
    position: absolute;
    inset: -18% -10% -20% -10%;
    background: radial-gradient(
      circle at 25% 35%,
      color-mix(in srgb, var(--gn-accent-strong) 35%, transparent) 0%,
      transparent 65%
    );
    filter: blur(18px);
    opacity: 0.75;
    pointer-events: none;
  }

  .knowledge-index__stage-frame {
    position: relative;
    border-radius: 1.75rem;
    overflow: hidden;
    border: 2px solid color-mix(in srgb, var(--gn-accent) 28%, transparent);
    background: color-mix(in srgb, var(--gn-bg-muted) 96%, var(--gn-accent) 4%);
    box-shadow: var(--gn-offset-shadow);
  }

  .knowledge-index__stage-frame::after {
    content: "";
    position: absolute;
    inset: 6px;
    border-radius: calc(1.75rem - 0.4rem);
    border: 1px solid var(--gn-panel-inner);
    pointer-events: none;
  }

  .knowledge-index__stage-image {
    display: block;
    width: 100%;
    height: auto;
    aspect-ratio: 3 / 2;
    object-fit: cover;
  }

  .knowledge-index__stage-panel {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    padding: 1.75rem;
    border-radius: 1.5rem;
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    background: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
    box-shadow: var(--gn-offset-shadow);
    text-align: center;
  }

  .knowledge-index__stage-panel::after {
    content: "";
    position: absolute;
    inset: 5px;
    border-radius: calc(1.5rem - 0.35rem);
    border: 1px solid var(--gn-panel-inner);
    pointer-events: none;
  }

  @media (min-width: 960px) {
    .knowledge-index__stage-panel {
      text-align: left;
      align-self: center;
    }
  }

  .knowledge-index__eyebrow {
    font-size: 1.125rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    font-weight: 600;
    color: var(--gn-ink-muted);
  }

  .knowledge-index__hero-text {
    font-size: 1.25rem;
    color: var(--gn-ink-muted);
    line-height: 1.7;
    margin: 0;
  }

  .knowledge-index__hero-text strong {
    color: var(--gn-ink);
    font-weight: 600;
  }

  @media (min-width: 640px) {
    .knowledge-index__hero-text {
      font-size: 1.375rem;
    }
  }

  .knowledge-index__features {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  @media (min-width: 960px) {
    .knowledge-index__features {
      justify-content: flex-start;
    }
  }

  .knowledge-index__feature-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    background: color-mix(in srgb, var(--gn-accent) 14%, transparent);
    border: 1px solid color-mix(in srgb, var(--gn-accent) 30%, transparent);
    border-radius: 1.5rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gn-ink);
    transition: all 0.2s ease;
  }

  .knowledge-index__feature-badge:hover {
    background: color-mix(in srgb, var(--gn-accent) 20%, transparent);
    border-color: color-mix(in srgb, var(--gn-accent) 42%, transparent);
  }

  .knowledge-index__section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .knowledge-index__section-head {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  @media (min-width: 640px) {
    .knowledge-index__section-head {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }

  .knowledge-index__section-title {
    font-size: 1.875rem;
    font-weight: 600;
    color: var(--gn-ink);
    margin: 0;
  }

  @media (min-width: 640px) {
    .knowledge-index__section-title {
      font-size: 2.125rem;
    }
  }

  .knowledge-index__section-help {
    font-size: 1.125rem;
    color: var(--gn-ink-muted);
    margin: 0;
  }

  @media (min-width: 640px) {
    .knowledge-index__section-help {
      font-size: 1.125rem;
    }
  }

  .knowledge-index__grid {
    display: grid;
    gap: 1.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  @media (min-width: 640px) {
    .knowledge-index__grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1024px) {
    .knowledge-index__grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .knowledge-index__empty {
    margin-top: 1.5rem;
    padding: 1.5rem;
    border-radius: 1rem;
    border: 2px solid var(--gn-panel-border);
    background: var(--gn-bg-muted);
    text-align: center;
    color: var(--gn-ink-muted);
    box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.75);
  }

  .knowledge-index__section--recent {
    margin-top: 0.5rem;
  }

  :global(.recent-reads) {
    position: relative;
    padding: 1.25rem;
    border-radius: 1.25rem;
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    background:
      radial-gradient(
        circle at 15% 20%,
        color-mix(in srgb, var(--gn-accent) 20%, transparent) 0%,
        transparent 55%
      ),
      linear-gradient(
        140deg,
        color-mix(in srgb, var(--gn-bg-muted) 92%, transparent),
        color-mix(in srgb, var(--gn-bg) 90%, transparent)
      );
    box-shadow:
      0 18px 40px rgba(0, 0, 0, 0.35),
      var(--gn-offset-shadow);
  }

  :global(.recent-reads)::after {
    content: "";
    position: absolute;
    inset: 4px;
    border-radius: 1rem;
    border: 1px solid var(--gn-panel-inner);
    pointer-events: none;
  }

  :global(.recent-reads--empty) {
    text-align: center;
    color: var(--gn-ink-muted);
  }

  :global(.recent-reads__empty-text) {
    margin: 0;
    font-size: 1.125rem;
  }

  :global(.recent-reads__list) {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.9rem;
  }

  @media (min-width: 720px) {
    :global(.recent-reads__list) {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  :global(.recent-reads__item) {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    padding: 0.85rem 1rem;
    border-radius: 1rem;
    border: 1px solid color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
    background: linear-gradient(
      150deg,
      color-mix(in srgb, var(--gn-bg) 88%, transparent),
      color-mix(in srgb, var(--gn-bg-muted) 92%, transparent)
    );
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
    overflow: hidden;
    transition:
      transform 180ms ease,
      box-shadow 180ms ease,
      border-color 180ms ease;
  }

  :global(.recent-reads__item)::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
      120deg,
      color-mix(in srgb, var(--gn-accent) 35%, transparent),
      transparent 45%,
      color-mix(in srgb, var(--gn-accent-strong) 28%, transparent) 100%
    );
    opacity: 0;
    pointer-events: none;
    transition: opacity 180ms ease;
  }

  :global(.recent-reads__item:hover) {
    transform: translateY(-4px);
    border-color: color-mix(in srgb, var(--gn-accent) 45%, transparent);
    box-shadow: 0 20px 35px rgba(0, 0, 0, 0.4);
  }

  :global(.recent-reads__item:hover)::before {
    opacity: 0.35;
  }

  :global(.recent-reads__link) {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gn-ink);
    text-decoration: none;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  :global(.recent-reads__link:hover) {
    text-decoration: underline;
  }

  :global(.recent-reads__link:focus-visible) {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 3px;
  }

  :global(.recent-reads__meta) {
    font-size: 1rem;
    color: var(--gn-ink-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .knowledge-index__sr {
    position: absolute;
    width: var(--sr-only-width);
    height: var(--sr-only-height);
    margin: var(--sr-only-margin);
    overflow: hidden;
    clip-path: var(--sr-only-clip-path);
    white-space: nowrap;
    border: 0;
  }

  .category-card {
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%;
    border-radius: 1.25rem;
    border: 2px solid var(--gn-panel-border);
    background: color-mix(in srgb, var(--gn-bg-muted) 92%, transparent);
    color: var(--gn-ink);
    overflow: hidden;
    box-shadow: var(--gn-offset-shadow);
    transition:
      transform var(--transition-base),
      box-shadow var(--transition-base);
  }

  .category-card::after {
    content: "";
    position: absolute;
    inset: 4px;
    border: 1px solid var(--gn-panel-inner);
    border-radius: 1rem;
    pointer-events: none;
  }

  .category-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 22px 45px rgba(0, 0, 0, 0.45);
  }

  .category-card__link {
    display: flex;
    flex-direction: column;
    height: 100%;
    text-decoration: none;
    color: inherit;
  }

  .category-card__link:focus-visible {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 3px;
  }

  .category-card__media {
    position: relative;
    aspect-ratio: 3 / 2;
    overflow: hidden;
    background: var(--gn-bg);
  }

  .category-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 500ms ease;
  }

  .category-card:hover .category-card__image {
    transform: scale(1.05);
  }

  .category-card__overlay {
    position: absolute;
    inset: 0;
  }

  .category-card__badge {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    border: 2px solid var(--gn-panel-border);
    background: color-mix(in srgb, var(--gn-bg) 90%, transparent);
    backdrop-filter: blur(8px);
    font-size: 1rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-weight: 600;
    color: var(--gn-ink);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .category-card__badge-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 999px;
    background: var(--color-gn-amber-400);
  }

  .category-card__body {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1.25rem;
    flex: 1;
  }

  .category-card__title {
    font-size: 1.225rem;
    font-weight: 600;
    margin: 0;
    color: var(--gn-ink);
  }

  .category-card__description {
    margin: 0;
    font-size: 1.125rem;
    line-height: 1.6;
    color: var(--gn-ink-muted);
  }
</style>

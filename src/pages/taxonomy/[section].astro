---
/**
 * Taxonomy Section Page - Display subsections and articles for a taxonomy section
 */
import Layout from "@layouts/Layout.astro";
import PageShell from "@components/Shared/PageShell.astro";
import KnowledgeCard from "@components/KnowledgeCard.astro";
import BackToTop from "@components/Shared/BackToTop.astro";
import { buildPageSeo } from "@utils/seo/buildPageSeo";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { sortKnowledgeEntries } from "@utils/content/sortKnowledgeEntries";
import { normalizeDate } from "@utils/content/dateUtils";
import { calculateReadingTime } from "@utils/readingTime";
import { resolvePageUrl } from "@utils/siteUrls";
import { musicTaxonomy } from "../../data/musicTaxonomy";
import type { TaxonomySubsection } from "../../types/taxonomy";
import { Image } from "astro:assets";

export const prerender = true;

export async function getStaticPaths() {
  return musicTaxonomy.map((section) => ({
    params: { section: section.id },
  }));
}

const sectionId = Astro.params.section as string;
const section = musicTaxonomy.find((s) => s.id === sectionId);

if (!section) {
  return new Response("Not found", { status: 404 });
}

// Load articles
let baseArticles: any[] = [];
try {
  baseArticles = await getCollectionCached("knowledge-en").catch(() => []);
} catch (e) {
  console.warn("taxonomy section: collection load issue", {
    error: (e as any)?.message || e,
  });
}

// Process articles
const articlesWithReadingTime = baseArticles.map((article: any) => {
  const createdAt = normalizeDate(article?.data?.createdAt);
  const updatedAt = normalizeDate(article?.data?.updatedAt);
  const readingTime =
    article.data.readingTime || calculateReadingTime(article.body || "");
  return {
    ...article,
    data: { ...article.data, createdAt, updatedAt, readingTime },
  };
});

// Get subsection IDs for this section
const subsectionIds = section.subsections.map((s) => s.id);

// Filter articles for this section
const sectionArticles = sortKnowledgeEntries(
  articlesWithReadingTime.filter((a: any) =>
    subsectionIds.includes(a.data?.taxonomySubsection)
  )
);

// Build subsection data with article counts
const subsectionsData = section.subsections.map((subsection: TaxonomySubsection) => {
  const articles = sortKnowledgeEntries(
    articlesWithReadingTime.filter(
      (a: any) => a.data?.taxonomySubsection === subsection.id
    )
  );

  return {
    ...subsection,
    articleCount: articles.length,
    articles,
  };
});

// SEO
const currentUrl = resolvePageUrl(Astro.site, `/taxonomy/${sectionId}`);

const pageSeo = buildPageSeo({
  title: `${section.title} | Taxonomy`,
  description:
    section.description || `Explore ${section.title} - music knowledge and guides.`,
  url: currentUrl,
  contentKind: "generic",
  structuredData: [],
  enrichedParts: [section.title, section.description || ""],
  fallbackKeywords: [],
  keywordLimit: 28,
  maxDescription: 160,
  image: section.image,
  imageAlt: `${section.title} - Melody Mind`,
  index: true,
  follow: true,
  autoSocialImage: false,
  authorName: "Melody Mind",
});
---

<Layout {pageSeo}>
  <PageShell className="page-shell--aurora page-shell--grid">
    <div class="taxonomy-section">
      <header class="taxonomy-section__header">
        <div class="taxonomy-section__hero">
          {
            section.image && (
              <div class="taxonomy-section__media">
                <Image
                  src={section.image}
                  alt={section.title}
                  loading="eager"
                  class="taxonomy-section__image"
                  width="1200"
                  height="400"
                />
                <div class="taxonomy-section__overlay" aria-hidden="true" />
              </div>
            )
          }
          <div class="taxonomy-section__intro">
            <h1 class="taxonomy-section__title">{section.title}</h1>
            {
              section.description && (
                <p class="taxonomy-section__description">{section.description}</p>
              )
            }
            <div class="taxonomy-section__stats">
              <span class="taxonomy-section__stat">
                {subsectionsData.length} topics
              </span>
              <span class="taxonomy-section__stat">
                {sectionArticles.length} articles
              </span>
            </div>
          </div>
        </div>
      </header>

      <section class="taxonomy-section__content">
        {
          subsectionsData.map((subsection) => (
            <div class="taxonomy-section__subsection">
              <div class="taxonomy-section__subsection-header">
                <div class="taxonomy-section__subsection-info">
                  <h2 class="taxonomy-section__subsection-title">{subsection.title}</h2>
                  {subsection.description && (
                    <p class="taxonomy-section__subsection-description">
                      {subsection.description}
                    </p>
                  )}
                  <span class="taxonomy-section__subsection-count">
                    {subsection.articleCount}{" "}
                    {subsection.articleCount === 1 ? "article" : "articles"}
                  </span>
                </div>
              </div>

              {subsection.groups && subsection.groups.length > 0 && (
                <div class="taxonomy-section__groups">
                  {subsection.groups.map((group) => {
                    const groupArticles = sortKnowledgeEntries(
                      articlesWithReadingTime.filter(
                        (a: any) =>
                          a.data?.taxonomySubsection === subsection.id &&
                          a.data?.taxonomyGroup === group.id
                      )
                    );

                    return (
                      <div class="taxonomy-section__group">
                        <div class="taxonomy-section__group-header">
                          <div class="taxonomy-section__group-info">
                            <h3 class="taxonomy-section__group-title">{group.title}</h3>
                            {group.description && (
                              <p class="taxonomy-section__group-description">
                                {group.description}
                              </p>
                            )}
                            <span class="taxonomy-section__group-count">
                              {groupArticles.length}{" "}
                              {groupArticles.length === 1 ? "article" : "articles"}
                            </span>
                          </div>
                        </div>
                        {groupArticles.length > 0 ? (
                          <ul class="taxonomy-section__articles">
                            {groupArticles.map((article: any, index: number) => {
                              const articleSlug =
                                "slug" in article ? article.slug : article.id;
                              return (
                                <li>
                                  <KnowledgeCard
                                    title={article.data.title}
                                    description={article.data.description}
                                    image={article.data.image}
                                    createdAt={article.data.createdAt || new Date()}
                                    slug={articleSlug}
                                    lang="en"
                                    readingTime={article.data.readingTime}
                                    articleUrl={`/knowledge/${articleSlug}`}
                                    index={index}
                                  />
                                </li>
                              );
                            })}
                          </ul>
                        ) : (
                          <p class="taxonomy-section__empty">No articles yet.</p>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}

              {(!subsection.groups || subsection.groups.length === 0) && (
                <>
                  {subsection.articles.length > 0 ? (
                    <ul class="taxonomy-section__articles">
                      {subsection.articles.map((article: any, index: number) => {
                        const articleSlug = "slug" in article ? article.slug : article.id;
                        return (
                          <li>
                            <KnowledgeCard
                              title={article.data.title}
                              description={article.data.description}
                              image={article.data.image}
                              createdAt={article.data.createdAt || new Date()}
                              slug={articleSlug}
                              lang="en"
                              readingTime={article.data.readingTime}
                              articleUrl={`/knowledge/${articleSlug}`}
                              index={index}
                            />
                          </li>
                        );
                      })}
                    </ul>
                  ) : (
                    <p class="taxonomy-section__empty">No articles in this topic yet.</p>
                  )}
                </>
              )}
            </div>
          ))
        }
      </section>
    </div>
  </PageShell>

  <BackToTop lang="en" />
</Layout>

<style>
  .taxonomy-section {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .taxonomy-section__header {
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--gn-panel-border);
  }

  .taxonomy-section__hero {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .taxonomy-section__hero {
      flex-direction: row;
      align-items: flex-start;
    }
  }

  .taxonomy-section__media {
    position: relative;
    width: 100%;
    aspect-ratio: 3 / 1;
    border-radius: 1.5rem;
    overflow: hidden;
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
  }

  @media (min-width: 768px) {
    .taxonomy-section__media {
      width: 40%;
      aspect-ratio: 4 / 3;
    }
  }

  .taxonomy-section__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .taxonomy-section__overlay {
    position: absolute;
    inset: 0;
  }

  .taxonomy-section__intro {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .taxonomy-section__title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gn-ink);
    margin: 0;
    line-height: 1.2;
  }

  @media (min-width: 768px) {
    .taxonomy-section__title {
      font-size: 2.5rem;
    }
  }

  .taxonomy-section__description {
    font-size: 1.125rem;
    color: var(--gn-ink-muted);
    line-height: 1.6;
    margin: 0;
  }

  .taxonomy-section__stats {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
  }

  .taxonomy-section__stat {
    display: inline-flex;
    align-items: center;
    padding: 0.4rem 0.9rem;
    border-radius: 999px;
    border: 1px solid var(--gn-panel-border);
    background: color-mix(in srgb, var(--gn-bg-muted) 80%, transparent);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gn-ink-muted);
  }

  .taxonomy-section__content {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .taxonomy-section__subsection {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .taxonomy-section__subsection-header {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  @media (min-width: 768px) {
    .taxonomy-section__subsection-header {
      flex-direction: row;
      align-items: flex-start;
      gap: 1.5rem;
    }
  }

  .taxonomy-section__subsection-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .taxonomy-section__subsection-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--gn-ink);
    margin: 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--gn-panel-border);
  }

  .taxonomy-section__subsection-description {
    font-size: 1rem;
    color: var(--gn-ink-muted);
    line-height: 1.6;
    margin: 0;
  }

  .taxonomy-section__subsection-count {
    font-size: 0.875rem;
    color: var(--color-gn-amber-300);
    font-weight: 500;
  }

  .taxonomy-section__subsection-image {
    width: 100%;
    max-width: 300px;
    flex-shrink: 0;
    border-radius: 1rem;
    overflow: hidden;
    border: 2px solid var(--gn-panel-border);
  }

  .taxonomy-section__subsection-img {
    width: 100%;
    height: auto;
    aspect-ratio: 3 / 2;
    object-fit: cover;
    display: block;
  }

  .taxonomy-section__groups {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .taxonomy-section__group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1.25rem;
    border-radius: 1rem;
    background: color-mix(in srgb, var(--gn-bg-muted) 60%, transparent);
    border: 1px solid var(--gn-panel-border);
  }

  .taxonomy-section__group-header {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  @media (min-width: 640px) {
    .taxonomy-section__group-header {
      flex-direction: row;
      align-items: flex-start;
      gap: 1rem;
    }
  }

  .taxonomy-section__group-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .taxonomy-section__group-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gn-ink);
    margin: 0;
  }

  .taxonomy-section__group-description {
    font-size: 0.9375rem;
    color: var(--gn-ink-muted);
    line-height: 1.5;
    margin: 0;
  }

  .taxonomy-section__group-count {
    font-size: 0.8125rem;
    color: var(--color-gn-amber-300);
    font-weight: 500;
  }

  .taxonomy-section__group-image {
    width: 100%;
    max-width: 180px;
    flex-shrink: 0;
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid var(--gn-panel-border);
  }

  .taxonomy-section__group-img {
    width: 100%;
    height: auto;
    aspect-ratio: 3 / 2;
    object-fit: cover;
    display: block;
  }

  .taxonomy-section__articles {
    display: grid;
    gap: 1.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  @media (min-width: 640px) {
    .taxonomy-section__articles {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1024px) {
    .taxonomy-section__articles {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .taxonomy-section__empty {
    padding: 1.5rem;
    border-radius: 1rem;
    background: color-mix(in srgb, var(--gn-bg-muted) 80%, transparent);
    border: 1px solid var(--gn-panel-border);
    color: var(--gn-ink-muted);
    text-align: center;
    margin: 0;
  }
</style>

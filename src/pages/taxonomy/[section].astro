---
/**
 * Taxonomy Section Page - Display subsections and articles for a taxonomy section
 */
import Layout from "@layouts/Layout.astro";
import PageShell from "@components/Shared/PageShell.astro";
import KnowledgeCard from "@components/KnowledgeCard.astro";
import BackToTop from "@components/Shared/BackToTop.astro";
import { buildPageSeo } from "@utils/seo/buildPageSeo";
import { getCollectionCached } from "@utils/content/getCollectionCached";
import { sortKnowledgeEntries } from "@utils/content/sortKnowledgeEntries";
import { normalizeDate } from "@utils/content/dateUtils";
import { calculateReadingTime } from "@utils/readingTime";
import { resolvePageUrl } from "@utils/siteUrls";
import { musicTaxonomy } from "../../data/musicTaxonomy";
import type { TaxonomySubsection } from "../../types/taxonomy";
import { Image } from "astro:assets";

export const prerender = true;

export async function getStaticPaths() {
  return musicTaxonomy.map((section) => ({
    params: { section: section.id },
  }));
}

const sectionId = Astro.params.section as string;
const section = musicTaxonomy.find((s) => s.id === sectionId);

if (!section) {
  return new Response("Not found", { status: 404 });
}

// Load articles
let baseArticles: any[] = [];
try {
  baseArticles = await getCollectionCached("knowledge-en").catch(() => []);
} catch (e) {
  console.warn("taxonomy section: collection load issue", {
    error: (e as any)?.message || e,
  });
}

// Process articles
const articlesWithReadingTime = baseArticles.map((article: any) => {
  const createdAt = normalizeDate(article?.data?.createdAt);
  const updatedAt = normalizeDate(article?.data?.updatedAt);
  const readingTime =
    article.data.readingTime || calculateReadingTime(article.body || "");
  return {
    ...article,
    data: { ...article.data, createdAt, updatedAt, readingTime },
  };
});

// Get subsection IDs for this section
const subsectionIds = section.subsections.map((s) => s.id);

// Filter articles for this section
const sectionArticles = sortKnowledgeEntries(
  articlesWithReadingTime.filter((a: any) =>
    subsectionIds.includes(a.data?.taxonomySubsection)
  )
);

// Build subsection data with article counts
const subsectionsData = section.subsections.map((subsection: TaxonomySubsection) => {
  const articles = sortKnowledgeEntries(
    articlesWithReadingTime.filter(
      (a: any) => a.data?.taxonomySubsection === subsection.id
    )
  );

  return {
    ...subsection,
    articleCount: articles.length,
    articles,
  };
});

// SEO
const currentUrl = resolvePageUrl(Astro.site, `/taxonomy/${sectionId}`);

const pageSeo = buildPageSeo({
  title: `${section.title} | Taxonomy`,
  description:
    section.description || `Explore ${section.title} - music knowledge and guides.`,
  url: currentUrl,
  contentKind: "generic",
  structuredData: [],
  enrichedParts: [section.title, section.description || ""],
  fallbackKeywords: [],
  keywordLimit: 28,
  maxDescription: 160,
  image: section.image,
  imageAlt: `${section.title} - Melody Mind`,
  index: true,
  follow: true,
  autoSocialImage: false,
  authorName: "Melody Mind",
});
---

<Layout {pageSeo}>
  <PageShell className="page-shell--aurora page-shell--grid">
    <div class="taxonomy-section">
      <header class="taxonomy-section__header">
        <div class="taxonomy-section__hero">
          {
            section.image && (
              <div class="taxonomy-section__media">
                <Image
                  src={section.image}
                  alt={section.title}
                  loading="eager"
                  class="taxonomy-section__image"
                  width="1200"
                  height="400"
                />
                <div class="taxonomy-section__overlay" aria-hidden="true" />
              </div>
            )
          }
          <div class="taxonomy-section__intro">
            <h1 class="taxonomy-section__title">{section.title}</h1>
            {
              section.description && (
                <p class="taxonomy-section__description">{section.description}</p>
              )
            }
            <div class="taxonomy-section__stats">
              <span class="taxonomy-section__stat">
                {subsectionsData.length} topics
              </span>
              <span class="taxonomy-section__stat">
                {sectionArticles.length} articles
              </span>
            </div>

            {
              subsectionsData.length > 1 && (
                <nav class="taxonomy-section__toc" aria-label="Jump to topic">
                  <button
                    type="button"
                    class="taxonomy-section__toc-toggle"
                    aria-expanded="false"
                    aria-controls="taxonomy-toc-content"
                  >
                    <span class="taxonomy-section__toc-toggle-label">Jump to topic</span>
                    <svg
                      class="taxonomy-section__toc-chevron"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      aria-hidden="true"
                    >
                      <polyline points="6 9 12 15 18 9" />
                    </svg>
                  </button>
                  <div id="taxonomy-toc-content" class="taxonomy-section__toc-content">
                    <ul class="taxonomy-section__toc-list">
                      {subsectionsData.map((subsection) => (
                        <li class="taxonomy-section__toc-item">
                          <a
                            href={`#${subsection.id}`}
                            class="taxonomy-section__toc-link"
                          >
                            {subsection.title}
                            <span class="taxonomy-section__toc-count">
                              {subsection.articleCount}
                            </span>
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                </nav>
              )
            }
          </div>
        </div>
      </header>

      <section class="taxonomy-section__content">
        {
          subsectionsData.map((subsection) => (
            <div id={subsection.id} class="taxonomy-section__subsection">
              <div class="taxonomy-section__subsection-header">
                <div class="taxonomy-section__subsection-info">
                  <h2 class="taxonomy-section__subsection-title">{subsection.title}</h2>
                  {subsection.description && (
                    <p class="taxonomy-section__subsection-description">
                      {subsection.description}
                    </p>
                  )}
                  <span class="taxonomy-section__subsection-count">
                    {subsection.articleCount}{" "}
                    {subsection.articleCount === 1 ? "article" : "articles"}
                  </span>
                </div>
              </div>

              {subsection.groups && subsection.groups.length > 0 && (
                <div class="taxonomy-section__groups">
                  {subsection.groups.map((group) => {
                    const groupArticles = sortKnowledgeEntries(
                      articlesWithReadingTime.filter(
                        (a: any) =>
                          a.data?.taxonomySubsection === subsection.id &&
                          a.data?.taxonomyGroup === group.id
                      )
                    );

                    return (
                      <div class="taxonomy-section__group">
                        <div class="taxonomy-section__group-header">
                          <div class="taxonomy-section__group-info">
                            <h3 class="taxonomy-section__group-title">{group.title}</h3>
                            {group.description && (
                              <p class="taxonomy-section__group-description">
                                {group.description}
                              </p>
                            )}
                            <span class="taxonomy-section__group-count">
                              {groupArticles.length}{" "}
                              {groupArticles.length === 1 ? "article" : "articles"}
                            </span>
                          </div>
                        </div>
                        {groupArticles.length > 0 ? (
                          <ul class="taxonomy-section__articles">
                            {groupArticles.map((article: any, index: number) => {
                              const articleSlug =
                                "slug" in article ? article.slug : article.id;
                              return (
                                <li>
                                  <KnowledgeCard
                                    title={article.data.title}
                                    description={article.data.description}
                                    image={article.data.image}
                                    createdAt={article.data.createdAt || new Date()}
                                    slug={articleSlug}
                                    lang="en"
                                    readingTime={article.data.readingTime}
                                    articleUrl={`/knowledge/${articleSlug}`}
                                    index={index}
                                  />
                                </li>
                              );
                            })}
                          </ul>
                        ) : (
                          <p class="taxonomy-section__empty">No articles yet.</p>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}

              {(!subsection.groups || subsection.groups.length === 0) && (
                <>
                  {subsection.articles.length > 0 ? (
                    <ul class="taxonomy-section__articles">
                      {subsection.articles.map((article: any, index: number) => {
                        const articleSlug = "slug" in article ? article.slug : article.id;
                        return (
                          <li>
                            <KnowledgeCard
                              title={article.data.title}
                              description={article.data.description}
                              image={article.data.image}
                              createdAt={article.data.createdAt || new Date()}
                              slug={articleSlug}
                              lang="en"
                              readingTime={article.data.readingTime}
                              articleUrl={`/knowledge/${articleSlug}`}
                              index={index}
                            />
                          </li>
                        );
                      })}
                    </ul>
                  ) : (
                    <p class="taxonomy-section__empty">No articles in this topic yet.</p>
                  )}
                </>
              )}
            </div>
          ))
        }
      </section>
    </div>
  </PageShell>

  <BackToTop lang="en" />
</Layout>

<style>
  .taxonomy-section {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .taxonomy-section__header {
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--gn-panel-border);
  }

  .taxonomy-section__hero {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .taxonomy-section__hero {
      flex-direction: row;
      align-items: flex-start;
    }
  }

  .taxonomy-section__media {
    position: relative;
    width: 100%;
    aspect-ratio: 3 / 1;
    border-radius: 1.5rem;
    overflow: hidden;
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 70%, transparent);
  }

  @media (min-width: 768px) {
    .taxonomy-section__media {
      width: 40%;
      aspect-ratio: 4 / 3;
    }
  }

  .taxonomy-section__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .taxonomy-section__overlay {
    position: absolute;
    inset: 0;
  }

  .taxonomy-section__intro {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .taxonomy-section__title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gn-ink);
    margin: 0;
    line-height: 1.2;
  }

  @media (min-width: 768px) {
    .taxonomy-section__title {
      font-size: 2.5rem;
    }
  }

  .taxonomy-section__description {
    font-size: 1.125rem;
    color: var(--gn-ink-muted);
    line-height: 1.6;
    margin: 0;
  }

  .taxonomy-section__stats {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
  }

  .taxonomy-section__stat {
    display: inline-flex;
    align-items: center;
    padding: 0.4rem 0.9rem;
    border-radius: 999px;
    border: 1px solid var(--gn-panel-border);
    background: color-mix(in srgb, var(--gn-bg-muted) 80%, transparent);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gn-ink-muted);
  }

  .taxonomy-section__content {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .taxonomy-section__subsection {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .taxonomy-section__subsection-header {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  @media (min-width: 768px) {
    .taxonomy-section__subsection-header {
      flex-direction: row;
      align-items: flex-start;
      gap: 1.5rem;
    }
  }

  .taxonomy-section__subsection-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .taxonomy-section__subsection-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--gn-ink);
    margin: 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--gn-panel-border);
  }

  .taxonomy-section__subsection-description {
    font-size: 1rem;
    color: var(--gn-ink-muted);
    line-height: 1.6;
    margin: 0;
  }

  .taxonomy-section__subsection-count {
    font-size: 0.875rem;
    color: var(--color-gn-amber-300);
    font-weight: 500;
  }

  .taxonomy-section__subsection-image {
    width: 100%;
    max-width: 300px;
    flex-shrink: 0;
    border-radius: 1rem;
    overflow: hidden;
    border: 2px solid var(--gn-panel-border);
  }

  .taxonomy-section__subsection-img {
    width: 100%;
    height: auto;
    aspect-ratio: 3 / 2;
    object-fit: cover;
    display: block;
  }

  .taxonomy-section__groups {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .taxonomy-section__group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1.25rem;
    border-radius: 1rem;
    background: color-mix(in srgb, var(--gn-bg-muted) 60%, transparent);
    border: 1px solid var(--gn-panel-border);
  }

  .taxonomy-section__group-header {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  @media (min-width: 640px) {
    .taxonomy-section__group-header {
      flex-direction: row;
      align-items: flex-start;
      gap: 1rem;
    }
  }

  .taxonomy-section__group-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .taxonomy-section__group-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gn-ink);
    margin: 0;
  }

  .taxonomy-section__group-description {
    font-size: 0.9375rem;
    color: var(--gn-ink-muted);
    line-height: 1.5;
    margin: 0;
  }

  .taxonomy-section__group-count {
    font-size: 0.8125rem;
    color: var(--color-gn-amber-300);
    font-weight: 500;
  }

  .taxonomy-section__group-image {
    width: 100%;
    max-width: 180px;
    flex-shrink: 0;
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid var(--gn-panel-border);
  }

  .taxonomy-section__group-img {
    width: 100%;
    height: auto;
    aspect-ratio: 3 / 2;
    object-fit: cover;
    display: block;
  }

  .taxonomy-section__articles {
    display: grid;
    gap: 1.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  @media (min-width: 640px) {
    .taxonomy-section__articles {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1024px) {
    .taxonomy-section__articles {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .taxonomy-section__empty {
    padding: 1.5rem;
    border-radius: 1rem;
    background: color-mix(in srgb, var(--gn-bg-muted) 80%, transparent);
    border: 1px solid var(--gn-panel-border);
    color: var(--gn-ink-muted);
    text-align: center;
    margin: 0;
  }

  /* Jump Navigation TOC */
  .taxonomy-section__toc {
    position: relative;
    margin-bottom: 1rem;
  }

  .taxonomy-section__toc-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    width: 100%;
    min-height: 48px;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    background: color-mix(in srgb, var(--gn-bg-muted) 90%, transparent);
    color: var(--gn-ink);
    font-size: 0.9375rem;
    font-weight: 600;
    text-align: left;
    cursor: pointer;
    transition:
      border-color var(--transition-fast),
      background-color var(--transition-fast);
  }

  .taxonomy-section__toc-toggle:hover {
    border-color: var(--color-gn-amber-300);
    background: color-mix(in srgb, var(--gn-bg-muted) 95%, transparent);
  }

  .taxonomy-section__toc-toggle:focus-visible {
    outline: 3px solid var(--color-gn-amber-300);
    outline-offset: 2px;
  }

  .taxonomy-section__toc-toggle-label {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .taxonomy-section__toc-chevron {
    flex-shrink: 0;
    color: var(--gn-ink-muted);
    transition: transform var(--transition-fast);
  }

  .taxonomy-section__toc[data-open="true"] .taxonomy-section__toc-chevron {
    transform: rotate(180deg);
  }

  .taxonomy-section__toc-content {
    display: none;
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    right: 0;
    z-index: 20;
    padding: 1rem;
    border-radius: 1rem;
    border: 2px solid color-mix(in srgb, var(--gn-panel-border) 85%, transparent);
    background: color-mix(in srgb, var(--gn-bg-muted) 97%, transparent);
    box-shadow:
      var(--gn-offset-shadow),
      0 12px 32px rgba(0, 0, 0, 0.25);
    max-height: 50vh;
    overflow-y: auto;
  }

  .taxonomy-section__toc[data-open="true"] .taxonomy-section__toc-content {
    display: block;
  }

  .taxonomy-section__toc-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .taxonomy-section__toc-item {
    margin: 0;
  }

  .taxonomy-section__toc-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.625rem 0.875rem;
    border-radius: 0.75rem;
    color: var(--gn-ink);
    text-decoration: none;
    font-size: 0.9375rem;
    font-weight: 500;
    transition:
      background-color var(--transition-fast),
      color var(--transition-fast);
  }

  .taxonomy-section__toc-link:hover {
    background: color-mix(in srgb, var(--gn-accent) 12%, transparent);
    color: var(--gn-ink);
  }

  .taxonomy-section__toc-link:focus-visible {
    outline: 2px solid var(--color-gn-amber-300);
    outline-offset: 2px;
  }

  .taxonomy-section__toc-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.5rem;
    height: 1.25rem;
    padding: 0 0.375rem;
    border-radius: 999px;
    background: color-mix(in srgb, var(--gn-accent) 20%, transparent);
    color: var(--gn-ink-muted);
    font-size: 0.75rem;
    font-weight: 600;
  }

  .taxonomy-section__toc-link:hover .taxonomy-section__toc-count {
    background: color-mix(in srgb, var(--gn-accent) 35%, transparent);
    color: var(--gn-ink);
  }

  /* Desktop: Show as pill list */
  @media (min-width: 640px) {
    .taxonomy-section__toc-toggle {
      display: none;
    }

    .taxonomy-section__toc-content {
      display: block;
      position: static;
      padding: 0;
      border: none;
      background: transparent;
      box-shadow: none;
      max-height: none;
      overflow: visible;
    }

    .taxonomy-section__toc-list {
      flex-direction: row;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .taxonomy-section__toc-link {
      padding: 0.5rem 0.875rem;
      border: 1px solid color-mix(in srgb, var(--gn-panel-border) 80%, transparent);
      background: color-mix(in srgb, var(--gn-bg-muted) 85%, transparent);
      border-radius: 999px;
      font-size: 0.875rem;
    }

    .taxonomy-section__toc-link:hover {
      border-color: var(--color-gn-amber-300);
      background: color-mix(in srgb, var(--gn-accent) 15%, transparent);
    }
  }

  /* Scroll margin for anchored sections */
  .taxonomy-section__subsection {
    scroll-margin-top: 80px;
  }
</style>

<script>
  const tocNav = document.querySelector(".taxonomy-section__toc");
  const tocToggle = document.querySelector(".taxonomy-section__toc-toggle");
  const tocContent = document.getElementById("taxonomy-toc-content");

  if (tocNav && tocToggle && tocContent) {
    const setOpen = (open: boolean): void => {
      tocNav?.setAttribute("data-open", open ? "true" : "false");
      tocToggle?.setAttribute("aria-expanded", open ? "true" : "false");
    };

    tocToggle.addEventListener("click", () => {
      const isOpen = tocToggle.getAttribute("aria-expanded") === "true";
      setOpen(!isOpen);
    });

    // Close on outside click
    document.addEventListener("click", (e) => {
      const target = e.target as Node;
      if (tocNav?.getAttribute("data-open") === "true" && !tocNav.contains(target)) {
        setOpen(false);
      }
    });

    // Close on Escape
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && tocNav?.getAttribute("data-open") === "true") {
        setOpen(false);
        tocToggle?.focus();
      }
    });

    // Close on link click (mobile)
    tocContent.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      const link = target.closest<HTMLAnchorElement>("a[href^='#']");
      if (link && window.innerWidth < 640) {
        setOpen(false);
      }
    });
  }
</script>
